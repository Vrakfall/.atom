"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.CombinationClientBase = exports.ObservationClientBase = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _rxjs = require("rxjs");

var _disposables = require("../disposables");

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _decorators = require("../decorators");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var __decorate = undefined && undefined.__decorate || function (decorators, target, key, desc) {
    var c = arguments.length,
        r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
        d;
    if ((typeof Reflect === "undefined" ? "undefined" : _typeof(Reflect)) === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {
        if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    }return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var ObservationClientBase = exports.ObservationClientBase = function () {
    function ObservationClientBase() {
        var _this = this;

        var clients = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

        _classCallCheck(this, ObservationClientBase);

        this.clients = clients;
        this._disposable = new _disposables.CompositeDisposable();
        this._clientDisposable = new _disposables.CompositeDisposable();
        this._clientsSubject = new _rxjs.ReplaySubject(1);
        this.makeMergeObserable = function (selector) {
            return _this._clientsSubject.switchMap(function (clients) {
                return _rxjs.Observable.merge.apply(_rxjs.Observable, _toConsumableArray(clients.map(selector)));
            }).share();
        };
        this.next = function () {
            return _this._clientsSubject.next(_this.clients.slice());
        };
        this.next();
        this._disposable.add(this._clientDisposable);
    }

    _createClass(ObservationClientBase, [{
        key: "dispose",
        value: function dispose() {
            if (this._disposable.isDisposed) return;
            this._disposable.dispose();
        }
    }, {
        key: "observe",
        value: function observe(selector) {
            return this.makeMergeObserable(selector);
        }
    }, {
        key: "add",
        value: function add(client) {
            var _this2 = this;

            this.clients.push(client);
            this.next();
            var d = _disposables.Disposable.create(function () {
                _lodash2.default.pull(_this2.clients, client);
                _this2.next();
            });
            this._clientDisposable.add(d);
            return d;
        }
    }, {
        key: "projectAdded",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "projectChanged",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "projectRemoved",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "error",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "msBuildProjectDiagnostics",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "packageRestoreStarted",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "packageRestoreFinished",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "unresolvedDependencies",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "events",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "commands",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "state",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "status",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "requests",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "responses",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "errors",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }]);

    return ObservationClientBase;
}();

__decorate([_decorators.merge], ObservationClientBase.prototype, "projectAdded", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "projectChanged", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "projectRemoved", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "error", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "msBuildProjectDiagnostics", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "packageRestoreStarted", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "packageRestoreFinished", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "unresolvedDependencies", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "events", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "commands", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "state", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "status", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "requests", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "responses", null);
__decorate([_decorators.merge], ObservationClientBase.prototype, "errors", null);

var CombinationClientBase = exports.CombinationClientBase = function () {
    function CombinationClientBase() {
        var _this3 = this;

        var clients = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

        _classCallCheck(this, CombinationClientBase);

        this.clients = clients;
        this._disposable = new _disposables.CompositeDisposable();
        this._clientDisposable = new _disposables.CompositeDisposable();
        this._clientsSubject = new _rxjs.ReplaySubject(1);
        this.makeAggregateObserable = function (selector) {
            var cache = {};
            return _this3._clientsSubject.switchMap(function (clients) {
                var removal = _lodash2.default.difference(_lodash2.default.keys(cache), clients.map(function (z) {
                    return z.uniqueId;
                }));
                _lodash2.default.each(removal, function (z) {
                    return delete cache[z];
                });
                return _rxjs.Observable.combineLatest(clients.map(function (z) {
                    return selector(z).startWith(cache[z.uniqueId]);
                }), function () {
                    for (var _len = arguments.length, values = Array(_len), _key = 0; _key < _len; _key++) {
                        values[_key] = arguments[_key];
                    }

                    return values.map(function (value, index) {
                        cache[clients[index].uniqueId] = value;
                        return {
                            key: clients[index].uniqueId,
                            value: value
                        };
                    });
                });
            }).share();
        };
        this.next = function () {
            return _this3._clientsSubject.next(_this3.clients.slice());
        };
        this.next();
        this._disposable.add(this._clientDisposable);
    }

    _createClass(CombinationClientBase, [{
        key: "dispose",
        value: function dispose() {
            if (this._disposable.isDisposed) return;
            this._disposable.dispose();
        }
    }, {
        key: "observe",
        value: function observe(selector) {
            return this.makeAggregateObserable(selector);
        }
    }, {
        key: "add",
        value: function add(client) {
            var _this4 = this;

            this.clients.push(client);
            this.next();
            var d = _disposables.Disposable.create(function () {
                _lodash2.default.pull(_this4.clients, client);
                _this4.next();
            });
            this._clientDisposable.add(d);
            return d;
        }
    }, {
        key: "projectAdded",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "projectChanged",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "projectRemoved",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "error",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "msBuildProjectDiagnostics",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "packageRestoreStarted",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "packageRestoreFinished",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "unresolvedDependencies",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "state",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "status",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }]);

    return CombinationClientBase;
}();

__decorate([_decorators.aggregate], CombinationClientBase.prototype, "projectAdded", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "projectChanged", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "projectRemoved", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "error", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "msBuildProjectDiagnostics", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "packageRestoreStarted", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "packageRestoreFinished", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "unresolvedDependencies", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "state", null);
__decorate([_decorators.aggregate], CombinationClientBase.prototype, "status", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hZ2dyZWdhdGUvY29tcG9zaXRlLWNsaWVudC1iYXNlLmpzIiwibGliL2FnZ3JlZ2F0ZS9jb21wb3NpdGUtY2xpZW50LWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFNQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7Ozs7OztBQVRBLElBQUksYUFBYSxTQUFDLElBQVEsVUFBSyxVQUFMLElBQW9CLFVBQVUsVUFBVixFQUFzQixNQUF0QixFQUE4QixHQUE5QixFQUFtQyxJQUFuQyxFQUF5QztBQUNuRixRQUFJLElBQUksVUFBVSxNQUFWO1FBQWtCLElBQUksSUFBSSxDQUFKLEdBQVEsTUFBUixHQUFpQixTQUFTLElBQVQsR0FBZ0IsT0FBTyxPQUFPLHdCQUFQLENBQWdDLE1BQWhDLEVBQXdDLEdBQXhDLENBQVAsR0FBc0QsSUFBdEU7UUFBNEUsQ0FBM0gsQ0FEbUY7QUFFbkYsUUFBSSxRQUFPLHlEQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU8sUUFBUSxRQUFSLEtBQXFCLFVBQTVCLEVBQXdDLElBQUksUUFBUSxRQUFSLENBQWlCLFVBQWpCLEVBQTZCLE1BQTdCLEVBQXFDLEdBQXJDLEVBQTBDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUksSUFBSSxXQUFXLE1BQVgsR0FBb0IsQ0FBcEIsRUFBdUIsS0FBSyxDQUFMLEVBQVEsR0FBNUM7QUFBaUQsWUFBSSxJQUFJLFdBQVcsQ0FBWCxDQUFKLEVBQW1CLElBQUksQ0FBQyxJQUFJLENBQUosR0FBUSxFQUFFLENBQUYsQ0FBUixHQUFlLElBQUksQ0FBSixHQUFRLEVBQUUsTUFBRixFQUFVLEdBQVYsRUFBZSxDQUFmLENBQVIsR0FBNEIsRUFBRSxNQUFGLEVBQVUsR0FBVixDQUE1QixDQUFoQixJQUErRCxDQUEvRCxDQUEzQjtLQUFqRCxPQUNFLElBQUksQ0FBSixJQUFTLENBQVQsSUFBYyxPQUFPLGNBQVAsQ0FBc0IsTUFBdEIsRUFBOEIsR0FBOUIsRUFBbUMs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R2hDLEVEd0d5QyxJQ3hHekM7QUFDQSxXQUFBLHVCQUFBLEVEMEdELHNCQUFzQixTQUF0QixFQUFpQyxRQzFHaEMsRUQwRzBDLElDMUcxQyIsImZpbGUiOiJsaWIvYWdncmVnYXRlL2NvbXBvc2l0ZS1jbGllbnQtYmFzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbmltcG9ydCB7IFJlcGxheVN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSB9IGZyb20gXCIuLi9kaXNwb3NhYmxlc1wiO1xuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgbWVyZ2UsIGFnZ3JlZ2F0ZSB9IGZyb20gXCIuLi9kZWNvcmF0b3JzXCI7XG5leHBvcnQgY2xhc3MgT2JzZXJ2YXRpb25DbGllbnRCYXNlIHtcbiAgICBjb25zdHJ1Y3RvcihjbGllbnRzID0gW10pIHtcbiAgICAgICAgdGhpcy5jbGllbnRzID0gY2xpZW50cztcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgIHRoaXMuX2NsaWVudERpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgICAgICB0aGlzLl9jbGllbnRzU3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xuICAgICAgICB0aGlzLm1ha2VNZXJnZU9ic2VyYWJsZSA9IChzZWxlY3RvcikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NsaWVudHNTdWJqZWN0LnN3aXRjaE1hcChjbGllbnRzID0+IE9ic2VydmFibGUubWVyZ2UoLi4uY2xpZW50cy5tYXAoc2VsZWN0b3IpKSkuc2hhcmUoKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5uZXh0ID0gKCkgPT4gdGhpcy5fY2xpZW50c1N1YmplY3QubmV4dCh0aGlzLmNsaWVudHMuc2xpY2UoKSk7XG4gICAgICAgIHRoaXMubmV4dCgpO1xuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZCh0aGlzLl9jbGllbnREaXNwb3NhYmxlKTtcbiAgICB9XG4gICAgZ2V0IHByb2plY3RBZGRlZCgpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHByb2plY3RDaGFuZ2VkKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgcHJvamVjdFJlbW92ZWQoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBlcnJvcigpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IG1zQnVpbGRQcm9qZWN0RGlhZ25vc3RpY3MoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBwYWNrYWdlUmVzdG9yZVN0YXJ0ZWQoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBwYWNrYWdlUmVzdG9yZUZpbmlzaGVkKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgdW5yZXNvbHZlZERlcGVuZGVuY2llcygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IGV2ZW50cygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IGNvbW1hbmRzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgc3RhdGUoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBzdGF0dXMoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCByZXF1ZXN0cygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHJlc3BvbnNlcygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IGVycm9ycygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Rpc3Bvc2FibGUuaXNEaXNwb3NlZClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgfVxuICAgIG9ic2VydmUoc2VsZWN0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWFrZU1lcmdlT2JzZXJhYmxlKHNlbGVjdG9yKTtcbiAgICB9XG4gICAgYWRkKGNsaWVudCkge1xuICAgICAgICB0aGlzLmNsaWVudHMucHVzaChjbGllbnQpO1xuICAgICAgICB0aGlzLm5leHQoKTtcbiAgICAgICAgY29uc3QgZCA9IERpc3Bvc2FibGUuY3JlYXRlKCgpID0+IHtcbiAgICAgICAgICAgIF8ucHVsbCh0aGlzLmNsaWVudHMsIGNsaWVudCk7XG4gICAgICAgICAgICB0aGlzLm5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuX2NsaWVudERpc3Bvc2FibGUuYWRkKGQpO1xuICAgICAgICByZXR1cm4gZDtcbiAgICB9XG59XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJwcm9qZWN0QWRkZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJwcm9qZWN0Q2hhbmdlZFwiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIG1lcmdlXG5dLCBPYnNlcnZhdGlvbkNsaWVudEJhc2UucHJvdG90eXBlLCBcInByb2plY3RSZW1vdmVkXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgbWVyZ2Vcbl0sIE9ic2VydmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwiZXJyb3JcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJtc0J1aWxkUHJvamVjdERpYWdub3N0aWNzXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgbWVyZ2Vcbl0sIE9ic2VydmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwicGFja2FnZVJlc3RvcmVTdGFydGVkXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgbWVyZ2Vcbl0sIE9ic2VydmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwicGFja2FnZVJlc3RvcmVGaW5pc2hlZFwiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIG1lcmdlXG5dLCBPYnNlcnZhdGlvbkNsaWVudEJhc2UucHJvdG90eXBlLCBcInVucmVzb2x2ZWREZXBlbmRlbmNpZXNcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJldmVudHNcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJjb21tYW5kc1wiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIG1lcmdlXG5dLCBPYnNlcnZhdGlvbkNsaWVudEJhc2UucHJvdG90eXBlLCBcInN0YXRlXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgbWVyZ2Vcbl0sIE9ic2VydmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwic3RhdHVzXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgbWVyZ2Vcbl0sIE9ic2VydmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwicmVxdWVzdHNcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJyZXNwb25zZXNcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBtZXJnZVxuXSwgT2JzZXJ2YXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJlcnJvcnNcIiwgbnVsbCk7XG5leHBvcnQgY2xhc3MgQ29tYmluYXRpb25DbGllbnRCYXNlIHtcbiAgICBjb25zdHJ1Y3RvcihjbGllbnRzID0gW10pIHtcbiAgICAgICAgdGhpcy5jbGllbnRzID0gY2xpZW50cztcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgIHRoaXMuX2NsaWVudERpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgICAgICB0aGlzLl9jbGllbnRzU3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xuICAgICAgICB0aGlzLm1ha2VBZ2dyZWdhdGVPYnNlcmFibGUgPSAoc2VsZWN0b3IpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlID0ge307XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fY2xpZW50c1N1YmplY3Quc3dpdGNoTWFwKGNsaWVudHMgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92YWwgPSBfLmRpZmZlcmVuY2UoXy5rZXlzKGNhY2hlKSwgY2xpZW50cy5tYXAoeiA9PiB6LnVuaXF1ZUlkKSk7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHJlbW92YWwsIHogPT4gZGVsZXRlIGNhY2hlW3pdKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb21iaW5lTGF0ZXN0KGNsaWVudHMubWFwKHogPT4gc2VsZWN0b3Ioeikuc3RhcnRXaXRoKGNhY2hlW3oudW5pcXVlSWRdKSksICguLi52YWx1ZXMpID0+IHZhbHVlcy5tYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtjbGllbnRzW2luZGV4XS51bmlxdWVJZF0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogY2xpZW50c1tpbmRleF0udW5pcXVlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9KS5zaGFyZSgpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLm5leHQgPSAoKSA9PiB0aGlzLl9jbGllbnRzU3ViamVjdC5uZXh0KHRoaXMuY2xpZW50cy5zbGljZSgpKTtcbiAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKHRoaXMuX2NsaWVudERpc3Bvc2FibGUpO1xuICAgIH1cbiAgICBnZXQgcHJvamVjdEFkZGVkKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgcHJvamVjdENoYW5nZWQoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBwcm9qZWN0UmVtb3ZlZCgpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IGVycm9yKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgbXNCdWlsZFByb2plY3REaWFnbm9zdGljcygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHBhY2thZ2VSZXN0b3JlU3RhcnRlZCgpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHBhY2thZ2VSZXN0b3JlRmluaXNoZWQoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCB1bnJlc29sdmVkRGVwZW5kZW5jaWVzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgc3RhdGUoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBzdGF0dXMoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9kaXNwb3NhYmxlLmlzRGlzcG9zZWQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBvYnNlcnZlKHNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1ha2VBZ2dyZWdhdGVPYnNlcmFibGUoc2VsZWN0b3IpO1xuICAgIH1cbiAgICBhZGQoY2xpZW50KSB7XG4gICAgICAgIHRoaXMuY2xpZW50cy5wdXNoKGNsaWVudCk7XG4gICAgICAgIHRoaXMubmV4dCgpO1xuICAgICAgICBjb25zdCBkID0gRGlzcG9zYWJsZS5jcmVhdGUoKCkgPT4ge1xuICAgICAgICAgICAgXy5wdWxsKHRoaXMuY2xpZW50cywgY2xpZW50KTtcbiAgICAgICAgICAgIHRoaXMubmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fY2xpZW50RGlzcG9zYWJsZS5hZGQoZCk7XG4gICAgICAgIHJldHVybiBkO1xuICAgIH1cbn1cbl9fZGVjb3JhdGUoW1xuICAgIGFnZ3JlZ2F0ZVxuXSwgQ29tYmluYXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJwcm9qZWN0QWRkZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBhZ2dyZWdhdGVcbl0sIENvbWJpbmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwicHJvamVjdENoYW5nZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBhZ2dyZWdhdGVcbl0sIENvbWJpbmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwicHJvamVjdFJlbW92ZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBhZ2dyZWdhdGVcbl0sIENvbWJpbmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwiZXJyb3JcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBhZ2dyZWdhdGVcbl0sIENvbWJpbmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwibXNCdWlsZFByb2plY3REaWFnbm9zdGljc1wiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIGFnZ3JlZ2F0ZVxuXSwgQ29tYmluYXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJwYWNrYWdlUmVzdG9yZVN0YXJ0ZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBhZ2dyZWdhdGVcbl0sIENvbWJpbmF0aW9uQ2xpZW50QmFzZS5wcm90b3R5cGUsIFwicGFja2FnZVJlc3RvcmVGaW5pc2hlZFwiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIGFnZ3JlZ2F0ZVxuXSwgQ29tYmluYXRpb25DbGllbnRCYXNlLnByb3RvdHlwZSwgXCJ1bnJlc29sdmVkRGVwZW5kZW5jaWVzXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgYWdncmVnYXRlXG5dLCBDb21iaW5hdGlvbkNsaWVudEJhc2UucHJvdG90eXBlLCBcInN0YXRlXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgYWdncmVnYXRlXG5dLCBDb21iaW5hdGlvbkNsaWVudEJhc2UucHJvdG90eXBlLCBcInN0YXR1c1wiLCBudWxsKTtcbiIsImltcG9ydCB7UmVwbGF5U3ViamVjdCwgT2JzZXJ2YWJsZX0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSwgSURpc3Bvc2FibGV9IGZyb20gXCIuLi9kaXNwb3NhYmxlc1wiO1xuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHtEcml2ZXJTdGF0ZX0gZnJvbSBcIi4uL2VudW1zXCI7XG5pbXBvcnQge09tbmlzaGFycENsaWVudFN0YXR1c30gZnJvbSBcIi4uL2VudW1zXCI7XG5pbXBvcnQge1JlcXVlc3RDb250ZXh0LCBSZXNwb25zZUNvbnRleHQsIENvbW1hbmRDb250ZXh0fSBmcm9tIFwiLi4vY29udGV4dHNcIjtcbmltcG9ydCB7bWVyZ2UsIGFnZ3JlZ2F0ZX0gZnJvbSBcIi4uL2RlY29yYXRvcnNcIjtcbmltcG9ydCAqIGFzIE9tbmlTaGFycCBmcm9tIFwiLi4vb21uaXNoYXJwLXNlcnZlclwiO1xuXG5leHBvcnQgY2xhc3MgT2JzZXJ2YXRpb25DbGllbnRCYXNlPENsaWVudD4gaW1wbGVtZW50cyBPbW5pU2hhcnAuRXZlbnRzLCBJRGlzcG9zYWJsZSB7XG4gICAgcHJvdGVjdGVkIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBwcml2YXRlIF9jbGllbnREaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBwcm90ZWN0ZWQgX2NsaWVudHNTdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8Q2xpZW50W10+KDEpO1xuXG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgcHJvamVjdEFkZGVkKCk6IE9ic2VydmFibGU8T21uaVNoYXJwLk1vZGVscy5Qcm9qZWN0SW5mb3JtYXRpb25SZXNwb25zZT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAbWVyZ2UgcHVibGljIGdldCBwcm9qZWN0Q2hhbmdlZCgpOiBPYnNlcnZhYmxlPE9tbmlTaGFycC5Nb2RlbHMuUHJvamVjdEluZm9ybWF0aW9uUmVzcG9uc2U+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgcHJvamVjdFJlbW92ZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlByb2plY3RJbmZvcm1hdGlvblJlc3BvbnNlPiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEBtZXJnZSBwdWJsaWMgZ2V0IGVycm9yKCk6IE9ic2VydmFibGU8T21uaVNoYXJwLk1vZGVscy5FcnJvck1lc3NhZ2U+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgbXNCdWlsZFByb2plY3REaWFnbm9zdGljcygpOiBPYnNlcnZhYmxlPE9tbmlTaGFycC5Nb2RlbHMuTVNCdWlsZFByb2plY3REaWFnbm9zdGljcz4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAbWVyZ2UgcHVibGljIGdldCBwYWNrYWdlUmVzdG9yZVN0YXJ0ZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlBhY2thZ2VSZXN0b3JlTWVzc2FnZT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAbWVyZ2UgcHVibGljIGdldCBwYWNrYWdlUmVzdG9yZUZpbmlzaGVkKCk6IE9ic2VydmFibGU8T21uaVNoYXJwLk1vZGVscy5QYWNrYWdlUmVzdG9yZU1lc3NhZ2U+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgdW5yZXNvbHZlZERlcGVuZGVuY2llcygpOiBPYnNlcnZhYmxlPE9tbmlTaGFycC5Nb2RlbHMuVW5yZXNvbHZlZERlcGVuZGVuY2llc01lc3NhZ2U+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG5cbiAgICBAbWVyZ2UgcHVibGljIGdldCBldmVudHMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuRXZlbnRQYWNrZXQ+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgY29tbWFuZHMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuUmVzcG9uc2VQYWNrZXQ+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgc3RhdGUoKTogT2JzZXJ2YWJsZTxEcml2ZXJTdGF0ZT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAbWVyZ2UgcHVibGljIGdldCBzdGF0dXMoKTogT2JzZXJ2YWJsZTxPbW5pc2hhcnBDbGllbnRTdGF0dXM+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgcmVxdWVzdHMoKTogT2JzZXJ2YWJsZTxSZXF1ZXN0Q29udGV4dDxhbnk+PiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEBtZXJnZSBwdWJsaWMgZ2V0IHJlc3BvbnNlcygpOiBPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQG1lcmdlIHB1YmxpYyBnZXQgZXJyb3JzKCk6IE9ic2VydmFibGU8Q29tbWFuZENvbnRleHQ8YW55Pj4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2xpZW50czogQ2xpZW50W10gPSBbXSkge1xuICAgICAgICB0aGlzLm5leHQoKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQodGhpcy5fY2xpZW50RGlzcG9zYWJsZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9kaXNwb3NhYmxlLmlzRGlzcG9zZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG1ha2VNZXJnZU9ic2VyYWJsZSA9IDxUPihzZWxlY3RvcjogKGNsaWVudDogQ2xpZW50KSA9PiBPYnNlcnZhYmxlPFQ+KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jbGllbnRzU3ViamVjdC5zd2l0Y2hNYXAoY2xpZW50cyA9PiBPYnNlcnZhYmxlLm1lcmdlPFQ+KC4uLmNsaWVudHMubWFwKHNlbGVjdG9yKSkpLnNoYXJlKCk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBvYnNlcnZlPFQ+KHNlbGVjdG9yOiAoY2xpZW50OiBDbGllbnQpID0+IE9ic2VydmFibGU8VD4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWFrZU1lcmdlT2JzZXJhYmxlKHNlbGVjdG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG5leHQgPSAoKSA9PiB0aGlzLl9jbGllbnRzU3ViamVjdC5uZXh0KHRoaXMuY2xpZW50cy5zbGljZSgpKTtcblxuICAgIHB1YmxpYyBhZGQoY2xpZW50OiBDbGllbnQpIHtcbiAgICAgICAgdGhpcy5jbGllbnRzLnB1c2goY2xpZW50KTtcbiAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgIGNvbnN0IGQgPSBEaXNwb3NhYmxlLmNyZWF0ZSgoKSA9PiB7XG4gICAgICAgICAgICBfLnB1bGwodGhpcy5jbGllbnRzLCBjbGllbnQpO1xuICAgICAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9jbGllbnREaXNwb3NhYmxlLmFkZChkKTtcbiAgICAgICAgcmV0dXJuIGQ7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgQ29tYmluYXRpb25DbGllbnRCYXNlPENsaWVudCBleHRlbmRzIHsgdW5pcXVlSWQ6IHN0cmluZzsgfT4gaW1wbGVtZW50cyBPbW5pU2hhcnAuQWdncmVnYXRlLkV2ZW50cywgSURpc3Bvc2FibGUge1xuICAgIHByb3RlY3RlZCBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgcHJpdmF0ZSBfY2xpZW50RGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgcHVibGljIF9jbGllbnRzU3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PENsaWVudFtdPigxKTtcblxuICAgIEBhZ2dyZWdhdGUgcHVibGljIGdldCBwcm9qZWN0QWRkZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5Qcm9qZWN0SW5mb3JtYXRpb25SZXNwb25zZT5bXT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAYWdncmVnYXRlIHB1YmxpYyBnZXQgcHJvamVjdENoYW5nZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5Qcm9qZWN0SW5mb3JtYXRpb25SZXNwb25zZT5bXT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAYWdncmVnYXRlIHB1YmxpYyBnZXQgcHJvamVjdFJlbW92ZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5Qcm9qZWN0SW5mb3JtYXRpb25SZXNwb25zZT5bXT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAYWdncmVnYXRlIHB1YmxpYyBnZXQgZXJyb3IoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5FcnJvck1lc3NhZ2U+W10+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQGFnZ3JlZ2F0ZSBwdWJsaWMgZ2V0IG1zQnVpbGRQcm9qZWN0RGlhZ25vc3RpY3MoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5NU0J1aWxkUHJvamVjdERpYWdub3N0aWNzPltdPiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEBhZ2dyZWdhdGUgcHVibGljIGdldCBwYWNrYWdlUmVzdG9yZVN0YXJ0ZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5QYWNrYWdlUmVzdG9yZU1lc3NhZ2U+W10+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQGFnZ3JlZ2F0ZSBwdWJsaWMgZ2V0IHBhY2thZ2VSZXN0b3JlRmluaXNoZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5QYWNrYWdlUmVzdG9yZU1lc3NhZ2U+W10+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQGFnZ3JlZ2F0ZSBwdWJsaWMgZ2V0IHVucmVzb2x2ZWREZXBlbmRlbmNpZXMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuQ29tYmluYXRpb25LZXk8T21uaVNoYXJwLk1vZGVscy5VbnJlc29sdmVkRGVwZW5kZW5jaWVzTWVzc2FnZT5bXT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cblxuICAgIEBhZ2dyZWdhdGUgcHVibGljIGdldCBzdGF0ZSgpOiBPYnNlcnZhYmxlPE9tbmlTaGFycC5Db21iaW5hdGlvbktleTxEcml2ZXJTdGF0ZT5bXT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAYWdncmVnYXRlIHB1YmxpYyBnZXQgc3RhdHVzKCk6IE9ic2VydmFibGU8T21uaVNoYXJwLkNvbWJpbmF0aW9uS2V5PE9tbmlzaGFycENsaWVudFN0YXR1cz5bXT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2xpZW50czogQ2xpZW50W10gPSBbXSkge1xuICAgICAgICB0aGlzLm5leHQoKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQodGhpcy5fY2xpZW50RGlzcG9zYWJsZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9kaXNwb3NhYmxlLmlzRGlzcG9zZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG1ha2VBZ2dyZWdhdGVPYnNlcmFibGUgPSA8VD4oc2VsZWN0b3I6IChjbGllbnQ6IENsaWVudCkgPT4gT2JzZXJ2YWJsZTxUPikgPT4ge1xuXG4gICAgICAgIC8vIENhY2hlcyB0aGUgdmFsdWUsIHNvIHRoYXQgd2hlbiB0aGUgdW5kZXJseWluZyBjbGllbnRzIGNoYW5nZVxuICAgICAgICAvLyB3ZSBjYW4gc3RhcnQgd2l0aCB0aGUgb2xkIHZhbHVlIG9mIHRoZSByZW1haW5pbmcgY2xpZW50c1xuICAgICAgICBjb25zdCBjYWNoZTogeyBba2V5OiBzdHJpbmddOiBUIH0gPSB7fTtcblxuICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1zdHJpbmctbGl0ZXJhbCAqL1xuICAgICAgICByZXR1cm4gdGhpcy5fY2xpZW50c1N1YmplY3Quc3dpdGNoTWFwKGNsaWVudHMgPT4ge1xuICAgICAgICAgICAgLy8gY2xlYW4gdXAgYWZ0ZXIgb3Vyc2VsdmVzLlxuICAgICAgICAgICAgY29uc3QgcmVtb3ZhbCA9IF8uZGlmZmVyZW5jZShfLmtleXMoY2FjaGUpLCBjbGllbnRzLm1hcCh6ID0+IHoudW5pcXVlSWQpKTtcbiAgICAgICAgICAgIF8uZWFjaChyZW1vdmFsLCB6ID0+IGRlbGV0ZSBjYWNoZVt6XSk7XG5cbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNvbWJpbmVMYXRlc3QoXG4gICAgICAgICAgICAgICAgY2xpZW50cy5tYXAoeiA9PiBzZWxlY3Rvcih6KS5zdGFydFdpdGgoY2FjaGVbei51bmlxdWVJZF0pKSxcbiAgICAgICAgICAgICAgICAoLi4udmFsdWVzOiBUW10pID0+XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlcy5tYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVbY2xpZW50c1tpbmRleF0udW5pcXVlSWRdID0gdmFsdWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBjbGllbnRzW2luZGV4XS51bmlxdWVJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9KS5zaGFyZSgpO1xuICAgICAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLXN0cmluZy1saXRlcmFsICovXG5cbiAgICB9O1xuXG4gICAgcHVibGljIG9ic2VydmU8VD4oc2VsZWN0b3I6IChjbGllbnQ6IENsaWVudCkgPT4gT2JzZXJ2YWJsZTxUPikge1xuICAgICAgICByZXR1cm4gdGhpcy5tYWtlQWdncmVnYXRlT2JzZXJhYmxlKHNlbGVjdG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG5leHQgPSAoKSA9PiB0aGlzLl9jbGllbnRzU3ViamVjdC5uZXh0KHRoaXMuY2xpZW50cy5zbGljZSgpKTtcblxuICAgIHB1YmxpYyBhZGQoY2xpZW50OiBDbGllbnQpIHtcbiAgICAgICAgdGhpcy5jbGllbnRzLnB1c2goY2xpZW50KTtcbiAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgIGNvbnN0IGQgPSBEaXNwb3NhYmxlLmNyZWF0ZSgoKSA9PiB7XG4gICAgICAgICAgICBfLnB1bGwodGhpcy5jbGllbnRzLCBjbGllbnQpO1xuICAgICAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9jbGllbnREaXNwb3NhYmxlLmFkZChkKTtcbiAgICAgICAgcmV0dXJuIGQ7XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
