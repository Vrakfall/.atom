"use strict";
var enums_1 = require('../enums');
var lodash_1 = require('lodash');
var enums_2 = require('../enums');
var cp = require('child_process');
var readline = require('readline');
var ts_disposables_1 = require('ts-disposables');
var rxjs_1 = require('rxjs');
var runtime_1 = require('../helpers/runtime');
var spawn = cp.spawn;
if (process.platform === 'win32') {
    spawn = require('../windows/super-spawn').spawn;
}
var env = lodash_1.defaults({ ATOM_SHELL_INTERNAL_RUN_AS_NODE: '1' }, process.env);
var StdioDriver = (function () {
    function StdioDriver(_a) {
        var _this = this;
        var projectPath = _a.projectPath, serverPath = _a.serverPath, findProject = _a.findProject, logger = _a.logger, timeout = _a.timeout, additionalArguments = _a.additionalArguments, runtime = _a.runtime, plugins = _a.plugins, version = _a.version, onEvent = _a.onEvent, onState = _a.onState, onCommand = _a.onCommand;
        this._outstandingRequests = new Map();
        this._disposable = new ts_disposables_1.CompositeDisposable();
        this.currentState = enums_2.DriverState.Disconnected;
        this._projectPath = projectPath;
        this._findProject = findProject || false;
        this._logger = logger || console;
        this._serverPath = serverPath;
        this._timeout = (timeout || 60) * 1000;
        this._runtime = runtime || enums_1.Runtime.ClrOrMono;
        this._additionalArguments = additionalArguments || [];
        this._plugins = plugins || [];
        this._version = version;
        this._onEvent = onEvent || lodash_1.noop;
        this._onState = function (state) {
            if (state !== _this.currentState) {
                (onState || lodash_1.noop)(state);
                _this.currentState = state;
            }
        };
        this._onCommand = onCommand || lodash_1.noop;
        this._runtimeContext = this._getRuntimeContext();
        this._disposable.add(ts_disposables_1.Disposable.create(function () {
            if (_this._process) {
                _this._process.removeAllListeners();
            }
        }));
        this._disposable.add(ts_disposables_1.Disposable.create(function () {
            _this._outstandingRequests.clear();
        }));
    }
    StdioDriver.prototype._getRuntimeContext = function () {
        return new runtime_1.RuntimeContext({
            runtime: this.runtime,
            platform: process.platform,
            arch: process.arch,
            version: this._version || undefined
        }, this._logger);
    };
    StdioDriver.prototype.dispose = function () {
        if (this._disposable.isDisposed)
            return;
        this.disconnect();
        this._disposable.dispose();
    };
    Object.defineProperty(StdioDriver.prototype, "serverPath", {
        get: function () {
            if (this._serverPath) {
                return this._serverPath;
            }
            return this._runtimeContext.location;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StdioDriver.prototype, "projectPath", {
        get: function () { return this._projectPath; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StdioDriver.prototype, "runtime", {
        get: function () { return this._runtime; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StdioDriver.prototype, "outstandingRequests", {
        get: function () { return this._outstandingRequests.size; },
        enumerable: true,
        configurable: true
    });
    StdioDriver.prototype.connect = function () {
        var _this = this;
        if (this._disposable.isDisposed)
            throw new Error('Driver is disposed');
        this._ensureRuntimeExists()
            .then(function () { return _this._connect(); });
        /*
        Enable once we can push a new build again
        this._disposable.add(this._ensureBootstrapExists()
            .subscribe((path) => this._serverPath = path, null, () => this._connect()));
        */
    };
    StdioDriver.prototype._connect = function () {
        var _this = this;
        this._seq = 1;
        this._outstandingRequests.clear();
        this._onState(enums_2.DriverState.Connecting);
        var path = this.serverPath;
        this._logger.log("Connecting to child @ " + process.execPath);
        this._logger.log("Path to server: " + path);
        this._logger.log("Selected project: " + this._projectPath);
        env.PATH = this._PATH || env.PATH;
        var serverArguments = ['--stdio', '--zero-based-indices', '-s', this._projectPath, '--hostPID', process.pid].concat(this._additionalArguments || []);
        if (lodash_1.startsWith(path, 'mono ')) {
            serverArguments.unshift(path.substr(5));
            path = 'mono';
        }
        this._logger.log("Arguments: " + serverArguments);
        this._process = spawn(path, serverArguments, { env: env });
        if (!this._process.pid) {
            this.serverErr('failed to connect to connect to server');
            return;
        }
        this._process.stderr.on('data', function (data) { return _this._logger.error(data.toString()); });
        this._process.stderr.on('data', function (data) { return _this.serverErr(data); });
        var rl = readline.createInterface({
            input: this._process.stdout,
            output: undefined
        });
        rl.on('line', function (data) { return _this.handleData(data); });
        this.id = this._process.pid.toString();
        this._process.on('error', function (data) { return _this.serverErr(data); });
        this._process.on('close', function () { return _this.disconnect(); });
        this._process.on('exit', function () { return _this.disconnect(); });
        this._process.on('disconnect', function () { return _this.disconnect(); });
    };
    StdioDriver.prototype._ensureRuntimeExists = function () {
        var _this = this;
        this._onState(enums_2.DriverState.Downloading);
        return runtime_1.isSupportedRuntime(this._runtimeContext)
            .toPromise()
            .then(function (ctx) {
            _this._runtime = ctx.runtime;
            _this._PATH = ctx.path;
            _this._runtimeContext = _this._getRuntimeContext();
            return ctx;
        })
            .then(function (runtime) {
            return _this._runtimeContext.downloadRuntimeIfMissing()
                .toPromise()
                .then(function () { _this._onState(enums_2.DriverState.Downloaded); });
        });
    };
    /*private _ensureBootstrapExists() {
        return this._ensureRuntimeExists()
            .flatMap(() => getPluginPath(this._projectPath, this._runtime, process, this._plugins, this._logger));
    }*/
    StdioDriver.prototype.updatePlugins = function (plugins) {
        this._plugins = plugins;
        this.disconnect();
        this.connect();
    };
    StdioDriver.prototype.serverErr = function (data) {
        var friendlyMessage = this.parseError(data);
        this._onState(enums_2.DriverState.Error);
        this._process = null;
        this._onEvent({
            Type: 'error',
            Event: 'error',
            Seq: -1,
            Body: {
                Message: friendlyMessage
            }
        });
    };
    StdioDriver.prototype.parseError = function (data) {
        var message = data.toString();
        if (data.code === 'ENOENT' && data.path === 'mono') {
            message = 'mono could not be found, please ensure it is installed and in your path';
        }
        return message;
    };
    StdioDriver.prototype.disconnect = function () {
        if (this._process != null && this._process.pid) {
            this._process.kill('SIGTERM');
        }
        this._process = null;
        this._onState(enums_2.DriverState.Disconnected);
    };
    StdioDriver.prototype.request = function (command, request) {
        if (!this._process) {
            return rxjs_1.Observable.throw(new Error('Server is not connected, erroring out'));
        }
        var sequence = this._seq++;
        var packet = {
            Command: lodash_1.trimStart(command, '/'),
            Seq: sequence,
            Arguments: request
        };
        var subject = new rxjs_1.AsyncSubject();
        var response = subject
            .asObservable()
            .timeout(this._timeout, rxjs_1.Observable.throw('Request timed out'));
        // Doing a little bit of tickery here
        // Going to return this Observable, as if it were promise like.
        // And we will only commit to the promise once someone calls then on it.
        // This way another client, can cast the result to an observable, and gain cancelation
        var promiseLike = response;
        promiseLike.then = (function (fulfilled, rejected) {
            return response.toPromise().then(fulfilled, rejected);
        });
        this._outstandingRequests.set(sequence, subject);
        this._process.stdin.write(JSON.stringify(packet) + '\n', 'utf8');
        return promiseLike;
    };
    StdioDriver.prototype.handleData = function (data) {
        var packet;
        try {
            packet = JSON.parse(data.trim());
        }
        catch (_error) {
            this.handleNonPacket(data);
        }
        if (packet) {
            this.handlePacket(packet);
        }
    };
    StdioDriver.prototype.handlePacket = function (packet) {
        if (packet.Type === 'response') {
            this.handlePacketResponse(packet);
        }
        else if (packet.Type === 'event') {
            this.handlePacketEvent(packet);
        }
    };
    StdioDriver.prototype.handlePacketResponse = function (response) {
        if (this._outstandingRequests.has(response.Request_seq)) {
            var observer = this._outstandingRequests.get(response.Request_seq);
            this._outstandingRequests.delete(response.Request_seq);
            if (observer.closed)
                return;
            if (response.Success) {
                observer.next(response.Body);
                observer.complete();
            }
            else {
                observer.error(response.Message);
            }
        }
        else {
            if (response.Success) {
                this._onCommand(response);
            }
            else {
            }
        }
    };
    StdioDriver.prototype.handlePacketEvent = function (event) {
        this._onEvent(event);
        if (event.Event === 'started') {
            this._onState(enums_2.DriverState.Connected);
        }
    };
    StdioDriver.prototype.handleNonPacket = function (data) {
        var s = data.toString();
        this._onEvent({
            Type: 'unknown',
            Event: 'unknown',
            Seq: -1,
            Body: {
                Message: s
            }
        });
        var ref = s.match(/Detected an OmniSharp instance already running on port/);
        if ((ref != null ? ref.length : 0) > 0) {
            this.disconnect();
        }
    };
    return StdioDriver;
}());
exports.StdioDriver = StdioDriver;

//# sourceMappingURL=data:application/json;base64,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QUFLLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxtQkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pDLENBQUM7SUFDTCxDQUFDO0lBRU8scUNBQWUsR0FBdkIsVUFBd0IsSUFBUztRQUM3QixJQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUNWLElBQUksRUFBRSxTQUFTO1lBQ2YsS0FBSyxFQUFFLFNBQVM7WUFDaEIsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNQLElBQUksRUFBRTtnQkFDRixPQUFPLEVBQUUsQ0FBQzthQUNiO1NBQ0osQ0FBQyxDQUFDO1FBRUgsSUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO1FBQzlFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3RCLENBQUM7SUFDTCxDQUFDO0lBQ0wsa0JBQUM7QUFBRCxDQXhTQSxBQXdTQyxJQUFBO0FBeFNZLG1CQUFXLGNBd1N2QixDQUFBIiwiZmlsZSI6ImxpYi9kcml2ZXJzL3N0ZGlvLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgT21uaVNoYXJwIGZyb20gJy4uL29tbmlzaGFycC1zZXJ2ZXInO1xuaW1wb3J0IHsgSURyaXZlciwgSURyaXZlck9wdGlvbnMsIElMb2dnZXIsIFJ1bnRpbWUsIElPbW5pc2hhcnBQbHVnaW4gfSBmcm9tICcuLi9lbnVtcyc7XG5pbXBvcnQgeyBkZWZhdWx0cywgc3RhcnRzV2l0aCwgbm9vcCwgdHJpbVN0YXJ0IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IERyaXZlclN0YXRlIH0gZnJvbSAnLi4vZW51bXMnO1xuaW1wb3J0ICogYXMgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgKiBhcyByZWFkbGluZSBmcm9tICdyZWFkbGluZSc7XG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBEaXNwb3NhYmxlIH0gZnJvbSAndHMtZGlzcG9zYWJsZXMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQXN5bmNTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBSdW50aW1lQ29udGV4dCwgaXNTdXBwb3J0ZWRSdW50aW1lIH0gZnJvbSAnLi4vaGVscGVycy9ydW50aW1lJztcblxubGV0IHNwYXduID0gY3Auc3Bhd247XG5pZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICAgIHNwYXduID0gcmVxdWlyZSgnLi4vd2luZG93cy9zdXBlci1zcGF3bicpLnNwYXduO1xufVxuXG5sZXQgZW52OiBhbnkgPSBkZWZhdWx0cyh7IEFUT01fU0hFTExfSU5URVJOQUxfUlVOX0FTX05PREU6ICcxJyB9LCBwcm9jZXNzLmVudik7XG5leHBvcnQgY2xhc3MgU3RkaW9Ecml2ZXIgaW1wbGVtZW50cyBJRHJpdmVyIHtcbiAgICBwcml2YXRlIF9zZXE6IG51bWJlcjtcbiAgICBwcml2YXRlIF9wcm9jZXNzOiBjcC5DaGlsZFByb2Nlc3MgfCBudWxsO1xuICAgIHByaXZhdGUgX291dHN0YW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwPG51bWJlciwgQXN5bmNTdWJqZWN0PGFueT4+KCk7XG4gICAgcHJpdmF0ZSBfcHJvamVjdFBhdGg6IHN0cmluZztcbiAgICBwcml2YXRlIF9hZGRpdGlvbmFsQXJndW1lbnRzOiBzdHJpbmdbXTtcbiAgICBwcml2YXRlIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBwcml2YXRlIF9wbHVnaW5zOiBJT21uaXNoYXJwUGx1Z2luW107XG4gICAgcHJpdmF0ZSBfc2VydmVyUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgcHJpdmF0ZSBfZmluZFByb2plY3Q6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfbG9nZ2VyOiBJTG9nZ2VyO1xuICAgIHByaXZhdGUgX3RpbWVvdXQ6IG51bWJlcjtcbiAgICBwcml2YXRlIF9ydW50aW1lOiBSdW50aW1lO1xuICAgIHByaXZhdGUgX3ZlcnNpb246IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwcml2YXRlIF9QQVRIOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfcnVudGltZUNvbnRleHQ6IFJ1bnRpbWVDb250ZXh0O1xuICAgIHB1YmxpYyBpZDogc3RyaW5nO1xuXG5cbiAgICBwcml2YXRlIF9vbkV2ZW50OiAoZXZlbnQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIF9vbkNvbW1hbmQ6IChldmVudDogT21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLlJlc3BvbnNlUGFja2V0KSA9PiB2b2lkO1xuICAgIHByaXZhdGUgX29uU3RhdGU6IChzdGF0ZTogRHJpdmVyU3RhdGUpID0+IHZvaWQ7XG5cbiAgICBwdWJsaWMgY3VycmVudFN0YXRlOiBEcml2ZXJTdGF0ZSA9IERyaXZlclN0YXRlLkRpc2Nvbm5lY3RlZDtcblxuICAgIGNvbnN0cnVjdG9yKHtwcm9qZWN0UGF0aCwgc2VydmVyUGF0aCwgZmluZFByb2plY3QsIGxvZ2dlciwgdGltZW91dCwgYWRkaXRpb25hbEFyZ3VtZW50cywgcnVudGltZSwgcGx1Z2lucywgdmVyc2lvbiwgb25FdmVudCwgb25TdGF0ZSwgb25Db21tYW5kfTogSURyaXZlck9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5fcHJvamVjdFBhdGggPSBwcm9qZWN0UGF0aDtcbiAgICAgICAgdGhpcy5fZmluZFByb2plY3QgPSBmaW5kUHJvamVjdCB8fCBmYWxzZTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyIHx8IGNvbnNvbGU7XG4gICAgICAgIHRoaXMuX3NlcnZlclBhdGggPSBzZXJ2ZXJQYXRoO1xuICAgICAgICB0aGlzLl90aW1lb3V0ID0gKHRpbWVvdXQgfHwgNjApICogMTAwMDtcbiAgICAgICAgdGhpcy5fcnVudGltZSA9IHJ1bnRpbWUgfHwgUnVudGltZS5DbHJPck1vbm87XG4gICAgICAgIHRoaXMuX2FkZGl0aW9uYWxBcmd1bWVudHMgPSBhZGRpdGlvbmFsQXJndW1lbnRzIHx8IFtdO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0gcGx1Z2lucyB8fCBbXTtcbiAgICAgICAgdGhpcy5fdmVyc2lvbiA9IHZlcnNpb247XG4gICAgICAgIHRoaXMuX29uRXZlbnQgPSBvbkV2ZW50IHx8IG5vb3A7XG4gICAgICAgIHRoaXMuX29uU3RhdGUgPSAoc3RhdGUpID0+IHtcbiAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gdGhpcy5jdXJyZW50U3RhdGUpIHtcbiAgICAgICAgICAgICAgICAob25TdGF0ZSB8fCBub29wKShzdGF0ZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fb25Db21tYW5kID0gb25Db21tYW5kIHx8IG5vb3A7XG5cbiAgICAgICAgdGhpcy5fcnVudGltZUNvbnRleHQgPSB0aGlzLl9nZXRSdW50aW1lQ29udGV4dCgpO1xuXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKERpc3Bvc2FibGUuY3JlYXRlKCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9wcm9jZXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKERpc3Bvc2FibGUuY3JlYXRlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuY2xlYXIoKTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFJ1bnRpbWVDb250ZXh0KCkge1xuICAgICAgICByZXR1cm4gbmV3IFJ1bnRpbWVDb250ZXh0KHtcbiAgICAgICAgICAgIHJ1bnRpbWU6IHRoaXMucnVudGltZSxcbiAgICAgICAgICAgIHBsYXRmb3JtOiBwcm9jZXNzLnBsYXRmb3JtLFxuICAgICAgICAgICAgYXJjaDogcHJvY2Vzcy5hcmNoLFxuICAgICAgICAgICAgdmVyc2lvbjogdGhpcy5fdmVyc2lvbiB8fCB1bmRlZmluZWRcbiAgICAgICAgfSwgdGhpcy5fbG9nZ2VyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGlzcG9zZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Rpc3Bvc2FibGUuaXNEaXNwb3NlZCkgcmV0dXJuO1xuICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzZXJ2ZXJQYXRoKCkge1xuICAgICAgICBpZiAodGhpcy5fc2VydmVyUGF0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NlcnZlclBhdGg7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX3J1bnRpbWVDb250ZXh0LmxvY2F0aW9uO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcHJvamVjdFBhdGgoKSB7IHJldHVybiB0aGlzLl9wcm9qZWN0UGF0aDsgfVxuICAgIHB1YmxpYyBnZXQgcnVudGltZSgpIHsgcmV0dXJuIHRoaXMuX3J1bnRpbWU7IH1cbiAgICBwdWJsaWMgZ2V0IG91dHN0YW5kaW5nUmVxdWVzdHMoKSB7IHJldHVybiB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLnNpemU7IH1cblxuICAgIHB1YmxpYyBjb25uZWN0KCkge1xuICAgICAgICBpZiAodGhpcy5fZGlzcG9zYWJsZS5pc0Rpc3Bvc2VkKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEcml2ZXIgaXMgZGlzcG9zZWQnKTtcblxuICAgICAgICB0aGlzLl9lbnN1cmVSdW50aW1lRXhpc3RzKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuX2Nvbm5lY3QoKSk7XG4gICAgICAgIC8qXG4gICAgICAgIEVuYWJsZSBvbmNlIHdlIGNhbiBwdXNoIGEgbmV3IGJ1aWxkIGFnYWluXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKHRoaXMuX2Vuc3VyZUJvb3RzdHJhcEV4aXN0cygpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChwYXRoKSA9PiB0aGlzLl9zZXJ2ZXJQYXRoID0gcGF0aCwgbnVsbCwgKCkgPT4gdGhpcy5fY29ubmVjdCgpKSk7XG4gICAgICAgICovXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY29ubmVjdCgpIHtcbiAgICAgICAgdGhpcy5fc2VxID0gMTtcbiAgICAgICAgdGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5jbGVhcigpO1xuICAgICAgICB0aGlzLl9vblN0YXRlKERyaXZlclN0YXRlLkNvbm5lY3RpbmcpO1xuXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5zZXJ2ZXJQYXRoO1xuXG4gICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYENvbm5lY3RpbmcgdG8gY2hpbGQgQCAke3Byb2Nlc3MuZXhlY1BhdGh9YCk7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYFBhdGggdG8gc2VydmVyOiAke3BhdGh9YCk7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYFNlbGVjdGVkIHByb2plY3Q6ICR7dGhpcy5fcHJvamVjdFBhdGh9YCk7XG5cbiAgICAgICAgZW52LlBBVEggPSB0aGlzLl9QQVRIIHx8IGVudi5QQVRIO1xuXG4gICAgICAgIGNvbnN0IHNlcnZlckFyZ3VtZW50czogYW55W10gPSBbJy0tc3RkaW8nLCAnLS16ZXJvLWJhc2VkLWluZGljZXMnLCAnLXMnLCB0aGlzLl9wcm9qZWN0UGF0aCwgJy0taG9zdFBJRCcsIHByb2Nlc3MucGlkXS5jb25jYXQodGhpcy5fYWRkaXRpb25hbEFyZ3VtZW50cyB8fCBbXSk7XG5cbiAgICAgICAgaWYgKHN0YXJ0c1dpdGgocGF0aCwgJ21vbm8gJykpIHtcbiAgICAgICAgICAgIHNlcnZlckFyZ3VtZW50cy51bnNoaWZ0KHBhdGguc3Vic3RyKDUpKTtcbiAgICAgICAgICAgIHBhdGggPSAnbW9ubyc7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9sb2dnZXIubG9nKGBBcmd1bWVudHM6ICR7c2VydmVyQXJndW1lbnRzfWApO1xuICAgICAgICB0aGlzLl9wcm9jZXNzID0gc3Bhd24ocGF0aCwgc2VydmVyQXJndW1lbnRzLCB7IGVudiB9KTtcblxuICAgICAgICBpZiAoIXRoaXMuX3Byb2Nlc3MucGlkKSB7XG4gICAgICAgICAgICB0aGlzLnNlcnZlckVycignZmFpbGVkIHRvIGNvbm5lY3QgdG8gY29ubmVjdCB0byBzZXJ2ZXInKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3Byb2Nlc3Muc3RkZXJyLm9uKCdkYXRhJywgKGRhdGE6IGFueSkgPT4gdGhpcy5fbG9nZ2VyLmVycm9yKGRhdGEudG9TdHJpbmcoKSkpO1xuICAgICAgICB0aGlzLl9wcm9jZXNzLnN0ZGVyci5vbignZGF0YScsIChkYXRhOiBhbnkpID0+IHRoaXMuc2VydmVyRXJyKGRhdGEpKTtcblxuICAgICAgICBjb25zdCBybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSh7XG4gICAgICAgICAgICBpbnB1dDogdGhpcy5fcHJvY2Vzcy5zdGRvdXQsXG4gICAgICAgICAgICBvdXRwdXQ6IHVuZGVmaW5lZFxuICAgICAgICB9KTtcblxuICAgICAgICBybC5vbignbGluZScsIChkYXRhOiBhbnkpID0+IHRoaXMuaGFuZGxlRGF0YShkYXRhKSk7XG5cbiAgICAgICAgdGhpcy5pZCA9IHRoaXMuX3Byb2Nlc3MucGlkLnRvU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3Mub24oJ2Vycm9yJywgKGRhdGE6IGFueSkgPT4gdGhpcy5zZXJ2ZXJFcnIoZGF0YSkpO1xuICAgICAgICB0aGlzLl9wcm9jZXNzLm9uKCdjbG9zZScsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5vbignZXhpdCcsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5vbignZGlzY29ubmVjdCcsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9lbnN1cmVSdW50aW1lRXhpc3RzKCkge1xuICAgICAgICB0aGlzLl9vblN0YXRlKERyaXZlclN0YXRlLkRvd25sb2FkaW5nKTtcbiAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkUnVudGltZSh0aGlzLl9ydW50aW1lQ29udGV4dClcbiAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgLnRoZW4oKGN0eCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX3J1bnRpbWUgPSBjdHgucnVudGltZTtcbiAgICAgICAgICAgICAgICB0aGlzLl9QQVRIID0gY3R4LnBhdGg7XG4gICAgICAgICAgICAgICAgdGhpcy5fcnVudGltZUNvbnRleHQgPSB0aGlzLl9nZXRSdW50aW1lQ29udGV4dCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBjdHg7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKHJ1bnRpbWUpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5fcnVudGltZUNvbnRleHQuZG93bmxvYWRSdW50aW1lSWZNaXNzaW5nKClcbiAgICAgICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHsgdGhpcy5fb25TdGF0ZShEcml2ZXJTdGF0ZS5Eb3dubG9hZGVkKTsgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLypwcml2YXRlIF9lbnN1cmVCb290c3RyYXBFeGlzdHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnN1cmVSdW50aW1lRXhpc3RzKClcbiAgICAgICAgICAgIC5mbGF0TWFwKCgpID0+IGdldFBsdWdpblBhdGgodGhpcy5fcHJvamVjdFBhdGgsIHRoaXMuX3J1bnRpbWUsIHByb2Nlc3MsIHRoaXMuX3BsdWdpbnMsIHRoaXMuX2xvZ2dlcikpO1xuICAgIH0qL1xuXG4gICAgcHVibGljIHVwZGF0ZVBsdWdpbnMocGx1Z2luczogSU9tbmlzaGFycFBsdWdpbltdKSB7XG4gICAgICAgIHRoaXMuX3BsdWdpbnMgPSBwbHVnaW5zO1xuICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgdGhpcy5jb25uZWN0KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXJ2ZXJFcnIoZGF0YTogYW55KSB7XG4gICAgICAgIGNvbnN0IGZyaWVuZGx5TWVzc2FnZSA9IHRoaXMucGFyc2VFcnJvcihkYXRhKTtcbiAgICAgICAgdGhpcy5fb25TdGF0ZShEcml2ZXJTdGF0ZS5FcnJvcik7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuXG4gICAgICAgIHRoaXMuX29uRXZlbnQoe1xuICAgICAgICAgICAgVHlwZTogJ2Vycm9yJyxcbiAgICAgICAgICAgIEV2ZW50OiAnZXJyb3InLFxuICAgICAgICAgICAgU2VxOiAtMSxcbiAgICAgICAgICAgIEJvZHk6IHtcbiAgICAgICAgICAgICAgICBNZXNzYWdlOiBmcmllbmRseU1lc3NhZ2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUVycm9yKGRhdGE6IGFueSkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgaWYgKGRhdGEuY29kZSA9PT0gJ0VOT0VOVCcgJiYgZGF0YS5wYXRoID09PSAnbW9ubycpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSAnbW9ubyBjb3VsZCBub3QgYmUgZm91bmQsIHBsZWFzZSBlbnN1cmUgaXQgaXMgaW5zdGFsbGVkIGFuZCBpbiB5b3VyIHBhdGgnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtZXNzYWdlO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNjb25uZWN0KCkge1xuICAgICAgICBpZiAodGhpcy5fcHJvY2VzcyAhPSBudWxsICYmIHRoaXMuX3Byb2Nlc3MucGlkKSB7XG4gICAgICAgICAgICB0aGlzLl9wcm9jZXNzLmtpbGwoJ1NJR1RFUk0nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICAgICAgdGhpcy5fb25TdGF0ZShEcml2ZXJTdGF0ZS5EaXNjb25uZWN0ZWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZXF1ZXN0PFRSZXF1ZXN0LCBUUmVzcG9uc2U+KGNvbW1hbmQ6IHN0cmluZywgcmVxdWVzdD86IFRSZXF1ZXN0KTogUHJvbWlzZUxpa2U8VFJlc3BvbnNlPiB7XG4gICAgICAgIGlmICghdGhpcy5fcHJvY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuIDxhbnk+T2JzZXJ2YWJsZS50aHJvdzxhbnk+KG5ldyBFcnJvcignU2VydmVyIGlzIG5vdCBjb25uZWN0ZWQsIGVycm9yaW5nIG91dCcpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNlcXVlbmNlID0gdGhpcy5fc2VxKys7XG4gICAgICAgIGNvbnN0IHBhY2tldDogT21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLlJlcXVlc3RQYWNrZXQgPSB7XG4gICAgICAgICAgICBDb21tYW5kOiB0cmltU3RhcnQoY29tbWFuZCwgJy8nKSxcbiAgICAgICAgICAgIFNlcTogc2VxdWVuY2UsXG4gICAgICAgICAgICBBcmd1bWVudHM6IHJlcXVlc3RcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzdWJqZWN0ID0gbmV3IEFzeW5jU3ViamVjdDxUUmVzcG9uc2U+KCk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gc3ViamVjdFxuICAgICAgICAgICAgLmFzT2JzZXJ2YWJsZSgpXG4gICAgICAgICAgICAudGltZW91dCh0aGlzLl90aW1lb3V0LCBPYnNlcnZhYmxlLnRocm93PGFueT4oJ1JlcXVlc3QgdGltZWQgb3V0JykpO1xuXG4gICAgICAgIC8vIERvaW5nIGEgbGl0dGxlIGJpdCBvZiB0aWNrZXJ5IGhlcmVcbiAgICAgICAgLy8gR29pbmcgdG8gcmV0dXJuIHRoaXMgT2JzZXJ2YWJsZSwgYXMgaWYgaXQgd2VyZSBwcm9taXNlIGxpa2UuXG4gICAgICAgIC8vIEFuZCB3ZSB3aWxsIG9ubHkgY29tbWl0IHRvIHRoZSBwcm9taXNlIG9uY2Ugc29tZW9uZSBjYWxscyB0aGVuIG9uIGl0LlxuICAgICAgICAvLyBUaGlzIHdheSBhbm90aGVyIGNsaWVudCwgY2FuIGNhc3QgdGhlIHJlc3VsdCB0byBhbiBvYnNlcnZhYmxlLCBhbmQgZ2FpbiBjYW5jZWxhdGlvblxuICAgICAgICBjb25zdCBwcm9taXNlTGlrZTogUHJvbWlzZUxpa2U8VFJlc3BvbnNlPiA9IDxhbnk+cmVzcG9uc2U7XG4gICAgICAgIHByb21pc2VMaWtlLnRoZW4gPSA8YW55PigoZnVsZmlsbGVkOiBGdW5jdGlvbiwgcmVqZWN0ZWQ6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UudG9Qcm9taXNlKCkudGhlbig8YW55PmZ1bGZpbGxlZCwgPGFueT5yZWplY3RlZCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuc2V0KHNlcXVlbmNlLCBzdWJqZWN0KTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5zdGRpbi53cml0ZShKU09OLnN0cmluZ2lmeShwYWNrZXQpICsgJ1xcbicsICd1dGY4Jyk7XG4gICAgICAgIHJldHVybiBwcm9taXNlTGlrZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZURhdGEoZGF0YTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBwYWNrZXQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5QYWNrZXQgfCB1bmRlZmluZWQ7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBwYWNrZXQgPSBKU09OLnBhcnNlKGRhdGEudHJpbSgpKTtcbiAgICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZU5vblBhY2tldChkYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYWNrZXQpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlUGFja2V0KHBhY2tldCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVBhY2tldChwYWNrZXQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5QYWNrZXQpIHtcbiAgICAgICAgaWYgKHBhY2tldC5UeXBlID09PSAncmVzcG9uc2UnKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZVBhY2tldFJlc3BvbnNlKDxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuUmVzcG9uc2VQYWNrZXQ+cGFja2V0KTtcbiAgICAgICAgfSBlbHNlIGlmIChwYWNrZXQuVHlwZSA9PT0gJ2V2ZW50Jykge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVQYWNrZXRFdmVudCg8T21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLkV2ZW50UGFja2V0PnBhY2tldCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVBhY2tldFJlc3BvbnNlKHJlc3BvbnNlOiBPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuUmVzcG9uc2VQYWNrZXQpIHtcbiAgICAgICAgaWYgKHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuaGFzKHJlc3BvbnNlLlJlcXVlc3Rfc2VxKSkge1xuICAgICAgICAgICAgY29uc3Qgb2JzZXJ2ZXIgPSB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLmdldChyZXNwb25zZS5SZXF1ZXN0X3NlcSkgITtcbiAgICAgICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuZGVsZXRlKHJlc3BvbnNlLlJlcXVlc3Rfc2VxKTtcbiAgICAgICAgICAgIGlmICgoPGFueT5vYnNlcnZlcikuY2xvc2VkKSByZXR1cm47XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuU3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzcG9uc2UuQm9keSk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IocmVzcG9uc2UuTWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuU3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIHRoaXMuX29uQ29tbWFuZChyZXNwb25zZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFRPRE86IG1ha2Ugbm90aWZpY2F0aW9uP1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVQYWNrZXRFdmVudChldmVudDogT21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLkV2ZW50UGFja2V0KSB7XG4gICAgICAgIHRoaXMuX29uRXZlbnQoZXZlbnQpO1xuICAgICAgICBpZiAoZXZlbnQuRXZlbnQgPT09ICdzdGFydGVkJykge1xuICAgICAgICAgICAgdGhpcy5fb25TdGF0ZShEcml2ZXJTdGF0ZS5Db25uZWN0ZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVOb25QYWNrZXQoZGF0YTogYW55KSB7XG4gICAgICAgIGNvbnN0IHMgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuX29uRXZlbnQoe1xuICAgICAgICAgICAgVHlwZTogJ3Vua25vd24nLFxuICAgICAgICAgICAgRXZlbnQ6ICd1bmtub3duJyxcbiAgICAgICAgICAgIFNlcTogLTEsXG4gICAgICAgICAgICBCb2R5OiB7XG4gICAgICAgICAgICAgICAgTWVzc2FnZTogc1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCByZWYgPSBzLm1hdGNoKC9EZXRlY3RlZCBhbiBPbW5pU2hhcnAgaW5zdGFuY2UgYWxyZWFkeSBydW5uaW5nIG9uIHBvcnQvKTtcbiAgICAgICAgaWYgKChyZWYgIT0gbnVsbCA/IHJlZi5sZW5ndGggOiAwKSA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
