"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.StdioDriver = undefined;

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _enums = require("../enums");

var _lodash = require("lodash");

var _child_process = require("child_process");

var _child_process2 = _interopRequireDefault(_child_process);

var _readline = require("readline");

var readline = _interopRequireWildcard(_readline);

var _disposables = require("../disposables");

var _rxjs = require("rxjs");

var _runtime = require("../helpers/runtime");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var spawn = _child_process2.default.spawn;
if (process.platform === "win32") {
    spawn = require("../windows/super-spawn").spawn;
}
var env = (0, _lodash.defaults)({ ATOM_SHELL_INTERNAL_RUN_AS_NODE: "1" }, process.env);

var StdioDriver = function () {
    function StdioDriver(_ref) {
        var _this = this;

        var projectPath = _ref.projectPath;
        var serverPath = _ref.serverPath;
        var findProject = _ref.findProject;
        var logger = _ref.logger;
        var timeout = _ref.timeout;
        var additionalArguments = _ref.additionalArguments;
        var runtime = _ref.runtime;
        var plugins = _ref.plugins;
        var version = _ref.version;

        _classCallCheck(this, StdioDriver);

        this._outstandingRequests = new Map();
        this._disposable = new _disposables.CompositeDisposable();
        this._currentState = _enums.DriverState.Disconnected;
        this._commandStream = new _rxjs.Subject();
        this._eventStream = new _rxjs.Subject();
        this._connectionStream = new _rxjs.Subject();
        this._projectPath = projectPath;
        this._findProject = findProject || false;
        this._connectionStream.subscribe(function (state) {
            return _this.currentState = state;
        });
        this._logger = logger || console;
        this._serverPath = serverPath;
        this._timeout = (timeout || 60) * 1000;
        this._runtime = runtime || _enums.Runtime.ClrOrMono;
        this._additionalArguments = additionalArguments;
        this._plugins = plugins;
        this._version = version;
        this._runtimeContext = this._getRuntimeContext();
        this._disposable.add(_disposables.Disposable.create(function () {
            if (_this._process) {
                _this._process.removeAllListeners();
            }
        }));
        this._disposable.add(_disposables.Disposable.create(function () {
            var iterator = _this._outstandingRequests.entries();
            var iteratee = iterator.next();
            while (!iteratee.done) {
                var _iteratee$value = _slicedToArray(iteratee.value, 2);

                var key = _iteratee$value[0];
                var disposable = _iteratee$value[1];

                _this._outstandingRequests.delete(key);
                disposable.unsubscribe();
                iteratee = iterator.next();
            }
            _this._outstandingRequests.clear();
        }));
    }

    _createClass(StdioDriver, [{
        key: "_getRuntimeContext",
        value: function _getRuntimeContext() {
            return new _runtime.RuntimeContext({
                runtime: this.runtime,
                platform: process.platform,
                arch: process.arch,
                version: this._version || undefined
            }, this._logger);
        }
    }, {
        key: "dispose",
        value: function dispose() {
            if (this._disposable.isDisposed) return;
            this.disconnect();
            this._disposable.dispose();
        }
    }, {
        key: "connect",
        value: function connect() {
            var _this2 = this;

            if (this._disposable.isDisposed) throw new Error("Driver is disposed");
            this._ensureRuntimeExists().subscribe({ complete: function complete() {
                    return _this2._connect();
                } });
        }
    }, {
        key: "_connect",
        value: function _connect() {
            var _this3 = this;

            this._seq = 1;
            this._outstandingRequests.clear();
            this._connectionStream.next(_enums.DriverState.Connecting);
            var path = this.serverPath;
            this._logger.log("Connecting to child @ " + process.execPath);
            this._logger.log("Path to server: " + path);
            this._logger.log("Selected project: " + this._projectPath);
            env.PATH = this._PATH || env.PATH;
            var serverArguments = ["--stdio", "-s", this._projectPath, "--hostPID", process.pid].concat(this._additionalArguments || []);
            if ((0, _lodash.startsWith)(path, "mono ")) {
                serverArguments.unshift(path.substr(5));
                path = "mono";
            }
            this._logger.log("Arguments: " + serverArguments);
            this._process = spawn(path, serverArguments, { env: env });
            if (!this._process.pid) {
                this.serverErr("failed to connect to connect to server");
                return;
            }
            this._process.stderr.on("data", function (data) {
                return _this3._logger.error(data.toString());
            });
            this._process.stderr.on("data", function (data) {
                return _this3.serverErr(data);
            });
            var rl = readline.createInterface({
                input: this._process.stdout,
                output: undefined
            });
            rl.on("line", function (data) {
                return _this3.handleData(data);
            });
            this.id = this._process.pid.toString();
            this._process.on("error", function (data) {
                return _this3.serverErr(data);
            });
            this._process.on("close", function () {
                return _this3.disconnect();
            });
            this._process.on("exit", function () {
                return _this3.disconnect();
            });
            this._process.on("disconnect", function () {
                return _this3.disconnect();
            });
        }
    }, {
        key: "_ensureRuntimeExists",
        value: function _ensureRuntimeExists() {
            var _this4 = this;

            this._connectionStream.next(_enums.DriverState.Downloading);
            return _rxjs.Observable.fromPromise((0, _runtime.isSupportedRuntime)(this._runtimeContext).do(function (ctx) {
                _this4._runtime = ctx.runtime;
                _this4._PATH = ctx.path;
                _this4._runtimeContext = _this4._getRuntimeContext();
            }).toPromise().then(function (runtime) {
                return _this4._runtimeContext.downloadRuntimeIfMissing().do({ complete: function complete() {
                        _this4._connectionStream.next(_enums.DriverState.Downloaded);
                    } }).toPromise();
            }));
        }
    }, {
        key: "updatePlugins",
        value: function updatePlugins(plugins) {
            this._plugins = plugins;
            this.disconnect();
            this.connect();
        }
    }, {
        key: "serverErr",
        value: function serverErr(data) {
            var friendlyMessage = this.parseError(data);
            this._connectionStream.next(_enums.DriverState.Error);
            this._process = null;
            this._eventStream.next({
                Type: "error",
                Event: "error",
                Seq: -1,
                Body: {
                    Message: friendlyMessage
                }
            });
        }
    }, {
        key: "parseError",
        value: function parseError(data) {
            var message = data.toString();
            if (data.code === "ENOENT" && data.path === "mono") {
                message = "mono could not be found, please ensure it is installed and in your path";
            }
            return message;
        }
    }, {
        key: "disconnect",
        value: function disconnect() {
            if (this._process != null && this._process.pid) {
                this._process.kill("SIGTERM");
            }
            this._process = null;
            this._connectionStream.next(_enums.DriverState.Disconnected);
        }
    }, {
        key: "request",
        value: function request(command, _request) {
            if (!this._process) {
                return _rxjs.Observable.throw(new Error("Server is not connected, erroring out"));
            }
            var sequence = this._seq++;
            var packet = {
                Command: command,
                Seq: sequence,
                Arguments: _request
            };
            var subject = new _rxjs.AsyncSubject();
            this._outstandingRequests.set(sequence, subject);
            this._process.stdin.write(JSON.stringify(packet) + "\n", "utf8");
            return subject.timeout(this._timeout, _rxjs.Observable.throw("Request timed out"));
        }
    }, {
        key: "handleData",
        value: function handleData(data) {
            var packet = void 0;
            try {
                packet = JSON.parse(data.trim());
            } catch (_error) {
                this.handleNonPacket(data);
            }
            if (packet) {
                this.handlePacket(packet);
            }
        }
    }, {
        key: "handlePacket",
        value: function handlePacket(packet) {
            if (packet.Type === "response") {
                this.handlePacketResponse(packet);
            } else if (packet.Type === "event") {
                this.handlePacketEvent(packet);
            }
        }
    }, {
        key: "handlePacketResponse",
        value: function handlePacketResponse(response) {
            if (this._outstandingRequests.has(response.Request_seq)) {
                var observer = this._outstandingRequests.get(response.Request_seq);
                this._outstandingRequests.delete(response.Request_seq);
                if (observer.isUnsubscribed) return;
                if (response.Success) {
                    observer.next(response.Body);
                    observer.complete();
                } else {
                    observer.error(response.Message);
                }
            } else {
                if (response.Success) {
                    this._commandStream.next(response);
                } else {}
            }
        }
    }, {
        key: "handlePacketEvent",
        value: function handlePacketEvent(event) {
            this._eventStream.next(event);
            if (event.Event === "started") {
                this._connectionStream.next(_enums.DriverState.Connected);
            }
        }
    }, {
        key: "handleNonPacket",
        value: function handleNonPacket(data) {
            var s = data.toString();
            this._eventStream.next({
                Type: "unknown",
                Event: "unknown",
                Seq: -1,
                Body: {
                    Message: s
                }
            });
            var ref = s.match(/Detected an OmniSharp instance already running on port/);
            if ((ref != null ? ref.length : 0) > 0) {
                this.disconnect();
            }
        }
    }, {
        key: "currentState",
        get: function get() {
            return this._currentState;
        },
        set: function set(value) {
            this._currentState = value;
        }
    }, {
        key: "serverPath",
        get: function get() {
            if (this._serverPath) {
                return this._serverPath;
            }
            return this._runtimeContext.location;
        }
    }, {
        key: "projectPath",
        get: function get() {
            return this._projectPath;
        }
    }, {
        key: "runtime",
        get: function get() {
            return this._runtime;
        }
    }, {
        key: "commands",
        get: function get() {
            return this._commandStream;
        }
    }, {
        key: "events",
        get: function get() {
            return this._eventStream;
        }
    }, {
        key: "state",
        get: function get() {
            return this._connectionStream;
        }
    }, {
        key: "outstandingRequests",
        get: function get() {
            return this._outstandingRequests.size;
        }
    }]);

    return StdioDriver;
}();

exports.StdioDriver = StdioDriver;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXJzL3N0ZGlvLmpzIiwibGliL2RyaXZlcnMvc3RkaW8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7OztBQUNBOztJQ0NZOztBREFaOztBQUNBOztBQUNBOzs7Ozs7OztBQ0dBLElBQUksUUFBUSx3QkFBRyxLQUFIO0FBQ1osSUFBSSxRQUFRLFFBQVIsS0FBcUIsT0FBckIsRUFBOEI7QUFDOUIsWUFBUSxRQUFRLHdCQUFSLEVBQWtDLEtBQWxDLENBRHNCO0NBQWxDO0FBSUEsSUFBSSxNQUFXLHNCQUFTLEVBQUUsaUNBQWlDLEdBQWpDLEVBQVgsRUFBbUQsUUFBUSxHQUFSLENBQTlEOztJQUVKO0FBdUJJLGFBdkJKLFdBdUJJLE9BQW1JOzs7WUFBdEgsK0JBQXNIO1lBQXpHLDZCQUF5RztZQUE3RiwrQkFBNkY7WUFBaEYscUJBQWdGO1lBQXhFLHVCQUF3RTtZQUEvRCwrQ0FBK0Q7WUFBMUMsdUJBQTBDO1lBQWpDLHVCQUFpQztZQUF4Qix1QkFBd0I7OzhCQXZCdkksYUF1QnVJOztBQXBCM0gsYUFBQSxvQkFBQSxHQUF1QixJQUFJLEdBQUosRUFBdkIsQ0FvQjJIO0FBakIzSCxhQUFBLFdBQUEsR0FBYyxzQ0FBZCxDQWlCMkg7QUFKM0gsYUFBQSxhQUFBLEdBQTZCLG1CQUFZLFlBQVosQ0FJOEY7QUE2RDNILGFBQUEsY0FBQSxHQUFpQixtQkFBakIsQ0E3RDJIO0FBZ0UzSCxhQUFBLFlBQUEsR0FBZSxtQkFBZixDQWhFMkg7QUFtRTNILGFBQUEsaUJBQUEsR0FBb0IsbUJBQXBCLENBbkUySDtBQUMvSCxhQUFLLFlBQUwsR0FBb0IsV0FBcEIsQ0FEK0g7QUFFL0gsYUFBSyxZQUFMLEdBQW9CLGVBQWUsS0FBZixDQUYyRztBQUcvSCxhQUFLLGlCQUFMLENBQXVCLFNBQXZCLENBQWlDO21CQUFTLE1BQUssWUFBTCxHQUFvQixLQUFwQjtTQUFULENBQWpDLENBSCtIO0FBSS9ILGFBQUssT0FB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TCxDQUFxQixRQUFyQixDQUpVOzs7OzRCQU1DO0FBQUssbUJBQU8sS0FBSyxZQUFMLENBQVo7Ozs7NEJBQ0o7QUFBSyxtQkFBTyxLQUFLLFFBQUwsQ0FBWjs7Ozs0QkFHQztBQUEwRCxtQkFBaUUsS0FBSyxjQUFMLENBQTNIOzs7OzRCQUdGO0FBQXVELG1CQUE4RCxLQUFLLFlBQUwsQ0FBckg7Ozs7NEJBR0Q7QUFBOEIsbUJBQXFDLEtBQUssaUJBQUwsQ0FBbkU7Ozs7NEJBRWM7QUFBSyxtQkFBTyxLQUFLLG9CQUFMLENBQTBCLElBQTFCLENBQVo7Ozs7V0E3RmxDIiwiZmlsZSI6ImxpYi9kcml2ZXJzL3N0ZGlvLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUnVudGltZSB9IGZyb20gXCIuLi9lbnVtc1wiO1xuaW1wb3J0IHsgZGVmYXVsdHMsIHN0YXJ0c1dpdGggfSBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgeyBEcml2ZXJTdGF0ZSB9IGZyb20gXCIuLi9lbnVtc1wiO1xuaW1wb3J0IGNwIGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgKiBhcyByZWFkbGluZSBmcm9tIFwicmVhZGxpbmVcIjtcbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUgfSBmcm9tIFwiLi4vZGlzcG9zYWJsZXNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIEFzeW5jU3ViamVjdCB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBSdW50aW1lQ29udGV4dCwgaXNTdXBwb3J0ZWRSdW50aW1lIH0gZnJvbSBcIi4uL2hlbHBlcnMvcnVudGltZVwiO1xubGV0IHNwYXduID0gY3Auc3Bhd247XG5pZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gXCJ3aW4zMlwiKSB7XG4gICAgc3Bhd24gPSByZXF1aXJlKFwiLi4vd2luZG93cy9zdXBlci1zcGF3blwiKS5zcGF3bjtcbn1cbmxldCBlbnYgPSBkZWZhdWx0cyh7IEFUT01fU0hFTExfSU5URVJOQUxfUlVOX0FTX05PREU6IFwiMVwiIH0sIHByb2Nlc3MuZW52KTtcbmV4cG9ydCBjbGFzcyBTdGRpb0RyaXZlciB7XG4gICAgY29uc3RydWN0b3IoeyBwcm9qZWN0UGF0aCwgc2VydmVyUGF0aCwgZmluZFByb2plY3QsIGxvZ2dlciwgdGltZW91dCwgYWRkaXRpb25hbEFyZ3VtZW50cywgcnVudGltZSwgcGx1Z2lucywgdmVyc2lvbiB9KSB7XG4gICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgICAgICB0aGlzLl9jdXJyZW50U3RhdGUgPSBEcml2ZXJTdGF0ZS5EaXNjb25uZWN0ZWQ7XG4gICAgICAgIHRoaXMuX2NvbW1hbmRTdHJlYW0gPSBuZXcgU3ViamVjdCgpO1xuICAgICAgICB0aGlzLl9ldmVudFN0cmVhbSA9IG5ldyBTdWJqZWN0KCk7XG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0gPSBuZXcgU3ViamVjdCgpO1xuICAgICAgICB0aGlzLl9wcm9qZWN0UGF0aCA9IHByb2plY3RQYXRoO1xuICAgICAgICB0aGlzLl9maW5kUHJvamVjdCA9IGZpbmRQcm9qZWN0IHx8IGZhbHNlO1xuICAgICAgICB0aGlzLl9jb25uZWN0aW9uU3RyZWFtLnN1YnNjcmliZShzdGF0ZSA9PiB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyIHx8IGNvbnNvbGU7XG4gICAgICAgIHRoaXMuX3NlcnZlclBhdGggPSBzZXJ2ZXJQYXRoO1xuICAgICAgICB0aGlzLl90aW1lb3V0ID0gKHRpbWVvdXQgfHwgNjApICogMTAwMDtcbiAgICAgICAgdGhpcy5fcnVudGltZSA9IHJ1bnRpbWUgfHwgUnVudGltZS5DbHJPck1vbm87XG4gICAgICAgIHRoaXMuX2FkZGl0aW9uYWxBcmd1bWVudHMgPSBhZGRpdGlvbmFsQXJndW1lbnRzO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0gcGx1Z2lucztcbiAgICAgICAgdGhpcy5fdmVyc2lvbiA9IHZlcnNpb247XG4gICAgICAgIHRoaXMuX3J1bnRpbWVDb250ZXh0ID0gdGhpcy5fZ2V0UnVudGltZUNvbnRleHQoKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoRGlzcG9zYWJsZS5jcmVhdGUoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX3Byb2Nlc3MpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9wcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KSk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKERpc3Bvc2FibGUuY3JlYXRlKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZXJhdG9yID0gdGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5lbnRyaWVzKCk7XG4gICAgICAgICAgICBsZXQgaXRlcmF0ZWUgPSBpdGVyYXRvci5uZXh0KCk7XG4gICAgICAgICAgICB3aGlsZSAoIWl0ZXJhdGVlLmRvbmUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBba2V5LCBkaXNwb3NhYmxlXSA9IGl0ZXJhdGVlLnZhbHVlO1xuICAgICAgICAgICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuZGVsZXRlKGtleSk7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZS51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgIGl0ZXJhdGVlID0gaXRlcmF0b3IubmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5jbGVhcigpO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIGdldCBjdXJyZW50U3RhdGUoKSB7IHJldHVybiB0aGlzLl9jdXJyZW50U3RhdGU7IH1cbiAgICBzZXQgY3VycmVudFN0YXRlKHZhbHVlKSB7IHRoaXMuX2N1cnJlbnRTdGF0ZSA9IHZhbHVlOyB9XG4gICAgX2dldFJ1bnRpbWVDb250ZXh0KCkge1xuICAgICAgICByZXR1cm4gbmV3IFJ1bnRpbWVDb250ZXh0KHtcbiAgICAgICAgICAgIHJ1bnRpbWU6IHRoaXMucnVudGltZSxcbiAgICAgICAgICAgIHBsYXRmb3JtOiBwcm9jZXNzLnBsYXRmb3JtLFxuICAgICAgICAgICAgYXJjaDogcHJvY2Vzcy5hcmNoLFxuICAgICAgICAgICAgdmVyc2lvbjogdGhpcy5fdmVyc2lvbiB8fCB1bmRlZmluZWRcbiAgICAgICAgfSwgdGhpcy5fbG9nZ2VyKTtcbiAgICB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Rpc3Bvc2FibGUuaXNEaXNwb3NlZClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBnZXQgc2VydmVyUGF0aCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3NlcnZlclBhdGgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zZXJ2ZXJQYXRoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9ydW50aW1lQ29udGV4dC5sb2NhdGlvbjtcbiAgICB9XG4gICAgZ2V0IHByb2plY3RQYXRoKCkgeyByZXR1cm4gdGhpcy5fcHJvamVjdFBhdGg7IH1cbiAgICBnZXQgcnVudGltZSgpIHsgcmV0dXJuIHRoaXMuX3J1bnRpbWU7IH1cbiAgICBnZXQgY29tbWFuZHMoKSB7IHJldHVybiB0aGlzLl9jb21tYW5kU3RyZWFtOyB9XG4gICAgZ2V0IGV2ZW50cygpIHsgcmV0dXJuIHRoaXMuX2V2ZW50U3RyZWFtOyB9XG4gICAgZ2V0IHN0YXRlKCkgeyByZXR1cm4gdGhpcy5fY29ubmVjdGlvblN0cmVhbTsgfVxuICAgIGdldCBvdXRzdGFuZGluZ1JlcXVlc3RzKCkgeyByZXR1cm4gdGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5zaXplOyB9XG4gICAgY29ubmVjdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Rpc3Bvc2FibGUuaXNEaXNwb3NlZClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRyaXZlciBpcyBkaXNwb3NlZFwiKTtcbiAgICAgICAgdGhpcy5fZW5zdXJlUnVudGltZUV4aXN0cygpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHsgY29tcGxldGU6ICgpID0+IHRoaXMuX2Nvbm5lY3QoKSB9KTtcbiAgICB9XG4gICAgX2Nvbm5lY3QoKSB7XG4gICAgICAgIHRoaXMuX3NlcSA9IDE7XG4gICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvblN0cmVhbS5uZXh0KERyaXZlclN0YXRlLkNvbm5lY3RpbmcpO1xuICAgICAgICBsZXQgcGF0aCA9IHRoaXMuc2VydmVyUGF0aDtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgQ29ubmVjdGluZyB0byBjaGlsZCBAICR7cHJvY2Vzcy5leGVjUGF0aH1gKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgUGF0aCB0byBzZXJ2ZXI6ICR7cGF0aH1gKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgU2VsZWN0ZWQgcHJvamVjdDogJHt0aGlzLl9wcm9qZWN0UGF0aH1gKTtcbiAgICAgICAgZW52LlBBVEggPSB0aGlzLl9QQVRIIHx8IGVudi5QQVRIO1xuICAgICAgICBjb25zdCBzZXJ2ZXJBcmd1bWVudHMgPSBbXCItLXN0ZGlvXCIsIFwiLXNcIiwgdGhpcy5fcHJvamVjdFBhdGgsIFwiLS1ob3N0UElEXCIsIHByb2Nlc3MucGlkXS5jb25jYXQodGhpcy5fYWRkaXRpb25hbEFyZ3VtZW50cyB8fCBbXSk7XG4gICAgICAgIGlmIChzdGFydHNXaXRoKHBhdGgsIFwibW9ubyBcIikpIHtcbiAgICAgICAgICAgIHNlcnZlckFyZ3VtZW50cy51bnNoaWZ0KHBhdGguc3Vic3RyKDUpKTtcbiAgICAgICAgICAgIHBhdGggPSBcIm1vbm9cIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9sb2dnZXIubG9nKGBBcmd1bWVudHM6ICR7c2VydmVyQXJndW1lbnRzfWApO1xuICAgICAgICB0aGlzLl9wcm9jZXNzID0gc3Bhd24ocGF0aCwgc2VydmVyQXJndW1lbnRzLCB7IGVudiB9KTtcbiAgICAgICAgaWYgKCF0aGlzLl9wcm9jZXNzLnBpZCkge1xuICAgICAgICAgICAgdGhpcy5zZXJ2ZXJFcnIoXCJmYWlsZWQgdG8gY29ubmVjdCB0byBjb25uZWN0IHRvIHNlcnZlclwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9wcm9jZXNzLnN0ZGVyci5vbihcImRhdGFcIiwgKGRhdGEpID0+IHRoaXMuX2xvZ2dlci5lcnJvcihkYXRhLnRvU3RyaW5nKCkpKTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5zdGRlcnIub24oXCJkYXRhXCIsIChkYXRhKSA9PiB0aGlzLnNlcnZlckVycihkYXRhKSk7XG4gICAgICAgIGNvbnN0IHJsID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHtcbiAgICAgICAgICAgIGlucHV0OiB0aGlzLl9wcm9jZXNzLnN0ZG91dCxcbiAgICAgICAgICAgIG91dHB1dDogdW5kZWZpbmVkXG4gICAgICAgIH0pO1xuICAgICAgICBybC5vbihcImxpbmVcIiwgKGRhdGEpID0+IHRoaXMuaGFuZGxlRGF0YShkYXRhKSk7XG4gICAgICAgIHRoaXMuaWQgPSB0aGlzLl9wcm9jZXNzLnBpZC50b1N0cmluZygpO1xuICAgICAgICB0aGlzLl9wcm9jZXNzLm9uKFwiZXJyb3JcIiwgKGRhdGEpID0+IHRoaXMuc2VydmVyRXJyKGRhdGEpKTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5vbihcImNsb3NlXCIsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5vbihcImV4aXRcIiwgKCkgPT4gdGhpcy5kaXNjb25uZWN0KCkpO1xuICAgICAgICB0aGlzLl9wcm9jZXNzLm9uKFwiZGlzY29ubmVjdFwiLCAoKSA9PiB0aGlzLmRpc2Nvbm5lY3QoKSk7XG4gICAgfVxuICAgIF9lbnN1cmVSdW50aW1lRXhpc3RzKCkge1xuICAgICAgICB0aGlzLl9jb25uZWN0aW9uU3RyZWFtLm5leHQoRHJpdmVyU3RhdGUuRG93bmxvYWRpbmcpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShpc1N1cHBvcnRlZFJ1bnRpbWUodGhpcy5fcnVudGltZUNvbnRleHQpXG4gICAgICAgICAgICAuZG8oKGN0eCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcnVudGltZSA9IGN0eC5ydW50aW1lO1xuICAgICAgICAgICAgdGhpcy5fUEFUSCA9IGN0eC5wYXRoO1xuICAgICAgICAgICAgdGhpcy5fcnVudGltZUNvbnRleHQgPSB0aGlzLl9nZXRSdW50aW1lQ29udGV4dCgpO1xuICAgICAgICB9KVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAudGhlbigocnVudGltZSkgPT4gdGhpcy5fcnVudGltZUNvbnRleHQuZG93bmxvYWRSdW50aW1lSWZNaXNzaW5nKClcbiAgICAgICAgICAgIC5kbyh7IGNvbXBsZXRlOiAoKSA9PiB7IHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0ubmV4dChEcml2ZXJTdGF0ZS5Eb3dubG9hZGVkKTsgfSB9KVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpKSk7XG4gICAgfVxuICAgIHVwZGF0ZVBsdWdpbnMocGx1Z2lucykge1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0gcGx1Z2lucztcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRoaXMuY29ubmVjdCgpO1xuICAgIH1cbiAgICBzZXJ2ZXJFcnIoZGF0YSkge1xuICAgICAgICBjb25zdCBmcmllbmRseU1lc3NhZ2UgPSB0aGlzLnBhcnNlRXJyb3IoZGF0YSk7XG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0ubmV4dChEcml2ZXJTdGF0ZS5FcnJvcik7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgICAgICB0aGlzLl9ldmVudFN0cmVhbS5uZXh0KHtcbiAgICAgICAgICAgIFR5cGU6IFwiZXJyb3JcIixcbiAgICAgICAgICAgIEV2ZW50OiBcImVycm9yXCIsXG4gICAgICAgICAgICBTZXE6IC0xLFxuICAgICAgICAgICAgQm9keToge1xuICAgICAgICAgICAgICAgIE1lc3NhZ2U6IGZyaWVuZGx5TWVzc2FnZVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgcGFyc2VFcnJvcihkYXRhKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICBpZiAoZGF0YS5jb2RlID09PSBcIkVOT0VOVFwiICYmIGRhdGEucGF0aCA9PT0gXCJtb25vXCIpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBcIm1vbm8gY291bGQgbm90IGJlIGZvdW5kLCBwbGVhc2UgZW5zdXJlIGl0IGlzIGluc3RhbGxlZCBhbmQgaW4geW91ciBwYXRoXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgfVxuICAgIGRpc2Nvbm5lY3QoKSB7XG4gICAgICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwgJiYgdGhpcy5fcHJvY2Vzcy5waWQpIHtcbiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3Mua2lsbChcIlNJR1RFUk1cIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0ubmV4dChEcml2ZXJTdGF0ZS5EaXNjb25uZWN0ZWQpO1xuICAgIH1cbiAgICByZXF1ZXN0KGNvbW1hbmQsIHJlcXVlc3QpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9wcm9jZXNzKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhuZXcgRXJyb3IoXCJTZXJ2ZXIgaXMgbm90IGNvbm5lY3RlZCwgZXJyb3Jpbmcgb3V0XCIpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzZXF1ZW5jZSA9IHRoaXMuX3NlcSsrO1xuICAgICAgICBjb25zdCBwYWNrZXQgPSB7XG4gICAgICAgICAgICBDb21tYW5kOiBjb21tYW5kLFxuICAgICAgICAgICAgU2VxOiBzZXF1ZW5jZSxcbiAgICAgICAgICAgIEFyZ3VtZW50czogcmVxdWVzdFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBzdWJqZWN0ID0gbmV3IEFzeW5jU3ViamVjdCgpO1xuICAgICAgICB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLnNldChzZXF1ZW5jZSwgc3ViamVjdCk7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3Muc3RkaW4ud3JpdGUoSlNPTi5zdHJpbmdpZnkocGFja2V0KSArIFwiXFxuXCIsIFwidXRmOFwiKTtcbiAgICAgICAgcmV0dXJuIHN1YmplY3QudGltZW91dCh0aGlzLl90aW1lb3V0LCBPYnNlcnZhYmxlLnRocm93KFwiUmVxdWVzdCB0aW1lZCBvdXRcIikpO1xuICAgIH1cbiAgICBoYW5kbGVEYXRhKGRhdGEpIHtcbiAgICAgICAgbGV0IHBhY2tldDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHBhY2tldCA9IEpTT04ucGFyc2UoZGF0YS50cmltKCkpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChfZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlTm9uUGFja2V0KGRhdGEpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwYWNrZXQpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlUGFja2V0KHBhY2tldCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaGFuZGxlUGFja2V0KHBhY2tldCkge1xuICAgICAgICBpZiAocGFja2V0LlR5cGUgPT09IFwicmVzcG9uc2VcIikge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVQYWNrZXRSZXNwb25zZShwYWNrZXQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBhY2tldC5UeXBlID09PSBcImV2ZW50XCIpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlUGFja2V0RXZlbnQocGFja2V0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBoYW5kbGVQYWNrZXRSZXNwb25zZShyZXNwb25zZSkge1xuICAgICAgICBpZiAodGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5oYXMocmVzcG9uc2UuUmVxdWVzdF9zZXEpKSB7XG4gICAgICAgICAgICBjb25zdCBvYnNlcnZlciA9IHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuZ2V0KHJlc3BvbnNlLlJlcXVlc3Rfc2VxKTtcbiAgICAgICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuZGVsZXRlKHJlc3BvbnNlLlJlcXVlc3Rfc2VxKTtcbiAgICAgICAgICAgIGlmIChvYnNlcnZlci5pc1Vuc3Vic2NyaWJlZClcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuU3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzcG9uc2UuQm9keSk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKHJlc3BvbnNlLk1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLlN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jb21tYW5kU3RyZWFtLm5leHQocmVzcG9uc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaGFuZGxlUGFja2V0RXZlbnQoZXZlbnQpIHtcbiAgICAgICAgdGhpcy5fZXZlbnRTdHJlYW0ubmV4dChldmVudCk7XG4gICAgICAgIGlmIChldmVudC5FdmVudCA9PT0gXCJzdGFydGVkXCIpIHtcbiAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0ubmV4dChEcml2ZXJTdGF0ZS5Db25uZWN0ZWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGhhbmRsZU5vblBhY2tldChkYXRhKSB7XG4gICAgICAgIGNvbnN0IHMgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuX2V2ZW50U3RyZWFtLm5leHQoe1xuICAgICAgICAgICAgVHlwZTogXCJ1bmtub3duXCIsXG4gICAgICAgICAgICBFdmVudDogXCJ1bmtub3duXCIsXG4gICAgICAgICAgICBTZXE6IC0xLFxuICAgICAgICAgICAgQm9keToge1xuICAgICAgICAgICAgICAgIE1lc3NhZ2U6IHNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJlZiA9IHMubWF0Y2goL0RldGVjdGVkIGFuIE9tbmlTaGFycCBpbnN0YW5jZSBhbHJlYWR5IHJ1bm5pbmcgb24gcG9ydC8pO1xuICAgICAgICBpZiAoKHJlZiAhPSBudWxsID8gcmVmLmxlbmd0aCA6IDApID4gMCkge1xuICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iLCJpbXBvcnQgKiBhcyBPbW5pU2hhcnAgZnJvbSBcIi4uL29tbmlzaGFycC1zZXJ2ZXJcIjtcbmltcG9ydCB7SURyaXZlciwgSURyaXZlck9wdGlvbnMsIElMb2dnZXIsIFJ1bnRpbWUsIElPbW5pc2hhcnBQbHVnaW59IGZyb20gXCIuLi9lbnVtc1wiO1xuaW1wb3J0IHtkZWZhdWx0cywgc3RhcnRzV2l0aH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHtEcml2ZXJTdGF0ZX0gZnJvbSBcIi4uL2VudW1zXCI7XG5pbXBvcnQgY3AsIHtDaGlsZFByb2Nlc3N9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgKiBhcyByZWFkbGluZSBmcm9tIFwicmVhZGxpbmVcIjtcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZX0gZnJvbSBcIi4uL2Rpc3Bvc2FibGVzXCI7XG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3QsIEFzeW5jU3ViamVjdH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7UnVudGltZUNvbnRleHQsIGlzU3VwcG9ydGVkUnVudGltZX0gZnJvbSBcIi4uL2hlbHBlcnMvcnVudGltZVwiO1xuXG5sZXQgc3Bhd24gPSBjcC5zcGF3bjtcbmlmIChwcm9jZXNzLnBsYXRmb3JtID09PSBcIndpbjMyXCIpIHtcbiAgICBzcGF3biA9IHJlcXVpcmUoXCIuLi93aW5kb3dzL3N1cGVyLXNwYXduXCIpLnNwYXduO1xufVxuXG5sZXQgZW52OiBhbnkgPSBkZWZhdWx0cyh7IEFUT01fU0hFTExfSU5URVJOQUxfUlVOX0FTX05PREU6IFwiMVwiIH0sIHByb2Nlc3MuZW52KTtcblxuZXhwb3J0IGNsYXNzIFN0ZGlvRHJpdmVyIGltcGxlbWVudHMgSURyaXZlciB7XG4gICAgcHJpdmF0ZSBfc2VxOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBfcHJvY2VzczogQ2hpbGRQcm9jZXNzO1xuICAgIHByaXZhdGUgX291dHN0YW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwPG51bWJlciwgQXN5bmNTdWJqZWN0PGFueT4+KCk7XG4gICAgcHJpdmF0ZSBfcHJvamVjdFBhdGg6IHN0cmluZztcbiAgICBwcml2YXRlIF9hZGRpdGlvbmFsQXJndW1lbnRzOiBzdHJpbmdbXTtcbiAgICBwcml2YXRlIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBwcml2YXRlIF9wbHVnaW5zOiBJT21uaXNoYXJwUGx1Z2luW107XG4gICAgcHJpdmF0ZSBfc2VydmVyUGF0aDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBfZmluZFByb2plY3Q6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfbG9nZ2VyOiBJTG9nZ2VyO1xuICAgIHByaXZhdGUgX3RpbWVvdXQ6IG51bWJlcjtcbiAgICBwcml2YXRlIF9ydW50aW1lOiBSdW50aW1lO1xuICAgIHByaXZhdGUgX3ZlcnNpb246IHN0cmluZztcbiAgICBwcml2YXRlIF9QQVRIOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfcnVudGltZUNvbnRleHQ6IFJ1bnRpbWVDb250ZXh0O1xuICAgIHB1YmxpYyBpZDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBfY3VycmVudFN0YXRlOiBEcml2ZXJTdGF0ZSA9IERyaXZlclN0YXRlLkRpc2Nvbm5lY3RlZDtcbiAgICBwdWJsaWMgZ2V0IGN1cnJlbnRTdGF0ZSgpIHsgcmV0dXJuIHRoaXMuX2N1cnJlbnRTdGF0ZTsgfVxuICAgIHB1YmxpYyBzZXQgY3VycmVudFN0YXRlKHZhbHVlKSB7IHRoaXMuX2N1cnJlbnRTdGF0ZSA9IHZhbHVlOyB9XG5cbiAgICBjb25zdHJ1Y3Rvcih7cHJvamVjdFBhdGgsIHNlcnZlclBhdGgsIGZpbmRQcm9qZWN0LCBsb2dnZXIsIHRpbWVvdXQsIGFkZGl0aW9uYWxBcmd1bWVudHMsIHJ1bnRpbWUsIHBsdWdpbnMsIHZlcnNpb259OiBJRHJpdmVyT3B0aW9ucykge1xuICAgICAgICB0aGlzLl9wcm9qZWN0UGF0aCA9IHByb2plY3RQYXRoO1xuICAgICAgICB0aGlzLl9maW5kUHJvamVjdCA9IGZpbmRQcm9qZWN0IHx8IGZhbHNlO1xuICAgICAgICB0aGlzLl9jb25uZWN0aW9uU3RyZWFtLnN1YnNjcmliZShzdGF0ZSA9PiB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyIHx8IGNvbnNvbGU7XG4gICAgICAgIHRoaXMuX3NlcnZlclBhdGggPSBzZXJ2ZXJQYXRoO1xuICAgICAgICB0aGlzLl90aW1lb3V0ID0gKHRpbWVvdXQgfHwgNjApICogMTAwMDtcbiAgICAgICAgdGhpcy5fcnVudGltZSA9IHJ1bnRpbWUgfHwgUnVudGltZS5DbHJPck1vbm87XG4gICAgICAgIHRoaXMuX2FkZGl0aW9uYWxBcmd1bWVudHMgPSBhZGRpdGlvbmFsQXJndW1lbnRzO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0gcGx1Z2lucztcbiAgICAgICAgdGhpcy5fdmVyc2lvbiA9IHZlcnNpb247XG5cbiAgICAgICAgdGhpcy5fcnVudGltZUNvbnRleHQgPSB0aGlzLl9nZXRSdW50aW1lQ29udGV4dCgpO1xuXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKERpc3Bvc2FibGUuY3JlYXRlKCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9wcm9jZXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKERpc3Bvc2FibGUuY3JlYXRlKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZXJhdG9yID0gdGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5lbnRyaWVzKCk7XG4gICAgICAgICAgICBsZXQgaXRlcmF0ZWUgPSBpdGVyYXRvci5uZXh0KCk7XG5cbiAgICAgICAgICAgIHdoaWxlICghaXRlcmF0ZWUuZG9uZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IFtrZXksIGRpc3Bvc2FibGVdID0gaXRlcmF0ZWUudmFsdWU7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLmRlbGV0ZShrZXkpO1xuICAgICAgICAgICAgICAgIGRpc3Bvc2FibGUudW5zdWJzY3JpYmUoKTtcblxuICAgICAgICAgICAgICAgIGl0ZXJhdGVlID0gaXRlcmF0b3IubmV4dCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLmNsZWFyKCk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRSdW50aW1lQ29udGV4dCgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBSdW50aW1lQ29udGV4dCh7XG4gICAgICAgICAgICBydW50aW1lOiB0aGlzLnJ1bnRpbWUsXG4gICAgICAgICAgICBwbGF0Zm9ybTogcHJvY2Vzcy5wbGF0Zm9ybSxcbiAgICAgICAgICAgIGFyY2g6IHByb2Nlc3MuYXJjaCxcbiAgICAgICAgICAgIHZlcnNpb246IHRoaXMuX3ZlcnNpb24gfHwgdW5kZWZpbmVkXG4gICAgICAgIH0sIHRoaXMuX2xvZ2dlcik7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9kaXNwb3NhYmxlLmlzRGlzcG9zZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc2VydmVyUGF0aCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3NlcnZlclBhdGgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zZXJ2ZXJQYXRoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9ydW50aW1lQ29udGV4dC5sb2NhdGlvbjtcbiAgICB9XG4gICAgcHVibGljIGdldCBwcm9qZWN0UGF0aCgpIHsgcmV0dXJuIHRoaXMuX3Byb2plY3RQYXRoOyB9XG4gICAgcHVibGljIGdldCBydW50aW1lKCkgeyByZXR1cm4gdGhpcy5fcnVudGltZTsgfVxuXG4gICAgcHJpdmF0ZSBfY29tbWFuZFN0cmVhbSA9IG5ldyBTdWJqZWN0PE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5SZXNwb25zZVBhY2tldD4oKTtcbiAgICBwdWJsaWMgZ2V0IGNvbW1hbmRzKCk6IE9ic2VydmFibGU8T21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLlJlc3BvbnNlUGFja2V0PiB7IHJldHVybiA8T2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuUmVzcG9uc2VQYWNrZXQ+Pjxhbnk+dGhpcy5fY29tbWFuZFN0cmVhbTsgfVxuXG4gICAgcHJpdmF0ZSBfZXZlbnRTdHJlYW0gPSBuZXcgU3ViamVjdDxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuRXZlbnRQYWNrZXQ+KCk7XG4gICAgcHVibGljIGdldCBldmVudHMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuRXZlbnRQYWNrZXQ+IHsgcmV0dXJuIDxPYnNlcnZhYmxlPE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldD4+PGFueT50aGlzLl9ldmVudFN0cmVhbTsgfVxuXG4gICAgcHJpdmF0ZSBfY29ubmVjdGlvblN0cmVhbSA9IG5ldyBTdWJqZWN0PERyaXZlclN0YXRlPigpO1xuICAgIHB1YmxpYyBnZXQgc3RhdGUoKTogT2JzZXJ2YWJsZTxEcml2ZXJTdGF0ZT4geyByZXR1cm4gPE9ic2VydmFibGU8RHJpdmVyU3RhdGU+Pjxhbnk+dGhpcy5fY29ubmVjdGlvblN0cmVhbTsgfVxuXG4gICAgcHVibGljIGdldCBvdXRzdGFuZGluZ1JlcXVlc3RzKCkgeyByZXR1cm4gdGhpcy5fb3V0c3RhbmRpbmdSZXF1ZXN0cy5zaXplOyB9XG5cbiAgICBwdWJsaWMgY29ubmVjdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2Rpc3Bvc2FibGUuaXNEaXNwb3NlZClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRyaXZlciBpcyBkaXNwb3NlZFwiKTtcblxuICAgICAgICB0aGlzLl9lbnN1cmVSdW50aW1lRXhpc3RzKClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoeyBjb21wbGV0ZTogKCkgPT4gdGhpcy5fY29ubmVjdCgpIH0pO1xuICAgICAgICAvKlxuICAgICAgICBFbmFibGUgb25jZSB3ZSBjYW4gcHVzaCBhIG5ldyBidWlsZCBhZ2FpblxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZCh0aGlzLl9lbnN1cmVCb290c3RyYXBFeGlzdHMoKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgocGF0aCkgPT4gdGhpcy5fc2VydmVyUGF0aCA9IHBhdGgsIG51bGwsICgpID0+IHRoaXMuX2Nvbm5lY3QoKSkpO1xuICAgICAgICAqL1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Nvbm5lY3QoKSB7XG4gICAgICAgIHRoaXMuX3NlcSA9IDE7XG4gICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvblN0cmVhbS5uZXh0KERyaXZlclN0YXRlLkNvbm5lY3RpbmcpO1xuXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5zZXJ2ZXJQYXRoO1xuXG4gICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYENvbm5lY3RpbmcgdG8gY2hpbGQgQCAke3Byb2Nlc3MuZXhlY1BhdGh9YCk7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYFBhdGggdG8gc2VydmVyOiAke3BhdGh9YCk7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYFNlbGVjdGVkIHByb2plY3Q6ICR7dGhpcy5fcHJvamVjdFBhdGh9YCk7XG5cbiAgICAgICAgZW52LlBBVEggPSB0aGlzLl9QQVRIIHx8IGVudi5QQVRIO1xuXG4gICAgICAgIGNvbnN0IHNlcnZlckFyZ3VtZW50czogYW55W10gPSBbXCItLXN0ZGlvXCIsIFwiLXNcIiwgdGhpcy5fcHJvamVjdFBhdGgsIFwiLS1ob3N0UElEXCIsIHByb2Nlc3MucGlkXS5jb25jYXQodGhpcy5fYWRkaXRpb25hbEFyZ3VtZW50cyB8fCBbXSk7XG5cbiAgICAgICAgaWYgKHN0YXJ0c1dpdGgocGF0aCwgXCJtb25vIFwiKSkge1xuICAgICAgICAgICAgc2VydmVyQXJndW1lbnRzLnVuc2hpZnQocGF0aC5zdWJzdHIoNSkpO1xuICAgICAgICAgICAgcGF0aCA9IFwibW9ub1wiO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgQXJndW1lbnRzOiAke3NlcnZlckFyZ3VtZW50c31gKTtcbiAgICAgICAgdGhpcy5fcHJvY2VzcyA9IHNwYXduKHBhdGgsIHNlcnZlckFyZ3VtZW50cywgeyBlbnYgfSk7XG5cbiAgICAgICAgaWYgKCF0aGlzLl9wcm9jZXNzLnBpZCkge1xuICAgICAgICAgICAgdGhpcy5zZXJ2ZXJFcnIoXCJmYWlsZWQgdG8gY29ubmVjdCB0byBjb25uZWN0IHRvIHNlcnZlclwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3Byb2Nlc3Muc3RkZXJyLm9uKFwiZGF0YVwiLCAoZGF0YTogYW55KSA9PiB0aGlzLl9sb2dnZXIuZXJyb3IoZGF0YS50b1N0cmluZygpKSk7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3Muc3RkZXJyLm9uKFwiZGF0YVwiLCAoZGF0YTogYW55KSA9PiB0aGlzLnNlcnZlckVycihkYXRhKSk7XG5cbiAgICAgICAgY29uc3QgcmwgPSByZWFkbGluZS5jcmVhdGVJbnRlcmZhY2Uoe1xuICAgICAgICAgICAgaW5wdXQ6IHRoaXMuX3Byb2Nlc3Muc3Rkb3V0LFxuICAgICAgICAgICAgb3V0cHV0OiB1bmRlZmluZWRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmwub24oXCJsaW5lXCIsIChkYXRhOiBhbnkpID0+IHRoaXMuaGFuZGxlRGF0YShkYXRhKSk7XG5cbiAgICAgICAgdGhpcy5pZCA9IHRoaXMuX3Byb2Nlc3MucGlkLnRvU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3Mub24oXCJlcnJvclwiLCAoZGF0YTogYW55KSA9PiB0aGlzLnNlcnZlckVycihkYXRhKSk7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3Mub24oXCJjbG9zZVwiLCAoKSA9PiB0aGlzLmRpc2Nvbm5lY3QoKSk7XG4gICAgICAgIHRoaXMuX3Byb2Nlc3Mub24oXCJleGl0XCIsICgpID0+IHRoaXMuZGlzY29ubmVjdCgpKTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5vbihcImRpc2Nvbm5lY3RcIiwgKCkgPT4gdGhpcy5kaXNjb25uZWN0KCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Vuc3VyZVJ1bnRpbWVFeGlzdHMoKSB7XG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0ubmV4dChEcml2ZXJTdGF0ZS5Eb3dubG9hZGluZyk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKGlzU3VwcG9ydGVkUnVudGltZSh0aGlzLl9ydW50aW1lQ29udGV4dClcbiAgICAgICAgICAgIC5kbygoY3R4KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcnVudGltZSA9IGN0eC5ydW50aW1lO1xuICAgICAgICAgICAgICAgIHRoaXMuX1BBVEggPSBjdHgucGF0aDtcbiAgICAgICAgICAgICAgICB0aGlzLl9ydW50aW1lQ29udGV4dCA9IHRoaXMuX2dldFJ1bnRpbWVDb250ZXh0KCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAudGhlbigocnVudGltZSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLl9ydW50aW1lQ29udGV4dC5kb3dubG9hZFJ1bnRpbWVJZk1pc3NpbmcoKVxuICAgICAgICAgICAgICAgICAgICAuZG8oeyBjb21wbGV0ZTogKCkgPT4geyB0aGlzLl9jb25uZWN0aW9uU3RyZWFtLm5leHQoRHJpdmVyU3RhdGUuRG93bmxvYWRlZCk7IH0gfSlcbiAgICAgICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICApKTtcbiAgICB9XG5cbiAgICAvKnByaXZhdGUgX2Vuc3VyZUJvb3RzdHJhcEV4aXN0cygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vuc3VyZVJ1bnRpbWVFeGlzdHMoKVxuICAgICAgICAgICAgLmZsYXRNYXAoKCkgPT4gZ2V0UGx1Z2luUGF0aCh0aGlzLl9wcm9qZWN0UGF0aCwgdGhpcy5fcnVudGltZSwgcHJvY2VzcywgdGhpcy5fcGx1Z2lucywgdGhpcy5fbG9nZ2VyKSk7XG4gICAgfSovXG5cbiAgICBwdWJsaWMgdXBkYXRlUGx1Z2lucyhwbHVnaW5zOiBJT21uaXNoYXJwUGx1Z2luW10pIHtcbiAgICAgICAgdGhpcy5fcGx1Z2lucyA9IHBsdWdpbnM7XG4gICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICB0aGlzLmNvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNlcnZlckVycihkYXRhOiBhbnkpIHtcbiAgICAgICAgY29uc3QgZnJpZW5kbHlNZXNzYWdlID0gdGhpcy5wYXJzZUVycm9yKGRhdGEpO1xuICAgICAgICB0aGlzLl9jb25uZWN0aW9uU3RyZWFtLm5leHQoRHJpdmVyU3RhdGUuRXJyb3IpO1xuICAgICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcblxuICAgICAgICB0aGlzLl9ldmVudFN0cmVhbS5uZXh0KHtcbiAgICAgICAgICAgIFR5cGU6IFwiZXJyb3JcIixcbiAgICAgICAgICAgIEV2ZW50OiBcImVycm9yXCIsXG4gICAgICAgICAgICBTZXE6IC0xLFxuICAgICAgICAgICAgQm9keToge1xuICAgICAgICAgICAgICAgIE1lc3NhZ2U6IGZyaWVuZGx5TWVzc2FnZVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlRXJyb3IoZGF0YTogYW55KSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICBpZiAoZGF0YS5jb2RlID09PSBcIkVOT0VOVFwiICYmIGRhdGEucGF0aCA9PT0gXCJtb25vXCIpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBcIm1vbm8gY291bGQgbm90IGJlIGZvdW5kLCBwbGVhc2UgZW5zdXJlIGl0IGlzIGluc3RhbGxlZCBhbmQgaW4geW91ciBwYXRoXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc2Nvbm5lY3QoKSB7XG4gICAgICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwgJiYgdGhpcy5fcHJvY2Vzcy5waWQpIHtcbiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3Mua2lsbChcIlNJR1RFUk1cIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25TdHJlYW0ubmV4dChEcml2ZXJTdGF0ZS5EaXNjb25uZWN0ZWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZXF1ZXN0PFRSZXF1ZXN0LCBUUmVzcG9uc2U+KGNvbW1hbmQ6IHN0cmluZywgcmVxdWVzdD86IFRSZXF1ZXN0KTogT2JzZXJ2YWJsZTxUUmVzcG9uc2U+IHtcbiAgICAgICAgaWYgKCF0aGlzLl9wcm9jZXNzKSB7XG4gICAgICAgICAgICByZXR1cm4gPGFueT5PYnNlcnZhYmxlLnRocm93PGFueT4obmV3IEVycm9yKFwiU2VydmVyIGlzIG5vdCBjb25uZWN0ZWQsIGVycm9yaW5nIG91dFwiKSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXF1ZW5jZSA9IHRoaXMuX3NlcSsrO1xuICAgICAgICBjb25zdCBwYWNrZXQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5SZXF1ZXN0UGFja2V0ID0ge1xuICAgICAgICAgICAgQ29tbWFuZDogY29tbWFuZCxcbiAgICAgICAgICAgIFNlcTogc2VxdWVuY2UsXG4gICAgICAgICAgICBBcmd1bWVudHM6IHJlcXVlc3RcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzdWJqZWN0ID0gbmV3IEFzeW5jU3ViamVjdDxUUmVzcG9uc2U+KCk7XG4gICAgICAgIHRoaXMuX291dHN0YW5kaW5nUmVxdWVzdHMuc2V0KHNlcXVlbmNlLCBzdWJqZWN0KTtcbiAgICAgICAgdGhpcy5fcHJvY2Vzcy5zdGRpbi53cml0ZShKU09OLnN0cmluZ2lmeShwYWNrZXQpICsgXCJcXG5cIiwgXCJ1dGY4XCIpO1xuICAgICAgICByZXR1cm4gc3ViamVjdC50aW1lb3V0KHRoaXMuX3RpbWVvdXQsIE9ic2VydmFibGUudGhyb3c8YW55PihcIlJlcXVlc3QgdGltZWQgb3V0XCIpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZURhdGEoZGF0YTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBwYWNrZXQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5QYWNrZXQ7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBwYWNrZXQgPSBKU09OLnBhcnNlKGRhdGEudHJpbSgpKTtcbiAgICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZU5vblBhY2tldChkYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYWNrZXQpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlUGFja2V0KHBhY2tldCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVBhY2tldChwYWNrZXQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5QYWNrZXQpIHtcbiAgICAgICAgaWYgKHBhY2tldC5UeXBlID09PSBcInJlc3BvbnNlXCIpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlUGFja2V0UmVzcG9uc2UoPE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5SZXNwb25zZVBhY2tldD5wYWNrZXQpO1xuICAgICAgICB9IGVsc2UgaWYgKHBhY2tldC5UeXBlID09PSBcImV2ZW50XCIpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlUGFja2V0RXZlbnQoPE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldD5wYWNrZXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVQYWNrZXRSZXNwb25zZShyZXNwb25zZTogT21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLlJlc3BvbnNlUGFja2V0KSB7XG4gICAgICAgIGlmICh0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLmhhcyhyZXNwb25zZS5SZXF1ZXN0X3NlcSkpIHtcblxuICAgICAgICAgICAgY29uc3Qgb2JzZXJ2ZXIgPSB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLmdldChyZXNwb25zZS5SZXF1ZXN0X3NlcSk7XG4gICAgICAgICAgICB0aGlzLl9vdXRzdGFuZGluZ1JlcXVlc3RzLmRlbGV0ZShyZXNwb25zZS5SZXF1ZXN0X3NlcSk7XG4gICAgICAgICAgICBpZiAob2JzZXJ2ZXIuaXNVbnN1YnNjcmliZWQpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5TdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXNwb25zZS5Cb2R5KTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihyZXNwb25zZS5NZXNzYWdlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLlN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jb21tYW5kU3RyZWFtLm5leHQocmVzcG9uc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBtYWtlIG5vdGlmaWNhdGlvbj9cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlUGFja2V0RXZlbnQoZXZlbnQ6IE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldCkge1xuICAgICAgICB0aGlzLl9ldmVudFN0cmVhbS5uZXh0KGV2ZW50KTtcbiAgICAgICAgaWYgKGV2ZW50LkV2ZW50ID09PSBcInN0YXJ0ZWRcIikge1xuICAgICAgICAgICAgdGhpcy5fY29ubmVjdGlvblN0cmVhbS5uZXh0KERyaXZlclN0YXRlLkNvbm5lY3RlZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZU5vblBhY2tldChkYXRhOiBhbnkpIHtcbiAgICAgICAgY29uc3QgcyA9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgdGhpcy5fZXZlbnRTdHJlYW0ubmV4dCh7XG4gICAgICAgICAgICBUeXBlOiBcInVua25vd25cIixcbiAgICAgICAgICAgIEV2ZW50OiBcInVua25vd25cIixcbiAgICAgICAgICAgIFNlcTogLTEsXG4gICAgICAgICAgICBCb2R5OiB7XG4gICAgICAgICAgICAgICAgTWVzc2FnZTogc1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCByZWYgPSBzLm1hdGNoKC9EZXRlY3RlZCBhbiBPbW5pU2hhcnAgaW5zdGFuY2UgYWxyZWFkeSBydW5uaW5nIG9uIHBvcnQvKTtcbiAgICAgICAgaWYgKChyZWYgIT0gbnVsbCA/IHJlZi5sZW5ndGggOiAwKSA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
