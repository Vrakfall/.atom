"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.ClientEventsBase = exports.ClientBase = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _rxjs = require("rxjs");

var _disposables = require("../disposables");

var _lodash = require("lodash");

var _enums = require("../enums");

var _contexts = require("../contexts");

var _responseHandling = require("../response-handling");

var _options2 = require("../options");

var _decorators = require("../decorators");

var _prioritization = require("../helpers/prioritization");

var _create = require("../operators/create");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var __decorate = undefined && undefined.__decorate || function (decorators, target, key, desc) {
    var c = arguments.length,
        r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
        d;
    if ((typeof Reflect === "undefined" ? "undefined" : _typeof(Reflect)) === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {
        if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    }return c > 3 && r && Object.defineProperty(target, key, r), r;
};

function pausable(incomingStream, pauser) {
    return (0, _create.createObservable)(function (observer) {
        var paused = void 0;
        var queue = [];
        var sub = new _rxjs.Subscription();
        sub.add(pauser.subscribe(function (shouldRun) {
            paused = !shouldRun;
            if (shouldRun && queue.length) {
                (0, _lodash.each)(queue, function (r) {
                    return observer.next(r);
                });
                queue = [];
            }
        }));
        sub.add(incomingStream.subscribe(function (request) {
            if (paused) {
                queue.push(request);
            } else {
                observer.next(request);
            }
        }));
        return sub;
    });
}

var ClientBase = function () {
    function ClientBase(_options, observableFactory) {
        var _this = this;

        _classCallCheck(this, ClientBase);

        this._options = _options;
        this._requestStream = new _rxjs.Subject();
        this._responseStream = new _rxjs.Subject();
        this._errorStream = new _rxjs.Subject();
        this._customEvents = new _rxjs.Subject();
        this._uniqueId = (0, _lodash.uniqueId)("client");
        this._eventWatchers = new Map();
        this._commandWatchers = new Map();
        this._disposable = new _disposables.CompositeDisposable();
        this._currentRequests = new Set();
        this._fixups = [];
        _options.driver = _options.driver || _enums.Driver.Stdio;
        (0, _options2.ensureClientOptions)(_options);
        this._resetDriver();
        this._enqueuedEvents = _rxjs.Observable.merge(this._customEvents, this._driver.events).map(function (event) {
            if ((0, _lodash.isObject)(event.Body)) {
                Object.freeze(event.Body);
            }
            return Object.freeze(event);
        });
        this._enqueuedResponses = _rxjs.Observable.merge(this._responseStream, this._driver.commands.map(function (packet) {
            return new _contexts.ResponseContext(new _contexts.RequestContext(_this._uniqueId, packet.Command, {}, {}, "command"), packet.Body);
        }));
        this._lowestIndexValue = _options.oneBasedIndices ? 1 : 0;
        this._disposable.add(this._requestStream.subscribe(function (x) {
            return _this._currentRequests.add(x);
        }));
        var getStatusValues = function getStatusValues() {
            return {
                state: _this._driver.currentState,
                outgoingRequests: _this.outstandingRequests,
                hasOutgoingRequests: _this.outstandingRequests > 0
            };
        };
        this.setupRequestStreams();
        this.setupObservers();
        var status = _rxjs.Observable.merge(this._requestStream, this._responseStream);
        this._statusStream = status.delay(10).map(getStatusValues).distinctUntilChanged().map(Object.freeze).share();
        this._observe = observableFactory(this);
        if (this._options.debug) {
            this._disposable.add(this._responseStream.subscribe(function (context) {
                _this._customEvents.next({
                    Event: "log",
                    Body: {
                        Message: "/" + context.command + "  " + context.responseTime + "ms (round trip)",
                        LogLevel: "INFORMATION"
                    },
                    Seq: -1,
                    Type: "log"
                });
            }));
        }
    }

    _createClass(ClientBase, [{
        key: "getCurrentRequests",
        value: function getCurrentRequests() {
            var response = [];
            this._currentRequests.forEach(function (request) {
                response.push({
                    command: request.command,
                    sequence: (0, _lodash.cloneDeep)(request.sequence),
                    request: request.request,
                    silent: request.silent,
                    duration: Date.now() - request.time.getTime()
                });
            });
            return response;
        }
    }, {
        key: "dispose",
        value: function dispose() {
            if (this._disposable.isDisposed) return;
            this.disconnect();
            this._disposable.dispose();
        }
    }, {
        key: "setupRequestStreams",
        value: function setupRequestStreams() {
            var _this2 = this;

            var priorityRequests = new _rxjs.BehaviorSubject(0),
                priorityResponses = new _rxjs.BehaviorSubject(0);
            var pauser = _rxjs.Observable.combineLatest(priorityRequests, priorityResponses, function (requests, responses) {
                if (requests > 0 && responses === requests) {
                    priorityRequests.next(0);
                    priorityResponses.next(0);
                    return true;
                } else if (requests > 0) {
                    return false;
                }
                return true;
            }).startWith(true).debounceTime(120).share();
            var deferredConcurrency = Math.max(Math.floor(this._options.concurrency / 4), 2);
            var deferredQueue = pausable(this._requestStream.filter(_prioritization.isDeferredCommand), pauser).map(function (request) {
                return _this2.handleResult(request);
            }).merge(deferredConcurrency);
            var normalQueue = pausable(this._requestStream.filter(_prioritization.isNormalCommand), pauser).map(function (request) {
                return _this2.handleResult(request);
            }).merge(this._options.concurrency);
            var priorityQueue = this._requestStream.filter(_prioritization.isPriorityCommand).do(function () {
                return priorityRequests.next(priorityRequests.getValue() + 1);
            }).map(function (request) {
                return _this2.handleResult(request, function () {
                    return priorityResponses.next(priorityResponses.getValue() + 1);
                });
            }).merge(this._options.concurrency);
            this._disposable.add(_rxjs.Observable.merge(deferredQueue, normalQueue, priorityQueue).subscribe());
        }
    }, {
        key: "handleResult",
        value: function handleResult(context, complete) {
            var _this3 = this;

            var result = this._driver.request(context.command, context.request);
            result.subscribe(function (data) {
                _this3._responseStream.next(new _contexts.ResponseContext(context, data));
            }, function (error) {
                _this3._errorStream.next(new _contexts.CommandContext(context.command, error));
                _this3._responseStream.next(new _contexts.ResponseContext(context, null, true));
                _this3._currentRequests.delete(context);
                if (complete) {
                    complete();
                    complete = null;
                }
            }, function () {
                _this3._currentRequests.delete(context);
                if (complete) {
                    complete();
                    complete = null;
                }
            });
            return result.timeout(this._options.concurrencyTimeout, _rxjs.Observable.empty());
        }
    }, {
        key: "log",
        value: function log(message, logLevel) {
            this._customEvents.next({
                Event: "log",
                Body: {
                    Message: message,
                    LogLevel: logLevel ? logLevel.toUpperCase() : "INFORMATION"
                },
                Seq: -1,
                Type: "log"
            });
        }
    }, {
        key: "connect",
        value: function connect() {
            if (this.currentState >= _enums.DriverState.Downloading && this.currentState <= _enums.DriverState.Connected) return;
            this._currentRequests.clear();
            this._driver.connect();
        }
    }, {
        key: "_resetDriver",
        value: function _resetDriver() {
            if (this._driver) {
                this._disposable.remove(this._driver);
                this._driver.dispose();
            }
            var driver = this._options.driver;

            var item = require("../drivers/" + _enums.Driver[driver].toLowerCase());
            var driverFactory = item[(0, _lodash.keys)(item)[0]];
            this._driver = new driverFactory(this._options);
            this._disposable.add(this._driver);
            return this._driver;
        }
    }, {
        key: "disconnect",
        value: function disconnect() {
            this._driver.disconnect();
        }
    }, {
        key: "request",
        value: function request(action, _request, options) {
            var _this4 = this;

            if (!options) options = {};
            (0, _lodash.defaults)(options, { oneBasedIndices: this._options.oneBasedIndices });
            if (this.currentState !== _enums.DriverState.Connected && this.currentState !== _enums.DriverState.Error) {
                var _ret = function () {
                    var response = new _rxjs.AsyncSubject();
                    _this4.state.filter(function (z) {
                        return z === _enums.DriverState.Connected;
                    }).take(1).subscribe(function (z) {
                        _this4.request(action, _request, options).subscribe(function (x) {
                            return response.next(x);
                        });
                    });
                    return {
                        v: response
                    };
                }();

                if ((typeof _ret === "undefined" ? "undefined" : _typeof(_ret)) === "object") return _ret.v;
            }
            var context = new _contexts.RequestContext(this._uniqueId, action, _request, options);
            this._requestStream.next(context);
            return context.getResponse(this._responseStream);
        }
    }, {
        key: "setupObservers",
        value: function setupObservers() {
            var _this5 = this;

            this._driver.events.subscribe(function (x) {
                if (_this5._eventWatchers.has(x.Event)) _this5._eventWatchers.get(x.Event)[0].next(x.Body);
            });
            this._enqueuedResponses.subscribe(function (x) {
                if (!x.silent && _this5._commandWatchers.has(x.command)) _this5._commandWatchers.get(x.command)[0].next(x);
            });
        }
    }, {
        key: "registerFixup",
        value: function registerFixup(func) {
            this._fixups.push(func);
        }
    }, {
        key: "_fixup",
        value: function _fixup(action, request, options) {
            (0, _lodash.each)(this._fixups, function (f) {
                return f(action, request, options);
            });
        }
    }, {
        key: "uniqueId",
        get: function get() {
            return this._uniqueId;
        }
    }, {
        key: "id",
        get: function get() {
            return this._driver.id;
        }
    }, {
        key: "serverPath",
        get: function get() {
            return this._driver.serverPath;
        }
    }, {
        key: "projectPath",
        get: function get() {
            return this._driver.projectPath;
        }
    }, {
        key: "runtime",
        get: function get() {
            return this._driver.runtime;
        }
    }, {
        key: "currentState",
        get: function get() {
            return this._driver.currentState;
        }
    }, {
        key: "events",
        get: function get() {
            return this._enqueuedEvents;
        }
    }, {
        key: "commands",
        get: function get() {
            return this._driver.commands;
        }
    }, {
        key: "state",
        get: function get() {
            return this._driver.state;
        }
    }, {
        key: "outstandingRequests",
        get: function get() {
            return this._currentRequests.size;
        }
    }, {
        key: "status",
        get: function get() {
            return this._statusStream;
        }
    }, {
        key: "requests",
        get: function get() {
            return this._requestStream;
        }
    }, {
        key: "responses",
        get: function get() {
            return this._enqueuedResponses;
        }
    }, {
        key: "errors",
        get: function get() {
            return this._errorStream;
        }
    }, {
        key: "observe",
        get: function get() {
            return this._observe;
        }
    }]);

    return ClientBase;
}();

exports.ClientBase = ClientBase;

ClientBase.serverLineNumbers = _responseHandling.serverLineNumbers;
ClientBase.serverLineNumberArrays = _responseHandling.serverLineNumberArrays;

var ClientEventsBase = exports.ClientEventsBase = function () {
    function ClientEventsBase(_client) {
        _classCallCheck(this, ClientEventsBase);

        this._client = _client;
    }

    _createClass(ClientEventsBase, [{
        key: "uniqueId",
        get: function get() {
            return this._client.uniqueId;
        }
    }, {
        key: "projectAdded",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "projectChanged",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "projectRemoved",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "error",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "msBuildProjectDiagnostics",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "packageRestoreStarted",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "packageRestoreFinished",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "unresolvedDependencies",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "events",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "commands",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "state",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "status",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "requests",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "responses",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }, {
        key: "errors",
        get: function get() {
            throw new Error("Implemented by decorator");
        }
    }]);

    return ClientEventsBase;
}();

__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "projectAdded", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "projectChanged", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "projectRemoved", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "error", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "msBuildProjectDiagnostics", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "packageRestoreStarted", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "packageRestoreFinished", null);
__decorate([_decorators.watchEvent], ClientEventsBase.prototype, "unresolvedDependencies", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "events", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "commands", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "state", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "status", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "requests", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "responses", null);
__decorate([_decorators.reference], ClientEventsBase.prototype, "errors", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jbGllbnRzL2NsaWVudC1iYXNlLmpzIiwibGliL2NsaWVudHMvY2xpZW50LWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFNQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWZBLElBQUksYUFBYSxTQUFDLElBQVEsVUFBSyxVQUFMLElBQW9CLFVBQVUsVUFBVixFQUFzQixNQUF0QixFQUE4QixHQUE5QixFQUFtQyxJQUFuQyxFQUF5QztBQUNuRixRQUFJLElBQUksVUFBVSxNQUFWO1FBQWtCLElBQUksSUFBSSxDQUFKLEdBQVEsTUFBUixHQUFpQixTQUFTLElBQVQsR0FBZ0IsT0FBTyxPQUFPLHdCQUFQLENBQWdDLE1BQWhDLEVBQXdDLEdBQXhDLENBQVAsR0FBc0QsSUFBdEU7UUFBNEUsQ0FBM0gsQ0FEbUY7QUFFbkYsUUFBSSxRQUFPLHlEQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU8sUUFBUSxRQUFSLEtBQXFCLFVBQTVCLEVBQXdDLElBQUksUUFBUSxRQUFSLENBQWlCLFVBQWpCLEVBQTZCLE1BQTdCLEVBQXFDLEdBQXJDLEVBQTBDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUksSUFBSSxXQUFXLE1BQVgsR0FBb0IsQ0FBcEIsRUFBdUIsS0FBSyxDQUFMLEVBQVEsR0FBNUM7QUFBaUQsWUFBSSxJQUFJLFdBQVcsQ0FBWCxDQUFKLEVBQW1CLElBQUksQ0FBQyxJQUFJLENBQUosR0FBUSxFQUFFLENBQUYsQ0FBUixHQUFlLElBQUksQ0FBSixHQUFRLEVBQUUsTUFBRixFQUFVLEdBQVYsRUFBZSxDQUFmLENBQVIsR0FBNEIsRUFBRSxNQUFGLEVBQVUsR0FBVixDQUE1QixDQUFoQixJQUErRCxDQUEvRCxDQUEzQjtLQUFqRCxPQUNFLElBQUksQ0FBSixJQUFTLENBQVQsSUFBYyxPQUFPLGNBQVAsQ0FBc0IsTUFBdEIsRUFBOEIsR0FBOUIsRUFBbUMsQ0FBbkMsQ0FBZCxFQUFxRCxDQUFyRCxDQUo0RTtDQUF6Qzs7QUNlOUMsU0FBQSxRQUFBLENBQXFCLGNBQXJCLEVBQW9ELE1BQXBELEVBQStFO0FBQzNFLFdBQU8sOEJBQW9CLG9CQUFRO0FBQy9CLFlBQUksZUFBSixDQUQrQjtBQUUvQixZQUFJLFFBQWUsRUFBZixDQUYyQjtBQUcvQixZQUFNLE1BQU0sd0JBQU4sQ0FIeUI7QUFLL0IsWUFBSSxHQUFKLENBQVEsT0FBTyxTQUFQLENBQWlCLHFCQUFTO0FBQzlCLHFCQUFTLENBQUMsU0FBRCxDQURxQjtBQUc5QixnQkFBSSxhQUFhLE1BQU0sTUFBTixFQUFjO0FBQzNCLGtDQUFLLEtBQUwsRUFBWTsyQkFBSyxTQUFTLElBQVQsQ0FBYyxDQUFkO2lCQUFMLENBQVosQ0FEMkI7QUFFM0Isd0JBQVEsRUFBUixDQUYyQjthQUEvQjtTQUhxQixDQUF6QixFQUwrQjtBQWMvQixZQUFJLEdBQUosQ0FBUSxlQUNILFNBREcsQ0FDTyxtQkFBTztBQUNkLGdCQUFJLE1BQUosRUFBWTtBQUNSLHNCQUFNLElBQU4sQ0FBVyxPQUFYLEVBRFE7YUFBWixNQUVPO0FBQ0gseUJBQVMsSUFBVCxDQUFjLE9BQWQsRUFERzthQUZQO1NBRE8sQ0FEZixFQWQrQjtBQXVCL0IsZUFBTyxHQUFQLENBdkIrQjtLQUFSLENBQTNCLENBRDJFO0NBQS9FOztJQTRCQTtBQWlFSSxhQWpFSixVQWlFSSxDQUFvQixRQUFwQixFQUFzRCxpQkFBdEQsRUFBaUg7Ozs4QkFqRXJILFlBaUVxSDs7QUFBN0YsYUFBQSxRQUFBLEdBQUEsUUFBQSxDQUE2RjtBQTVEekcsYUFBQSxjQUFBLEdBQWlCLG1CQUFqQixDQTREeUc7QUEzRHpHLGFBQUEsZUFBQSxHQUFrQixtQkFBbEIsQ0EyRHlHO0FBekR6RyxhQUFBLFlBQUEsR0FBZSxtQkFBZixDQXlEeUc7QUF4RHpHLGFBQUEsYUFBQSxHQUFnQixtQkFBaEIsQ0F3RHlHO0FBdkR6RyxhQUFBLFNBQUEsR0FBWSxzQkFBUyxRQUFULENBQVosQ0F1RHlHO0FBckR6RyxhQUFBLGNBQUEsR0FBaUIsSUFBSSxHQUFKLEVBQWpCLENBcUR5RztBQXBEekcsYUFBQSxnQkFBQSxHQUFtQixJQUFJLEdBQUosRUFBbkIsQ0FvRHlHO0FBbkR6RyxhQUFBLFdBQUEsR0FBYyxzQ0FBZCxDQW1EeUc7QUFqQ3pHLGFBQUEsZ0JBQUEsR0FBbUIsSUFBSSxHQUFKLEVBQW5CLENBaUN5RztBQWtPekcsYUFBQSxPQUFBLEdBQTZGLEVBQTdGLENBbE95RztBQUM3RyxpQkFBUyxNQUFULEdBQWtCLFNBQVMsTUFBVCxJQUFtQixjQUFPLEtBQVAsQ0FEd0U7QUFFN0csMkNBQW9CLFFBQXBCLEVBRjZHO0FBSzdHLGFBQUssWUFBTCxHQUw2RztBQWM3RyxhQUFLLGVBQUwsR0FBdUIsaUJBQVcsS0FBWCxDQUF3RSxLQUFLLGFBQUwsRUFBb0IsS0FBSyxPQUFMLENBQWEsTUFBYixDQUE1RixDQUNsQixHQURrQixDQUNkLGlCQUFLO0FBQ04sZ0JBQUksc0JBQVMsTUFBTSxJQUFOLENBQWIsRUFBMEI7QUFDdEIsdUJBQU8sTUFBUCxDQUFjLE1BQU0sSUFBTixDQUFkLENBRHNCO2FBQTFCO0FBR0EsbUJBQU8sT0FBTyxNQUFQLENBQWMsS0FBZCxDQUFQLENBSk07U0FBTCxDQURULENBZDZHO0FBc0I3RyxhQUFLLGtCQUFMLEdBQTBCLGlCQUFXLEtBQVgsQ0FDc0IsS0FBSyxlQUFMLEVBQzVDLEtBQUssT0FBTCxDQUFhLFFBQWIsQ0FDSyxHQURMLENBQ1M7bUJBQVUsOEJBQW9CLDZCQUFtQixNQUFLLFNBQUwsRUFBZ0IsT0FBTyxPQUFQLEVBQWdCLEVBQW5ELEVBQXVELEVBQXZELEVBQTJELFNBQTNELENBQXBCLEVBQTJGLE9BQU8sSUFBUDtTQUFyRyxDQUhhLENBQTFCLENBdEI2RztBQTJCN0csYUFBSyxpQkFBTCxHQUF5QixTQUFTLGVBQVQsR0FBMkIsQ0FBM0IsR0FBK0IsQ0FBL0IsQ0EzQm9GO0FBNkI3RyxhQUFLLFdBQUwsQ0FBaUIsR0FBakIsQ0FBcUIsS0FBSyxjQUFMLENBQW9CLFNBQXBCLENBQThCO21CQUFLLE1BQUssZ0JBQUwsQ0FBc0IsR0FBdEIsQ0FBMEIsQ0FBMUI7U0FBTCxDQUFuRCxFQTdCNkc7QUErQjdHLFlBQU0sa0JBQWtCLFNBQWxCLGVBQWtCO21CQUE4QjtBQUNsRCx1QkFBTyxNQUFLLE9BQUwsQ0FBYSxZQUFiO0FBQ1Asa0NBQWtCLE1BQUssbUJBQUw7QUFDbEIscUNBQXFCLE1BQUssbUJBQUwsR0FBMkIsQ0FBM0I7O1NBSEQsQ0EvQnFGO0FBcUM3RyxhQUFLLG1CQUFMLEdBckM2RztBQXNDN0csYUFBSyxjQUFMLEdBdEM2RztBQXdDN0csWUFBTSxTQUFTLGlCQUFXLEtBQVgsQ0FDVyxLQUFLLGNBQUwsRUFDQSxLQUFLLGVBQUwsQ0FGcEIsQ0F4Q3VHO0FBNEM3RyxhQUFLLGFBQUwsR0FBcUIsT0FDaEIsS0FEZ0IsQ0FDVixFQURVLEVBRWhCLEdBRmdCLENBRVosZUFGWSxFQUdoQixvQkFIZ0IsR0FJaEIsR0FKZ0IsQ0FJWixPQUFPLE1BQVAsQ0FKWSxDQUtoQixLQUxnQixFQUFyQixDQTVDNkc7QUFtRDdHLGFBQUssUUFBTCxHQUFnQixrQkFBa0IsSUFBbEIsQ0FBaEIsQ0FuRDZHO0FBcUQ3RyxZQUFJLEtBQUssUUFBTCxDQUFjLEtBQWQsRUFBcUI7QUFDckIsaUJBQUssV0FBTCxDQUFpQixHQUFqQixDQUFxQixLQUFLLGVBQUwsQ0FBcUIsU0FBckIsQ0FBK0IsbUJBQU87QUFFdkQsc0JBQUssYUFBTCxDQUFtQixJQUFuQixDQUF3QjtBQUNwQiwyQkFBTyxLQUFQO0FBQ0EsMEJBQU07QUFDRix1Q0FBYSxRQUFRLE9BQVIsVUFBb0IsUUFBUSxZQUFSLG9CQUFqQztBQUNBLGtDQUFVLGFBQVY7cUJBRko7QUFJQSx5QkFBSyxDQUFDLENBQUQ7QUFDTCwwQkFBTSxLQUFOO2lCQVBKLEVBRnVEO2FBQVAsQ0FBcEQsRUFEcUI7U0FBekI7S0FyREo7O2lCQWpFSjs7NkNBaUM2QjtBQUNyQixnQkFBTSxXQU1BLEVBTkEsQ0FEZTtBQVNyQixpQkFBSyxnQkFBTCxDQUFzQixPQUF0QixDQUE4QixtQkFBTztBQUNqQyx5QkFBUyxJQUFULENBQWM7QUFDViw2QkFBUyxRQUFRLE9BQVI7QUFDVCw4QkFBVSx1QkFBVSxRQUFRLFFBQVIsQ0FBcEI7QUFDQSw2QkFBUyxRQUFRLE9BQVI7QUFDVCw0QkFBUSxRQUFRLE1BQVI7QUFDUiw4QkFBVSxLQUFLLEdBQUwsS0FBYSxRQUFRLElBQVIsQ0FBYSxPQUFiLEVBQWI7aUJBTGQsRUFEaUM7YUFBUCxDQUE5QixDQVRxQjtBQW1CckIsbUJBQU8sUUFBUCxDQW5CcUI7Ozs7a0NBcUdYO0FBQ1YsZ0JBQUksS0FBSyxXQUFMLENBQWlCLFVBQWpCLEVBQTZCLE9BQWpDO0FBQ0EsaUJBQUssVUFBTCxHQUZVO0FBR1YsaUJBQUssV0FBTCxDQUFpQixPQUFqQixHQUhVOzs7OzhDQU1hOzs7QUFDdkIsZ0JBQU0sbUJBQW1CLDBCQUFvQixDQUFwQixDQUFuQjtnQkFBMkMsb0JBQW9CLDBCQUFvQixDQUFwQixDQUFwQixDQUQxQjtBQUd2QixnQkFBTSxTQUFTLGlCQUFXLGFBQVgsQ0FDYyxnQkFEZCxFQUVjLGlCQUZkLEVBR1gsVUFBQyxRQUFELEVBQVcsU0FBWCxFQUFvQjtBQUNoQixvQkFBSSxXQUFXLENBQVgsSUFBZ0IsY0FBYyxRQUFkLEVBQXdCO0FBQ3hDLHFDQUFpQixJQUFqQixDQUFzQixDQUF0QixFQUR3QztBQUV4QyxzQ0FBa0IsSUFBbEIsQ0FBdUIsQ0FBdkIsRUFGd0M7QUFHeEMsMkJBQU8sSUFBUCxDQUh3QztpQkFBNUMsTUFJTyxJQUFJLFdBQVcsQ0FBWCxFQUFjO0FBQ3JCLDJCQUFPLEtBQVAsQ0FEcUI7aUJBQWxCO0FBSVAsdUJBQU8sSUFBUCxDQVRnQjthQUFwQixDQUhXLENBY1YsU0FkVSxDQWNBLElBZEEsRUFlVixZQWZVLENBZUcsR0FmSCxFQWdCVixLQWhCVSxFQUFULENBSGlCO0FBc0J2QixnQkFBTSxzQkFBc0IsS0FBSyxHQUFMLENBQVMsS0FBSyxLQUFMLENBQVcsS0FBSyxRQUFMLENBQWMsV0FBZCxHQUE0QixDQUE1QixDQUFwQixFQUFvRCxDQUFwRCxDQUF0QixDQXRCaUI7QUEyQnZCLGdCQUFNLGdCQUFnQixTQUFTLEtBQUssY0FBTCxDQUFvQixNQUFwQixtQ0FBVCxFQUF3RCxNQUF4RCxFQUNqQixHQURpQixDQUNiO3VCQUFXLE9BQUssWUFBTCxDQUFrQixPQUFsQjthQUFYLENBRGEsQ0FFakIsS0FGaUIsQ0FFWCxtQkFGVyxDQUFoQixDQTNCaUI7QUFnQ3ZCLGdCQUFNLGNBQWMsU0FBUyxLQUFLLGNBQUwsQ0FBb0IsTUFBcEIsaUNBQVQsRUFBc0QsTUFBdEQsRUFDZixHQURlLENBQ1g7dUJBQVcsT0FBSyxZQUFMLENBQWtCLE9BQWxCO2FBQVgsQ0FEVyxDQUVmLEtBRmUsQ0FFVCxLQUFLLFFBQUwsQ0FBYyxXQUFkLENBRkwsQ0FoQ2lCO0FBc0N2QixnQkFBTSxnQkFBZ0IsS0FBSyxjQUFMLENBQ2pCLE1BRGlCLG9DQUVqQixFQUZpQixDQUVkO3VCQUFNLGlCQUFpQixJQUFqQixDQUFzQixpQkFBaUIsUUFBakIsS0FBOEIsQ0FBOUI7YUFBNUIsQ0FGYyxDQUdqQixHQUhpQixDQUdiO3VCQUFXLE9BQUssWUFBTCxDQUFrQixPQUFsQixFQUEyQjsyQkFBTSxrQkFBa0IsSUFBbEIsQ0FBdUIsa0JBQWtCLFFBQWxCLEtBQStCLENBQS9CO2lCQUE3QjthQUF0QyxDQUhhLENBSWpCLEtBSmlCLENBSVgsS0FBSyxRQUFMLENBQWMsV0FBZCxDQUpMLENBdENpQjtBQTRDdkIsaUJBQUssV0FBTCxDQUFpQixHQUFqQixDQUFxQixpQkFBVyxLQUFYLENBQWlCLGFBQWpCLEVBQWdDLFdBQWhDLEVBQTZDLGFBQTdDLEVBQTRELFNBQTVELEVBQXJCLEVBNUN1Qjs7OztxQ0ErQ04sU0FBOEIsVUFBcUI7OztBQUdwRSxnQkFBTSxTQUFnRCxLQUFLLE9BQUwsQ0FBYSxPQUFiLENBQStCLFFBQVEsT0FBUixFQUFpQixRQUFRLE9BQVIsQ0FBaEcsQ0FIOEQ7QUFJcEUsbUJBQU8sU0FBUCxDQUFpQixVQUFDLElBQUQsRUFBSztBQUNsQix1QkFBSyxlQUFMLENBQXFCLElBQXJCLENBQTBCLDhCQUFvQixPQUFwQixFQUE2QixJQUE3QixDQUExQixFQURrQjthQUFMLEVBRWQsVUFBQyxLQUFELEVBQU07QUFDTCx1QkFBSyxZQUFMLENBQWtCLElBQWxCLENBQXVCLDZCQUFtQixRQUFRLE9BQVIsRUFBaUIsS0FBcEMsQ0FBdkIsRUFESztBQUVMLHVCQUFLLGVBQUwsQ0FBcUIsSUFBckIsQ0FBMEIsOEJBQW9CLE9BQXBCLEVBQTZCLElBQTdCLEVBQW1DLElBQW5DLENBQTFCLEVBRks7QUFHTCx1QkFBSyxnQkFBTCxDQUFzQixNQUF0QixDQUE2QixPQUE3QixFQUhLO0FBSUwsb0JBQUksUUFBSixFQUFjO0FBQ1YsK0JBRFU7QUFFViwrQkFBVyxJQUFYLENBRlU7aUJBQWQ7YUFKRCxFQVFBLFlBQUE7QUFDQyx1QkFBSyxnQkFBTCxDQUFzQixNQUF0QixDQUE2QixPQUE3QixFQUREO0FBRUMsb0JBQUksUUFBSixFQUFjO0FBQ1YsK0JBRFU7QUFFViwrQkFBVyxJQUFYLENBRlU7aUJBQWQ7YUFGRCxDQVZILENBSm9FO0FBc0JwRSxtQkFBTyxPQUdGLE9BSEUsQ0FHTSxLQUFLLFFBQUwsQ0FBYyxrQkFBZCxFQUFrQyxpQkFBVyxLQUFYLEVBSHhDLENBQVAsQ0F0Qm9FOzs7OzRCQTRCN0QsU0FBaUIsVUFBaUI7QUFFekMsaUJBQUssYUFBTCxDQUFtQixJQUFuQixDQUF3QjtBQUNwQix1QkFBTyxLQUFQO0FBQ0Esc0JBQU07QUFDRiw2QkFBUyxPQUFUO0FBQ0EsOEJBQVUsV0FBVyxTQUFTLFdBQVQsRUFBWCxHQUFvQyxhQUFwQztpQkFGZDtBQUlBLHFCQUFLLENBQUMsQ0FBRDtBQUNMLHNCQUFNLEtBQU47YUFQSixFQUZ5Qzs7OztrQ0FhL0I7QUFFVixnQkFBSSxLQUFLLFlBQUwsSUFBcUIsbUJBQVksV0FBWixJQUEyQixLQUFLLFlBQUwsSUFBcUIsbUJBQVksU0FBWixFQUF1QixPQUFoRztBQUdBLGlCQUFLLGdCQUFMLENBQXNCLEtBQXRCLEdBTFU7QUFNVixpQkFBSyxPQUFMLENBQWEsT0FBYixHQU5VOzs7O3VDQVNNO0FBQ2hCLGdCQUFJLEtBQUssT0FBTCxFQUFjO0FBQ2QscUJBQUssV0FBTCxDQUFpQixNQUFqQixDQUF3QixLQUFLLE9BQUwsQ0FBeEIsQ0FEYztBQUVkLHFCQUFLLE9BQUwsQ0FBYSxPQUFiLEdBRmM7YUFBbEI7Z0JBS08sU0FBVSxLQUFLLFFBQUwsQ0FBVixPQU5TOztBQU9oQixnQkFBTSxPQUFPLFFBQVEsZ0JBQWdCLGNBQU8sTUFBUCxFQUFlLFdBQWYsRUFBaEIsQ0FBZixDQVBVO0FBUWhCLGdCQUFNLGdCQUErQixLQUFLLGtCQUFLLElBQUwsRUFBVyxDQUFYLENBQUwsQ0FBL0IsQ0FSVTtBQVNoQixpQkFBSyxPQUFMLEdBQWUsSUFBSSxhQUFKLENBQWtCLEtBQUssUUFBTCxDQUFqQyxDQVRnQjtBQVVoQixpQkFBSyxXQUFMLENBQWlCLEdBQWpCLENBQXFCLEtBQUssT0FBTCxDQUFyQixDQVZnQjtBQVloQixtQkFBTyxLQUFLLE9BQUwsQ0FaUzs7OztxQ0FlSDtBQUNiLGlCQUFLLE9BQUwsQ0FBYSxVQUFiLEdBRGE7Ozs7Z0NBSW1CLFFBQWdCLFVBQW1CLFNBQWtDOzs7QUFDckcsZ0JBQUksQ0FBQyxPQUFELEVBQVUsVUFBb0MsRUFBcEMsQ0FBZDtBQUNBLGtDQUFTLE9BQVQsRUFBa0IsRUFBRSxpQkFBaUIsS0FBSyxRQUFMLENBQWMsZUFBZCxFQUFyQyxFQUZxRztBQUtyRyxnQkFBSSxLQUFLLFlBQUwsS0FBc0IsbUJBQVksU0FBWixJQUF5QixLQUFLLFlBQUwsS0FBc0IsbUJBQVksS0FBWixFQUFtQjs7QUFDeEYsd0JBQU0sV0FBVyx3QkFBWDtBQUVOLDJCQUFLLEtBQUwsQ0FBVyxNQUFYLENBQWtCOytCQUFLLE1BQU0sbUJBQVksU0FBWjtxQkFBWCxDQUFsQixDQUNLLElBREwsQ0FDVSxDQURWLEVBRUssU0FGTCxDQUVlLGFBQUM7QUFDUiwrQkFBSyxPQUFMLENBQWtDLE1BQWxDLEVBQTBDLFFBQTFDLEVBQW1ELE9BQW5ELEVBQTRELFNBQTVELENBQXNFO21DQUFLLFNBQVMsSUFBVCxDQUFjLENBQWQ7eUJBQUwsQ0FBdEUsQ0FEUTtxQkFBRCxDQUZmO0FBTUE7MkJBQW1DO3FCQUFuQztvQkFUd0Y7OzthQUE1RjtBQVlBLGdCQUFNLFVBQVUsNkJBQW1CLEtBQUssU0FBTCxFQUFnQixNQUFuQyxFQUEyQyxRQUEzQyxFQUFvRCxPQUFwRCxDQUFWLENBakIrRjtBQWtCckcsaUJBQUssY0FBTCxDQUFvQixJQUFwQixDQUF5QixPQUF6QixFQWxCcUc7QUFvQnJHLG1CQUFPLFFBQVEsV0FBUixDQUFxRCxLQUFLLGVBQUwsQ0FBNUQsQ0FwQnFHOzs7O3lDQXVCbkY7OztBQUNsQixpQkFBSyxPQUFMLENBQWEsTUFBYixDQUFvQixTQUFwQixDQUE4QixhQUFDO0FBQzNCLG9CQUFJLE9BQUssY0FBTCxDQUFvQixHQUFwQixDQUF3QixFQUFFLEtBQUYsQ0FBNUIsRUFDSSxPQUFLLGNBQUwsQ0FBb0IsR0FBcEIsQ0FBd0IsRUFBRSxLQUFGLENBQXhCLENBQWlDLENBQWpDLEVBQW9DLElBQXBDLENBQXlDLEVBQUUsSUFBRixDQUF6QyxDQURKO2FBRDBCLENBQTlCLENBRGtCO0FBTWxCLGlCQUFLLGtCQUFMLENBQXdCLFNBQXhCLENBQWtDLGFBQUM7QUFDL0Isb0JBQUksQ0FBQyxFQUFFLE1BQUYsSUFBWSxPQUFLLGdCQUFMLENBQXNCLEdBQXRCLENBQTBCLEVBQUUsT0FBRixDQUF2QyxFQUNBLE9BQUssZ0JBQUwsQ0FBc0IsR0FBdEIsQ0FBMEIsRUFBRSxPQUFGLENBQTFCLENBQXFDLENBQXJDLEVBQXdDLElBQXhDLENBQTZDLENBQTdDLEVBREo7YUFEOEIsQ0FBbEMsQ0FOa0I7Ozs7c0NBYUQsTUFBZ0Y7QUFDakcsaUJBQUssT0FBTCxDQUFhLElBQWIsQ0FBa0IsSUFBbEIsRUFEaUc7Ozs7K0JBSzVFLFFBQWdCLFNBQW1CLFNBQWtDO0FBQzFGLDhCQUFLLEtBQUssT0FBTCxFQUFjO3VCQUFLLEVBQUUsTUFBRixFQUFVLE9BQVYsRUFBbUIsT0FBbkI7YUFBTCxDQUFuQixDQUQwRjs7Ozs0QkF4UjNFO0FBQUssbUJBQU8sS0FBSyxTQUFMLENBQVo7Ozs7NEJBRU47QUFBSyxtQkFBTyxLQUFLLE9BQUwsQ0FBYSxFQUFiLENBQVo7Ozs7NEJBQ1E7QUFBSyxtQkFBTyxLQUFLLE9BQUwsQ0FBYSxVQUFiLENBQVo7Ozs7NEJBQ0M7QUFBSyxtQkFBTyxLQUFLLE9BQUwsQ0FBYSxXQUFiLENBQVo7Ozs7NEJBQ0o7QUFBYyxtQkFBTyxLQUFLLE9BQUwsQ0FBYSxPQUFiLENBQXJCOzs7OzRCQUVLO0FBQUssbUJBQU8sS0FBSyxPQUFMLENBQWEsWUFBYixDQUFaOzs7OzRCQUVOO0FBQXVELG1CQUFPLEtBQUssZUFBTCxDQUE5RDs7Ozs0QkFDRTtBQUEwRCxtQkFBTyxLQUFLLE9BQUwsQ0FBYSxRQUFiLENBQWpFOzs7OzRCQUNIO0FBQThCLG1CQUFPLEtBQUssT0FBTCxDQUFhLEtBQWIsQ0FBckM7Ozs7NEJBRWM7QUFBSyxtQkFBTyxLQUFLLGdCQUFMLENBQXNCLElBQXRCLENBQVo7Ozs7NEJBeUJiO0FBQXdDLG1CQUFPLEtBQUssYUFBTCxDQUEvQzs7Ozs0QkFDRTtBQUFzQyxtQkFBNkMsS0FBSyxjQUFMLENBQW5GOzs7OzRCQUdDO0FBQTRDLG1CQUFPLEtBQUssa0JBQUwsQ0FBbkQ7Ozs7NEJBQ0g7QUFBc0MsbUJBQTZDLEtBQUssWUFBTCxDQUFuRjs7Ozs0QkFHQztBQUFjLG1CQUFPLEtBQUssUUFBTCxDQUFyQjs7OztXQS9EdEI7Ozs7O0FBQ2tCLFdBQUEsaUJBQUE7QUFDQSxXQUFBLHNCQUFBOztJQXFUbEI7QUFDSSxhQURKLGdCQUNJLENBQW9CLE9BQXBCLEVBQWdDOzhCQURwQyxrQkFDb0M7O0FBQVosYUFBQSxPQUFBLEdBQUEsT0FBQSxDQUFZO0tBQWhDOztpQkFESjs7NEJBR3VCO0FBQUssbUJBQU8sS0FBSyxPQUFMLENBQWEsUUFBYixDQUFaOzs7OzRCQUVnQjtBQUE4RCxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQTlEOzs7OzRCQUNFO0FBQThELGtCQUFNLElBQUksS0FBSixDQUFVLDBCQUFWLENBQU4sQ0FBOUQ7Ozs7NEJBQ0E7QUFBOEQsa0JBQU0sSUFBSSxLQUFKLENBQVUsMEJBQVYsQ0FBTixDQUE5RDs7Ozs0QkFDVDtBQUFnRCxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQWhEOzs7OzRCQUNvQjtBQUE2RCxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQTdEOzs7OzRCQUNKO0FBQXlELGtCQUFNLElBQUksS0FBSixDQUFVLDBCQUFWLENBQU4sQ0FBekQ7Ozs7NEJBQ0M7QUFBeUQsa0JBQU0sSUFBSSxLQUFKLENBQVUsMEJBQVYsQ0FBTixDQUF6RDs7Ozs0QkFDQTtBQUFpRSxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQWpFOzs7OzRCQUVqQjtBQUF1RCxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQXZEOzs7OzRCQUNFO0FBQTBELGtCQUFNLElBQUksS0FBSixDQUFVLDBCQUFWLENBQU4sQ0FBMUQ7Ozs7NEJBQ0g7QUFBOEIsa0JBQU0sSUFBSSxLQUFKLENBQVUsMEJBQVYsQ0FBTixDQUE5Qjs7Ozs0QkFDQztBQUF3QyxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQXhDOzs7OzRCQUNFO0FBQXNDLGtCQUFNLElBQUksS0FBSixDQUFVLDBCQUFWLENBQU4sQ0FBdEM7Ozs7NEJBQ0M7QUFBNEMsa0JBQU0sSUFBSSxLQUFKLENBQVUsMEJBQVYsQ0FBTixDQUE1Qzs7Ozs0QkFDSDtBQUFzQyxrQkFBTSxJQUFJLEtBQUosQ0FBVSwwQkFBVixDQUFOLENBQXRDOzs7O1dBcEJoQzs7O0FBS0ksV0FBQSx3QkFBQSxFRHRGRCxpQkFBaUIsU0FBakIsRUFBNEIsY0NzRjNCLEVEdEYyQyxJQ3NGM0M7QUFDQSxXQUFBLHdCQUFBLEVEcEZELGlCQUFpQixTQUFqQixFQUE0QixnQkNvRjNCLEVEcEY2QyxJQ29GN0M7QUFDQSxXQUFBLHdCQUFBLEVEbEZELGlCQUFpQixTQUFqQixFQUE0QixnQkNrRjNCLEVEbEY2QyxJQ2tGN0M7QUFDQSxXQUFBLHdCQUFBLEVEaEZELGlCQUFpQixTQUFqQixFQUE0QixPQ2dGM0IsRURoRm9DLElDZ0ZwQztBQUNBLFdBQUEsd0JBQUEsRUQ5RUQsaUJBQWlCLFNBQWpCLEVBQTRCLDJCQzhFM0IsRUQ5RXdELElDOEV4RDtBQUNBLFdBQUEsd0JBQUEsRUQ1RUQsaUJBQWlCLFNBQWpCLEVBQTRCLHVCQzRFM0IsRUQ1RW9ELElDNEVwRDtBQUNBLFdBQUEsd0JBQUEsRUQxRUQsaUJBQWlCLFNBQWpCLEVBQTRCLHdCQzBFM0IsRUQxRXFELElDMEVyRDtBQUNBLFdBQUEsd0JBQUEsRUR4RUQsaUJBQWlCLFNBQWpCLEVBQTRCLHdCQ3dFM0IsRUR4RXFELElDd0VyRDtBQUVBLFdBQUEsdUJBQUEsRUR2RUQsaUJBQWlCLFNBQWpCLEVBQTRCLFFDdUUzQixFRHZFcUMsSUN1RXJDO0FBQ0EsV0FBQSx1QkFBQSxFRHJFRCxpQkFBaUIsU0FBakIsRUFBNEIsVUNxRTNCLEVEckV1QyxJQ3FFdkM7QUFDQSxXQUFBLHVCQUFBLEVEbkVELGlCQUFpQixTQUFqQixFQUE0QixPQ21FM0IsRURuRW9DLElDbUVwQztBQUNBLFdBQUEsdUJBQUEsRURqRUQsaUJBQWlCLFNBQWpCLEVBQTRCLFFDaUUzQixFRGpFcUMsSUNpRXJDO0FBQ0EsV0FBQSx1QkFBQSxFRC9ERCxpQkFBaUIsU0FBakIsRUFBNEIsVUMrRDNCLEVEL0R1QyxJQytEdkM7QUFDQSxXQUFBLHVCQUFBLEVEN0RELGlCQUFpQixTQUFqQixFQUE0QixXQzZEM0IsRUQ3RHdDLElDNkR4QztBQUNBLFdBQUEsdUJBQUEsRUQzREQsaUJBQWlCLFNBQWpCLEVBQTRCLFFDMkQzQixFRDNEcUMsSUMyRHJDIiwiZmlsZSI6ImxpYi9jbGllbnRzL2NsaWVudC1iYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgQXN5bmNTdWJqZWN0LCBCZWhhdmlvclN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSBcIi4uL2Rpc3Bvc2FibGVzXCI7XG5pbXBvcnQgeyBrZXlzLCBpc09iamVjdCwgdW5pcXVlSWQsIGVhY2gsIGRlZmF1bHRzLCBjbG9uZURlZXAgfSBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgeyBEcml2ZXIsIERyaXZlclN0YXRlIH0gZnJvbSBcIi4uL2VudW1zXCI7XG5pbXBvcnQgeyBSZXF1ZXN0Q29udGV4dCwgUmVzcG9uc2VDb250ZXh0LCBDb21tYW5kQ29udGV4dCB9IGZyb20gXCIuLi9jb250ZXh0c1wiO1xuaW1wb3J0IHsgc2VydmVyTGluZU51bWJlcnMsIHNlcnZlckxpbmVOdW1iZXJBcnJheXMgfSBmcm9tIFwiLi4vcmVzcG9uc2UtaGFuZGxpbmdcIjtcbmltcG9ydCB7IGVuc3VyZUNsaWVudE9wdGlvbnMgfSBmcm9tIFwiLi4vb3B0aW9uc1wiO1xuaW1wb3J0IHsgd2F0Y2hFdmVudCwgcmVmZXJlbmNlIH0gZnJvbSBcIi4uL2RlY29yYXRvcnNcIjtcbmltcG9ydCB7IGlzUHJpb3JpdHlDb21tYW5kLCBpc05vcm1hbENvbW1hbmQsIGlzRGVmZXJyZWRDb21tYW5kIH0gZnJvbSBcIi4uL2hlbHBlcnMvcHJpb3JpdGl6YXRpb25cIjtcbmltcG9ydCB7IGNyZWF0ZU9ic2VydmFibGUgfSBmcm9tIFwiLi4vb3BlcmF0b3JzL2NyZWF0ZVwiO1xuZnVuY3Rpb24gcGF1c2FibGUoaW5jb21pbmdTdHJlYW0sIHBhdXNlcikge1xuICAgIHJldHVybiBjcmVhdGVPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcbiAgICAgICAgbGV0IHBhdXNlZDtcbiAgICAgICAgbGV0IHF1ZXVlID0gW107XG4gICAgICAgIGNvbnN0IHN1YiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgICAgICAgc3ViLmFkZChwYXVzZXIuc3Vic2NyaWJlKHNob3VsZFJ1biA9PiB7XG4gICAgICAgICAgICBwYXVzZWQgPSAhc2hvdWxkUnVuO1xuICAgICAgICAgICAgaWYgKHNob3VsZFJ1biAmJiBxdWV1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBlYWNoKHF1ZXVlLCByID0+IG9ic2VydmVyLm5leHQocikpO1xuICAgICAgICAgICAgICAgIHF1ZXVlID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICAgICAgc3ViLmFkZChpbmNvbWluZ1N0cmVhbVxuICAgICAgICAgICAgLnN1YnNjcmliZShyZXF1ZXN0ID0+IHtcbiAgICAgICAgICAgIGlmIChwYXVzZWQpIHtcbiAgICAgICAgICAgICAgICBxdWV1ZS5wdXNoKHJlcXVlc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXF1ZXN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuICAgICAgICByZXR1cm4gc3ViO1xuICAgIH0pO1xufVxuZXhwb3J0IGNsYXNzIENsaWVudEJhc2Uge1xuICAgIGNvbnN0cnVjdG9yKF9vcHRpb25zLCBvYnNlcnZhYmxlRmFjdG9yeSkge1xuICAgICAgICB0aGlzLl9vcHRpb25zID0gX29wdGlvbnM7XG4gICAgICAgIHRoaXMuX3JlcXVlc3RTdHJlYW0gPSBuZXcgU3ViamVjdCgpO1xuICAgICAgICB0aGlzLl9yZXNwb25zZVN0cmVhbSA9IG5ldyBTdWJqZWN0KCk7XG4gICAgICAgIHRoaXMuX2Vycm9yU3RyZWFtID0gbmV3IFN1YmplY3QoKTtcbiAgICAgICAgdGhpcy5fY3VzdG9tRXZlbnRzID0gbmV3IFN1YmplY3QoKTtcbiAgICAgICAgdGhpcy5fdW5pcXVlSWQgPSB1bmlxdWVJZChcImNsaWVudFwiKTtcbiAgICAgICAgdGhpcy5fZXZlbnRXYXRjaGVycyA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy5fY29tbWFuZFdhdGNoZXJzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICAgICAgdGhpcy5fY3VycmVudFJlcXVlc3RzID0gbmV3IFNldCgpO1xuICAgICAgICB0aGlzLl9maXh1cHMgPSBbXTtcbiAgICAgICAgX29wdGlvbnMuZHJpdmVyID0gX29wdGlvbnMuZHJpdmVyIHx8IERyaXZlci5TdGRpbztcbiAgICAgICAgZW5zdXJlQ2xpZW50T3B0aW9ucyhfb3B0aW9ucyk7XG4gICAgICAgIHRoaXMuX3Jlc2V0RHJpdmVyKCk7XG4gICAgICAgIHRoaXMuX2VucXVldWVkRXZlbnRzID0gT2JzZXJ2YWJsZS5tZXJnZSh0aGlzLl9jdXN0b21FdmVudHMsIHRoaXMuX2RyaXZlci5ldmVudHMpXG4gICAgICAgICAgICAubWFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgIGlmIChpc09iamVjdChldmVudC5Cb2R5KSkge1xuICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZXZlbnQuQm9keSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmZyZWV6ZShldmVudCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9lbnF1ZXVlZFJlc3BvbnNlcyA9IE9ic2VydmFibGUubWVyZ2UodGhpcy5fcmVzcG9uc2VTdHJlYW0sIHRoaXMuX2RyaXZlci5jb21tYW5kc1xuICAgICAgICAgICAgLm1hcChwYWNrZXQgPT4gbmV3IFJlc3BvbnNlQ29udGV4dChuZXcgUmVxdWVzdENvbnRleHQodGhpcy5fdW5pcXVlSWQsIHBhY2tldC5Db21tYW5kLCB7fSwge30sIFwiY29tbWFuZFwiKSwgcGFja2V0LkJvZHkpKSk7XG4gICAgICAgIHRoaXMuX2xvd2VzdEluZGV4VmFsdWUgPSBfb3B0aW9ucy5vbmVCYXNlZEluZGljZXMgPyAxIDogMDtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQodGhpcy5fcmVxdWVzdFN0cmVhbS5zdWJzY3JpYmUoeCA9PiB0aGlzLl9jdXJyZW50UmVxdWVzdHMuYWRkKHgpKSk7XG4gICAgICAgIGNvbnN0IGdldFN0YXR1c1ZhbHVlcyA9ICgpID0+ICh7XG4gICAgICAgICAgICBzdGF0ZTogdGhpcy5fZHJpdmVyLmN1cnJlbnRTdGF0ZSxcbiAgICAgICAgICAgIG91dGdvaW5nUmVxdWVzdHM6IHRoaXMub3V0c3RhbmRpbmdSZXF1ZXN0cyxcbiAgICAgICAgICAgIGhhc091dGdvaW5nUmVxdWVzdHM6IHRoaXMub3V0c3RhbmRpbmdSZXF1ZXN0cyA+IDBcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2V0dXBSZXF1ZXN0U3RyZWFtcygpO1xuICAgICAgICB0aGlzLnNldHVwT2JzZXJ2ZXJzKCk7XG4gICAgICAgIGNvbnN0IHN0YXR1cyA9IE9ic2VydmFibGUubWVyZ2UodGhpcy5fcmVxdWVzdFN0cmVhbSwgdGhpcy5fcmVzcG9uc2VTdHJlYW0pO1xuICAgICAgICB0aGlzLl9zdGF0dXNTdHJlYW0gPSBzdGF0dXNcbiAgICAgICAgICAgIC5kZWxheSgxMClcbiAgICAgICAgICAgIC5tYXAoZ2V0U3RhdHVzVmFsdWVzKVxuICAgICAgICAgICAgLmRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgICAgICAgIC5tYXAoT2JqZWN0LmZyZWV6ZSlcbiAgICAgICAgICAgIC5zaGFyZSgpO1xuICAgICAgICB0aGlzLl9vYnNlcnZlID0gb2JzZXJ2YWJsZUZhY3RvcnkodGhpcyk7XG4gICAgICAgIGlmICh0aGlzLl9vcHRpb25zLmRlYnVnKSB7XG4gICAgICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZCh0aGlzLl9yZXNwb25zZVN0cmVhbS5zdWJzY3JpYmUoY29udGV4dCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY3VzdG9tRXZlbnRzLm5leHQoe1xuICAgICAgICAgICAgICAgICAgICBFdmVudDogXCJsb2dcIixcbiAgICAgICAgICAgICAgICAgICAgQm9keToge1xuICAgICAgICAgICAgICAgICAgICAgICAgTWVzc2FnZTogYC8ke2NvbnRleHQuY29tbWFuZH0gICR7Y29udGV4dC5yZXNwb25zZVRpbWV9bXMgKHJvdW5kIHRyaXApYCxcbiAgICAgICAgICAgICAgICAgICAgICAgIExvZ0xldmVsOiBcIklORk9STUFUSU9OXCJcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgU2VxOiAtMSxcbiAgICAgICAgICAgICAgICAgICAgVHlwZTogXCJsb2dcIlxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldCB1bmlxdWVJZCgpIHsgcmV0dXJuIHRoaXMuX3VuaXF1ZUlkOyB9XG4gICAgZ2V0IGlkKCkgeyByZXR1cm4gdGhpcy5fZHJpdmVyLmlkOyB9XG4gICAgZ2V0IHNlcnZlclBhdGgoKSB7IHJldHVybiB0aGlzLl9kcml2ZXIuc2VydmVyUGF0aDsgfVxuICAgIGdldCBwcm9qZWN0UGF0aCgpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5wcm9qZWN0UGF0aDsgfVxuICAgIGdldCBydW50aW1lKCkgeyByZXR1cm4gdGhpcy5fZHJpdmVyLnJ1bnRpbWU7IH1cbiAgICBnZXQgY3VycmVudFN0YXRlKCkgeyByZXR1cm4gdGhpcy5fZHJpdmVyLmN1cnJlbnRTdGF0ZTsgfVxuICAgIGdldCBldmVudHMoKSB7IHJldHVybiB0aGlzLl9lbnF1ZXVlZEV2ZW50czsgfVxuICAgIGdldCBjb21tYW5kcygpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5jb21tYW5kczsgfVxuICAgIGdldCBzdGF0ZSgpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5zdGF0ZTsgfVxuICAgIGdldCBvdXRzdGFuZGluZ1JlcXVlc3RzKCkgeyByZXR1cm4gdGhpcy5fY3VycmVudFJlcXVlc3RzLnNpemU7IH1cbiAgICBnZXRDdXJyZW50UmVxdWVzdHMoKSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gW107XG4gICAgICAgIHRoaXMuX2N1cnJlbnRSZXF1ZXN0cy5mb3JFYWNoKHJlcXVlc3QgPT4ge1xuICAgICAgICAgICAgcmVzcG9uc2UucHVzaCh7XG4gICAgICAgICAgICAgICAgY29tbWFuZDogcmVxdWVzdC5jb21tYW5kLFxuICAgICAgICAgICAgICAgIHNlcXVlbmNlOiBjbG9uZURlZXAocmVxdWVzdC5zZXF1ZW5jZSksXG4gICAgICAgICAgICAgICAgcmVxdWVzdDogcmVxdWVzdC5yZXF1ZXN0LFxuICAgICAgICAgICAgICAgIHNpbGVudDogcmVxdWVzdC5zaWxlbnQsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSByZXF1ZXN0LnRpbWUuZ2V0VGltZSgpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG4gICAgZ2V0IHN0YXR1cygpIHsgcmV0dXJuIHRoaXMuX3N0YXR1c1N0cmVhbTsgfVxuICAgIGdldCByZXF1ZXN0cygpIHsgcmV0dXJuIHRoaXMuX3JlcXVlc3RTdHJlYW07IH1cbiAgICBnZXQgcmVzcG9uc2VzKCkgeyByZXR1cm4gdGhpcy5fZW5xdWV1ZWRSZXNwb25zZXM7IH1cbiAgICBnZXQgZXJyb3JzKCkgeyByZXR1cm4gdGhpcy5fZXJyb3JTdHJlYW07IH1cbiAgICBnZXQgb2JzZXJ2ZSgpIHsgcmV0dXJuIHRoaXMuX29ic2VydmU7IH1cbiAgICBkaXNwb3NlKCkge1xuICAgICAgICBpZiAodGhpcy5fZGlzcG9zYWJsZS5pc0Rpc3Bvc2VkKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgfVxuICAgIHNldHVwUmVxdWVzdFN0cmVhbXMoKSB7XG4gICAgICAgIGNvbnN0IHByaW9yaXR5UmVxdWVzdHMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KDApLCBwcmlvcml0eVJlc3BvbnNlcyA9IG5ldyBCZWhhdmlvclN1YmplY3QoMCk7XG4gICAgICAgIGNvbnN0IHBhdXNlciA9IE9ic2VydmFibGUuY29tYmluZUxhdGVzdChwcmlvcml0eVJlcXVlc3RzLCBwcmlvcml0eVJlc3BvbnNlcywgKHJlcXVlc3RzLCByZXNwb25zZXMpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0cyA+IDAgJiYgcmVzcG9uc2VzID09PSByZXF1ZXN0cykge1xuICAgICAgICAgICAgICAgIHByaW9yaXR5UmVxdWVzdHMubmV4dCgwKTtcbiAgICAgICAgICAgICAgICBwcmlvcml0eVJlc3BvbnNlcy5uZXh0KDApO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAocmVxdWVzdHMgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pXG4gICAgICAgICAgICAuc3RhcnRXaXRoKHRydWUpXG4gICAgICAgICAgICAuZGVib3VuY2VUaW1lKDEyMClcbiAgICAgICAgICAgIC5zaGFyZSgpO1xuICAgICAgICBjb25zdCBkZWZlcnJlZENvbmN1cnJlbmN5ID0gTWF0aC5tYXgoTWF0aC5mbG9vcih0aGlzLl9vcHRpb25zLmNvbmN1cnJlbmN5IC8gNCksIDIpO1xuICAgICAgICBjb25zdCBkZWZlcnJlZFF1ZXVlID0gcGF1c2FibGUodGhpcy5fcmVxdWVzdFN0cmVhbS5maWx0ZXIoaXNEZWZlcnJlZENvbW1hbmQpLCBwYXVzZXIpXG4gICAgICAgICAgICAubWFwKHJlcXVlc3QgPT4gdGhpcy5oYW5kbGVSZXN1bHQocmVxdWVzdCkpXG4gICAgICAgICAgICAubWVyZ2UoZGVmZXJyZWRDb25jdXJyZW5jeSk7XG4gICAgICAgIGNvbnN0IG5vcm1hbFF1ZXVlID0gcGF1c2FibGUodGhpcy5fcmVxdWVzdFN0cmVhbS5maWx0ZXIoaXNOb3JtYWxDb21tYW5kKSwgcGF1c2VyKVxuICAgICAgICAgICAgLm1hcChyZXF1ZXN0ID0+IHRoaXMuaGFuZGxlUmVzdWx0KHJlcXVlc3QpKVxuICAgICAgICAgICAgLm1lcmdlKHRoaXMuX29wdGlvbnMuY29uY3VycmVuY3kpO1xuICAgICAgICBjb25zdCBwcmlvcml0eVF1ZXVlID0gdGhpcy5fcmVxdWVzdFN0cmVhbVxuICAgICAgICAgICAgLmZpbHRlcihpc1ByaW9yaXR5Q29tbWFuZClcbiAgICAgICAgICAgIC5kbygoKSA9PiBwcmlvcml0eVJlcXVlc3RzLm5leHQocHJpb3JpdHlSZXF1ZXN0cy5nZXRWYWx1ZSgpICsgMSkpXG4gICAgICAgICAgICAubWFwKHJlcXVlc3QgPT4gdGhpcy5oYW5kbGVSZXN1bHQocmVxdWVzdCwgKCkgPT4gcHJpb3JpdHlSZXNwb25zZXMubmV4dChwcmlvcml0eVJlc3BvbnNlcy5nZXRWYWx1ZSgpICsgMSkpKVxuICAgICAgICAgICAgLm1lcmdlKHRoaXMuX29wdGlvbnMuY29uY3VycmVuY3kpO1xuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChPYnNlcnZhYmxlLm1lcmdlKGRlZmVycmVkUXVldWUsIG5vcm1hbFF1ZXVlLCBwcmlvcml0eVF1ZXVlKS5zdWJzY3JpYmUoKSk7XG4gICAgfVxuICAgIGhhbmRsZVJlc3VsdChjb250ZXh0LCBjb21wbGV0ZSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9kcml2ZXIucmVxdWVzdChjb250ZXh0LmNvbW1hbmQsIGNvbnRleHQucmVxdWVzdCk7XG4gICAgICAgIHJlc3VsdC5zdWJzY3JpYmUoKGRhdGEpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3Jlc3BvbnNlU3RyZWFtLm5leHQobmV3IFJlc3BvbnNlQ29udGV4dChjb250ZXh0LCBkYXRhKSk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fZXJyb3JTdHJlYW0ubmV4dChuZXcgQ29tbWFuZENvbnRleHQoY29udGV4dC5jb21tYW5kLCBlcnJvcikpO1xuICAgICAgICAgICAgdGhpcy5fcmVzcG9uc2VTdHJlYW0ubmV4dChuZXcgUmVzcG9uc2VDb250ZXh0KGNvbnRleHQsIG51bGwsIHRydWUpKTtcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRSZXF1ZXN0cy5kZWxldGUoY29udGV4dCk7XG4gICAgICAgICAgICBpZiAoY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICBjb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fY3VycmVudFJlcXVlc3RzLmRlbGV0ZShjb250ZXh0KTtcbiAgICAgICAgICAgIGlmIChjb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgY29tcGxldGUgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgICAgICAgLnRpbWVvdXQodGhpcy5fb3B0aW9ucy5jb25jdXJyZW5jeVRpbWVvdXQsIE9ic2VydmFibGUuZW1wdHkoKSk7XG4gICAgfVxuICAgIGxvZyhtZXNzYWdlLCBsb2dMZXZlbCkge1xuICAgICAgICB0aGlzLl9jdXN0b21FdmVudHMubmV4dCh7XG4gICAgICAgICAgICBFdmVudDogXCJsb2dcIixcbiAgICAgICAgICAgIEJvZHk6IHtcbiAgICAgICAgICAgICAgICBNZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgICAgICAgICAgIExvZ0xldmVsOiBsb2dMZXZlbCA/IGxvZ0xldmVsLnRvVXBwZXJDYXNlKCkgOiBcIklORk9STUFUSU9OXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBTZXE6IC0xLFxuICAgICAgICAgICAgVHlwZTogXCJsb2dcIlxuICAgICAgICB9KTtcbiAgICB9XG4gICAgY29ubmVjdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0YXRlID49IERyaXZlclN0YXRlLkRvd25sb2FkaW5nICYmIHRoaXMuY3VycmVudFN0YXRlIDw9IERyaXZlclN0YXRlLkNvbm5lY3RlZClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5fY3VycmVudFJlcXVlc3RzLmNsZWFyKCk7XG4gICAgICAgIHRoaXMuX2RyaXZlci5jb25uZWN0KCk7XG4gICAgfVxuICAgIF9yZXNldERyaXZlcigpIHtcbiAgICAgICAgaWYgKHRoaXMuX2RyaXZlcikge1xuICAgICAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5yZW1vdmUodGhpcy5fZHJpdmVyKTtcbiAgICAgICAgICAgIHRoaXMuX2RyaXZlci5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBkcml2ZXIgfSA9IHRoaXMuX29wdGlvbnM7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSByZXF1aXJlKFwiLi4vZHJpdmVycy9cIiArIERyaXZlcltkcml2ZXJdLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICBjb25zdCBkcml2ZXJGYWN0b3J5ID0gaXRlbVtrZXlzKGl0ZW0pWzBdXTtcbiAgICAgICAgdGhpcy5fZHJpdmVyID0gbmV3IGRyaXZlckZhY3RvcnkodGhpcy5fb3B0aW9ucyk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKHRoaXMuX2RyaXZlcik7XG4gICAgICAgIHJldHVybiB0aGlzLl9kcml2ZXI7XG4gICAgfVxuICAgIGRpc2Nvbm5lY3QoKSB7XG4gICAgICAgIHRoaXMuX2RyaXZlci5kaXNjb25uZWN0KCk7XG4gICAgfVxuICAgIHJlcXVlc3QoYWN0aW9uLCByZXF1ZXN0LCBvcHRpb25zKSB7XG4gICAgICAgIGlmICghb3B0aW9ucylcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7fTtcbiAgICAgICAgZGVmYXVsdHMob3B0aW9ucywgeyBvbmVCYXNlZEluZGljZXM6IHRoaXMuX29wdGlvbnMub25lQmFzZWRJbmRpY2VzIH0pO1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RhdGUgIT09IERyaXZlclN0YXRlLkNvbm5lY3RlZCAmJiB0aGlzLmN1cnJlbnRTdGF0ZSAhPT0gRHJpdmVyU3RhdGUuRXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IEFzeW5jU3ViamVjdCgpO1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5maWx0ZXIoeiA9PiB6ID09PSBEcml2ZXJTdGF0ZS5Db25uZWN0ZWQpXG4gICAgICAgICAgICAgICAgLnRha2UoMSlcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKHogPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdChhY3Rpb24sIHJlcXVlc3QsIG9wdGlvbnMpLnN1YnNjcmliZSh4ID0+IHJlc3BvbnNlLm5leHQoeCkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29udGV4dCA9IG5ldyBSZXF1ZXN0Q29udGV4dCh0aGlzLl91bmlxdWVJZCwgYWN0aW9uLCByZXF1ZXN0LCBvcHRpb25zKTtcbiAgICAgICAgdGhpcy5fcmVxdWVzdFN0cmVhbS5uZXh0KGNvbnRleHQpO1xuICAgICAgICByZXR1cm4gY29udGV4dC5nZXRSZXNwb25zZSh0aGlzLl9yZXNwb25zZVN0cmVhbSk7XG4gICAgfVxuICAgIHNldHVwT2JzZXJ2ZXJzKCkge1xuICAgICAgICB0aGlzLl9kcml2ZXIuZXZlbnRzLnN1YnNjcmliZSh4ID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9ldmVudFdhdGNoZXJzLmhhcyh4LkV2ZW50KSlcbiAgICAgICAgICAgICAgICB0aGlzLl9ldmVudFdhdGNoZXJzLmdldCh4LkV2ZW50KVswXS5uZXh0KHguQm9keSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9lbnF1ZXVlZFJlc3BvbnNlcy5zdWJzY3JpYmUoeCA9PiB7XG4gICAgICAgICAgICBpZiAoIXguc2lsZW50ICYmIHRoaXMuX2NvbW1hbmRXYXRjaGVycy5oYXMoeC5jb21tYW5kKSlcbiAgICAgICAgICAgICAgICB0aGlzLl9jb21tYW5kV2F0Y2hlcnMuZ2V0KHguY29tbWFuZClbMF0ubmV4dCh4KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJlZ2lzdGVyRml4dXAoZnVuYykge1xuICAgICAgICB0aGlzLl9maXh1cHMucHVzaChmdW5jKTtcbiAgICB9XG4gICAgX2ZpeHVwKGFjdGlvbiwgcmVxdWVzdCwgb3B0aW9ucykge1xuICAgICAgICBlYWNoKHRoaXMuX2ZpeHVwcywgZiA9PiBmKGFjdGlvbiwgcmVxdWVzdCwgb3B0aW9ucykpO1xuICAgIH1cbn1cbkNsaWVudEJhc2Uuc2VydmVyTGluZU51bWJlcnMgPSBzZXJ2ZXJMaW5lTnVtYmVycztcbkNsaWVudEJhc2Uuc2VydmVyTGluZU51bWJlckFycmF5cyA9IHNlcnZlckxpbmVOdW1iZXJBcnJheXM7XG5leHBvcnQgY2xhc3MgQ2xpZW50RXZlbnRzQmFzZSB7XG4gICAgY29uc3RydWN0b3IoX2NsaWVudCkge1xuICAgICAgICB0aGlzLl9jbGllbnQgPSBfY2xpZW50O1xuICAgIH1cbiAgICBnZXQgdW5pcXVlSWQoKSB7IHJldHVybiB0aGlzLl9jbGllbnQudW5pcXVlSWQ7IH1cbiAgICBnZXQgcHJvamVjdEFkZGVkKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgcHJvamVjdENoYW5nZWQoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBwcm9qZWN0UmVtb3ZlZCgpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IGVycm9yKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgbXNCdWlsZFByb2plY3REaWFnbm9zdGljcygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHBhY2thZ2VSZXN0b3JlU3RhcnRlZCgpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHBhY2thZ2VSZXN0b3JlRmluaXNoZWQoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCB1bnJlc29sdmVkRGVwZW5kZW5jaWVzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgZXZlbnRzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgY29tbWFuZHMoKSB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIGdldCBzdGF0ZSgpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHN0YXR1cygpIHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgZ2V0IHJlcXVlc3RzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgcmVzcG9uc2VzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBnZXQgZXJyb3JzKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbn1cbl9fZGVjb3JhdGUoW1xuICAgIHdhdGNoRXZlbnRcbl0sIENsaWVudEV2ZW50c0Jhc2UucHJvdG90eXBlLCBcInByb2plY3RBZGRlZFwiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIHdhdGNoRXZlbnRcbl0sIENsaWVudEV2ZW50c0Jhc2UucHJvdG90eXBlLCBcInByb2plY3RDaGFuZ2VkXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgd2F0Y2hFdmVudFxuXSwgQ2xpZW50RXZlbnRzQmFzZS5wcm90b3R5cGUsIFwicHJvamVjdFJlbW92ZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICB3YXRjaEV2ZW50XG5dLCBDbGllbnRFdmVudHNCYXNlLnByb3RvdHlwZSwgXCJlcnJvclwiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIHdhdGNoRXZlbnRcbl0sIENsaWVudEV2ZW50c0Jhc2UucHJvdG90eXBlLCBcIm1zQnVpbGRQcm9qZWN0RGlhZ25vc3RpY3NcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICB3YXRjaEV2ZW50XG5dLCBDbGllbnRFdmVudHNCYXNlLnByb3RvdHlwZSwgXCJwYWNrYWdlUmVzdG9yZVN0YXJ0ZWRcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICB3YXRjaEV2ZW50XG5dLCBDbGllbnRFdmVudHNCYXNlLnByb3RvdHlwZSwgXCJwYWNrYWdlUmVzdG9yZUZpbmlzaGVkXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgd2F0Y2hFdmVudFxuXSwgQ2xpZW50RXZlbnRzQmFzZS5wcm90b3R5cGUsIFwidW5yZXNvbHZlZERlcGVuZGVuY2llc1wiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIHJlZmVyZW5jZVxuXSwgQ2xpZW50RXZlbnRzQmFzZS5wcm90b3R5cGUsIFwiZXZlbnRzXCIsIG51bGwpO1xuX19kZWNvcmF0ZShbXG4gICAgcmVmZXJlbmNlXG5dLCBDbGllbnRFdmVudHNCYXNlLnByb3RvdHlwZSwgXCJjb21tYW5kc1wiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIHJlZmVyZW5jZVxuXSwgQ2xpZW50RXZlbnRzQmFzZS5wcm90b3R5cGUsIFwic3RhdGVcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICByZWZlcmVuY2Vcbl0sIENsaWVudEV2ZW50c0Jhc2UucHJvdG90eXBlLCBcInN0YXR1c1wiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIHJlZmVyZW5jZVxuXSwgQ2xpZW50RXZlbnRzQmFzZS5wcm90b3R5cGUsIFwicmVxdWVzdHNcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICByZWZlcmVuY2Vcbl0sIENsaWVudEV2ZW50c0Jhc2UucHJvdG90eXBlLCBcInJlc3BvbnNlc1wiLCBudWxsKTtcbl9fZGVjb3JhdGUoW1xuICAgIHJlZmVyZW5jZVxuXSwgQ2xpZW50RXZlbnRzQmFzZS5wcm90b3R5cGUsIFwiZXJyb3JzXCIsIG51bGwpO1xuIiwiaW1wb3J0ICogYXMgT21uaVNoYXJwIGZyb20gXCIuLi9vbW5pc2hhcnAtc2VydmVyXCI7XG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3QsIEFzeW5jU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0LCBTdWJzY3JpcHRpb259IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQge0lEaXNwb3NhYmxlLCBDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tIFwiLi4vZGlzcG9zYWJsZXNcIjtcbmltcG9ydCB7a2V5cywgaXNPYmplY3QsIHVuaXF1ZUlkLCBlYWNoLCBkZWZhdWx0cywgY2xvbmVEZWVwfSBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQge0lEcml2ZXIsIElTdGF0aWNEcml2ZXIsIE9tbmlzaGFycENsaWVudFN0YXR1cywgT21uaXNoYXJwQ2xpZW50T3B0aW9uc30gZnJvbSBcIi4uL2VudW1zXCI7XG4vKmltcG9ydCB7SU9tbmlzaGFycFBsdWdpbiwgaXNQbHVnaW5Ecml2ZXJ9IGZyb20gXCIuLi9lbnVtc1wiOyovXG5pbXBvcnQge0RyaXZlciwgRHJpdmVyU3RhdGUsIFJ1bnRpbWV9IGZyb20gXCIuLi9lbnVtc1wiO1xuaW1wb3J0IHtSZXF1ZXN0Q29udGV4dCwgUmVzcG9uc2VDb250ZXh0LCBDb21tYW5kQ29udGV4dH0gZnJvbSBcIi4uL2NvbnRleHRzXCI7XG5pbXBvcnQge3NlcnZlckxpbmVOdW1iZXJzLCBzZXJ2ZXJMaW5lTnVtYmVyQXJyYXlzfSBmcm9tIFwiLi4vcmVzcG9uc2UtaGFuZGxpbmdcIjtcbmltcG9ydCB7ZW5zdXJlQ2xpZW50T3B0aW9uc30gZnJvbSBcIi4uL29wdGlvbnNcIjtcbmltcG9ydCB7d2F0Y2hFdmVudCwgcmVmZXJlbmNlfSBmcm9tIFwiLi4vZGVjb3JhdG9yc1wiO1xuaW1wb3J0IHtpc1ByaW9yaXR5Q29tbWFuZCwgaXNOb3JtYWxDb21tYW5kLCBpc0RlZmVycmVkQ29tbWFuZH0gZnJvbSBcIi4uL2hlbHBlcnMvcHJpb3JpdGl6YXRpb25cIjtcbmltcG9ydCB7Y3JlYXRlT2JzZXJ2YWJsZX0gZnJvbSBcIi4uL29wZXJhdG9ycy9jcmVhdGVcIjtcbi8vaW1wb3J0IHtQbHVnaW5NYW5hZ2VyfSBmcm9tIFwiLi4vaGVscGVycy9wbHVnaW4tbWFuYWdlclwiO1xuLy9cbmZ1bmN0aW9uIHBhdXNhYmxlPFQ+KGluY29taW5nU3RyZWFtOiBPYnNlcnZhYmxlPFQ+LCBwYXVzZXI6IE9ic2VydmFibGU8Ym9vbGVhbj4pIHtcbiAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZTxUPihvYnNlcnZlciA9PiB7XG4gICAgICAgIGxldCBwYXVzZWQ6IGJvb2xlYW47XG4gICAgICAgIGxldCBxdWV1ZTogYW55W10gPSBbXTtcbiAgICAgICAgY29uc3Qgc3ViID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gICAgICAgIHN1Yi5hZGQocGF1c2VyLnN1YnNjcmliZShzaG91bGRSdW4gPT4ge1xuICAgICAgICAgICAgcGF1c2VkID0gIXNob3VsZFJ1bjtcblxuICAgICAgICAgICAgaWYgKHNob3VsZFJ1biAmJiBxdWV1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBlYWNoKHF1ZXVlLCByID0+IG9ic2VydmVyLm5leHQocikpO1xuICAgICAgICAgICAgICAgIHF1ZXVlID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKTtcblxuICAgICAgICBzdWIuYWRkKGluY29taW5nU3RyZWFtXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHJlcXVlc3QgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwYXVzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVldWUucHVzaChyZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICByZXR1cm4gc3ViO1xuICAgIH0pO1xufVxuXG5leHBvcnQgY2xhc3MgQ2xpZW50QmFzZTxURXZlbnRzIGV4dGVuZHMgQ2xpZW50RXZlbnRzQmFzZT4gaW1wbGVtZW50cyBJRHJpdmVyLCBJRGlzcG9zYWJsZSB7XG4gICAgcHVibGljIHN0YXRpYyBzZXJ2ZXJMaW5lTnVtYmVycyA9IHNlcnZlckxpbmVOdW1iZXJzO1xuICAgIHB1YmxpYyBzdGF0aWMgc2VydmVyTGluZU51bWJlckFycmF5cyA9IHNlcnZlckxpbmVOdW1iZXJBcnJheXM7XG5cbiAgICBwcml2YXRlIF9kcml2ZXI6IElEcml2ZXI7XG4gICAgcHJpdmF0ZSBfcmVxdWVzdFN0cmVhbSA9IG5ldyBTdWJqZWN0PFJlcXVlc3RDb250ZXh0PGFueT4+KCk7XG4gICAgcHJpdmF0ZSBfcmVzcG9uc2VTdHJlYW0gPSBuZXcgU3ViamVjdDxSZXNwb25zZUNvbnRleHQ8YW55LCBhbnk+PigpO1xuICAgIHByaXZhdGUgX3N0YXR1c1N0cmVhbTogT2JzZXJ2YWJsZTxPbW5pc2hhcnBDbGllbnRTdGF0dXM+O1xuICAgIHByaXZhdGUgX2Vycm9yU3RyZWFtID0gbmV3IFN1YmplY3Q8Q29tbWFuZENvbnRleHQ8YW55Pj4oKTtcbiAgICBwcml2YXRlIF9jdXN0b21FdmVudHMgPSBuZXcgU3ViamVjdDxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuRXZlbnRQYWNrZXQ+KCk7XG4gICAgcHJpdmF0ZSBfdW5pcXVlSWQgPSB1bmlxdWVJZChcImNsaWVudFwiKTtcbiAgICBwcm90ZWN0ZWQgX2xvd2VzdEluZGV4VmFsdWU6IG51bWJlcjtcbiAgICBwcml2YXRlIF9ldmVudFdhdGNoZXJzID0gbmV3IE1hcDxzdHJpbmcsIFtTdWJqZWN0PENvbW1hbmRDb250ZXh0PGFueT4+LCBPYnNlcnZhYmxlPENvbW1hbmRDb250ZXh0PGFueT4+XT4oKTtcbiAgICBwcml2YXRlIF9jb21tYW5kV2F0Y2hlcnMgPSBuZXcgTWFwPHN0cmluZywgW1N1YmplY3Q8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj4sIE9ic2VydmFibGU8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj5dPigpO1xuICAgIHByaXZhdGUgX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIC8vcHJpdmF0ZSBfcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcjtcblxuICAgIHB1YmxpYyBnZXQgdW5pcXVlSWQoKSB7IHJldHVybiB0aGlzLl91bmlxdWVJZDsgfVxuXG4gICAgcHVibGljIGdldCBpZCgpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5pZDsgfVxuICAgIHB1YmxpYyBnZXQgc2VydmVyUGF0aCgpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5zZXJ2ZXJQYXRoOyB9XG4gICAgcHVibGljIGdldCBwcm9qZWN0UGF0aCgpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5wcm9qZWN0UGF0aDsgfVxuICAgIHB1YmxpYyBnZXQgcnVudGltZSgpOiBSdW50aW1lIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5ydW50aW1lOyB9XG5cbiAgICBwdWJsaWMgZ2V0IGN1cnJlbnRTdGF0ZSgpIHsgcmV0dXJuIHRoaXMuX2RyaXZlci5jdXJyZW50U3RhdGU7IH1cbiAgICBwcml2YXRlIF9lbnF1ZXVlZEV2ZW50czogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuRXZlbnRQYWNrZXQ+O1xuICAgIHB1YmxpYyBnZXQgZXZlbnRzKCk6IE9ic2VydmFibGU8T21uaVNoYXJwLlN0ZGlvLlByb3RvY29sLkV2ZW50UGFja2V0PiB7IHJldHVybiB0aGlzLl9lbnF1ZXVlZEV2ZW50czsgfVxuICAgIHB1YmxpYyBnZXQgY29tbWFuZHMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuUmVzcG9uc2VQYWNrZXQ+IHsgcmV0dXJuIHRoaXMuX2RyaXZlci5jb21tYW5kczsgfVxuICAgIHB1YmxpYyBnZXQgc3RhdGUoKTogT2JzZXJ2YWJsZTxEcml2ZXJTdGF0ZT4geyByZXR1cm4gdGhpcy5fZHJpdmVyLnN0YXRlOyB9XG5cbiAgICBwdWJsaWMgZ2V0IG91dHN0YW5kaW5nUmVxdWVzdHMoKSB7IHJldHVybiB0aGlzLl9jdXJyZW50UmVxdWVzdHMuc2l6ZTsgfVxuXG4gICAgcHJpdmF0ZSBfY3VycmVudFJlcXVlc3RzID0gbmV3IFNldDxSZXF1ZXN0Q29udGV4dDxhbnk+PigpO1xuICAgIHB1YmxpYyBnZXRDdXJyZW50UmVxdWVzdHMoKSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlOiB7XG4gICAgICAgICAgICBjb21tYW5kOiBzdHJpbmc7XG4gICAgICAgICAgICBzZXF1ZW5jZTogc3RyaW5nO1xuICAgICAgICAgICAgc2lsZW50OiBib29sZWFuO1xuICAgICAgICAgICAgcmVxdWVzdDogYW55O1xuICAgICAgICAgICAgZHVyYXRpb246IG51bWJlcjtcbiAgICAgICAgfVtdID0gW107XG5cbiAgICAgICAgdGhpcy5fY3VycmVudFJlcXVlc3RzLmZvckVhY2gocmVxdWVzdCA9PiB7XG4gICAgICAgICAgICByZXNwb25zZS5wdXNoKHtcbiAgICAgICAgICAgICAgICBjb21tYW5kOiByZXF1ZXN0LmNvbW1hbmQsXG4gICAgICAgICAgICAgICAgc2VxdWVuY2U6IGNsb25lRGVlcChyZXF1ZXN0LnNlcXVlbmNlKSxcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiByZXF1ZXN0LnJlcXVlc3QsXG4gICAgICAgICAgICAgICAgc2lsZW50OiByZXF1ZXN0LnNpbGVudCxcbiAgICAgICAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHJlcXVlc3QudGltZS5nZXRUaW1lKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzdGF0dXMoKTogT2JzZXJ2YWJsZTxPbW5pc2hhcnBDbGllbnRTdGF0dXM+IHsgcmV0dXJuIHRoaXMuX3N0YXR1c1N0cmVhbTsgfVxuICAgIHB1YmxpYyBnZXQgcmVxdWVzdHMoKTogT2JzZXJ2YWJsZTxSZXF1ZXN0Q29udGV4dDxhbnk+PiB7IHJldHVybiA8T2JzZXJ2YWJsZTxSZXF1ZXN0Q29udGV4dDxhbnk+Pj48YW55PnRoaXMuX3JlcXVlc3RTdHJlYW07IH1cblxuICAgIHByaXZhdGUgX2VucXVldWVkUmVzcG9uc2VzOiBPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+O1xuICAgIHB1YmxpYyBnZXQgcmVzcG9uc2VzKCk6IE9ic2VydmFibGU8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj4geyByZXR1cm4gdGhpcy5fZW5xdWV1ZWRSZXNwb25zZXM7IH1cbiAgICBwdWJsaWMgZ2V0IGVycm9ycygpOiBPYnNlcnZhYmxlPENvbW1hbmRDb250ZXh0PGFueT4+IHsgcmV0dXJuIDxPYnNlcnZhYmxlPENvbW1hbmRDb250ZXh0PGFueT4+Pjxhbnk+dGhpcy5fZXJyb3JTdHJlYW07IH1cblxuICAgIHByaXZhdGUgX29ic2VydmU6IFRFdmVudHM7XG4gICAgcHVibGljIGdldCBvYnNlcnZlKCk6IFRFdmVudHMgeyByZXR1cm4gdGhpcy5fb2JzZXJ2ZTsgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfb3B0aW9uczogT21uaXNoYXJwQ2xpZW50T3B0aW9ucywgb2JzZXJ2YWJsZUZhY3Rvcnk6IChjbGllbnQ6IENsaWVudEJhc2U8VEV2ZW50cz4pID0+IFRFdmVudHMpIHtcbiAgICAgICAgX29wdGlvbnMuZHJpdmVyID0gX29wdGlvbnMuZHJpdmVyIHx8IERyaXZlci5TdGRpbztcbiAgICAgICAgZW5zdXJlQ2xpZW50T3B0aW9ucyhfb3B0aW9ucyk7XG5cbiAgICAgICAgLy90aGlzLl9wbHVnaW5NYW5hZ2VyID0gbmV3IFBsdWdpbk1hbmFnZXIoX29wdGlvbnMucGx1Z2lucyk7XG4gICAgICAgIHRoaXMuX3Jlc2V0RHJpdmVyKCk7XG5cbiAgICAgICAgLyp0aGlzLl9kaXNwb3NhYmxlLmFkZCh0aGlzLl9wbHVnaW5NYW5hZ2VyLmNoYW5nZWQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRyaXZlciA9IHRoaXMuX2RyaXZlcjtcbiAgICAgICAgICAgIGlmIChpc1BsdWdpbkRyaXZlcihkcml2ZXIpKSB7XG4gICAgICAgICAgICAgICAgZHJpdmVyLnVwZGF0ZVBsdWdpbnModGhpcy5fcGx1Z2luTWFuYWdlci5wbHVnaW5zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpOyovXG5cbiAgICAgICAgdGhpcy5fZW5xdWV1ZWRFdmVudHMgPSBPYnNlcnZhYmxlLm1lcmdlKDxPYnNlcnZhYmxlPE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldD4+PGFueT50aGlzLl9jdXN0b21FdmVudHMsIHRoaXMuX2RyaXZlci5ldmVudHMpXG4gICAgICAgICAgICAubWFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoZXZlbnQuQm9keSkpIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShldmVudC5Cb2R5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoZXZlbnQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fZW5xdWV1ZWRSZXNwb25zZXMgPSBPYnNlcnZhYmxlLm1lcmdlKFxuICAgICAgICAgICAgPE9ic2VydmFibGU8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj4+PGFueT50aGlzLl9yZXNwb25zZVN0cmVhbSxcbiAgICAgICAgICAgIHRoaXMuX2RyaXZlci5jb21tYW5kc1xuICAgICAgICAgICAgICAgIC5tYXAocGFja2V0ID0+IG5ldyBSZXNwb25zZUNvbnRleHQobmV3IFJlcXVlc3RDb250ZXh0KHRoaXMuX3VuaXF1ZUlkLCBwYWNrZXQuQ29tbWFuZCwge30sIHt9LCBcImNvbW1hbmRcIiksIHBhY2tldC5Cb2R5KSkpO1xuXG4gICAgICAgIHRoaXMuX2xvd2VzdEluZGV4VmFsdWUgPSBfb3B0aW9ucy5vbmVCYXNlZEluZGljZXMgPyAxIDogMDtcblxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZCh0aGlzLl9yZXF1ZXN0U3RyZWFtLnN1YnNjcmliZSh4ID0+IHRoaXMuX2N1cnJlbnRSZXF1ZXN0cy5hZGQoeCkpKTtcblxuICAgICAgICBjb25zdCBnZXRTdGF0dXNWYWx1ZXMgPSAoKSA9PiA8T21uaXNoYXJwQ2xpZW50U3RhdHVzPih7XG4gICAgICAgICAgICBzdGF0ZTogdGhpcy5fZHJpdmVyLmN1cnJlbnRTdGF0ZSxcbiAgICAgICAgICAgIG91dGdvaW5nUmVxdWVzdHM6IHRoaXMub3V0c3RhbmRpbmdSZXF1ZXN0cyxcbiAgICAgICAgICAgIGhhc091dGdvaW5nUmVxdWVzdHM6IHRoaXMub3V0c3RhbmRpbmdSZXF1ZXN0cyA+IDBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zZXR1cFJlcXVlc3RTdHJlYW1zKCk7XG4gICAgICAgIHRoaXMuc2V0dXBPYnNlcnZlcnMoKTtcblxuICAgICAgICBjb25zdCBzdGF0dXMgPSBPYnNlcnZhYmxlLm1lcmdlKFxuICAgICAgICAgICAgPE9ic2VydmFibGU8YW55Pj48YW55PnRoaXMuX3JlcXVlc3RTdHJlYW0sXG4gICAgICAgICAgICA8T2JzZXJ2YWJsZTxhbnk+Pjxhbnk+dGhpcy5fcmVzcG9uc2VTdHJlYW0pO1xuXG4gICAgICAgIHRoaXMuX3N0YXR1c1N0cmVhbSA9IHN0YXR1c1xuICAgICAgICAgICAgLmRlbGF5KDEwKVxuICAgICAgICAgICAgLm1hcChnZXRTdGF0dXNWYWx1ZXMpXG4gICAgICAgICAgICAuZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgICAgICAgLm1hcChPYmplY3QuZnJlZXplKVxuICAgICAgICAgICAgLnNoYXJlKCk7XG5cbiAgICAgICAgdGhpcy5fb2JzZXJ2ZSA9IG9ic2VydmFibGVGYWN0b3J5KHRoaXMpO1xuXG4gICAgICAgIGlmICh0aGlzLl9vcHRpb25zLmRlYnVnKSB7XG4gICAgICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZCh0aGlzLl9yZXNwb25zZVN0cmVhbS5zdWJzY3JpYmUoY29udGV4dCA9PiB7XG4gICAgICAgICAgICAgICAgLy8gbG9nIG91ciBjb21wbGV0ZSByZXNwb25zZSB0aW1lXG4gICAgICAgICAgICAgICAgdGhpcy5fY3VzdG9tRXZlbnRzLm5leHQoe1xuICAgICAgICAgICAgICAgICAgICBFdmVudDogXCJsb2dcIixcbiAgICAgICAgICAgICAgICAgICAgQm9keToge1xuICAgICAgICAgICAgICAgICAgICAgICAgTWVzc2FnZTogYC8ke2NvbnRleHQuY29tbWFuZH0gICR7Y29udGV4dC5yZXNwb25zZVRpbWV9bXMgKHJvdW5kIHRyaXApYCxcbiAgICAgICAgICAgICAgICAgICAgICAgIExvZ0xldmVsOiBcIklORk9STUFUSU9OXCJcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgU2VxOiAtMSxcbiAgICAgICAgICAgICAgICAgICAgVHlwZTogXCJsb2dcIlxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLl9kaXNwb3NhYmxlLmlzRGlzcG9zZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0dXBSZXF1ZXN0U3RyZWFtcygpIHtcbiAgICAgICAgY29uc3QgcHJpb3JpdHlSZXF1ZXN0cyA9IG5ldyBCZWhhdmlvclN1YmplY3QoMCksIHByaW9yaXR5UmVzcG9uc2VzID0gbmV3IEJlaGF2aW9yU3ViamVjdCgwKTtcblxuICAgICAgICBjb25zdCBwYXVzZXIgPSBPYnNlcnZhYmxlLmNvbWJpbmVMYXRlc3QoXG4gICAgICAgICAgICA8T2JzZXJ2YWJsZTxudW1iZXI+Pjxhbnk+cHJpb3JpdHlSZXF1ZXN0cyxcbiAgICAgICAgICAgIDxPYnNlcnZhYmxlPG51bWJlcj4+PGFueT5wcmlvcml0eVJlc3BvbnNlcyxcbiAgICAgICAgICAgIChyZXF1ZXN0cywgcmVzcG9uc2VzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlcXVlc3RzID4gMCAmJiByZXNwb25zZXMgPT09IHJlcXVlc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgIHByaW9yaXR5UmVxdWVzdHMubmV4dCgwKTtcbiAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHlSZXNwb25zZXMubmV4dCgwKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0cyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5zdGFydFdpdGgodHJ1ZSlcbiAgICAgICAgICAgIC5kZWJvdW5jZVRpbWUoMTIwKVxuICAgICAgICAgICAgLnNoYXJlKCk7XG5cbiAgICAgICAgLy8gS2VlcCBkZWZlcnJlZCBjb25jdXJyZW5jeSBhdCBhIG1pbiBvZiB0d28sIHRoaXMgbGV0cyB1cyBnZXQgYXJvdW5kIGxvbmcgcnVubmluZyByZXF1ZXN0cyBqYW1taW5nIHRoZSBwaXBlcy5cbiAgICAgICAgY29uc3QgZGVmZXJyZWRDb25jdXJyZW5jeSA9IE1hdGgubWF4KE1hdGguZmxvb3IodGhpcy5fb3B0aW9ucy5jb25jdXJyZW5jeSAvIDQpLCAyKTtcblxuICAgICAgICAvLyBUaGVzZSBhcmUgb3BlcmF0aW9ucyB0aGF0IHNob3VsZCB3YWl0IHVudGlsIGFmdGVyXG4gICAgICAgIC8vIHdlIGhhdmUgZXhlY3V0ZWQgYWxsIHRoZSBjdXJyZW50IHByaW9yaXR5IGNvbW1hbmRzXG4gICAgICAgIC8vIFdlIGFsc28gZGVmZXIgc2lsZW50IGNvbW1hbmRzIHRvIHRoaXMgcXVldWUsIGFzIHRoZXkgYXJlIGdlbmVyYWxseSBmb3IgXCJiYWNrZ3JvdW5kXCIgd29ya1xuICAgICAgICBjb25zdCBkZWZlcnJlZFF1ZXVlID0gcGF1c2FibGUodGhpcy5fcmVxdWVzdFN0cmVhbS5maWx0ZXIoaXNEZWZlcnJlZENvbW1hbmQpLCBwYXVzZXIpXG4gICAgICAgICAgICAubWFwKHJlcXVlc3QgPT4gdGhpcy5oYW5kbGVSZXN1bHQocmVxdWVzdCkpXG4gICAgICAgICAgICAubWVyZ2UoZGVmZXJyZWRDb25jdXJyZW5jeSk7XG5cbiAgICAgICAgLy8gV2UganVzdCBwYXNzIHRoZXNlIG9wZXJhdGlvbnMgdGhyb3VnaCBhcyBzb29uIGFzIHBvc3NpYmxlXG4gICAgICAgIGNvbnN0IG5vcm1hbFF1ZXVlID0gcGF1c2FibGUodGhpcy5fcmVxdWVzdFN0cmVhbS5maWx0ZXIoaXNOb3JtYWxDb21tYW5kKSwgcGF1c2VyKVxuICAgICAgICAgICAgLm1hcChyZXF1ZXN0ID0+IHRoaXMuaGFuZGxlUmVzdWx0KHJlcXVlc3QpKVxuICAgICAgICAgICAgLm1lcmdlKHRoaXMuX29wdGlvbnMuY29uY3VycmVuY3kpO1xuXG4gICAgICAgIC8vIFdlIG11c3Qgd2FpdCBmb3IgdGhlc2UgY29tbWFuZHNcbiAgICAgICAgLy8gQW5kIHRoZXNlIGNvbW1hbmRzIG11c3QgcnVuIGluIG9yZGVyLlxuICAgICAgICBjb25zdCBwcmlvcml0eVF1ZXVlID0gdGhpcy5fcmVxdWVzdFN0cmVhbVxuICAgICAgICAgICAgLmZpbHRlcihpc1ByaW9yaXR5Q29tbWFuZClcbiAgICAgICAgICAgIC5kbygoKSA9PiBwcmlvcml0eVJlcXVlc3RzLm5leHQocHJpb3JpdHlSZXF1ZXN0cy5nZXRWYWx1ZSgpICsgMSkpXG4gICAgICAgICAgICAubWFwKHJlcXVlc3QgPT4gdGhpcy5oYW5kbGVSZXN1bHQocmVxdWVzdCwgKCkgPT4gcHJpb3JpdHlSZXNwb25zZXMubmV4dChwcmlvcml0eVJlc3BvbnNlcy5nZXRWYWx1ZSgpICsgMSkpKVxuICAgICAgICAgICAgLm1lcmdlKHRoaXMuX29wdGlvbnMuY29uY3VycmVuY3kpO1xuXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKE9ic2VydmFibGUubWVyZ2UoZGVmZXJyZWRRdWV1ZSwgbm9ybWFsUXVldWUsIHByaW9yaXR5UXVldWUpLnN1YnNjcmliZSgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVJlc3VsdChjb250ZXh0OiBSZXF1ZXN0Q29udGV4dDxhbnk+LCBjb21wbGV0ZT86ICgpID0+IHZvaWQpOiBPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+IHtcbiAgICAgICAgLy8gVE9ETzogRmluZCBhIHdheSB0byBub3QgcmVwZWF0IHRoZSBzYW1lIGNvbW1hbmRzLCBpZiB0aGVyZSBhcmUgb3V0c3RhbmRpbmcgKHRpbWVkIG91dCkgcmVxdWVzdHMuXG4gICAgICAgIC8vIEluIHNvbWUgY2FzZXMgZm9yIGV4YW1wbGUgZmluZCB1c2FnZXMgaGFzIHRha2VuIG92ZXIgMzAgc2Vjb25kcywgc28gd2Ugc2hvdWxkblwidCBoaXQgdGhlIHNlcnZlciB3aXRoIG11bHRpcGxlIG9mIHRoZXNlIHJlcXVlc3RzIChhcyB3ZSBzbGFtIHRoZSBjcFUpXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IDxPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+PnRoaXMuX2RyaXZlci5yZXF1ZXN0PGFueSwgYW55Pihjb250ZXh0LmNvbW1hbmQsIGNvbnRleHQucmVxdWVzdCk7XG4gICAgICAgIHJlc3VsdC5zdWJzY3JpYmUoKGRhdGEpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3Jlc3BvbnNlU3RyZWFtLm5leHQobmV3IFJlc3BvbnNlQ29udGV4dChjb250ZXh0LCBkYXRhKSk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fZXJyb3JTdHJlYW0ubmV4dChuZXcgQ29tbWFuZENvbnRleHQoY29udGV4dC5jb21tYW5kLCBlcnJvcikpO1xuICAgICAgICAgICAgdGhpcy5fcmVzcG9uc2VTdHJlYW0ubmV4dChuZXcgUmVzcG9uc2VDb250ZXh0KGNvbnRleHQsIG51bGwsIHRydWUpKTtcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRSZXF1ZXN0cy5kZWxldGUoY29udGV4dCk7XG4gICAgICAgICAgICBpZiAoY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICBjb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fY3VycmVudFJlcXVlc3RzLmRlbGV0ZShjb250ZXh0KTtcbiAgICAgICAgICAgIGlmIChjb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgY29tcGxldGUgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgICAvLyBUaGlzIHRpbWVvdXQgZG9lc24ndCBwcmV2ZW50IHRoZSByZXF1ZXN0IGZyb20gY29tcGxldGluZ1xuICAgICAgICAgICAgLy8gSXQgc2ltcGx5IHVuYmxvY2tzIHRoZSBxdWV1ZSwgc28gd2UgY2FuIGNvbnRpbnVlIHRvIHByb2Nlc3MgaXRlbXMuXG4gICAgICAgICAgICAudGltZW91dCh0aGlzLl9vcHRpb25zLmNvbmN1cnJlbmN5VGltZW91dCwgT2JzZXJ2YWJsZS5lbXB0eTxSZXNwb25zZUNvbnRleHQ8YW55LCBhbnk+PigpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9nKG1lc3NhZ2U6IHN0cmluZywgbG9nTGV2ZWw/OiBzdHJpbmcpIHtcbiAgICAgICAgLy8gbG9nIG91ciBjb21wbGV0ZSByZXNwb25zZSB0aW1lXG4gICAgICAgIHRoaXMuX2N1c3RvbUV2ZW50cy5uZXh0KHtcbiAgICAgICAgICAgIEV2ZW50OiBcImxvZ1wiLFxuICAgICAgICAgICAgQm9keToge1xuICAgICAgICAgICAgICAgIE1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgTG9nTGV2ZWw6IGxvZ0xldmVsID8gbG9nTGV2ZWwudG9VcHBlckNhc2UoKSA6IFwiSU5GT1JNQVRJT05cIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFNlcTogLTEsXG4gICAgICAgICAgICBUeXBlOiBcImxvZ1wiXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb25uZWN0KCkge1xuICAgICAgICAvLyBDdXJyZW50bHkgY29ubmVjdGluZ1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RhdGUgPj0gRHJpdmVyU3RhdGUuRG93bmxvYWRpbmcgJiYgdGhpcy5jdXJyZW50U3RhdGUgPD0gRHJpdmVyU3RhdGUuQ29ubmVjdGVkKSByZXR1cm47XG4gICAgICAgIC8vIEJvb3RzdHJhcCBwbHVnaW5zIGhlcmVcblxuICAgICAgICB0aGlzLl9jdXJyZW50UmVxdWVzdHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5fZHJpdmVyLmNvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZXNldERyaXZlcigpIHtcbiAgICAgICAgaWYgKHRoaXMuX2RyaXZlcikge1xuICAgICAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5yZW1vdmUodGhpcy5fZHJpdmVyKTtcbiAgICAgICAgICAgIHRoaXMuX2RyaXZlci5kaXNwb3NlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7ZHJpdmVyfSA9IHRoaXMuX29wdGlvbnM7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSByZXF1aXJlKFwiLi4vZHJpdmVycy9cIiArIERyaXZlcltkcml2ZXJdLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICBjb25zdCBkcml2ZXJGYWN0b3J5OiBJU3RhdGljRHJpdmVyID0gaXRlbVtrZXlzKGl0ZW0pWzBdXTtcbiAgICAgICAgdGhpcy5fZHJpdmVyID0gbmV3IGRyaXZlckZhY3RvcnkodGhpcy5fb3B0aW9ucyk7XG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKHRoaXMuX2RyaXZlcik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2RyaXZlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGlzY29ubmVjdCgpIHtcbiAgICAgICAgdGhpcy5fZHJpdmVyLmRpc2Nvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVxdWVzdDxUUmVxdWVzdCwgVFJlc3BvbnNlPihhY3Rpb246IHN0cmluZywgcmVxdWVzdDogVFJlcXVlc3QsIG9wdGlvbnM/OiBPbW5pU2hhcnAuUmVxdWVzdE9wdGlvbnMpOiBPYnNlcnZhYmxlPFRSZXNwb25zZT4ge1xuICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSA8T21uaVNoYXJwLlJlcXVlc3RPcHRpb25zPnt9O1xuICAgICAgICBkZWZhdWx0cyhvcHRpb25zLCB7IG9uZUJhc2VkSW5kaWNlczogdGhpcy5fb3B0aW9ucy5vbmVCYXNlZEluZGljZXMgfSk7XG5cbiAgICAgICAgLy8gSGFuZGxlIGRpc2Nvbm5lY3RlZCByZXF1ZXN0c1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RhdGUgIT09IERyaXZlclN0YXRlLkNvbm5lY3RlZCAmJiB0aGlzLmN1cnJlbnRTdGF0ZSAhPT0gRHJpdmVyU3RhdGUuRXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IEFzeW5jU3ViamVjdDxUUmVzcG9uc2U+KCk7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdGUuZmlsdGVyKHogPT4geiA9PT0gRHJpdmVyU3RhdGUuQ29ubmVjdGVkKVxuICAgICAgICAgICAgICAgIC50YWtlKDEpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSh6ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0PFRSZXF1ZXN0LCBUUmVzcG9uc2U+KGFjdGlvbiwgcmVxdWVzdCwgb3B0aW9ucykuc3Vic2NyaWJlKHggPT4gcmVzcG9uc2UubmV4dCh4KSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiA8T2JzZXJ2YWJsZTxUUmVzcG9uc2U+Pjxhbnk+cmVzcG9uc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb250ZXh0ID0gbmV3IFJlcXVlc3RDb250ZXh0KHRoaXMuX3VuaXF1ZUlkLCBhY3Rpb24sIHJlcXVlc3QsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLl9yZXF1ZXN0U3RyZWFtLm5leHQoY29udGV4dCk7XG5cbiAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0UmVzcG9uc2U8VFJlc3BvbnNlPig8T2JzZXJ2YWJsZTxhbnk+Pjxhbnk+dGhpcy5fcmVzcG9uc2VTdHJlYW0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0dXBPYnNlcnZlcnMoKSB7XG4gICAgICAgIHRoaXMuX2RyaXZlci5ldmVudHMuc3Vic2NyaWJlKHggPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2V2ZW50V2F0Y2hlcnMuaGFzKHguRXZlbnQpKVxuICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50V2F0Y2hlcnMuZ2V0KHguRXZlbnQpWzBdLm5leHQoeC5Cb2R5KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fZW5xdWV1ZWRSZXNwb25zZXMuc3Vic2NyaWJlKHggPT4ge1xuICAgICAgICAgICAgaWYgKCF4LnNpbGVudCAmJiB0aGlzLl9jb21tYW5kV2F0Y2hlcnMuaGFzKHguY29tbWFuZCkpXG4gICAgICAgICAgICAgICAgdGhpcy5fY29tbWFuZFdhdGNoZXJzLmdldCh4LmNvbW1hbmQpWzBdLm5leHQoeCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ZpeHVwczogQXJyYXk8KGFjdGlvbjogc3RyaW5nLCByZXF1ZXN0OiBhbnksIG9wdGlvbnM/OiBPbW5pU2hhcnAuUmVxdWVzdE9wdGlvbnMpID0+IHZvaWQ+ID0gW107XG4gICAgcHVibGljIHJlZ2lzdGVyRml4dXAoZnVuYzogKGFjdGlvbjogc3RyaW5nLCByZXF1ZXN0OiBhbnksIG9wdGlvbnM/OiBPbW5pU2hhcnAuUmVxdWVzdE9wdGlvbnMpID0+IHZvaWQpIHtcbiAgICAgICAgdGhpcy5fZml4dXBzLnB1c2goZnVuYyk7XG4gICAgfVxuXG4gICAgLyogdHNsaW50OmRpc2FibGU6bm8tdW51c2VkLXZhcmlhYmxlICovXG4gICAgcHJpdmF0ZSBfZml4dXA8VFJlcXVlc3Q+KGFjdGlvbjogc3RyaW5nLCByZXF1ZXN0OiBUUmVxdWVzdCwgb3B0aW9ucz86IE9tbmlTaGFycC5SZXF1ZXN0T3B0aW9ucykge1xuICAgICAgICBlYWNoKHRoaXMuX2ZpeHVwcywgZiA9PiBmKGFjdGlvbiwgcmVxdWVzdCwgb3B0aW9ucykpO1xuICAgIH1cbiAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLXVudXNlZC12YXJpYWJsZSAqL1xuXG4gICAgLypwdWJsaWMgYWRkUGx1Z2luKHBsdWdpbjogSU9tbmlzaGFycFBsdWdpbikge1xuICAgICAgICB0aGlzLl9wbHVnaW5NYW5hZ2VyLmFkZChwbHVnaW4pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVQbHVnaW4ocGx1Z2luOiBJT21uaXNoYXJwUGx1Z2luKSB7XG4gICAgICAgIHRoaXMuX3BsdWdpbk1hbmFnZXIucmVtb3ZlKHBsdWdpbik7XG4gICAgfSovXG59XG5cbmV4cG9ydCBjbGFzcyBDbGllbnRFdmVudHNCYXNlIGltcGxlbWVudHMgT21uaVNoYXJwLkV2ZW50cyB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfY2xpZW50OiBhbnkpIHsgfVxuXG4gICAgcHVibGljIGdldCB1bmlxdWVJZCgpIHsgcmV0dXJuIHRoaXMuX2NsaWVudC51bmlxdWVJZDsgfVxuXG4gICAgQHdhdGNoRXZlbnQgcHVibGljIGdldCBwcm9qZWN0QWRkZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlByb2plY3RJbmZvcm1hdGlvblJlc3BvbnNlPiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEB3YXRjaEV2ZW50IHB1YmxpYyBnZXQgcHJvamVjdENoYW5nZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlByb2plY3RJbmZvcm1hdGlvblJlc3BvbnNlPiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEB3YXRjaEV2ZW50IHB1YmxpYyBnZXQgcHJvamVjdFJlbW92ZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlByb2plY3RJbmZvcm1hdGlvblJlc3BvbnNlPiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEB3YXRjaEV2ZW50IHB1YmxpYyBnZXQgZXJyb3IoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLkVycm9yTWVzc2FnZT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAd2F0Y2hFdmVudCBwdWJsaWMgZ2V0IG1zQnVpbGRQcm9qZWN0RGlhZ25vc3RpY3MoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLk1TQnVpbGRQcm9qZWN0RGlhZ25vc3RpY3M+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQHdhdGNoRXZlbnQgcHVibGljIGdldCBwYWNrYWdlUmVzdG9yZVN0YXJ0ZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlBhY2thZ2VSZXN0b3JlTWVzc2FnZT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAd2F0Y2hFdmVudCBwdWJsaWMgZ2V0IHBhY2thZ2VSZXN0b3JlRmluaXNoZWQoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlBhY2thZ2VSZXN0b3JlTWVzc2FnZT4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAd2F0Y2hFdmVudCBwdWJsaWMgZ2V0IHVucmVzb2x2ZWREZXBlbmRlbmNpZXMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuTW9kZWxzLlVucmVzb2x2ZWREZXBlbmRlbmNpZXNNZXNzYWdlPiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuXG4gICAgQHJlZmVyZW5jZSBwdWJsaWMgZ2V0IGV2ZW50cygpOiBPYnNlcnZhYmxlPE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldD4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAcmVmZXJlbmNlIHB1YmxpYyBnZXQgY29tbWFuZHMoKTogT2JzZXJ2YWJsZTxPbW5pU2hhcnAuU3RkaW8uUHJvdG9jb2wuUmVzcG9uc2VQYWNrZXQ+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQHJlZmVyZW5jZSBwdWJsaWMgZ2V0IHN0YXRlKCk6IE9ic2VydmFibGU8RHJpdmVyU3RhdGU+IHsgdGhyb3cgbmV3IEVycm9yKFwiSW1wbGVtZW50ZWQgYnkgZGVjb3JhdG9yXCIpOyB9XG4gICAgQHJlZmVyZW5jZSBwdWJsaWMgZ2V0IHN0YXR1cygpOiBPYnNlcnZhYmxlPE9tbmlzaGFycENsaWVudFN0YXR1cz4geyB0aHJvdyBuZXcgRXJyb3IoXCJJbXBsZW1lbnRlZCBieSBkZWNvcmF0b3JcIik7IH1cbiAgICBAcmVmZXJlbmNlIHB1YmxpYyBnZXQgcmVxdWVzdHMoKTogT2JzZXJ2YWJsZTxSZXF1ZXN0Q29udGV4dDxhbnk+PiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEByZWZlcmVuY2UgcHVibGljIGdldCByZXNwb25zZXMoKTogT2JzZXJ2YWJsZTxSZXNwb25zZUNvbnRleHQ8YW55LCBhbnk+PiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxuICAgIEByZWZlcmVuY2UgcHVibGljIGdldCBlcnJvcnMoKTogT2JzZXJ2YWJsZTxDb21tYW5kQ29udGV4dDxhbnk+PiB7IHRocm93IG5ldyBFcnJvcihcIkltcGxlbWVudGVkIGJ5IGRlY29yYXRvclwiKTsgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
