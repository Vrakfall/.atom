"use strict";
var _ = require('lodash');
var path_1 = require('path');
var rxjs_1 = require('rxjs');
require('rxjs/add/operator/distinctKey');
var ts_disposables_1 = require('ts-disposables');
var create_1 = require('./operators/create');
var fs_1 = require('fs');
var glob = require('globby');
function ifEmpty(observable, other) {
    return create_1.createObservable(function (observer) {
        var hasValue = false;
        var cd = new ts_disposables_1.CompositeDisposable();
        cd.add(observable.subscribe(function (value) {
            hasValue = true;
            observer.next(value);
        }, function (e) { return observer.error(e); }, function () {
            if (!hasValue) {
                cd.add(other.subscribe(function (value) { return observer.next(value); }, function (e) { return observer.error(e); }, function () { return observer.complete(); }));
            }
            else {
                observer.complete();
            }
        }));
        return new rxjs_1.Subscription(function () { return cd.dispose(); });
    });
}
exports.ifEmpty = ifEmpty;
var Candidate = (function () {
    function Candidate(originalFile, predicate) {
        this.originalFile = originalFile = path_1.normalize(originalFile);
        this.path = _.endsWith(originalFile, '.sln') ? originalFile : path_1.dirname(originalFile);
        this.isProject = predicate(originalFile);
        Object.freeze(this);
    }
    Candidate.prototype.toString = function () {
        return this.path;
    };
    return Candidate;
}());
exports.Candidate = Candidate;
exports.findCandidates = (function () {
    function realFindCandidates(location, logger, options) {
        if (options === void 0) { options = {}; }
        location = _.trimEnd(location, path_1.sep);
        var solutionFilesToSearch = options.solutionFilesToSearch || (options.solutionFilesToSearch = ['global.json', '*.sln']);
        var projectFilesToSearch = options.projectFilesToSearch || (options.projectFilesToSearch = ['project.json', '*.csproj']);
        var sourceFilesToSearch = options.sourceFilesToSearch || (options.sourceFilesToSearch = ['*.cs']);
        var solutionIndependentSourceFilesToSearch = options.solutionIndependentSourceFilesToSearch || (options.solutionIndependentSourceFilesToSearch = ['*.csx']);
        var maxDepth = options.maxDepth || 10;
        var solutionsOrProjects = searchForCandidates(location, solutionFilesToSearch, projectFilesToSearch, maxDepth, logger)
            .toArray()
            .flatMap(function (result) { return result.length ? rxjs_1.Observable.from(result) : searchForCandidates(location, projectFilesToSearch, [], maxDepth, logger); })
            .toArray()
            .map(squashCandidates);
        var independentSourceFiles = searchForCandidates(location, solutionIndependentSourceFilesToSearch, [], maxDepth, logger)
            .toArray();
        var baseFiles = rxjs_1.Observable.concat(solutionsOrProjects, independentSourceFiles)
            .flatMap(function (x) { return x; });
        var sourceFiles = searchForCandidates(location, sourceFilesToSearch, [], maxDepth, logger);
        var predicate = function (path) { return _.some(solutionFilesToSearch.concat(projectFilesToSearch), function (pattern) { return _.endsWith(path, _.trimStart(pattern, '*')); }); };
        return ifEmpty(baseFiles, sourceFiles)
            .map(function (file) { return new Candidate(file, predicate); })
            .distinctKey('path')
            .toArray()
            .do(function (candidates) { return logger.log("Omni Project Candidates: Found " + candidates); });
    }
    function findCandidates(location, logger, options) {
        if (options === void 0) { options = {}; }
        return realFindCandidates(location, logger, options)
            .map(function (z) { return z.map(function (x) { return x.toString(); }); });
    }
    findCandidates.withCandidates = realFindCandidates;
    return findCandidates;
})();
function squashCandidates(candidates) {
    var rootCandidateCount = getMinCandidate(candidates);
    return _.uniq(_.filter(_.map(candidates, path_1.normalize), function (z) { return z.split(path_1.sep).length === rootCandidateCount; }));
}
function getMinCandidate(candidates) {
    if (!candidates.length)
        return -1;
    return _.minBy(_.map(candidates, path_1.normalize), function (z) { return z.split(path_1.sep).length; }).split(path_1.sep).length;
}
function searchForCandidates(location, filesToSearch, projectFilesToSearch, maxDepth, logger) {
    var locations = location.split(path_1.sep);
    locations = locations.map(function (loc, index) {
        return _.take(locations, locations.length - index).join(path_1.sep);
    });
    locations = locations.slice(0, Math.min(maxDepth, locations.length));
    return rxjs_1.Observable.from(locations)
        .subscribeOn(rxjs_1.Scheduler.queue)
        .mergeMap(function (loc) {
        var files = filesToSearch.map(function (fileName) { return path_1.join(loc, fileName); });
        logger.log("Omni Project Candidates: Searching " + loc + " for " + filesToSearch);
        return rxjs_1.Observable.from(files)
            .flatMap(function (file) { return glob([file], { cache: {} }); })
            .map(function (x) {
            if (x.length > 1) {
                // Handle the unity project case
                // Also handle optional solutions that may also exist with the unity ones.
                var unitySolutionIndex = _.findIndex(x, function (z) { return _.endsWith(z, '-csharp.sln'); });
                if (unitySolutionIndex > -1) {
                    var unitySolution = x[unitySolutionIndex];
                    var baseSolution_1 = unitySolution.substr(0, unitySolution.indexOf('-csharp.sln')) + '.sln';
                    var baseSolutionIndex = _.findIndex(x, function (z) { return z.toLowerCase() === baseSolution_1.toLowerCase(); });
                    if (baseSolutionIndex > -1) {
                        // Remove the index
                        x.splice(baseSolutionIndex, 1);
                    }
                }
            }
            if (_.some(x, function (file) { return _.endsWith(file, '.sln'); })) {
                return x.filter(function (file) {
                    var content = fs_1.readFileSync(file).toString();
                    return _.some(projectFilesToSearch, function (path) { return content.indexOf(_.trimStart(path, '*')) > -1; });
                });
            }
            return x;
        });
    })
        .filter(function (z) { return z.length > 0; })
        .defaultIfEmpty([])
        .first()
        .flatMap(function (z) { return z; });
}

//# sourceMappingURL=data:application/json;base64,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QUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUE1QyxDQUE0QyxDQUFDLENBQUM7Z0JBQzlGLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztZQUNELE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDYixDQUFDLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQztTQUNELE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFaLENBQVksQ0FBQztTQUN6QixjQUFjLENBQUMsRUFBRSxDQUFDO1NBQ2xCLEtBQUssRUFBRTtTQUNQLE9BQU8sQ0FBUyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQztBQUNqQyxDQUFDIiwiZmlsZSI6ImxpYi9jYW5kaWRhdGUtZmluZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgSUxvZ2dlciB9IGZyb20gJy4vZW51bXMnO1xuaW1wb3J0IHsgam9pbiwgZGlybmFtZSwgc2VwLCBub3JtYWxpemUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFNjaGVkdWxlciwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTdWJzY3JpYmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9kaXN0aW5jdEtleSc7XG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSAndHMtZGlzcG9zYWJsZXMnO1xuaW1wb3J0IHsgY3JlYXRlT2JzZXJ2YWJsZSB9IGZyb20gJy4vb3BlcmF0b3JzL2NyZWF0ZSc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5jb25zdCBnbG9iOiAoZmlsZTogc3RyaW5nW10sIG9wdGlvbnM/OiBhbnkpID0+IFByb21pc2U8c3RyaW5nW10+ID0gcmVxdWlyZSgnZ2xvYmJ5Jyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG4gICAgc29sdXRpb25GaWxlc1RvU2VhcmNoPzogc3RyaW5nW107XG4gICAgcHJvamVjdEZpbGVzVG9TZWFyY2g/OiBzdHJpbmdbXTtcbiAgICBzb3VyY2VGaWxlc1RvU2VhcmNoPzogc3RyaW5nW107XG4gICAgc29sdXRpb25JbmRlcGVuZGVudFNvdXJjZUZpbGVzVG9TZWFyY2g/OiBzdHJpbmdbXTtcbiAgICBtYXhEZXB0aD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlmRW1wdHk8VD4ob2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUPiwgb3RoZXI6IE9ic2VydmFibGU8VD4pIHtcbiAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZTxUPihvYnNlcnZlciA9PiB7XG4gICAgICAgIGxldCBoYXNWYWx1ZSA9IGZhbHNlO1xuICAgICAgICBjb25zdCBjZCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgIGNkLmFkZChvYnNlcnZhYmxlLnN1YnNjcmliZShcbiAgICAgICAgICAgIHZhbHVlID0+IHtcbiAgICAgICAgICAgICAgICBoYXNWYWx1ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh2YWx1ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZSA9PiBvYnNlcnZlci5lcnJvcihlKSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWhhc1ZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNkLmFkZChvdGhlci5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9PiBvYnNlcnZlci5uZXh0KHZhbHVlKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGUgPT4gb2JzZXJ2ZXIuZXJyb3IoZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApKTtcbiAgICAgICAgcmV0dXJuIG5ldyBTdWJzY3JpcHRpb24oKCkgPT4gY2QuZGlzcG9zZSgpKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGNsYXNzIENhbmRpZGF0ZSB7XG4gICAgcHVibGljIHBhdGg6IHN0cmluZztcbiAgICBwdWJsaWMgb3JpZ2luYWxGaWxlOiBzdHJpbmc7XG4gICAgcHVibGljIGlzUHJvamVjdDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKG9yaWdpbmFsRmlsZTogc3RyaW5nLCBwcmVkaWNhdGU6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5vcmlnaW5hbEZpbGUgPSBvcmlnaW5hbEZpbGUgPSBub3JtYWxpemUob3JpZ2luYWxGaWxlKTtcbiAgICAgICAgdGhpcy5wYXRoID0gXy5lbmRzV2l0aChvcmlnaW5hbEZpbGUsICcuc2xuJykgPyBvcmlnaW5hbEZpbGUgOiBkaXJuYW1lKG9yaWdpbmFsRmlsZSk7XG4gICAgICAgIHRoaXMuaXNQcm9qZWN0ID0gcHJlZGljYXRlKG9yaWdpbmFsRmlsZSk7XG5cbiAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhdGg7XG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgZmluZENhbmRpZGF0ZXMgPSAoKCkgPT4ge1xuICAgIGZ1bmN0aW9uIHJlYWxGaW5kQ2FuZGlkYXRlcyhsb2NhdGlvbjogc3RyaW5nLCBsb2dnZXI6IElMb2dnZXIsIG9wdGlvbnM6IE9wdGlvbnMgPSB7fSkge1xuICAgICAgICBsb2NhdGlvbiA9IF8udHJpbUVuZChsb2NhdGlvbiwgc2VwKTtcblxuICAgICAgICBjb25zdCBzb2x1dGlvbkZpbGVzVG9TZWFyY2ggPSBvcHRpb25zLnNvbHV0aW9uRmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5zb2x1dGlvbkZpbGVzVG9TZWFyY2ggPSBbJ2dsb2JhbC5qc29uJywgJyouc2xuJ10pO1xuICAgICAgICBjb25zdCBwcm9qZWN0RmlsZXNUb1NlYXJjaCA9IG9wdGlvbnMucHJvamVjdEZpbGVzVG9TZWFyY2ggfHwgKG9wdGlvbnMucHJvamVjdEZpbGVzVG9TZWFyY2ggPSBbJ3Byb2plY3QuanNvbicsICcqLmNzcHJvaiddKTtcbiAgICAgICAgY29uc3Qgc291cmNlRmlsZXNUb1NlYXJjaCA9IG9wdGlvbnMuc291cmNlRmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5zb3VyY2VGaWxlc1RvU2VhcmNoID0gWycqLmNzJ10pO1xuICAgICAgICBjb25zdCBzb2x1dGlvbkluZGVwZW5kZW50U291cmNlRmlsZXNUb1NlYXJjaCA9IG9wdGlvbnMuc29sdXRpb25JbmRlcGVuZGVudFNvdXJjZUZpbGVzVG9TZWFyY2ggfHwgKG9wdGlvbnMuc29sdXRpb25JbmRlcGVuZGVudFNvdXJjZUZpbGVzVG9TZWFyY2ggPSBbJyouY3N4J10pO1xuICAgICAgICBjb25zdCBtYXhEZXB0aCA9IG9wdGlvbnMubWF4RGVwdGggfHwgMTA7XG5cbiAgICAgICAgY29uc3Qgc29sdXRpb25zT3JQcm9qZWN0cyA9IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHNvbHV0aW9uRmlsZXNUb1NlYXJjaCwgcHJvamVjdEZpbGVzVG9TZWFyY2gsIG1heERlcHRoLCBsb2dnZXIpXG4gICAgICAgICAgICAudG9BcnJheSgpXG4gICAgICAgICAgICAuZmxhdE1hcChyZXN1bHQgPT4gcmVzdWx0Lmxlbmd0aCA/IE9ic2VydmFibGUuZnJvbShyZXN1bHQpIDogc2VhcmNoRm9yQ2FuZGlkYXRlcyhsb2NhdGlvbiwgcHJvamVjdEZpbGVzVG9TZWFyY2gsIFtdLCBtYXhEZXB0aCwgbG9nZ2VyKSlcbiAgICAgICAgICAgIC50b0FycmF5KClcbiAgICAgICAgICAgIC5tYXAoc3F1YXNoQ2FuZGlkYXRlcyk7XG5cbiAgICAgICAgY29uc3QgaW5kZXBlbmRlbnRTb3VyY2VGaWxlcyA9IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHNvbHV0aW9uSW5kZXBlbmRlbnRTb3VyY2VGaWxlc1RvU2VhcmNoLCBbXSwgbWF4RGVwdGgsIGxvZ2dlcilcbiAgICAgICAgICAgIC50b0FycmF5KCk7XG5cbiAgICAgICAgY29uc3QgYmFzZUZpbGVzID0gT2JzZXJ2YWJsZS5jb25jYXQoc29sdXRpb25zT3JQcm9qZWN0cywgaW5kZXBlbmRlbnRTb3VyY2VGaWxlcylcbiAgICAgICAgICAgIC5mbGF0TWFwPHN0cmluZz4oeCA9PiB4KTtcblxuICAgICAgICBjb25zdCBzb3VyY2VGaWxlcyA9IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHNvdXJjZUZpbGVzVG9TZWFyY2gsIFtdLCBtYXhEZXB0aCwgbG9nZ2VyKTtcblxuICAgICAgICBjb25zdCBwcmVkaWNhdGUgPSAocGF0aDogc3RyaW5nKSA9PiBfLnNvbWUoc29sdXRpb25GaWxlc1RvU2VhcmNoLmNvbmNhdChwcm9qZWN0RmlsZXNUb1NlYXJjaCksIHBhdHRlcm4gPT4gXy5lbmRzV2l0aChwYXRoLCBfLnRyaW1TdGFydChwYXR0ZXJuLCAnKicpKSk7XG5cbiAgICAgICAgcmV0dXJuIGlmRW1wdHkoYmFzZUZpbGVzLCBzb3VyY2VGaWxlcylcbiAgICAgICAgICAgIC5tYXAoZmlsZSA9PiBuZXcgQ2FuZGlkYXRlKGZpbGUsIHByZWRpY2F0ZSkpXG4gICAgICAgICAgICAuZGlzdGluY3RLZXkoJ3BhdGgnKVxuICAgICAgICAgICAgLnRvQXJyYXkoKVxuICAgICAgICAgICAgLmRvKGNhbmRpZGF0ZXMgPT4gbG9nZ2VyLmxvZyhgT21uaSBQcm9qZWN0IENhbmRpZGF0ZXM6IEZvdW5kICR7Y2FuZGlkYXRlc31gKSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZmluZENhbmRpZGF0ZXMobG9jYXRpb246IHN0cmluZywgbG9nZ2VyOiBJTG9nZ2VyLCBvcHRpb25zOiBPcHRpb25zID0ge30pIHtcbiAgICAgICAgcmV0dXJuIHJlYWxGaW5kQ2FuZGlkYXRlcyhsb2NhdGlvbiwgbG9nZ2VyLCBvcHRpb25zKVxuICAgICAgICAgICAgLm1hcCh6ID0+IHoubWFwKHggPT4geC50b1N0cmluZygpKSk7XG4gICAgfVxuXG4gICAgKDxhbnk+ZmluZENhbmRpZGF0ZXMpLndpdGhDYW5kaWRhdGVzID0gcmVhbEZpbmRDYW5kaWRhdGVzO1xuXG4gICAgcmV0dXJuIDx7IChsb2NhdGlvbjogc3RyaW5nLCBsb2dnZXI6IElMb2dnZXIsIG9wdGlvbnM/OiBPcHRpb25zKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT47IHdpdGhDYW5kaWRhdGVzOiB0eXBlb2YgcmVhbEZpbmRDYW5kaWRhdGVzIH0+ZmluZENhbmRpZGF0ZXM7XG59KSgpO1xuXG5mdW5jdGlvbiBzcXVhc2hDYW5kaWRhdGVzKGNhbmRpZGF0ZXM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3Qgcm9vdENhbmRpZGF0ZUNvdW50ID0gZ2V0TWluQ2FuZGlkYXRlKGNhbmRpZGF0ZXMpO1xuICAgIHJldHVybiBfLnVuaXEoXy5maWx0ZXIoXy5tYXAoY2FuZGlkYXRlcywgbm9ybWFsaXplKSwgeiA9PiB6LnNwbGl0KHNlcCkubGVuZ3RoID09PSByb290Q2FuZGlkYXRlQ291bnQpKTtcbn1cblxuZnVuY3Rpb24gZ2V0TWluQ2FuZGlkYXRlKGNhbmRpZGF0ZXM6IHN0cmluZ1tdKSB7XG4gICAgaWYgKCFjYW5kaWRhdGVzLmxlbmd0aCkgcmV0dXJuIC0xO1xuXG4gICAgcmV0dXJuIF8ubWluQnkoXy5tYXAoY2FuZGlkYXRlcywgbm9ybWFsaXplKSwgeiA9PiB6LnNwbGl0KHNlcCkubGVuZ3RoKS5zcGxpdChzZXApLmxlbmd0aDtcbn1cblxuZnVuY3Rpb24gc2VhcmNoRm9yQ2FuZGlkYXRlcyhsb2NhdGlvbjogc3RyaW5nLCBmaWxlc1RvU2VhcmNoOiBzdHJpbmdbXSwgcHJvamVjdEZpbGVzVG9TZWFyY2g6IHN0cmluZ1tdLCBtYXhEZXB0aDogbnVtYmVyLCBsb2dnZXI6IElMb2dnZXIpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGxldCBsb2NhdGlvbnMgPSBsb2NhdGlvbi5zcGxpdChzZXApO1xuICAgIGxvY2F0aW9ucyA9IGxvY2F0aW9ucy5tYXAoKGxvYywgaW5kZXgpID0+IHtcbiAgICAgICAgcmV0dXJuIF8udGFrZShsb2NhdGlvbnMsIGxvY2F0aW9ucy5sZW5ndGggLSBpbmRleCkuam9pbihzZXApO1xuICAgIH0pO1xuXG4gICAgbG9jYXRpb25zID0gbG9jYXRpb25zLnNsaWNlKDAsIE1hdGgubWluKG1heERlcHRoLCBsb2NhdGlvbnMubGVuZ3RoKSk7XG5cbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tKGxvY2F0aW9ucylcbiAgICAgICAgLnN1YnNjcmliZU9uKFNjaGVkdWxlci5xdWV1ZSlcbiAgICAgICAgLm1lcmdlTWFwKChsb2MpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVzID0gZmlsZXNUb1NlYXJjaC5tYXAoZmlsZU5hbWUgPT4gam9pbihsb2MsIGZpbGVOYW1lKSk7XG5cbiAgICAgICAgICAgIGxvZ2dlci5sb2coYE9tbmkgUHJvamVjdCBDYW5kaWRhdGVzOiBTZWFyY2hpbmcgJHtsb2N9IGZvciAke2ZpbGVzVG9TZWFyY2h9YCk7XG5cbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb20oZmlsZXMpXG4gICAgICAgICAgICAgICAgLmZsYXRNYXAoZmlsZSA9PiBnbG9iKFtmaWxlXSwgeyBjYWNoZToge30gfSkpXG4gICAgICAgICAgICAgICAgLm1hcCh4ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHgubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSB1bml0eSBwcm9qZWN0IGNhc2VcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFsc28gaGFuZGxlIG9wdGlvbmFsIHNvbHV0aW9ucyB0aGF0IG1heSBhbHNvIGV4aXN0IHdpdGggdGhlIHVuaXR5IG9uZXMuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1bml0eVNvbHV0aW9uSW5kZXggPSBfLmZpbmRJbmRleCh4LCB6ID0+IF8uZW5kc1dpdGgoeiwgJy1jc2hhcnAuc2xuJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVuaXR5U29sdXRpb25JbmRleCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5pdHlTb2x1dGlvbiA9IHhbdW5pdHlTb2x1dGlvbkluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlU29sdXRpb24gPSB1bml0eVNvbHV0aW9uLnN1YnN0cigwLCB1bml0eVNvbHV0aW9uLmluZGV4T2YoJy1jc2hhcnAuc2xuJykpICsgJy5zbG4nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZVNvbHV0aW9uSW5kZXggPSBfLmZpbmRJbmRleCh4LCB6ID0+IHoudG9Mb3dlckNhc2UoKSA9PT0gYmFzZVNvbHV0aW9uLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYXNlU29sdXRpb25JbmRleCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgaW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeC5zcGxpY2UoYmFzZVNvbHV0aW9uSW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChfLnNvbWUoeCwgZmlsZSA9PiBfLmVuZHNXaXRoKGZpbGUsICcuc2xuJykpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geC5maWx0ZXIoZmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHJlYWRGaWxlU3luYyhmaWxlKS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfLnNvbWUocHJvamVjdEZpbGVzVG9TZWFyY2gsIHBhdGggPT4gY29udGVudC5pbmRleE9mKF8udHJpbVN0YXJ0KHBhdGgsICcqJykpID4gLTEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5maWx0ZXIoeiA9PiB6Lmxlbmd0aCA+IDApXG4gICAgICAgIC5kZWZhdWx0SWZFbXB0eShbXSlcbiAgICAgICAgLmZpcnN0KClcbiAgICAgICAgLmZsYXRNYXA8c3RyaW5nPih6ID0+IHopO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
