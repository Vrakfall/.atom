"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.findCandidates = exports.Candidate = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

exports.ifEmpty = ifEmpty;

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require("path");

var _rxjs = require("rxjs");

require("rxjs/add/operator/distinctKey");

var _disposables = require("./disposables");

var _create = require("./operators/create");

var _fs = require("fs");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var glob = require("globby");
function ifEmpty(observable, other) {
    return (0, _create.createObservable)(function (observer) {
        var hasValue = false;
        var cd = new _disposables.CompositeDisposable();
        cd.add(observable.subscribe(function (value) {
            hasValue = true;
            observer.next(value);
        }, function (e) {
            return observer.error(e);
        }, function () {
            if (!hasValue) {
                cd.add(other.subscribe(function (value) {
                    return observer.next(value);
                }, function (e) {
                    return observer.error(e);
                }, function () {
                    return observer.complete();
                }));
            } else {
                observer.complete();
            }
        }));
        return new _rxjs.Subscription(function () {
            return cd.dispose();
        });
    });
}

var Candidate = exports.Candidate = function () {
    function Candidate(originalFile, predicate) {
        _classCallCheck(this, Candidate);

        this.originalFile = originalFile = (0, _path.normalize)(originalFile);
        this.path = _lodash2.default.endsWith(originalFile, ".sln") ? originalFile : (0, _path.dirname)(originalFile);
        this.isProject = predicate(originalFile);
        Object.freeze(this);
    }

    _createClass(Candidate, [{
        key: "toString",
        value: function toString() {
            return this.path;
        }
    }]);

    return Candidate;
}();

var findCandidates = exports.findCandidates = function () {
    function realFindCandidates(location, logger) {
        var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

        location = _lodash2.default.trimEnd(location, _path.sep);
        var solutionFilesToSearch = options.solutionFilesToSearch || (options.solutionFilesToSearch = ["global.json", "*.sln"]);
        var projectFilesToSearch = options.projectFilesToSearch || (options.projectFilesToSearch = ["project.json", "*.csproj"]);
        var sourceFilesToSearch = options.sourceFilesToSearch || (options.sourceFilesToSearch = ["*.cs"]);
        var solutionIndependentSourceFilesToSearch = options.solutionIndependentSourceFilesToSearch || (options.solutionIndependentSourceFilesToSearch = ["*.csx"]);
        var solutionsOrProjects = searchForCandidates(location, solutionFilesToSearch, projectFilesToSearch, logger).toArray().flatMap(function (result) {
            return result.length ? _rxjs.Observable.from(result) : searchForCandidates(location, projectFilesToSearch, [], logger);
        }).toArray().map(squashCandidates);
        var independentSourceFiles = searchForCandidates(location, solutionIndependentSourceFilesToSearch, [], logger).toArray();
        var baseFiles = _rxjs.Observable.concat(solutionsOrProjects, independentSourceFiles).flatMap(function (x) {
            return x;
        });
        var sourceFiles = searchForCandidates(location, sourceFilesToSearch, [], logger);
        var predicate = function predicate(path) {
            return _lodash2.default.some(solutionFilesToSearch.concat(projectFilesToSearch), function (pattern) {
                return _lodash2.default.endsWith(path, _lodash2.default.trimStart(pattern, "*"));
            });
        };
        return ifEmpty(baseFiles, sourceFiles).map(function (file) {
            return new Candidate(file, predicate);
        }).distinctKey("path").toArray().do(function (candidates) {
            return logger.log("Omni Project Candidates: Found " + candidates);
        });
    }
    function findCandidates(location, logger) {
        var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

        return realFindCandidates(location, logger, options).map(function (z) {
            return z.map(function (x) {
                return x.toString();
            });
        });
    }
    findCandidates.withCandidates = realFindCandidates;
    return findCandidates;
}();
function squashCandidates(candidates) {
    var rootCandidateCount = getMinCandidate(candidates);
    return _lodash2.default.uniq(_lodash2.default.filter(_lodash2.default.map(candidates, _path.normalize), function (z) {
        return z.split(_path.sep).length === rootCandidateCount;
    }));
}
function getMinCandidate(candidates) {
    if (!candidates.length) return -1;
    return _lodash2.default.minBy(_lodash2.default.map(candidates, _path.normalize), function (z) {
        return z.split(_path.sep).length;
    }).split(_path.sep).length;
}
function searchForCandidates(location, filesToSearch, projectFilesToSearch, logger) {
    var locations = location.split(_path.sep);
    locations = locations.map(function (loc, index) {
        return _lodash2.default.take(locations, locations.length - index).join(_path.sep);
    });
    locations = locations.slice(0, Math.min(5, locations.length));
    var rootObservable = _rxjs.Observable.from(locations).subscribeOn(_rxjs.Scheduler.queue).map(function (loc) {
        return {
            loc: loc,
            files: filesToSearch.map(function (fileName) {
                return (0, _path.join)(loc, fileName);
            })
        };
    }).flatMap(function (_ref) {
        var loc = _ref.loc;
        var files = _ref.files;

        logger.log("Omni Project Candidates: Searching " + loc + " for " + filesToSearch);
        return _rxjs.Observable.from(files).flatMap(function (file) {
            return glob([file], { cache: {} });
        }).map(function (x) {
            if (x.length > 1) {
                var unitySolutionIndex = _lodash2.default.findIndex(x, function (z) {
                    return _lodash2.default.endsWith(z, "-csharp.sln");
                });
                if (unitySolutionIndex > -1) {
                    (function () {
                        var unitySolution = x[unitySolutionIndex];
                        var baseSolution = unitySolution.substr(0, unitySolution.indexOf("-csharp.sln")) + ".sln";
                        var baseSolutionIndex = _lodash2.default.findIndex(x, function (z) {
                            return z.toLowerCase() === baseSolution.toLowerCase();
                        });
                        if (baseSolutionIndex > -1) {
                            x.splice(baseSolutionIndex, 1);
                        }
                    })();
                }
            }
            if (_lodash2.default.some(x, function (file) {
                return _lodash2.default.endsWith(file, ".sln");
            })) {
                return x.filter(function (file) {
                    var content = (0, _fs.readFileSync)(file).toString();
                    return _lodash2.default.some(projectFilesToSearch, function (path) {
                        return content.indexOf(_lodash2.default.trimStart(path, "*")) > -1;
                    });
                });
            }
            return x;
        });
    }).filter(function (z) {
        return z.length > 0;
    }).defaultIfEmpty([]).first().flatMap(function (z) {
        return z;
    });
    return rootObservable;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jYW5kaWRhdGUtZmluZGVyLnRzIiwibGliL2NhbmRpZGF0ZS1maW5kZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O1FBaUJBOztBQ2pCQTs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QURFQSxJQUFNLE9BQTZELFFBQVEsUUFBUixDQUE3RDtBQVNOLFNBQUEsT0FBQSxDQUEyQixVQUEzQixFQUFzRCxLQUF0RCxFQUEwRTtBQUN0RSxXQUFPLDhCQUFvQixvQkFBUTtBQUMvQixZQUFJLFdBQVcsS0FBWCxDQUQyQjtBQUUvQixZQUFNLEtBQUssc0NBQUwsQ0FGeUI7QUFHL0IsV0FBRyxHQUFILENBQU8sV0FBVyxTQUFYLENBQ0gsaUJBQUs7QUFDRCx1QkFBVyxJQUFYLENBREM7QUFFRCxxQkFBUyxJQUFULENBQWMsS0FBZCxFQUZDO1NBQUwsRUFJQTttQkFBSyxTQUFTLEtBQVQsQ0FBZSxDQUFmO1NBQUwsRUFDQSxZQUFBO0FBQ0ksZ0JBQUksQ0FBQyxRQUFELEVBQVc7QUFDWCxtQkFBRyxHQUFILENBQU8sTUFBTSxTQUFOLENBQ0g7MkJBQVMsU0FBUyxJQUFULENBQWMsS0FBZDtpQkFBVCxFQUNBOzJCQUFLLFNBQVMsS0FBVCxDQUFlLENBQWY7aUJBQUwsRUFDQTsyQkFBTSxTQUFTLFFBQVQ7aUJBQU4sQ0FISixFQURXO2FBQWYsTUFNTztBQUNILHlCQUFTLFFBQVQsR0FERzthQU5QO1NBREosQ0FOSixFQUgrQjtBQXFCL0IsZUFBTyx1QkFBaUI7bUJBQU0sR0FBRyxPQUFIO1NBQU4sQ0FBeEIsQ0FyQitCO0tBQVIsQ0FBM0IsQ0FEc0U7Q0FBMUU7O0lBMEJBO0FBS0ksYUFMSixTQUtJLENBQVksWUFBWixFQUFrQyxTQUFsQyxFQUFzRTs4QkFMMUUsV0FLMEU7O0FBQ2xFLGFBQUssWUFBTCxHQUFvQixlQUFlLHFCQUFVLFlBQVYsQ0FBZixDQUQ4QztBQUVsRSxhQUFLLElBQUwsR0FBWSxpQkFB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RixDQUFXLElBQVgsRUFBaUIsTUFBakI7YUFBUixDQUFkLEVBQWlEO0FBQzdDLHVCQUFPLEVBQUUsTUFBRixDQUFTLGdCQUFJO0FBQ2hCLHdCQUFNLFVBQVUsc0JBQWEsSUFBYixFQUFtQixRQUFuQixFQUFWLENBRFU7QUFFaEIsMkJBQU8saUJBQUUsSUFBRixDQUFPLG9CQUFQLEVBQTZCOytCQUFRLFFBQVEsT0FBUixDQUFnQixpQkFBRSxTQUFGLENBQVksSUFBWixFQUFrQixHQUFsQixDQUFoQixJQUEwQyxDQUFDLENBQUQ7cUJBQWxELENBQXBDLENBRmdCO2lCQUFKLENBQWhCLENBRDZDO2FBQWpEO0FBTUEsbUJBQU8sQ0FBUCxDQXZCRTtTQUFELENBRlQsQ0FIMEI7S0FBckIsQ0FOVSxDQXFDbEIsTUFyQ2tCLENBcUNYO2VBQUssRUFBRSxNQUFGLEdBQVcsQ0FBWDtLQUFMLENBckNXLENBc0NsQixjQXRDa0IsQ0FzQ0gsRUF0Q0csRUF1Q2xCLEtBdkNrQixHQXdDbEIsT0F4Q2tCLENBd0NWO2VBQUs7S0FBTCxDQXhDUCxDQVI2RztBQWtEbkgsV0FBTyxjQUFQLENBbERtSDtDQUF2SCIsImZpbGUiOiJsaWIvY2FuZGlkYXRlLWZpbmRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7SUxvZ2dlcn0gZnJvbSBcIi4vZW51bXNcIjtcbmltcG9ydCB7am9pbiwgZGlybmFtZSwgc2VwLCBub3JtYWxpemV9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQge09ic2VydmFibGUsIFNjaGVkdWxlciwgU3Vic2NyaXB0aW9ufSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IFwicnhqcy9hZGQvb3BlcmF0b3IvZGlzdGluY3RLZXlcIjtcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSBcIi4vZGlzcG9zYWJsZXNcIjtcbmltcG9ydCB7Y3JlYXRlT2JzZXJ2YWJsZX0gZnJvbSBcIi4vb3BlcmF0b3JzL2NyZWF0ZVwiO1xuaW1wb3J0IHtyZWFkRmlsZVN5bmN9IGZyb20gXCJmc1wiO1xuY29uc3QgZ2xvYjogKGZpbGU6IHN0cmluZ1tdLCBvcHRpb25zPzogYW55KSA9PiBQcm9taXNlPHN0cmluZ1tdPiA9IHJlcXVpcmUoXCJnbG9iYnlcIik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG4gICAgc29sdXRpb25GaWxlc1RvU2VhcmNoPzogc3RyaW5nW107XG4gICAgcHJvamVjdEZpbGVzVG9TZWFyY2g/OiBzdHJpbmdbXTtcbiAgICBzb3VyY2VGaWxlc1RvU2VhcmNoPzogc3RyaW5nW107XG4gICAgc29sdXRpb25JbmRlcGVuZGVudFNvdXJjZUZpbGVzVG9TZWFyY2g/OiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlmRW1wdHk8VD4ob2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUPiwgb3RoZXI6IE9ic2VydmFibGU8VD4pIHtcbiAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZTxUPihvYnNlcnZlciA9PiB7XG4gICAgICAgIGxldCBoYXNWYWx1ZSA9IGZhbHNlO1xuICAgICAgICBjb25zdCBjZCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgIGNkLmFkZChvYnNlcnZhYmxlLnN1YnNjcmliZShcbiAgICAgICAgICAgIHZhbHVlID0+IHtcbiAgICAgICAgICAgICAgICBoYXNWYWx1ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh2YWx1ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZSA9PiBvYnNlcnZlci5lcnJvcihlKSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWhhc1ZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNkLmFkZChvdGhlci5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9PiBvYnNlcnZlci5uZXh0KHZhbHVlKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGUgPT4gb2JzZXJ2ZXIuZXJyb3IoZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApKTtcbiAgICAgICAgcmV0dXJuIG5ldyBTdWJzY3JpcHRpb24oKCkgPT4gY2QuZGlzcG9zZSgpKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGNsYXNzIENhbmRpZGF0ZSB7XG4gICAgcHVibGljIHBhdGg6IHN0cmluZztcbiAgICBwdWJsaWMgb3JpZ2luYWxGaWxlOiBzdHJpbmc7XG4gICAgcHVibGljIGlzUHJvamVjdDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKG9yaWdpbmFsRmlsZTogc3RyaW5nLCBwcmVkaWNhdGU6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5vcmlnaW5hbEZpbGUgPSBvcmlnaW5hbEZpbGUgPSBub3JtYWxpemUob3JpZ2luYWxGaWxlKTtcbiAgICAgICAgdGhpcy5wYXRoID0gXy5lbmRzV2l0aChvcmlnaW5hbEZpbGUsIFwiLnNsblwiKSA/IG9yaWdpbmFsRmlsZSA6IGRpcm5hbWUob3JpZ2luYWxGaWxlKTtcbiAgICAgICAgdGhpcy5pc1Byb2plY3QgPSBwcmVkaWNhdGUob3JpZ2luYWxGaWxlKTtcblxuICAgICAgICBPYmplY3QuZnJlZXplKHRoaXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGF0aDtcbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBmaW5kQ2FuZGlkYXRlcyA9IChmdW5jdGlvbigpIHtcbiAgICBmdW5jdGlvbiByZWFsRmluZENhbmRpZGF0ZXMobG9jYXRpb246IHN0cmluZywgbG9nZ2VyOiBJTG9nZ2VyLCBvcHRpb25zOiBPcHRpb25zID0ge30pIHtcbiAgICAgICAgbG9jYXRpb24gPSBfLnRyaW1FbmQobG9jYXRpb24sIHNlcCk7XG5cbiAgICAgICAgY29uc3Qgc29sdXRpb25GaWxlc1RvU2VhcmNoID0gb3B0aW9ucy5zb2x1dGlvbkZpbGVzVG9TZWFyY2ggfHwgKG9wdGlvbnMuc29sdXRpb25GaWxlc1RvU2VhcmNoID0gW1wiZ2xvYmFsLmpzb25cIiwgXCIqLnNsblwiXSk7XG4gICAgICAgIGNvbnN0IHByb2plY3RGaWxlc1RvU2VhcmNoID0gb3B0aW9ucy5wcm9qZWN0RmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5wcm9qZWN0RmlsZXNUb1NlYXJjaCA9IFtcInByb2plY3QuanNvblwiLCBcIiouY3Nwcm9qXCJdKTtcbiAgICAgICAgY29uc3Qgc291cmNlRmlsZXNUb1NlYXJjaCA9IG9wdGlvbnMuc291cmNlRmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5zb3VyY2VGaWxlc1RvU2VhcmNoID0gW1wiKi5jc1wiXSk7XG4gICAgICAgIGNvbnN0IHNvbHV0aW9uSW5kZXBlbmRlbnRTb3VyY2VGaWxlc1RvU2VhcmNoID0gb3B0aW9ucy5zb2x1dGlvbkluZGVwZW5kZW50U291cmNlRmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5zb2x1dGlvbkluZGVwZW5kZW50U291cmNlRmlsZXNUb1NlYXJjaCA9IFtcIiouY3N4XCJdKTtcblxuICAgICAgICBjb25zdCBzb2x1dGlvbnNPclByb2plY3RzID0gc2VhcmNoRm9yQ2FuZGlkYXRlcyhsb2NhdGlvbiwgc29sdXRpb25GaWxlc1RvU2VhcmNoLCBwcm9qZWN0RmlsZXNUb1NlYXJjaCwgbG9nZ2VyKVxuICAgICAgICAgICAgLnRvQXJyYXkoKVxuICAgICAgICAgICAgLmZsYXRNYXAocmVzdWx0ID0+IHJlc3VsdC5sZW5ndGggPyBPYnNlcnZhYmxlLmZyb20ocmVzdWx0KSA6IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHByb2plY3RGaWxlc1RvU2VhcmNoLCBbXSwgbG9nZ2VyKSlcbiAgICAgICAgICAgIC50b0FycmF5KClcbiAgICAgICAgICAgIC5tYXAoc3F1YXNoQ2FuZGlkYXRlcyk7XG5cbiAgICAgICAgY29uc3QgaW5kZXBlbmRlbnRTb3VyY2VGaWxlcyA9IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHNvbHV0aW9uSW5kZXBlbmRlbnRTb3VyY2VGaWxlc1RvU2VhcmNoLCBbXSwgbG9nZ2VyKVxuICAgICAgICAgICAgLnRvQXJyYXkoKTtcblxuICAgICAgICBjb25zdCBiYXNlRmlsZXMgPSBPYnNlcnZhYmxlLmNvbmNhdChzb2x1dGlvbnNPclByb2plY3RzLCBpbmRlcGVuZGVudFNvdXJjZUZpbGVzKVxuICAgICAgICAgICAgLmZsYXRNYXAoeCA9PiB4KTtcblxuICAgICAgICBjb25zdCBzb3VyY2VGaWxlcyA9IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHNvdXJjZUZpbGVzVG9TZWFyY2gsIFtdLCBsb2dnZXIpO1xuXG4gICAgICAgIGNvbnN0IHByZWRpY2F0ZSA9IChwYXRoOiBzdHJpbmcpID0+IF8uc29tZShzb2x1dGlvbkZpbGVzVG9TZWFyY2guY29uY2F0KHByb2plY3RGaWxlc1RvU2VhcmNoKSwgcGF0dGVybiA9PiBfLmVuZHNXaXRoKHBhdGgsIF8udHJpbVN0YXJ0KHBhdHRlcm4sIFwiKlwiKSkpO1xuXG4gICAgICAgIHJldHVybiBpZkVtcHR5KGJhc2VGaWxlcywgc291cmNlRmlsZXMpXG4gICAgICAgICAgICAubWFwKGZpbGUgPT4gbmV3IENhbmRpZGF0ZShmaWxlLCBwcmVkaWNhdGUpKVxuICAgICAgICAgICAgLmRpc3RpbmN0S2V5KFwicGF0aFwiKVxuICAgICAgICAgICAgLnRvQXJyYXkoKVxuICAgICAgICAgICAgLmRvKGNhbmRpZGF0ZXMgPT4gbG9nZ2VyLmxvZyhgT21uaSBQcm9qZWN0IENhbmRpZGF0ZXM6IEZvdW5kICR7Y2FuZGlkYXRlc31gKSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZmluZENhbmRpZGF0ZXMobG9jYXRpb246IHN0cmluZywgbG9nZ2VyOiBJTG9nZ2VyLCBvcHRpb25zOiBPcHRpb25zID0ge30pIHtcbiAgICAgICAgcmV0dXJuIHJlYWxGaW5kQ2FuZGlkYXRlcyhsb2NhdGlvbiwgbG9nZ2VyLCBvcHRpb25zKVxuICAgICAgICAgICAgLm1hcCh6ID0+IHoubWFwKHggPT4geC50b1N0cmluZygpKSk7XG4gICAgfVxuXG4gICAgKDxhbnk+ZmluZENhbmRpZGF0ZXMpLndpdGhDYW5kaWRhdGVzID0gcmVhbEZpbmRDYW5kaWRhdGVzO1xuXG4gICAgcmV0dXJuIDx7IChsb2NhdGlvbjogc3RyaW5nLCBsb2dnZXI6IElMb2dnZXIsIG9wdGlvbnM6IE9wdGlvbnMgPSB7fSk6IE9ic2VydmFibGU8c3RyaW5nW10+OyB3aXRoQ2FuZGlkYXRlczogdHlwZW9mIHJlYWxGaW5kQ2FuZGlkYXRlcyB9PmZpbmRDYW5kaWRhdGVzO1xufSkoKTtcblxuZnVuY3Rpb24gc3F1YXNoQ2FuZGlkYXRlcyhjYW5kaWRhdGVzOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHJvb3RDYW5kaWRhdGVDb3VudCA9IGdldE1pbkNhbmRpZGF0ZShjYW5kaWRhdGVzKTtcbiAgICByZXR1cm4gXy51bmlxKF8uZmlsdGVyKF8ubWFwKGNhbmRpZGF0ZXMsIG5vcm1hbGl6ZSksIHogPT4gei5zcGxpdChzZXApLmxlbmd0aCA9PT0gcm9vdENhbmRpZGF0ZUNvdW50KSk7XG59XG5cbmZ1bmN0aW9uIGdldE1pbkNhbmRpZGF0ZShjYW5kaWRhdGVzOiBzdHJpbmdbXSkge1xuICAgIGlmICghY2FuZGlkYXRlcy5sZW5ndGgpIHJldHVybiAtMTtcblxuICAgIHJldHVybiBfLm1pbkJ5KF8ubWFwKGNhbmRpZGF0ZXMsIG5vcm1hbGl6ZSksIHogPT4gei5zcGxpdChzZXApLmxlbmd0aCkuc3BsaXQoc2VwKS5sZW5ndGg7XG59XG5cbmZ1bmN0aW9uIHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb246IHN0cmluZywgZmlsZXNUb1NlYXJjaDogc3RyaW5nW10sIHByb2plY3RGaWxlc1RvU2VhcmNoOiBzdHJpbmdbXSwgbG9nZ2VyOiBJTG9nZ2VyKSB7XG4gICAgbGV0IGxvY2F0aW9ucyA9IGxvY2F0aW9uLnNwbGl0KHNlcCk7XG4gICAgbG9jYXRpb25zID0gbG9jYXRpb25zLm1hcCgobG9jLCBpbmRleCkgPT4ge1xuICAgICAgICByZXR1cm4gXy50YWtlKGxvY2F0aW9ucywgbG9jYXRpb25zLmxlbmd0aCAtIGluZGV4KS5qb2luKHNlcCk7XG4gICAgfSk7XG5cbiAgICBsb2NhdGlvbnMgPSBsb2NhdGlvbnMuc2xpY2UoMCwgTWF0aC5taW4oNSwgbG9jYXRpb25zLmxlbmd0aCkpO1xuXG4gICAgY29uc3Qgcm9vdE9ic2VydmFibGUgPSBPYnNlcnZhYmxlLmZyb20obG9jYXRpb25zKVxuICAgICAgICAuc3Vic2NyaWJlT24oU2NoZWR1bGVyLnF1ZXVlKVxuICAgICAgICAubWFwKGxvYyA9PiAoe1xuICAgICAgICAgICAgbG9jLFxuICAgICAgICAgICAgZmlsZXM6IGZpbGVzVG9TZWFyY2gubWFwKGZpbGVOYW1lID0+IGpvaW4obG9jLCBmaWxlTmFtZSkpXG4gICAgICAgIH0pKVxuICAgICAgICAuZmxhdE1hcChmdW5jdGlvbih7bG9jLCBmaWxlc30pIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coYE9tbmkgUHJvamVjdCBDYW5kaWRhdGVzOiBTZWFyY2hpbmcgJHtsb2N9IGZvciAke2ZpbGVzVG9TZWFyY2h9YCk7XG5cbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb208c3RyaW5nPihmaWxlcylcbiAgICAgICAgICAgICAgICAuZmxhdE1hcChmaWxlID0+IGdsb2IoW2ZpbGVdLCB7IGNhY2hlOiB7fSB9KSlcbiAgICAgICAgICAgICAgICAubWFwKHggPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoeC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdGhlIHVuaXR5IHByb2plY3QgY2FzZVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWxzbyBoYW5kbGUgb3B0aW9uYWwgc29sdXRpb25zIHRoYXQgbWF5IGFsc28gZXhpc3Qgd2l0aCB0aGUgdW5pdHkgb25lcy5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuaXR5U29sdXRpb25JbmRleCA9IF8uZmluZEluZGV4KHgsIHogPT4gXy5lbmRzV2l0aCh6LCBcIi1jc2hhcnAuc2xuXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bml0eVNvbHV0aW9uSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuaXR5U29sdXRpb24gPSB4W3VuaXR5U29sdXRpb25JbmRleF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZVNvbHV0aW9uID0gdW5pdHlTb2x1dGlvbi5zdWJzdHIoMCwgdW5pdHlTb2x1dGlvbi5pbmRleE9mKFwiLWNzaGFycC5zbG5cIikpICsgXCIuc2xuXCI7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlU29sdXRpb25JbmRleCA9IF8uZmluZEluZGV4KHgsIHogPT4gei50b0xvd2VyQ2FzZSgpID09PSBiYXNlU29sdXRpb24udG9Mb3dlckNhc2UoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VTb2x1dGlvbkluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBpbmRleFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4LnNwbGljZShiYXNlU29sdXRpb25JbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uc29tZSh4LCBmaWxlID0+IF8uZW5kc1dpdGgoZmlsZSwgXCIuc2xuXCIpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguZmlsdGVyKGZpbGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSByZWFkRmlsZVN5bmMoZmlsZSkudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXy5zb21lKHByb2plY3RGaWxlc1RvU2VhcmNoLCBwYXRoID0+IGNvbnRlbnQuaW5kZXhPZihfLnRyaW1TdGFydChwYXRoLCBcIipcIikpID4gLTEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5maWx0ZXIoeiA9PiB6Lmxlbmd0aCA+IDApXG4gICAgICAgIC5kZWZhdWx0SWZFbXB0eShbXSlcbiAgICAgICAgLmZpcnN0KClcbiAgICAgICAgLmZsYXRNYXAoeiA9PiB6KTtcblxuICAgIHJldHVybiByb290T2JzZXJ2YWJsZTtcbn1cbiIsImltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUsIHNlcCwgbm9ybWFsaXplIH0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIFNjaGVkdWxlciwgU3Vic2NyaXB0aW9uIH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCBcInJ4anMvYWRkL29wZXJhdG9yL2Rpc3RpbmN0S2V5XCI7XG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSBcIi4vZGlzcG9zYWJsZXNcIjtcbmltcG9ydCB7IGNyZWF0ZU9ic2VydmFibGUgfSBmcm9tIFwiLi9vcGVyYXRvcnMvY3JlYXRlXCI7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tIFwiZnNcIjtcbmNvbnN0IGdsb2IgPSByZXF1aXJlKFwiZ2xvYmJ5XCIpO1xuZXhwb3J0IGZ1bmN0aW9uIGlmRW1wdHkob2JzZXJ2YWJsZSwgb3RoZXIpIHtcbiAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZShvYnNlcnZlciA9PiB7XG4gICAgICAgIGxldCBoYXNWYWx1ZSA9IGZhbHNlO1xuICAgICAgICBjb25zdCBjZCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgIGNkLmFkZChvYnNlcnZhYmxlLnN1YnNjcmliZSh2YWx1ZSA9PiB7XG4gICAgICAgICAgICBoYXNWYWx1ZSA9IHRydWU7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KHZhbHVlKTtcbiAgICAgICAgfSwgZSA9PiBvYnNlcnZlci5lcnJvcihlKSwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFoYXNWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGNkLmFkZChvdGhlci5zdWJzY3JpYmUodmFsdWUgPT4gb2JzZXJ2ZXIubmV4dCh2YWx1ZSksIGUgPT4gb2JzZXJ2ZXIuZXJyb3IoZSksICgpID0+IG9ic2VydmVyLmNvbXBsZXRlKCkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICAgICAgcmV0dXJuIG5ldyBTdWJzY3JpcHRpb24oKCkgPT4gY2QuZGlzcG9zZSgpKTtcbiAgICB9KTtcbn1cbmV4cG9ydCBjbGFzcyBDYW5kaWRhdGUge1xuICAgIGNvbnN0cnVjdG9yKG9yaWdpbmFsRmlsZSwgcHJlZGljYXRlKSB7XG4gICAgICAgIHRoaXMub3JpZ2luYWxGaWxlID0gb3JpZ2luYWxGaWxlID0gbm9ybWFsaXplKG9yaWdpbmFsRmlsZSk7XG4gICAgICAgIHRoaXMucGF0aCA9IF8uZW5kc1dpdGgob3JpZ2luYWxGaWxlLCBcIi5zbG5cIikgPyBvcmlnaW5hbEZpbGUgOiBkaXJuYW1lKG9yaWdpbmFsRmlsZSk7XG4gICAgICAgIHRoaXMuaXNQcm9qZWN0ID0gcHJlZGljYXRlKG9yaWdpbmFsRmlsZSk7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gICAgfVxuICAgIHRvU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wYXRoO1xuICAgIH1cbn1cbmV4cG9ydCBjb25zdCBmaW5kQ2FuZGlkYXRlcyA9IChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gcmVhbEZpbmRDYW5kaWRhdGVzKGxvY2F0aW9uLCBsb2dnZXIsIG9wdGlvbnMgPSB7fSkge1xuICAgICAgICBsb2NhdGlvbiA9IF8udHJpbUVuZChsb2NhdGlvbiwgc2VwKTtcbiAgICAgICAgY29uc3Qgc29sdXRpb25GaWxlc1RvU2VhcmNoID0gb3B0aW9ucy5zb2x1dGlvbkZpbGVzVG9TZWFyY2ggfHwgKG9wdGlvbnMuc29sdXRpb25GaWxlc1RvU2VhcmNoID0gW1wiZ2xvYmFsLmpzb25cIiwgXCIqLnNsblwiXSk7XG4gICAgICAgIGNvbnN0IHByb2plY3RGaWxlc1RvU2VhcmNoID0gb3B0aW9ucy5wcm9qZWN0RmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5wcm9qZWN0RmlsZXNUb1NlYXJjaCA9IFtcInByb2plY3QuanNvblwiLCBcIiouY3Nwcm9qXCJdKTtcbiAgICAgICAgY29uc3Qgc291cmNlRmlsZXNUb1NlYXJjaCA9IG9wdGlvbnMuc291cmNlRmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5zb3VyY2VGaWxlc1RvU2VhcmNoID0gW1wiKi5jc1wiXSk7XG4gICAgICAgIGNvbnN0IHNvbHV0aW9uSW5kZXBlbmRlbnRTb3VyY2VGaWxlc1RvU2VhcmNoID0gb3B0aW9ucy5zb2x1dGlvbkluZGVwZW5kZW50U291cmNlRmlsZXNUb1NlYXJjaCB8fCAob3B0aW9ucy5zb2x1dGlvbkluZGVwZW5kZW50U291cmNlRmlsZXNUb1NlYXJjaCA9IFtcIiouY3N4XCJdKTtcbiAgICAgICAgY29uc3Qgc29sdXRpb25zT3JQcm9qZWN0cyA9IHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIHNvbHV0aW9uRmlsZXNUb1NlYXJjaCwgcHJvamVjdEZpbGVzVG9TZWFyY2gsIGxvZ2dlcilcbiAgICAgICAgICAgIC50b0FycmF5KClcbiAgICAgICAgICAgIC5mbGF0TWFwKHJlc3VsdCA9PiByZXN1bHQubGVuZ3RoID8gT2JzZXJ2YWJsZS5mcm9tKHJlc3VsdCkgOiBzZWFyY2hGb3JDYW5kaWRhdGVzKGxvY2F0aW9uLCBwcm9qZWN0RmlsZXNUb1NlYXJjaCwgW10sIGxvZ2dlcikpXG4gICAgICAgICAgICAudG9BcnJheSgpXG4gICAgICAgICAgICAubWFwKHNxdWFzaENhbmRpZGF0ZXMpO1xuICAgICAgICBjb25zdCBpbmRlcGVuZGVudFNvdXJjZUZpbGVzID0gc2VhcmNoRm9yQ2FuZGlkYXRlcyhsb2NhdGlvbiwgc29sdXRpb25JbmRlcGVuZGVudFNvdXJjZUZpbGVzVG9TZWFyY2gsIFtdLCBsb2dnZXIpXG4gICAgICAgICAgICAudG9BcnJheSgpO1xuICAgICAgICBjb25zdCBiYXNlRmlsZXMgPSBPYnNlcnZhYmxlLmNvbmNhdChzb2x1dGlvbnNPclByb2plY3RzLCBpbmRlcGVuZGVudFNvdXJjZUZpbGVzKVxuICAgICAgICAgICAgLmZsYXRNYXAoeCA9PiB4KTtcbiAgICAgICAgY29uc3Qgc291cmNlRmlsZXMgPSBzZWFyY2hGb3JDYW5kaWRhdGVzKGxvY2F0aW9uLCBzb3VyY2VGaWxlc1RvU2VhcmNoLCBbXSwgbG9nZ2VyKTtcbiAgICAgICAgY29uc3QgcHJlZGljYXRlID0gKHBhdGgpID0+IF8uc29tZShzb2x1dGlvbkZpbGVzVG9TZWFyY2guY29uY2F0KHByb2plY3RGaWxlc1RvU2VhcmNoKSwgcGF0dGVybiA9PiBfLmVuZHNXaXRoKHBhdGgsIF8udHJpbVN0YXJ0KHBhdHRlcm4sIFwiKlwiKSkpO1xuICAgICAgICByZXR1cm4gaWZFbXB0eShiYXNlRmlsZXMsIHNvdXJjZUZpbGVzKVxuICAgICAgICAgICAgLm1hcChmaWxlID0+IG5ldyBDYW5kaWRhdGUoZmlsZSwgcHJlZGljYXRlKSlcbiAgICAgICAgICAgIC5kaXN0aW5jdEtleShcInBhdGhcIilcbiAgICAgICAgICAgIC50b0FycmF5KClcbiAgICAgICAgICAgIC5kbyhjYW5kaWRhdGVzID0+IGxvZ2dlci5sb2coYE9tbmkgUHJvamVjdCBDYW5kaWRhdGVzOiBGb3VuZCAke2NhbmRpZGF0ZXN9YCkpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBmaW5kQ2FuZGlkYXRlcyhsb2NhdGlvbiwgbG9nZ2VyLCBvcHRpb25zID0ge30pIHtcbiAgICAgICAgcmV0dXJuIHJlYWxGaW5kQ2FuZGlkYXRlcyhsb2NhdGlvbiwgbG9nZ2VyLCBvcHRpb25zKVxuICAgICAgICAgICAgLm1hcCh6ID0+IHoubWFwKHggPT4geC50b1N0cmluZygpKSk7XG4gICAgfVxuICAgIGZpbmRDYW5kaWRhdGVzLndpdGhDYW5kaWRhdGVzID0gcmVhbEZpbmRDYW5kaWRhdGVzO1xuICAgIHJldHVybiBmaW5kQ2FuZGlkYXRlcztcbn0pKCk7XG5mdW5jdGlvbiBzcXVhc2hDYW5kaWRhdGVzKGNhbmRpZGF0ZXMpIHtcbiAgICBjb25zdCByb290Q2FuZGlkYXRlQ291bnQgPSBnZXRNaW5DYW5kaWRhdGUoY2FuZGlkYXRlcyk7XG4gICAgcmV0dXJuIF8udW5pcShfLmZpbHRlcihfLm1hcChjYW5kaWRhdGVzLCBub3JtYWxpemUpLCB6ID0+IHouc3BsaXQoc2VwKS5sZW5ndGggPT09IHJvb3RDYW5kaWRhdGVDb3VudCkpO1xufVxuZnVuY3Rpb24gZ2V0TWluQ2FuZGlkYXRlKGNhbmRpZGF0ZXMpIHtcbiAgICBpZiAoIWNhbmRpZGF0ZXMubGVuZ3RoKVxuICAgICAgICByZXR1cm4gLTE7XG4gICAgcmV0dXJuIF8ubWluQnkoXy5tYXAoY2FuZGlkYXRlcywgbm9ybWFsaXplKSwgeiA9PiB6LnNwbGl0KHNlcCkubGVuZ3RoKS5zcGxpdChzZXApLmxlbmd0aDtcbn1cbmZ1bmN0aW9uIHNlYXJjaEZvckNhbmRpZGF0ZXMobG9jYXRpb24sIGZpbGVzVG9TZWFyY2gsIHByb2plY3RGaWxlc1RvU2VhcmNoLCBsb2dnZXIpIHtcbiAgICBsZXQgbG9jYXRpb25zID0gbG9jYXRpb24uc3BsaXQoc2VwKTtcbiAgICBsb2NhdGlvbnMgPSBsb2NhdGlvbnMubWFwKChsb2MsIGluZGV4KSA9PiB7XG4gICAgICAgIHJldHVybiBfLnRha2UobG9jYXRpb25zLCBsb2NhdGlvbnMubGVuZ3RoIC0gaW5kZXgpLmpvaW4oc2VwKTtcbiAgICB9KTtcbiAgICBsb2NhdGlvbnMgPSBsb2NhdGlvbnMuc2xpY2UoMCwgTWF0aC5taW4oNSwgbG9jYXRpb25zLmxlbmd0aCkpO1xuICAgIGNvbnN0IHJvb3RPYnNlcnZhYmxlID0gT2JzZXJ2YWJsZS5mcm9tKGxvY2F0aW9ucylcbiAgICAgICAgLnN1YnNjcmliZU9uKFNjaGVkdWxlci5xdWV1ZSlcbiAgICAgICAgLm1hcChsb2MgPT4gKHtcbiAgICAgICAgbG9jLFxuICAgICAgICBmaWxlczogZmlsZXNUb1NlYXJjaC5tYXAoZmlsZU5hbWUgPT4gam9pbihsb2MsIGZpbGVOYW1lKSlcbiAgICB9KSlcbiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKHsgbG9jLCBmaWxlcyB9KSB7XG4gICAgICAgIGxvZ2dlci5sb2coYE9tbmkgUHJvamVjdCBDYW5kaWRhdGVzOiBTZWFyY2hpbmcgJHtsb2N9IGZvciAke2ZpbGVzVG9TZWFyY2h9YCk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb20oZmlsZXMpXG4gICAgICAgICAgICAuZmxhdE1hcChmaWxlID0+IGdsb2IoW2ZpbGVdLCB7IGNhY2hlOiB7fSB9KSlcbiAgICAgICAgICAgIC5tYXAoeCA9PiB7XG4gICAgICAgICAgICBpZiAoeC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdW5pdHlTb2x1dGlvbkluZGV4ID0gXy5maW5kSW5kZXgoeCwgeiA9PiBfLmVuZHNXaXRoKHosIFwiLWNzaGFycC5zbG5cIikpO1xuICAgICAgICAgICAgICAgIGlmICh1bml0eVNvbHV0aW9uSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1bml0eVNvbHV0aW9uID0geFt1bml0eVNvbHV0aW9uSW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlU29sdXRpb24gPSB1bml0eVNvbHV0aW9uLnN1YnN0cigwLCB1bml0eVNvbHV0aW9uLmluZGV4T2YoXCItY3NoYXJwLnNsblwiKSkgKyBcIi5zbG5cIjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZVNvbHV0aW9uSW5kZXggPSBfLmZpbmRJbmRleCh4LCB6ID0+IHoudG9Mb3dlckNhc2UoKSA9PT0gYmFzZVNvbHV0aW9uLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZVNvbHV0aW9uSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgeC5zcGxpY2UoYmFzZVNvbHV0aW9uSW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKF8uc29tZSh4LCBmaWxlID0+IF8uZW5kc1dpdGgoZmlsZSwgXCIuc2xuXCIpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4LmZpbHRlcihmaWxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHJlYWRGaWxlU3luYyhmaWxlKS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXy5zb21lKHByb2plY3RGaWxlc1RvU2VhcmNoLCBwYXRoID0+IGNvbnRlbnQuaW5kZXhPZihfLnRyaW1TdGFydChwYXRoLCBcIipcIikpID4gLTEpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgIH0pO1xuICAgIH0pXG4gICAgICAgIC5maWx0ZXIoeiA9PiB6Lmxlbmd0aCA+IDApXG4gICAgICAgIC5kZWZhdWx0SWZFbXB0eShbXSlcbiAgICAgICAgLmZpcnN0KClcbiAgICAgICAgLmZsYXRNYXAoeiA9PiB6KTtcbiAgICByZXR1cm4gcm9vdE9ic2VydmFibGU7XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
