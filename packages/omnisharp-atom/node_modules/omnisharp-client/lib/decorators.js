"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.isNotNull = isNotNull;
exports.isAboveZero = isAboveZero;
exports.precondition = precondition;
exports.endpoint = endpoint;
exports.fixup = fixup;
exports.watchCommand = watchCommand;
exports.watchEvent = watchEvent;
exports.merge = merge;
exports.aggregate = aggregate;
exports.reference = reference;
exports.inheritProperties = inheritProperties;

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _rxjs = require("rxjs");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isNotNull(method) {
    return function isNotNull(target, propertyKey, descriptor) {
        var value = descriptor.value;
        descriptor.value = function (request) {
            var result = method(request);
            if (result === null || result === undefined) {
                var match = method.toString().match(/function \(request\) { return (.*?); }/);
                var methodText = match && match[1] || method.toString();
                var errorText = methodText + "  must not be null.";
                throw new Error(errorText);
            }
            return value.apply(this, arguments);
        };
    };
}
function isAboveZero(method) {
    return function isAboveZero(target, propertyKey, descriptor) {
        var value = descriptor.value;
        descriptor.value = function (request) {
            var minValue = (this._options.oneBasedIndices ? 1 : 0) - 1;
            var result = method(request);
            if (result === null || result === undefined) {
                return;
            }
            if (result <= minValue) {
                var match = method.toString().match(/function \(request\) { return (.*?); }/);
                var methodText = match && match[1] || method.toString();
                var errorText = methodText + " must be greater than or equal to " + (minValue + 1) + ".";
                throw new Error(errorText);
            }
            return value.apply(this, arguments);
        };
    };
}
function precondition(method) {
    for (var _len = arguments.length, decorators = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        decorators[_key - 1] = arguments[_key];
    }

    return function precondition(target, propertyKey, descriptor) {
        var originalValue = descriptor.value;
        var methods = _lodash2.default.map(decorators, function (decorator) {
            descriptor.value = _lodash2.default.noop;
            decorator(target, propertyKey, descriptor);
            return descriptor.value;
        });
        descriptor.value = function (request) {
            var _this = this;

            if (method(request)) {
                methods.forEach(function (m) {
                    return m.call(_this, request);
                });
            }
            return originalValue.apply(this, arguments);
        };
    };
}
function endpoint() {
    var version = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];

    var format = function format(name) {
        return name;
    };
    if (version > 1) {
        format = function format(name) {
            return "v" + version + "/" + name;
        };
    }
    return function endpoint(target, propertyKey, descriptor) {
        var name = format(propertyKey);
        descriptor.value = function (request, options) {
            return this.request(name, request, options);
        };
        descriptor.enumerable = true;
    };
}
function fixup(target, propertyKey, descriptor) {
    var value = descriptor.value;
    descriptor.value = function (request, options) {
        this._fixup(propertyKey, request, options);
        return value.apply(this, arguments);
    };
}
function watchCommand(target, propertyKey, descriptor) {
    var internalKey = "__" + propertyKey + "__";
    descriptor.get = function () {
        var instance = this._client || this;
        if (!instance._commandWatchers.get(propertyKey)) {
            var subject = new _rxjs.Subject();
            var observable = subject.share();
            instance._commandWatchers.set(propertyKey.toLowerCase(), [subject, observable]);
            this[internalKey] = observable;
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
}
function watchEvent(target, propertyKey, descriptor) {
    var internalKey = "__" + propertyKey + "__";
    var eventKey = propertyKey[0].toUpperCase() + propertyKey.substr(1);
    descriptor.get = function () {
        var instance = this._client || this;
        if (!instance._eventWatchers.get(eventKey)) {
            var subject = new _rxjs.Subject();
            var observable = subject.share();
            instance._eventWatchers.set(eventKey, [subject, observable]);
            this[internalKey] = observable;
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
}
function merge(target, propertyKey, descriptor) {
    var internalKey = "__" + propertyKey + "__";
    var method = function method(c) {
        return c.observe[propertyKey] || c[propertyKey];
    };
    descriptor.get = function () {
        if (!this[internalKey]) {
            var value = this.makeMergeObserable(method);
            this[internalKey] = value;
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
}
function aggregate(target, propertyKey, descriptor) {
    var internalKey = "__" + propertyKey + "__";
    var method = function method(c) {
        return c.observe[propertyKey] || c[propertyKey];
    };
    descriptor.get = function () {
        if (!this[internalKey]) {
            var value = this.makeAggregateObserable(method);
            this[internalKey] = value;
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
}
function reference(target, propertyKey, descriptor) {
    descriptor.get = function () {
        return this._client[propertyKey];
    };
}
function inheritProperties(source, dest) {
    _lodash2.default.each(_lodash2.default.keys(source.prototype), function (key) {
        var descriptor = Object.getOwnPropertyDescriptor(source.prototype, key);
        var isDefined = !!_lodash2.default.has(dest.prototype, key);
        if (descriptor && !isDefined) {
            if (_lodash2.default.has(descriptor, "value") || _lodash2.default.has(descriptor, "writable")) {
                Object.defineProperty(dest.prototype, key, {
                    configurable: descriptor.configurable,
                    enumerable: descriptor.enumerable,
                    value: descriptor.value,
                    writable: descriptor.writable
                });
            } else {
                Object.defineProperty(dest.prototype, key, {
                    configurable: descriptor.configurable,
                    enumerable: descriptor.enumerable,
                    get: descriptor.get,
                    set: descriptor.set
                });
            }
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZWNvcmF0b3JzLnRzIiwibGliL2RlY29yYXRvcnMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFJQTtRQWdCQTtRQW9CQTtRQWtCQTtRQWNBO1FBUUE7UUFnQkE7UUFpQkE7UUFhQTtRQWFBO1FBSUE7O0FDL0lBOzs7O0FBQ0E7Ozs7QURHQSxTQUFBLFNBQUEsQ0FBMEIsTUFBMUIsRUFBMEM7QUFDdEMsV0FBTyxTQUFBLFNBQUEsQ0FBbUIsTUFBbkIsRUFBbUMsV0FBbkMsRUFBd0QsVUFBeEQsRUFBZ0c7QUFDbkcsWUFBTSxRQUFRLFdBQVcsS0FBWCxDQURxRjtBQUVuRyxtQkFBVyxLQUFYLEdBQW1CLFVBQVMsT0FBVCxFQUEwQztBQUN6RCxnQkFBTSxTQUFTLE9BQU8sT0FBUCxDQUFULENBRG1EO0FBRXpELGdCQUFJLFdBQVcsSUFBWCxJQUFtQixXQUFXLFNBQVgsRUFBc0I7QUFDekMsb0JBQU0sUUFBUSxPQUFPLFFBQVAsR0FBa0IsS0FBbEIsQ0FBd0Isd0NBQXhCLENBQVIsQ0FEbUM7QUFFekMsb0JBQU0sYUFBYSxTQUFTLE1BQU0sQ0FBTixDQUFULElBQXFCLE9BQU8sUUFBUCxFQUFyQixDQUZzQjtBQUd6QyxvQkFBTSxZQUFlLGtDQUFmLENBSG1DO0FBSXpDLHNCQUFNLElBQUksS0FBSixDQUFVLFNBQVYsQ0FBTixDQUp5QzthQUE3QztBQU1BLG1CQUFPLE1BQU0sS0FBTixDQUFZLElBQVosRUFBa0IsU0FBbEIsQ0FBUCxDQVJ5RDtTQUExQyxDQUZnRjtLQUFoRyxDQUQrQjtDQUExQztBQWdCQSxTQUFBLFdBQUEsQ0FBNEIsTUFBNUIsRUFBNEM7QUFDeEMsV0FBTyxTQUFBLFdBQUEsQ0FBcUIsTUFBckIsRUFBcUMsV0FBckMsRUFBMEQsVUFBMUQsRUFBa0c7QUFDckcsWUFBTSxRQUFRLFdBQVcsS0FBWCxDQUR1RjtBQUVyRyxtQkFBVyxLQUFYLEdBQW1CLFVBQVMsT0FBVCxFQUEwQztBQUN6RCxnQkFBTSxXQUFXLENBQUMs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NkIsQ0FBakMsQ0FEb0Q7Q0FBeEQiLCJmaWxlIjoibGliL2RlY29yYXRvcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBPbW5pU2hhcnAgZnJvbSBcIi4vb21uaXNoYXJwLXNlcnZlclwiO1xuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHtTdWJqZWN0fSBmcm9tIFwicnhqc1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNOb3ROdWxsKG1ldGhvZDogRnVuY3Rpb24pIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gaXNOb3ROdWxsKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+KSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICAgICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uKHJlcXVlc3Q6IE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdCkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbWV0aG9kKHJlcXVlc3QpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gbWV0aG9kLnRvU3RyaW5nKCkubWF0Y2goL2Z1bmN0aW9uIFxcKHJlcXVlc3RcXCkgeyByZXR1cm4gKC4qPyk7IH0vKTtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRob2RUZXh0ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgbWV0aG9kLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYCR7bWV0aG9kVGV4dH0gIG11c3Qgbm90IGJlIG51bGwuYDtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JUZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0Fib3ZlWmVybyhtZXRob2Q6IEZ1bmN0aW9uKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIGlzQWJvdmVaZXJvKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+KSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICAgICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uKHJlcXVlc3Q6IE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdCkge1xuICAgICAgICAgICAgY29uc3QgbWluVmFsdWUgPSAodGhpcy5fb3B0aW9ucy5vbmVCYXNlZEluZGljZXMgPyAxIDogMCkgLSAxO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbWV0aG9kKHJlcXVlc3QpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHQgPD0gbWluVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IG1ldGhvZC50b1N0cmluZygpLm1hdGNoKC9mdW5jdGlvbiBcXChyZXF1ZXN0XFwpIHsgcmV0dXJuICguKj8pOyB9Lyk7XG4gICAgICAgICAgICAgICAgY29uc3QgbWV0aG9kVGV4dCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8IG1ldGhvZC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGAke21ldGhvZFRleHR9IG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvICR7bWluVmFsdWUgKyAxfS5gO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvclRleHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZWNvbmRpdGlvbihtZXRob2Q6IEZ1bmN0aW9uLCAuLi5kZWNvcmF0b3JzOiBNZXRob2REZWNvcmF0b3JbXSkge1xuICAgIHJldHVybiBmdW5jdGlvbiBwcmVjb25kaXRpb24odGFyZ2V0OiBPYmplY3QsIHByb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPGFueT4pIHtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxWYWx1ZSA9IGRlc2NyaXB0b3IudmFsdWU7XG4gICAgICAgIGNvbnN0IG1ldGhvZHMgPSBfLm1hcChkZWNvcmF0b3JzLCBkZWNvcmF0b3IgPT4ge1xuICAgICAgICAgICAgZGVzY3JpcHRvci52YWx1ZSA9IF8ubm9vcDtcbiAgICAgICAgICAgIGRlY29yYXRvcih0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yKTtcbiAgICAgICAgICAgIHJldHVybiBkZXNjcmlwdG9yLnZhbHVlO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24ocmVxdWVzdDogT21uaVNoYXJwLk1vZGVscy5SZXF1ZXN0KSB7XG4gICAgICAgICAgICBpZiAobWV0aG9kKHJlcXVlc3QpKSB7XG4gICAgICAgICAgICAgICAgbWV0aG9kcy5mb3JFYWNoKG0gPT4gbS5jYWxsKHRoaXMsIHJlcXVlc3QpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbFZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuZHBvaW50KHZlcnNpb24gPSAxKSB7XG4gICAgbGV0IGZvcm1hdCA9IChuYW1lOiBzdHJpbmcpID0+IG5hbWU7XG4gICAgaWYgKHZlcnNpb24gPiAxKSB7XG4gICAgICAgIGZvcm1hdCA9IChuYW1lKSA9PiBgdiR7dmVyc2lvbn0vJHtuYW1lfWA7XG4gICAgfVxuICAgIHJldHVybiBmdW5jdGlvbiBlbmRwb2ludCh0YXJnZXQ6IE9iamVjdCwgcHJvcGVydHlLZXk6IHN0cmluZywgZGVzY3JpcHRvcjogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8YW55Pikge1xuICAgICAgICBjb25zdCBuYW1lID0gZm9ybWF0KHByb3BlcnR5S2V5KTtcbiAgICAgICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uKHJlcXVlc3Q6IE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdCwgb3B0aW9uczogYW55KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KG5hbWUsIHJlcXVlc3QsIG9wdGlvbnMpO1xuICAgICAgICB9O1xuICAgICAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSB0cnVlO1xuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXh1cCh0YXJnZXQ6IE9iamVjdCwgcHJvcGVydHlLZXk6IHN0cmluZywgZGVzY3JpcHRvcjogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8YW55Pikge1xuICAgIGNvbnN0IHZhbHVlID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24ocmVxdWVzdDogT21uaVNoYXJwLk1vZGVscy5SZXF1ZXN0LCBvcHRpb25zOiBhbnkpIHtcbiAgICAgICAgdGhpcy5fZml4dXAocHJvcGVydHlLZXksIHJlcXVlc3QsIG9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gd2F0Y2hDb21tYW5kKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+KSB7XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBgX18ke3Byb3BlcnR5S2V5fV9fYDtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuX2NsaWVudCB8fCB0aGlzO1xuICAgICAgICBpZiAoIWluc3RhbmNlLl9jb21tYW5kV2F0Y2hlcnMuZ2V0KHByb3BlcnR5S2V5KSkge1xuICAgICAgICAgICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICAgICAgICAgIGNvbnN0IG9ic2VydmFibGUgPSBzdWJqZWN0LnNoYXJlKCk7XG5cbiAgICAgICAgICAgIGluc3RhbmNlLl9jb21tYW5kV2F0Y2hlcnMuc2V0KHByb3BlcnR5S2V5LnRvTG93ZXJDYXNlKCksIFtzdWJqZWN0LCBvYnNlcnZhYmxlXSk7XG4gICAgICAgICAgICB0aGlzW2ludGVybmFsS2V5XSA9IG9ic2VydmFibGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdhdGNoRXZlbnQodGFyZ2V0OiBPYmplY3QsIHByb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPGFueT4pIHtcbiAgICBjb25zdCBpbnRlcm5hbEtleSA9IGBfXyR7cHJvcGVydHlLZXl9X19gO1xuICAgIGNvbnN0IGV2ZW50S2V5ID0gcHJvcGVydHlLZXlbMF0udG9VcHBlckNhc2UoKSArIHByb3BlcnR5S2V5LnN1YnN0cigxKTtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuX2NsaWVudCB8fCB0aGlzO1xuICAgICAgICBpZiAoIWluc3RhbmNlLl9ldmVudFdhdGNoZXJzLmdldChldmVudEtleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gICAgICAgICAgICBjb25zdCBvYnNlcnZhYmxlID0gc3ViamVjdC5zaGFyZSgpO1xuXG4gICAgICAgICAgICBpbnN0YW5jZS5fZXZlbnRXYXRjaGVycy5zZXQoZXZlbnRLZXksIFtzdWJqZWN0LCBvYnNlcnZhYmxlXSk7XG4gICAgICAgICAgICB0aGlzW2ludGVybmFsS2V5XSA9IG9ic2VydmFibGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+KSB7XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBgX18ke3Byb3BlcnR5S2V5fV9fYDtcbiAgICBjb25zdCBtZXRob2QgPSAoYzogYW55KSA9PiBjLm9ic2VydmVbcHJvcGVydHlLZXldIHx8IGNbcHJvcGVydHlLZXldO1xuICAgIGRlc2NyaXB0b3IuZ2V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICghdGhpc1tpbnRlcm5hbEtleV0pIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5tYWtlTWVyZ2VPYnNlcmFibGUobWV0aG9kKTtcbiAgICAgICAgICAgIHRoaXNbaW50ZXJuYWxLZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFnZ3JlZ2F0ZSh0YXJnZXQ6IE9iamVjdCwgcHJvcGVydHlLZXk6IHN0cmluZywgZGVzY3JpcHRvcjogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8YW55Pikge1xuICAgIGNvbnN0IGludGVybmFsS2V5ID0gYF9fJHtwcm9wZXJ0eUtleX1fX2A7XG4gICAgY29uc3QgbWV0aG9kID0gKGM6IGFueSkgPT4gYy5vYnNlcnZlW3Byb3BlcnR5S2V5XSB8fCBjW3Byb3BlcnR5S2V5XTtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAoIXRoaXNbaW50ZXJuYWxLZXldKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMubWFrZUFnZ3JlZ2F0ZU9ic2VyYWJsZShtZXRob2QpO1xuICAgICAgICAgICAgdGhpc1tpbnRlcm5hbEtleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpc1tpbnRlcm5hbEtleV07XG4gICAgfTtcbiAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVmZXJlbmNlKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+KSB7XG4gICAgZGVzY3JpcHRvci5nZXQgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX2NsaWVudFtwcm9wZXJ0eUtleV07IH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmhlcml0UHJvcGVydGllcyhzb3VyY2U6IGFueSwgZGVzdDogYW55KSB7XG4gICAgXy5lYWNoKF8ua2V5cyhzb3VyY2UucHJvdG90eXBlKSwga2V5ID0+IHtcbiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLnByb3RvdHlwZSwga2V5KTtcbiAgICAgICAgY29uc3QgaXNEZWZpbmVkID0gISFfLmhhcyhkZXN0LnByb3RvdHlwZSwga2V5KTtcbiAgICAgICAgaWYgKGRlc2NyaXB0b3IgJiYgIWlzRGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKF8uaGFzKGRlc2NyaXB0b3IsIFwidmFsdWVcIikgfHwgXy5oYXMoZGVzY3JpcHRvciwgXCJ3cml0YWJsZVwiKSkge1xuICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShkZXN0LnByb3RvdHlwZSwga2V5LCB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZGVzY3JpcHRvci5jb25maWd1cmFibGUsXG4gICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZSxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGRlc2NyaXB0b3IudmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiBkZXNjcmlwdG9yLndyaXRhYmxlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZGVzdC5wcm90b3R5cGUsIGtleSwge1xuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlLFxuICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjcmlwdG9yLmVudW1lcmFibGUsXG4gICAgICAgICAgICAgICAgICAgIGdldDogZGVzY3JpcHRvci5nZXQsXG4gICAgICAgICAgICAgICAgICAgIHNldDogZGVzY3JpcHRvci5zZXRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xufVxuIiwiaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gXCJyeGpzXCI7XG5leHBvcnQgZnVuY3Rpb24gaXNOb3ROdWxsKG1ldGhvZCkge1xuICAgIHJldHVybiBmdW5jdGlvbiBpc05vdE51bGwodGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvcikge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGRlc2NyaXB0b3IudmFsdWU7XG4gICAgICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiAocmVxdWVzdCkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbWV0aG9kKHJlcXVlc3QpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gbWV0aG9kLnRvU3RyaW5nKCkubWF0Y2goL2Z1bmN0aW9uIFxcKHJlcXVlc3RcXCkgeyByZXR1cm4gKC4qPyk7IH0vKTtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRob2RUZXh0ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgbWV0aG9kLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYCR7bWV0aG9kVGV4dH0gIG11c3Qgbm90IGJlIG51bGwuYDtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JUZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuICAgIH07XG59XG5leHBvcnQgZnVuY3Rpb24gaXNBYm92ZVplcm8obWV0aG9kKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIGlzQWJvdmVaZXJvKHRhcmdldCwgcHJvcGVydHlLZXksIGRlc2NyaXB0b3IpIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBkZXNjcmlwdG9yLnZhbHVlO1xuICAgICAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKHJlcXVlc3QpIHtcbiAgICAgICAgICAgIGNvbnN0IG1pblZhbHVlID0gKHRoaXMuX29wdGlvbnMub25lQmFzZWRJbmRpY2VzID8gMSA6IDApIC0gMTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG1ldGhvZChyZXF1ZXN0KTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0IDw9IG1pblZhbHVlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBtZXRob2QudG9TdHJpbmcoKS5tYXRjaCgvZnVuY3Rpb24gXFwocmVxdWVzdFxcKSB7IHJldHVybiAoLio/KTsgfS8pO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGhvZFRleHQgPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCBtZXRob2QudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvclRleHQgPSBgJHttZXRob2RUZXh0fSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byAke21pblZhbHVlICsgMX0uYDtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JUZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuICAgIH07XG59XG5leHBvcnQgZnVuY3Rpb24gcHJlY29uZGl0aW9uKG1ldGhvZCwgLi4uZGVjb3JhdG9ycykge1xuICAgIHJldHVybiBmdW5jdGlvbiBwcmVjb25kaXRpb24odGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvcikge1xuICAgICAgICBjb25zdCBvcmlnaW5hbFZhbHVlID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICAgICAgY29uc3QgbWV0aG9kcyA9IF8ubWFwKGRlY29yYXRvcnMsIGRlY29yYXRvciA9PiB7XG4gICAgICAgICAgICBkZXNjcmlwdG9yLnZhbHVlID0gXy5ub29wO1xuICAgICAgICAgICAgZGVjb3JhdG9yKHRhcmdldCwgcHJvcGVydHlLZXksIGRlc2NyaXB0b3IpO1xuICAgICAgICAgICAgcmV0dXJuIGRlc2NyaXB0b3IudmFsdWU7XG4gICAgICAgIH0pO1xuICAgICAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKHJlcXVlc3QpIHtcbiAgICAgICAgICAgIGlmIChtZXRob2QocmVxdWVzdCkpIHtcbiAgICAgICAgICAgICAgICBtZXRob2RzLmZvckVhY2gobSA9PiBtLmNhbGwodGhpcywgcmVxdWVzdCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsVmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgfTtcbiAgICB9O1xufVxuZXhwb3J0IGZ1bmN0aW9uIGVuZHBvaW50KHZlcnNpb24gPSAxKSB7XG4gICAgbGV0IGZvcm1hdCA9IChuYW1lKSA9PiBuYW1lO1xuICAgIGlmICh2ZXJzaW9uID4gMSkge1xuICAgICAgICBmb3JtYXQgPSAobmFtZSkgPT4gYHYke3ZlcnNpb259LyR7bmFtZX1gO1xuICAgIH1cbiAgICByZXR1cm4gZnVuY3Rpb24gZW5kcG9pbnQodGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvcikge1xuICAgICAgICBjb25zdCBuYW1lID0gZm9ybWF0KHByb3BlcnR5S2V5KTtcbiAgICAgICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uIChyZXF1ZXN0LCBvcHRpb25zKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KG5hbWUsIHJlcXVlc3QsIG9wdGlvbnMpO1xuICAgICAgICB9O1xuICAgICAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSB0cnVlO1xuICAgIH07XG59XG5leHBvcnQgZnVuY3Rpb24gZml4dXAodGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvcikge1xuICAgIGNvbnN0IHZhbHVlID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKHJlcXVlc3QsIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5fZml4dXAocHJvcGVydHlLZXksIHJlcXVlc3QsIG9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9O1xufVxuZXhwb3J0IGZ1bmN0aW9uIHdhdGNoQ29tbWFuZCh0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yKSB7XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBgX18ke3Byb3BlcnR5S2V5fV9fYDtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLl9jbGllbnQgfHwgdGhpcztcbiAgICAgICAgaWYgKCFpbnN0YW5jZS5fY29tbWFuZFdhdGNoZXJzLmdldChwcm9wZXJ0eUtleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdCgpO1xuICAgICAgICAgICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHN1YmplY3Quc2hhcmUoKTtcbiAgICAgICAgICAgIGluc3RhbmNlLl9jb21tYW5kV2F0Y2hlcnMuc2V0KHByb3BlcnR5S2V5LnRvTG93ZXJDYXNlKCksIFtzdWJqZWN0LCBvYnNlcnZhYmxlXSk7XG4gICAgICAgICAgICB0aGlzW2ludGVybmFsS2V5XSA9IG9ic2VydmFibGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiB3YXRjaEV2ZW50KHRhcmdldCwgcHJvcGVydHlLZXksIGRlc2NyaXB0b3IpIHtcbiAgICBjb25zdCBpbnRlcm5hbEtleSA9IGBfXyR7cHJvcGVydHlLZXl9X19gO1xuICAgIGNvbnN0IGV2ZW50S2V5ID0gcHJvcGVydHlLZXlbMF0udG9VcHBlckNhc2UoKSArIHByb3BlcnR5S2V5LnN1YnN0cigxKTtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLl9jbGllbnQgfHwgdGhpcztcbiAgICAgICAgaWYgKCFpbnN0YW5jZS5fZXZlbnRXYXRjaGVycy5nZXQoZXZlbnRLZXkpKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcbiAgICAgICAgICAgIGNvbnN0IG9ic2VydmFibGUgPSBzdWJqZWN0LnNoYXJlKCk7XG4gICAgICAgICAgICBpbnN0YW5jZS5fZXZlbnRXYXRjaGVycy5zZXQoZXZlbnRLZXksIFtzdWJqZWN0LCBvYnNlcnZhYmxlXSk7XG4gICAgICAgICAgICB0aGlzW2ludGVybmFsS2V5XSA9IG9ic2VydmFibGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZSh0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yKSB7XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBgX18ke3Byb3BlcnR5S2V5fV9fYDtcbiAgICBjb25zdCBtZXRob2QgPSAoYykgPT4gYy5vYnNlcnZlW3Byb3BlcnR5S2V5XSB8fCBjW3Byb3BlcnR5S2V5XTtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCF0aGlzW2ludGVybmFsS2V5XSkge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLm1ha2VNZXJnZU9ic2VyYWJsZShtZXRob2QpO1xuICAgICAgICAgICAgdGhpc1tpbnRlcm5hbEtleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpc1tpbnRlcm5hbEtleV07XG4gICAgfTtcbiAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSB0cnVlO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGFnZ3JlZ2F0ZSh0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yKSB7XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBgX18ke3Byb3BlcnR5S2V5fV9fYDtcbiAgICBjb25zdCBtZXRob2QgPSAoYykgPT4gYy5vYnNlcnZlW3Byb3BlcnR5S2V5XSB8fCBjW3Byb3BlcnR5S2V5XTtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCF0aGlzW2ludGVybmFsS2V5XSkge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLm1ha2VBZ2dyZWdhdGVPYnNlcmFibGUobWV0aG9kKTtcbiAgICAgICAgICAgIHRoaXNbaW50ZXJuYWxLZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiByZWZlcmVuY2UodGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvcikge1xuICAgIGRlc2NyaXB0b3IuZ2V0ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcy5fY2xpZW50W3Byb3BlcnR5S2V5XTsgfTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBpbmhlcml0UHJvcGVydGllcyhzb3VyY2UsIGRlc3QpIHtcbiAgICBfLmVhY2goXy5rZXlzKHNvdXJjZS5wcm90b3R5cGUpLCBrZXkgPT4ge1xuICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UucHJvdG90eXBlLCBrZXkpO1xuICAgICAgICBjb25zdCBpc0RlZmluZWQgPSAhIV8uaGFzKGRlc3QucHJvdG90eXBlLCBrZXkpO1xuICAgICAgICBpZiAoZGVzY3JpcHRvciAmJiAhaXNEZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoXy5oYXMoZGVzY3JpcHRvciwgXCJ2YWx1ZVwiKSB8fCBfLmhhcyhkZXNjcmlwdG9yLCBcIndyaXRhYmxlXCIpKSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRlc3QucHJvdG90eXBlLCBrZXksIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSxcbiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZGVzY3JpcHRvci5lbnVtZXJhYmxlLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZGVzY3JpcHRvci52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6IGRlc2NyaXB0b3Iud3JpdGFibGUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZGVzdC5wcm90b3R5cGUsIGtleSwge1xuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlLFxuICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjcmlwdG9yLmVudW1lcmFibGUsXG4gICAgICAgICAgICAgICAgICAgIGdldDogZGVzY3JpcHRvci5nZXQsXG4gICAgICAgICAgICAgICAgICAgIHNldDogZGVzY3JpcHRvci5zZXRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
