"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.RefCountDisposable = undefined;

var _get = function get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if ("value" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _Disposable2 = require("./Disposable");

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var RefCountDisposable = exports.RefCountDisposable = function () {
    function RefCountDisposable(underlyingDisposable) {
        _classCallCheck(this, RefCountDisposable);

        this._isDisposed = false;
        this._isPrimaryDisposed = false;
        this._count = 0;
        this._underlyingDisposable = _Disposable2.Disposable.of(underlyingDisposable);
    }

    _createClass(RefCountDisposable, [{
        key: "dispose",
        value: function dispose() {
            if (!this.isDisposed && !this._isPrimaryDisposed) {
                this._isPrimaryDisposed = true;
                if (this._count === 0) {
                    this._isDisposed = true;
                    this._underlyingDisposable.dispose();
                }
            }
        }
    }, {
        key: "getDisposable",
        value: function getDisposable() {
            var _this = this;

            if (this.isDisposed) return _Disposable2.Disposable.empty;
            this._count++;
            return new InnerDisposable(this, function () {
                _this._count--;
                if (_this._count === 0 && _this._isPrimaryDisposed) {
                    _this._isDisposed = true;
                    _this._underlyingDisposable.dispose();
                }
            });
        }
    }, {
        key: "isDisposed",
        get: function get() {
            return this._isDisposed;
        }
    }]);

    return RefCountDisposable;
}();

var InnerDisposable = function (_Disposable) {
    _inherits(InnerDisposable, _Disposable);

    function InnerDisposable(_reference, action) {
        _classCallCheck(this, InnerDisposable);

        var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(InnerDisposable).call(this, action));

        _this2._reference = _reference;
        return _this2;
    }

    _createClass(InnerDisposable, [{
        key: "dispose",
        value: function dispose() {
            if (!this._reference.isDisposed && !this.isDisposed) {
                _get(Object.getPrototypeOf(InnerDisposable.prototype), "dispose", this).call(this);
            }
        }
    }]);

    return InnerDisposable;
}(_Disposable2.Disposable);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kaXNwb3NhYmxlcy9SZWZDb3VudERpc3Bvc2FibGUuanMiLCJsaWIvZGlzcG9zYWJsZXMvUmVmQ291bnREaXNwb3NhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7Ozs7Ozs7O0lDRUE7QUFNSSxhQU5KLGtCQU1JLENBQVksb0JBQVosRUFBMkQ7OEJBTi9ELG9CQU0rRDs7QUFKbkQsYUFBQSxXQUFBLEdBQWMsS0FBZCxDQUltRDtBQUhuRCxhQUFBLGtCQUFBLEdBQXFCLEtBQXJCLENBR21EO0FBRm5ELGFBQUEsTUFBQSxHQUFTLENBQVQsQ0FFbUQ7QUFDdkQsYUFBSyxxQkFBTCxHQUE2Qix3QkFBVyxFQUFYLENBQWMsb0JBQWQsQ0FBN0IsQ0FEdUQ7S0FBM0Q7O2lCQU5KOztrQ0FZa0I7QUFDVixnQkFBSSxDQUFDLEtBQUssVUFBTCxJQUFtQixDQUFDLEtBQUssa0JBQUwsRUFBeUI7QUFDOUMscUJBQUssa0JBQUwsR0FBMEIsSUFBMUIsQ0FEOEM7QUFFOUMsb0JBQUksS0FBSyxNQUFMLEtBQWdCLENBQWhCLEVBQW1CO0FBQ25CLHlCQUFLLFdBQUwsR0FBbUIsSUFBbkIsQ0FEbUI7QUFFbkIseUJBQUsscUJBQUwsQ0FBMkIsT0FBM0IsR0FGbUI7aUJBQXZCO2FBRko7Ozs7d0NBU2dCOzs7QUFDaEIsZ0JBQUksS0FBSyxVQUFMLEVBQWlCLE9BQU8sd0JBQVcsS0FBWCxDQUE1QjtBQUVBLGlCQUFLLE1BQUwsR0FIZ0I7QUFJaEIsbUJBQU8sSUFBSSxlQUFKLENBQW9CLElBQXBCLEVBQTBCLFlBQUE7QUFDN0Isc0JBQUssTUFBTCxHQUQ2QjtBQUU3QixvQkFBSSxNQUFLLE1BQUwsS0FBZ0IsQ0FBaEIsSUFBcUIsTUFBSyxrQkFBTCxFQUF5QjtBQUM5QywwQkFBSyxXQUFMLEdBQW1CLElBQW5CLENBRDhDO0FBRTlDLDBCQUFLLHFCQUFMLENBQTJCLE9BQTNCLEdBRjhDO2lCQUFsRDthQUY2QixDQUFqQyxDQUpnQjs7Ozs0QkFaQztBQUFLLG1CQUFPLEtBQUssV0FBTCxDQUFaOzs7O1dBVnpCOzs7SUFvQ0E7OztBQUNJLGFBREosZUFDSSxDQUFvQixVQUFwQixFQUFvRCxNQUFwRCxFQUFzRTs4QkFEMUUsaUJBQzBFOzs0RUFEMUUsNEJBRWMsU0FENEQ7O0FBQWxELGVBQUEsVUFBQSxHQUFBLFVBQUEsQ0FBa0Q7O0tBQXRFOztpQkFESjs7a0NBS2tCO0FBQ1YsZ0JBQUksQ0FBQyxLQUFLLFVBQUwsQ0FBZ0IsVUFBaEIsSUFBOEIsQ0FBQyxLQUFLLFVBQUwsRUFBaUI7QUFDakQsMkNBUFosdURBT1ksQ0FEaUQ7YUFBckQ7Ozs7V0FOUiIsImZpbGUiOiJsaWIvZGlzcG9zYWJsZXMvUmVmQ291bnREaXNwb3NhYmxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlzcG9zYWJsZSB9IGZyb20gXCIuL0Rpc3Bvc2FibGVcIjtcbmV4cG9ydCBjbGFzcyBSZWZDb3VudERpc3Bvc2FibGUge1xuICAgIGNvbnN0cnVjdG9yKHVuZGVybHlpbmdEaXNwb3NhYmxlKSB7XG4gICAgICAgIHRoaXMuX2lzRGlzcG9zZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5faXNQcmltYXJ5RGlzcG9zZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fY291bnQgPSAwO1xuICAgICAgICB0aGlzLl91bmRlcmx5aW5nRGlzcG9zYWJsZSA9IERpc3Bvc2FibGUub2YodW5kZXJseWluZ0Rpc3Bvc2FibGUpO1xuICAgIH1cbiAgICBnZXQgaXNEaXNwb3NlZCgpIHsgcmV0dXJuIHRoaXMuX2lzRGlzcG9zZWQ7IH1cbiAgICBkaXNwb3NlKCkge1xuICAgICAgICBpZiAoIXRoaXMuaXNEaXNwb3NlZCAmJiAhdGhpcy5faXNQcmltYXJ5RGlzcG9zZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2lzUHJpbWFyeURpc3Bvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2lzRGlzcG9zZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VuZGVybHlpbmdEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBnZXREaXNwb3NhYmxlKCkge1xuICAgICAgICBpZiAodGhpcy5pc0Rpc3Bvc2VkKVxuICAgICAgICAgICAgcmV0dXJuIERpc3Bvc2FibGUuZW1wdHk7XG4gICAgICAgIHRoaXMuX2NvdW50Kys7XG4gICAgICAgIHJldHVybiBuZXcgSW5uZXJEaXNwb3NhYmxlKHRoaXMsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2NvdW50LS07XG4gICAgICAgICAgICBpZiAodGhpcy5fY291bnQgPT09IDAgJiYgdGhpcy5faXNQcmltYXJ5RGlzcG9zZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pc0Rpc3Bvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLl91bmRlcmx5aW5nRGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbmNsYXNzIElubmVyRGlzcG9zYWJsZSBleHRlbmRzIERpc3Bvc2FibGUge1xuICAgIGNvbnN0cnVjdG9yKF9yZWZlcmVuY2UsIGFjdGlvbikge1xuICAgICAgICBzdXBlcihhY3Rpb24pO1xuICAgICAgICB0aGlzLl9yZWZlcmVuY2UgPSBfcmVmZXJlbmNlO1xuICAgIH1cbiAgICBkaXNwb3NlKCkge1xuICAgICAgICBpZiAoIXRoaXMuX3JlZmVyZW5jZS5pc0Rpc3Bvc2VkICYmICF0aGlzLmlzRGlzcG9zZWQpIHtcbiAgICAgICAgICAgIHN1cGVyLmRpc3Bvc2UoKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiIsImltcG9ydCB7SURpc3Bvc2FibGUsIElEaXNwb3NhYmxlT3JTdWJzY3JpcHRpb24sIERpc3Bvc2FibGV9IGZyb20gXCIuL0Rpc3Bvc2FibGVcIjtcblxuZXhwb3J0IGNsYXNzIFJlZkNvdW50RGlzcG9zYWJsZSBpbXBsZW1lbnRzIElEaXNwb3NhYmxlIHtcbiAgICBwcml2YXRlIF91bmRlcmx5aW5nRGlzcG9zYWJsZTogSURpc3Bvc2FibGU7XG4gICAgcHJpdmF0ZSBfaXNEaXNwb3NlZCA9IGZhbHNlO1xuICAgIHByaXZhdGUgX2lzUHJpbWFyeURpc3Bvc2VkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBfY291bnQgPSAwO1xuXG4gICAgY29uc3RydWN0b3IodW5kZXJseWluZ0Rpc3Bvc2FibGU6IElEaXNwb3NhYmxlT3JTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgdGhpcy5fdW5kZXJseWluZ0Rpc3Bvc2FibGUgPSBEaXNwb3NhYmxlLm9mKHVuZGVybHlpbmdEaXNwb3NhYmxlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzRGlzcG9zZWQoKSB7IHJldHVybiB0aGlzLl9pc0Rpc3Bvc2VkOyB9XG5cbiAgICBwdWJsaWMgZGlzcG9zZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzRGlzcG9zZWQgJiYgIXRoaXMuX2lzUHJpbWFyeURpc3Bvc2VkKSB7XG4gICAgICAgICAgICB0aGlzLl9pc1ByaW1hcnlEaXNwb3NlZCA9IHRydWU7XG4gICAgICAgICAgICBpZiAodGhpcy5fY291bnQgPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pc0Rpc3Bvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLl91bmRlcmx5aW5nRGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGlzcG9zYWJsZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNEaXNwb3NlZCkgcmV0dXJuIERpc3Bvc2FibGUuZW1wdHk7XG5cbiAgICAgICAgdGhpcy5fY291bnQrKztcbiAgICAgICAgcmV0dXJuIG5ldyBJbm5lckRpc3Bvc2FibGUodGhpcywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fY291bnQtLTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudCA9PT0gMCAmJiB0aGlzLl9pc1ByaW1hcnlEaXNwb3NlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2lzRGlzcG9zZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VuZGVybHlpbmdEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5jbGFzcyBJbm5lckRpc3Bvc2FibGUgZXh0ZW5kcyBEaXNwb3NhYmxlIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9yZWZlcmVuY2U6IFJlZkNvdW50RGlzcG9zYWJsZSwgYWN0aW9uOiAoKSA9PiB2b2lkKSB7XG4gICAgICAgIHN1cGVyKGFjdGlvbik7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICghdGhpcy5fcmVmZXJlbmNlLmlzRGlzcG9zZWQgJiYgIXRoaXMuaXNEaXNwb3NlZCkge1xuICAgICAgICAgICAgc3VwZXIuZGlzcG9zZSgpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
