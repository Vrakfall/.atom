"use strict";
var rxjs_1 = require('rxjs');
var fs = require('fs');
var child_process_1 = require('child_process');
var path_1 = require('path');
var create_1 = require('../operators/create');
var bootstrappedPlugins = new Map();
var exists = rxjs_1.Observable.bindCallback(fs.exists), readFile = rxjs_1.Observable.bindNodeCallback(fs.readFile);
var md5 = require('md5');
function getPluginPath(solutionLocation, ctx, requestedPlugins, logger) {
    var plugins = [];
    var hashStrings = [];
    var hash;
    requestedPlugins.forEach(function (plugin) {
        plugins.push(plugin);
    });
    return create_1.createObservable(function (observer) {
        logger.log('Bootstrapping ' + solutionLocation);
        // Include the plugins defined in omnisharp.json, they could have changed.
        exists(path_1.join(solutionLocation, 'omnisharp.json'))
            .filter(function (x) { return !!x; })
            .flatMap(function (x) { return readFile(path_1.join(solutionLocation, 'omnisharp.json')); })
            .map(function (x) { return JSON.parse(x.toString()); })
            .do({
            next: function (obj) {
                if (obj.plugins) {
                    hashStrings.push(obj.plugins);
                }
            },
            complete: function () {
                hash = md5(JSON.stringify(plugins.concat(hashStrings)));
                if (bootstrappedPlugins.has(hash)) {
                    observer.next(bootstrappedPlugins.get(hash));
                    observer.complete();
                    return;
                }
                var command = [ctx.location, '-s', solutionLocation].concat(plugins.map(function (x) {
                    if (x.location) {
                        return "--plugins " + x.location;
                    }
                    else if (x.version) {
                        return "--plugin-name " + x.name + "@" + x.version;
                    }
                    else {
                        return "--plugin-name " + x.name;
                    }
                })).join(' ');
                child_process_1.exec(command, function (error, stdout) {
                    if (error) {
                        observer.error(error);
                        return;
                    }
                    var location = stdout.toString().trim();
                    if (location) {
                        // restore(location, ctx, logger).subscribe(observer);
                        return;
                    }
                    observer.next(ctx.location);
                    observer.complete();
                });
            }
        });
    })
        .map(function (path) { return path && path || ctx.location; })
        .do(function (result) {
        if (!bootstrappedPlugins.has(hash))
            bootstrappedPlugins.set(hash, result);
        logger.log('Finished bootstrapping ' + solutionLocation);
    });
}
exports.getPluginPath = getPluginPath;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzL3BsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUJBQTJCLE1BQU0sQ0FBQyxDQUFBO0FBQ2xDLElBQVksRUFBRSxXQUFNLElBQUksQ0FBQyxDQUFBO0FBQ3pCLDhCQUFxQixlQUFlLENBQUMsQ0FBQTtBQUVyQyxxQkFBcUIsTUFBTSxDQUFDLENBQUE7QUFFNUIsdUJBQWlDLHFCQUFxQixDQUFDLENBQUE7QUFFdkQsSUFBTSxtQkFBbUIsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztBQUN0RCxJQUFNLE1BQU0sR0FBRyxpQkFBVSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQzdDLFFBQVEsR0FBc0MsaUJBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDM0YsSUFBTSxHQUFHLEdBQTJCLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUVuRCx1QkFBOEIsZ0JBQXdCLEVBQUUsR0FBbUIsRUFBRSxnQkFBb0MsRUFBRSxNQUFlO0lBQzlILElBQU0sT0FBTyxHQUFVLEVBQUUsQ0FBQztJQUMxQixJQUFNLFdBQVcsR0FBVSxFQUFFLENBQUM7SUFDOUIsSUFBSSxJQUFZLENBQUM7SUFDakIsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFVBQUEsTUFBTTtRQUMzQixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLHlCQUFnQixDQUFTLFVBQUEsUUFBUTtRQUNwQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLENBQUM7UUFDaEQsMEVBQTBFO1FBQzFFLE1BQU0sQ0FBQyxXQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzthQUMzQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsQ0FBQyxFQUFILENBQUcsQ0FBQzthQUNoQixPQUFPLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxRQUFRLENBQUMsV0FBSSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixDQUFDLENBQUMsRUFBbEQsQ0FBa0QsQ0FBQzthQUNoRSxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUF4QixDQUF3QixDQUFDO2FBQ2xDLEVBQUUsQ0FBQztZQUNBLElBQUksRUFBRSxVQUFBLEdBQUc7Z0JBQ0wsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7b0JBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQUMsQ0FBQztZQUN2RCxDQUFDO1lBQ0QsUUFBUSxFQUFFO2dCQUNOLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFeEQsRUFBRSxDQUFDLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDaEMsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDN0MsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUNwQixNQUFNLENBQUM7Z0JBQ1gsQ0FBQztnQkFFRCxJQUFNLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixDQUFDLENBQUMsTUFBTSxDQUN6RCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQztvQkFDVCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzt3QkFDYixNQUFNLENBQUMsZUFBYSxDQUFDLENBQUMsUUFBVSxDQUFDO29CQUNyQyxDQUFDO29CQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFDbkIsTUFBTSxDQUFDLG1CQUFpQixDQUFDLENBQUMsSUFBSSxTQUFJLENBQUMsQ0FBQyxPQUFTLENBQUM7b0JBQ2xELENBQUM7b0JBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ0osTUFBTSxDQUFDLG1CQUFpQixDQUFDLENBQUMsSUFBTSxDQUFDO29CQUNyQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUVsQixvQkFBSSxDQUFDLE9BQU8sRUFBRSxVQUFVLEtBQUssRUFBRSxNQUFNO29CQUNqQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO3dCQUNSLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ3RCLE1BQU0sQ0FBQztvQkFDWCxDQUFDO29CQUNELElBQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztvQkFDMUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzt3QkFDWCxzREFBc0Q7d0JBQ3RELE1BQU0sQ0FBQztvQkFDWCxDQUFDO29CQUNELFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO29CQUM1QixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3hCLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQztTQUNHLEdBQUcsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBNUIsQ0FBNEIsQ0FBQztTQUN6QyxFQUFFLENBQUMsVUFBQSxNQUFNO1FBQ04sRUFBRSxDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDL0IsbUJBQW1CLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMxQyxNQUFNLENBQUMsR0FBRyxDQUFDLHlCQUF5QixHQUFHLGdCQUFnQixDQUFDLENBQUM7SUFDN0QsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBN0RlLHFCQUFhLGdCQTZENUIsQ0FBQSIsImZpbGUiOiJsaWIvaGVscGVycy9wbHVnaW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBSdW50aW1lQ29udGV4dCB9IGZyb20gJy4vcnVudGltZSc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBJT21uaXNoYXJwUGx1Z2luLCBJTG9nZ2VyIH0gZnJvbSAnLi4vZW51bXMnO1xuaW1wb3J0IHsgY3JlYXRlT2JzZXJ2YWJsZSB9IGZyb20gJy4uL29wZXJhdG9ycy9jcmVhdGUnO1xuXG5jb25zdCBib290c3RyYXBwZWRQbHVnaW5zID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbmNvbnN0IGV4aXN0cyA9IE9ic2VydmFibGUuYmluZENhbGxiYWNrKGZzLmV4aXN0cyksXG4gICAgcmVhZEZpbGU6IChmaWxlOiBzdHJpbmcpID0+IE9ic2VydmFibGU8YW55PiA9IE9ic2VydmFibGUuYmluZE5vZGVDYWxsYmFjayhmcy5yZWFkRmlsZSk7XG5jb25zdCBtZDU6ICh2YWx1ZTogYW55KSA9PiBzdHJpbmcgPSByZXF1aXJlKCdtZDUnKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBsdWdpblBhdGgoc29sdXRpb25Mb2NhdGlvbjogc3RyaW5nLCBjdHg6IFJ1bnRpbWVDb250ZXh0LCByZXF1ZXN0ZWRQbHVnaW5zOiBJT21uaXNoYXJwUGx1Z2luW10sIGxvZ2dlcjogSUxvZ2dlcikge1xuICAgIGNvbnN0IHBsdWdpbnM6IGFueVtdID0gW107XG4gICAgY29uc3QgaGFzaFN0cmluZ3M6IGFueVtdID0gW107XG4gICAgbGV0IGhhc2g6IHN0cmluZztcbiAgICByZXF1ZXN0ZWRQbHVnaW5zLmZvckVhY2gocGx1Z2luID0+IHtcbiAgICAgICAgcGx1Z2lucy5wdXNoKHBsdWdpbik7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZTxzdHJpbmc+KG9ic2VydmVyID0+IHtcbiAgICAgICAgbG9nZ2VyLmxvZygnQm9vdHN0cmFwcGluZyAnICsgc29sdXRpb25Mb2NhdGlvbik7XG4gICAgICAgIC8vIEluY2x1ZGUgdGhlIHBsdWdpbnMgZGVmaW5lZCBpbiBvbW5pc2hhcnAuanNvbiwgdGhleSBjb3VsZCBoYXZlIGNoYW5nZWQuXG4gICAgICAgIGV4aXN0cyhqb2luKHNvbHV0aW9uTG9jYXRpb24sICdvbW5pc2hhcnAuanNvbicpKVxuICAgICAgICAgICAgLmZpbHRlcih4ID0+ICEheClcbiAgICAgICAgICAgIC5mbGF0TWFwKHggPT4gcmVhZEZpbGUoam9pbihzb2x1dGlvbkxvY2F0aW9uLCAnb21uaXNoYXJwLmpzb24nKSkpXG4gICAgICAgICAgICAubWFwKHggPT4gSlNPTi5wYXJzZSh4LnRvU3RyaW5nKCkpKVxuICAgICAgICAgICAgLmRvKHtcbiAgICAgICAgICAgICAgICBuZXh0OiBvYmogPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnBsdWdpbnMpIHsgaGFzaFN0cmluZ3MucHVzaChvYmoucGx1Z2lucyk7IH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGhhc2ggPSBtZDUoSlNPTi5zdHJpbmdpZnkocGx1Z2lucy5jb25jYXQoaGFzaFN0cmluZ3MpKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGJvb3RzdHJhcHBlZFBsdWdpbnMuaGFzKGhhc2gpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGJvb3RzdHJhcHBlZFBsdWdpbnMuZ2V0KGhhc2gpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21tYW5kID0gW2N0eC5sb2NhdGlvbiwgJy1zJywgc29sdXRpb25Mb2NhdGlvbl0uY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICAgICAgcGx1Z2lucy5tYXAoeCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHgubG9jYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAtLXBsdWdpbnMgJHt4LmxvY2F0aW9ufWA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4LnZlcnNpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAtLXBsdWdpbi1uYW1lICR7eC5uYW1lfUAke3gudmVyc2lvbn1gO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBgLS1wbHVnaW4tbmFtZSAke3gubmFtZX1gO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKS5qb2luKCcgJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgZXhlYyhjb21tYW5kLCBmdW5jdGlvbiAoZXJyb3IsIHN0ZG91dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gc3Rkb3V0LnRvU3RyaW5nKCkudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvY2F0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzdG9yZShsb2NhdGlvbiwgY3R4LCBsb2dnZXIpLnN1YnNjcmliZShvYnNlcnZlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChjdHgubG9jYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgfSlcbiAgICAgICAgLm1hcChwYXRoID0+IHBhdGggJiYgcGF0aCB8fCBjdHgubG9jYXRpb24pXG4gICAgICAgIC5kbyhyZXN1bHQgPT4ge1xuICAgICAgICAgICAgaWYgKCFib290c3RyYXBwZWRQbHVnaW5zLmhhcyhoYXNoKSlcbiAgICAgICAgICAgICAgICBib290c3RyYXBwZWRQbHVnaW5zLnNldChoYXNoLCByZXN1bHQpO1xuICAgICAgICAgICAgbG9nZ2VyLmxvZygnRmluaXNoZWQgYm9vdHN0cmFwcGluZyAnICsgc29sdXRpb25Mb2NhdGlvbik7XG4gICAgICAgIH0pO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
