"use strict";
var OmniSharp = require('../omnisharp-server');
var _ = require('lodash');
function getInternalKey(path) {
    return ("__" + path + "__").toLowerCase();
}
exports.getInternalKey = getInternalKey;
function getInternalValue(context, path) {
    return context[getInternalKey(path)];
}
exports.getInternalValue = getInternalValue;
function setEventOrResponse(context, path) {
    var instance = context._client || context;
    var isEvent = !_.startsWith(path, '/');
    var internalKey = getInternalKey(path);
    if (isEvent) {
        var eventKey_1 = path[0].toUpperCase() + path.substr(1);
        context[internalKey] = instance._eventsStream
            .filter(function (x) { return x.Event === eventKey_1; })
            .map(function (x) { return x.Body; })
            .share();
    }
    else {
        var stream = instance._getResponseStream(path);
        context[internalKey] = stream.asObservable()
            .filter(function (x) { return !x.silent; });
    }
    return context[internalKey];
}
exports.setEventOrResponse = setEventOrResponse;
function setMergeOrAggregate(context, path) {
    var internalKey = getInternalKey(path);
    var method = function (c) { return c.observe[path] || c[path]; };
    if (!context[internalKey]) {
        var value = context.makeObservable(method);
        context[internalKey] = value;
    }
    return context[internalKey];
}
exports.setMergeOrAggregate = setMergeOrAggregate;
function request(target, propertyKey) {
    var descriptor = {};
    var version = OmniSharp.Api.getVersion(propertyKey);
    var format = function (name) { return ("/" + name); };
    if (version !== 'v1') {
        format = function (name) { return ("/" + version + "/" + name); };
    }
    var name = format(propertyKey);
    descriptor.value = function (request, options) {
        if (request && request.silent) {
            options = request;
            request = {};
        }
        options = options || {};
        this._fixup(propertyKey, request, options);
        return this.request(name, request, options);
    };
    descriptor.enumerable = true;
    Object.defineProperty(target, propertyKey, descriptor);
}
exports.request = request;
function response(target, propertyKey, path) {
    var descriptor = {};
    var internalKey = getInternalKey(path);
    descriptor.get = function () {
        if (!this[internalKey]) {
            setEventOrResponse(this, path);
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
    Object.defineProperty(target, propertyKey, descriptor);
}
exports.response = response;
function event(target, path) {
    var descriptor = {};
    var internalKey = getInternalKey(path);
    descriptor.get = function () {
        if (!this[internalKey]) {
            setEventOrResponse(this, path);
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
    Object.defineProperty(target, path, descriptor);
}
exports.event = event;
function makeObservable(target, propertyKey, path) {
    var descriptor = {};
    var internalKey = getInternalKey(path);
    var method = function (c) { return c.observe[propertyKey] || c[propertyKey]; };
    descriptor.get = function () {
        if (!this[internalKey]) {
            var value = this.makeObservable(method);
            this[internalKey] = value;
        }
        return this[internalKey];
    };
    descriptor.enumerable = true;
    Object.defineProperty(target, propertyKey, descriptor);
}
exports.makeObservable = makeObservable;
function reference(target, propertyKey, path) {
    var descriptor = {};
    descriptor.get = function () { return this._client[propertyKey]; };
    Object.defineProperty(target, propertyKey, descriptor);
}
exports.reference = reference;

//# sourceMappingURL=data:application/json;base64,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QyxDQUF3QyxDQUFDO0lBQ3BFLFVBQVUsQ0FBQyxHQUFHLEdBQUc7UUFDYixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQzlCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzdCLENBQUMsQ0FBQztJQUNGLFVBQVUsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0lBQzdCLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUMzRCxDQUFDO0FBYmUsc0JBQWMsaUJBYTdCLENBQUE7QUFFRCxtQkFBMEIsTUFBYyxFQUFFLFdBQW1CLEVBQUUsSUFBWTtJQUN2RSxJQUFNLFVBQVUsR0FBaUMsRUFBRSxDQUFDO0lBQ3BELFVBQVUsQ0FBQyxHQUFHLEdBQUcsY0FBZ0YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckksTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzNELENBQUM7QUFKZSxpQkFBUyxZQUl4QixDQUFBIiwiZmlsZSI6ImxpYi9oZWxwZXJzL2RlY29yYXRvcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBPbW5pU2hhcnAgZnJvbSAnLi4vb21uaXNoYXJwLXNlcnZlcic7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBSZXNwb25zZUNvbnRleHQgfSBmcm9tICcuLi9jb250ZXh0cyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnRlcm5hbEtleShwYXRoOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYF9fJHtwYXRofV9fYC50b0xvd2VyQ2FzZSgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0SW50ZXJuYWxWYWx1ZShjb250ZXh0OiBhbnksIHBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiBjb250ZXh0W2dldEludGVybmFsS2V5KHBhdGgpXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldEV2ZW50T3JSZXNwb25zZShjb250ZXh0OiBhbnksIHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IGluc3RhbmNlID0gY29udGV4dC5fY2xpZW50IHx8IGNvbnRleHQ7XG4gICAgY29uc3QgaXNFdmVudCA9ICFfLnN0YXJ0c1dpdGgocGF0aCwgJy8nKTtcbiAgICBjb25zdCBpbnRlcm5hbEtleSA9IGdldEludGVybmFsS2V5KHBhdGgpO1xuICAgIGlmIChpc0V2ZW50KSB7XG4gICAgICAgIGNvbnN0IGV2ZW50S2V5ID0gcGF0aFswXS50b1VwcGVyQ2FzZSgpICsgcGF0aC5zdWJzdHIoMSk7XG4gICAgICAgIGNvbnRleHRbaW50ZXJuYWxLZXldID0gKDxPYnNlcnZhYmxlPE9tbmlTaGFycC5TdGRpby5Qcm90b2NvbC5FdmVudFBhY2tldD4+aW5zdGFuY2UuX2V2ZW50c1N0cmVhbSlcbiAgICAgICAgICAgIC5maWx0ZXIoeCA9PiB4LkV2ZW50ID09PSBldmVudEtleSlcbiAgICAgICAgICAgIC5tYXAoeCA9PiB4LkJvZHkpXG4gICAgICAgICAgICAuc2hhcmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdHJlYW06IFN1YmplY3Q8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj4gPSBpbnN0YW5jZS5fZ2V0UmVzcG9uc2VTdHJlYW0ocGF0aCk7XG4gICAgICAgIGNvbnRleHRbaW50ZXJuYWxLZXldID0gc3RyZWFtLmFzT2JzZXJ2YWJsZSgpXG4gICAgICAgICAgICAuZmlsdGVyKHggPT4gIXguc2lsZW50KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRleHRbaW50ZXJuYWxLZXldO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0TWVyZ2VPckFnZ3JlZ2F0ZShjb250ZXh0OiBhbnksIHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IGludGVybmFsS2V5ID0gZ2V0SW50ZXJuYWxLZXkocGF0aCk7XG4gICAgY29uc3QgbWV0aG9kID0gKGM6IGFueSkgPT4gYy5vYnNlcnZlW3BhdGhdIHx8IGNbcGF0aF07XG4gICAgaWYgKCFjb250ZXh0W2ludGVybmFsS2V5XSkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGNvbnRleHQubWFrZU9ic2VydmFibGUobWV0aG9kKTtcbiAgICAgICAgY29udGV4dFtpbnRlcm5hbEtleV0gPSB2YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRleHRbaW50ZXJuYWxLZXldO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVxdWVzdCh0YXJnZXQ6IE9iamVjdCwgcHJvcGVydHlLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGRlc2NyaXB0b3I6IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB7fTtcbiAgICBjb25zdCB2ZXJzaW9uID0gT21uaVNoYXJwLkFwaS5nZXRWZXJzaW9uKHByb3BlcnR5S2V5KTtcbiAgICBsZXQgZm9ybWF0ID0gKG5hbWU6IHN0cmluZykgPT4gYC8ke25hbWV9YDtcbiAgICBpZiAodmVyc2lvbiAhPT0gJ3YxJykge1xuICAgICAgICBmb3JtYXQgPSAobmFtZSkgPT4gYC8ke3ZlcnNpb259LyR7bmFtZX1gO1xuICAgIH1cblxuICAgIGNvbnN0IG5hbWUgPSBmb3JtYXQocHJvcGVydHlLZXkpO1xuICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiAodGhpczoge1xuICAgICAgICBfZml4dXA6IChwcm9wZXJ5OiBzdHJpbmcsIHJlcXVlc3Q6IE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdCwgb3B0aW9uczogYW55KSA9PiBhbnk7XG4gICAgICAgIHJlcXVlc3Q6IChuYW1lOiBzdHJpbmcsIHJlcXVlc3Q6IE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdCwgb3B0aW9uczogYW55KSA9PiBhbnk7XG4gICAgfSwgcmVxdWVzdDogT21uaVNoYXJwLk1vZGVscy5SZXF1ZXN0LCBvcHRpb25zOiBhbnkpIHtcbiAgICAgICAgaWYgKHJlcXVlc3QgJiYgKDxhbnk+cmVxdWVzdCkuc2lsZW50KSB7XG4gICAgICAgICAgICBvcHRpb25zID0gcmVxdWVzdDtcbiAgICAgICAgICAgIHJlcXVlc3QgPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcblxuICAgICAgICB0aGlzLl9maXh1cChwcm9wZXJ0eUtleSwgcmVxdWVzdCwgb3B0aW9ucyk7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QobmFtZSwgcmVxdWVzdCwgb3B0aW9ucyk7XG4gICAgfTtcbiAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSB0cnVlO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc3BvbnNlKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBwYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+ID0ge307XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBnZXRJbnRlcm5hbEtleShwYXRoKTtcbiAgICBkZXNjcmlwdG9yLmdldCA9IGZ1bmN0aW9uICh0aGlzOiB7IFtpbmRleDogc3RyaW5nXTogYW55OyB9KSB7XG4gICAgICAgIGlmICghdGhpc1tpbnRlcm5hbEtleV0pIHtcbiAgICAgICAgICAgIHNldEV2ZW50T3JSZXNwb25zZSh0aGlzLCBwYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzW2ludGVybmFsS2V5XTtcbiAgICB9O1xuICAgIGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IHRydWU7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcGVydHlLZXksIGRlc2NyaXB0b3IpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXZlbnQodGFyZ2V0OiBPYmplY3QsIHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IGRlc2NyaXB0b3I6IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB7fTtcbiAgICBjb25zdCBpbnRlcm5hbEtleSA9IGdldEludGVybmFsS2V5KHBhdGgpO1xuICAgIGRlc2NyaXB0b3IuZ2V0ID0gZnVuY3Rpb24gKHRoaXM6IHsgW2luZGV4OiBzdHJpbmddOiBhbnk7IH0pIHtcbiAgICAgICAgaWYgKCF0aGlzW2ludGVybmFsS2V5XSkge1xuICAgICAgICAgICAgc2V0RXZlbnRPclJlc3BvbnNlKHRoaXMsIHBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXNbaW50ZXJuYWxLZXldO1xuICAgIH07XG4gICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gdHJ1ZTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBwYXRoLCBkZXNjcmlwdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VPYnNlcnZhYmxlKHRhcmdldDogT2JqZWN0LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBwYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+ID0ge307XG4gICAgY29uc3QgaW50ZXJuYWxLZXkgPSBnZXRJbnRlcm5hbEtleShwYXRoKTtcbiAgICBjb25zdCBtZXRob2QgPSAoYzogYW55KSA9PiBjLm9ic2VydmVbcHJvcGVydHlLZXldIHx8IGNbcHJvcGVydHlLZXldO1xuICAgIGRlc2NyaXB0b3IuZ2V0ID0gZnVuY3Rpb24gKHRoaXM6IHsgW2luZGV4OiBzdHJpbmddOiBhbnk7IG1ha2VPYnNlcnZhYmxlOiAobWV0aG9kOiBGdW5jdGlvbikgPT4gYW55OyB9KSB7XG4gICAgICAgIGlmICghdGhpc1tpbnRlcm5hbEtleV0pIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5tYWtlT2JzZXJ2YWJsZShtZXRob2QpO1xuICAgICAgICAgICAgdGhpc1tpbnRlcm5hbEtleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpc1tpbnRlcm5hbEtleV07XG4gICAgfTtcbiAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSB0cnVlO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlZmVyZW5jZSh0YXJnZXQ6IE9iamVjdCwgcHJvcGVydHlLZXk6IHN0cmluZywgcGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgZGVzY3JpcHRvcjogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8YW55PiA9IHt9O1xuICAgIGRlc2NyaXB0b3IuZ2V0ID0gZnVuY3Rpb24gKHRoaXM6IHsgW2luZGV4OiBzdHJpbmddOiBhbnk7IF9jbGllbnQ6IHsgW2luZGV4OiBzdHJpbmddOiBhbnk7IH0gfSkgeyByZXR1cm4gdGhpcy5fY2xpZW50W3Byb3BlcnR5S2V5XTsgfTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvcik7XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
