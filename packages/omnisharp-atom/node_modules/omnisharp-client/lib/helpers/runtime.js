"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.isSupportedRuntime = exports.RuntimeContext = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

exports.findRuntimeById = findRuntimeById;

var _rxjs = require("rxjs");

var _path = require("path");

var _fs = require("fs");

var fs = _interopRequireWildcard(_fs);

var _enums = require("../enums");

var _lodash = require("lodash");

var _decompress = require("./decompress");

var _create = require("../operators/create");

require("rxjs/add/operator/max");

require("rxjs/add/operator/isEmpty");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

require("rxjs/add/observable/if");
var request = require("request");
var defaultServerVersion = require((0, _path.resolve)(__dirname, "../../package.json"))["omnisharp-roslyn"];
var exists = _rxjs.Observable.bindCallback(fs.exists);
var readFile = _rxjs.Observable.bindNodeCallback(fs.readFile);
var defaultDest = (0, _path.resolve)(__dirname, "../../");
var PATH = (0, _lodash.find)(process.env, function (v, key) {
    return (0, _lodash.toLower)(key) === "path";
}).split(_path.delimiter).concat(["/usr/local/bin", "/Library/Frameworks/Mono.framework/Commands"]);
;

var RuntimeContext = exports.RuntimeContext = function () {
    function RuntimeContext(runtimeContext, _logger) {
        _classCallCheck(this, RuntimeContext);

        this._logger = _logger;
        if (!_logger) {
            this._logger = console;
        }
        var self = this;
        (0, _lodash.assignWith)(self, runtimeContext || {}, function (obj, src, key) {
            self["_" + key] = obj || src;
        });
        if ((0, _lodash.isNull)(this._runtime) || (0, _lodash.isUndefined)(this._runtime)) {
            this._runtime = _enums.Runtime.ClrOrMono;
        }
        if ((0, _lodash.isNull)(this._platform) || (0, _lodash.isUndefined)(this._platform)) {
            this._platform = process.platform;
        }
        if ((0, _lodash.isNull)(this._arch) || (0, _lodash.isUndefined)(this._arch)) {
            this._arch = process.arch;
        }
        if ((0, _lodash.isNull)(this._version) || (0, _lodash.isUndefined)(this._version)) {
            this._version = defaultServerVersion;
        }
        this._arch = this._arch === "x86" ? "x86" : "x64";
        this._os = this._getOsName();
        this._key = this._getIdKey();
        this._id = "omnisharp-" + this._key;
        if ((0, _lodash.isNull)(this._location) || (0, _lodash.isUndefined)(this._location)) {
            this._location = this._getRuntimeLocation();
        }
        if ((0, _lodash.isNull)(this._destination) || (0, _lodash.isUndefined)(this._destination)) {
            this._destination = (0, _path.resolve)(defaultDest, this._id);
        }
        Object.freeze(this);
    }

    _createClass(RuntimeContext, [{
        key: "_getIdKey",
        value: function _getIdKey() {
            if (this._platform !== "win32" && this._runtime === _enums.Runtime.ClrOrMono) {
                return "linux-mono";
            }
            var runtimeName = "dnxcore50";
            if (this._runtime === _enums.Runtime.ClrOrMono) {
                if (this._platform === "win32") {
                    runtimeName = "dnx451";
                } else {
                    runtimeName = "mono";
                }
            }
            return this._os + "-" + this._arch + "-" + runtimeName;
        }
    }, {
        key: "_getOsName",
        value: function _getOsName() {
            if (this._platform === "win32") return "win";
            if (this._platform === "darwin") return "osx";
            return this._platform;
        }
    }, {
        key: "_getRuntimeLocation",
        value: function _getRuntimeLocation() {
            var path = process.env["OMNISHARP"];
            if (!path) {
                var omnisharp = process.platform === "win32" || this._runtime === _enums.Runtime.ClrOrMono ? "OmniSharp.exe" : "OmniSharp";
                path = (0, _path.resolve)(__dirname, "../../", this._id, omnisharp);
            }
            if (process.platform !== "win32" && this._runtime === _enums.Runtime.ClrOrMono) {
                return "mono " + path;
            }
            return path;
        }
    }, {
        key: "_checkCurrentVersion",
        value: function _checkCurrentVersion() {
            var _this = this;

            var filename = (0, _path.join)(this._destination, ".version");
            return exists(filename).flatMap(function (ex) {
                return _rxjs.Observable.if(function () {
                    return ex;
                }, _rxjs.Observable.defer(function () {
                    return readFile(filename).map(function (content) {
                        return content.toString().trim() === _this._version;
                    });
                }), _rxjs.Observable.of(false));
            });
        }
    }, {
        key: "_ensureCurrentVersion",
        value: function _ensureCurrentVersion() {
            var _this2 = this;

            var dest = this._destination;
            return this._checkCurrentVersion().flatMap(function (isCurrent) {
                return _rxjs.Observable.if(function () {
                    return !isCurrent;
                }, _rxjs.Observable.defer(function () {
                    return (0, _create.createObservable)(function (observer) {
                        dest = dest || defaultDest;
                        require("rimraf")(dest, function (err) {
                            if (err) {
                                observer.error(err);
                                return;
                            }
                            (0, _lodash.delay)(function () {
                                return fs.mkdir(dest, function (er) {
                                    fs.writeFile((0, _path.join)(dest, ".version"), _this2._version, function (e) {
                                        if (e) {
                                            observer.error(e);
                                            return;
                                        }
                                        observer.next(isCurrent);
                                        observer.complete();
                                    });
                                });
                            }, 500);
                        });
                    });
                }), _rxjs.Observable.of(isCurrent));
            });
        }
    }, {
        key: "findRuntime",
        value: function findRuntime() {
            var location = arguments.length <= 0 || arguments[0] === undefined ? (0, _path.resolve)(defaultDest) : arguments[0];

            return findRuntimeById(this._id, location);
        }
    }, {
        key: "downloadRuntime",
        value: function downloadRuntime() {
            var _this3 = this;

            return _rxjs.Observable.defer(function () {
                return _rxjs.Observable.concat(_this3._downloadSpecificRuntime("omnisharp"));
            }).subscribeOn(_rxjs.Scheduler.async).toArray();
        }
    }, {
        key: "downloadRuntimeIfMissing",
        value: function downloadRuntimeIfMissing() {
            var _this4 = this;

            return this._ensureCurrentVersion().flatMap(function (isCurrent) {
                return _this4.findRuntime().isEmpty();
            }).flatMap(function (empty) {
                return _rxjs.Observable.if(function () {
                    return empty;
                }, _this4.downloadRuntime());
            });
        }
    }, {
        key: "_downloadSpecificRuntime",
        value: function _downloadSpecificRuntime(name) {
            var _this5 = this;

            var filename = name + "-" + this._key + "." + (this._platform === "win32" ? "zip" : "tar.gz");
            var destination = this._destination;
            try {
                if (!fs.existsSync(destination)) fs.mkdirSync(destination);
            } catch (e) {}
            var url = "https://github.com/OmniSharp/omnisharp-roslyn/releases/download/" + this._version + "/" + filename;
            var path = (0, _path.join)(destination, filename);
            return _rxjs.Observable.defer(function () {
                return _rxjs.Observable.concat(_this5.downloadFile(url, path).delay(100), _rxjs.Observable.defer(function () {
                    return _this5._extract(_this5._platform === "win32", path, destination);
                })).do({ complete: function complete() {
                        try {
                            fs.unlinkSync(path);
                        } catch (e) {}
                    } }).subscribeOn(_rxjs.Scheduler.async);
            }).map(function () {
                return name;
            });
        }
    }, {
        key: "downloadFile",
        value: function downloadFile(url, path) {
            var _this6 = this;

            this._logger.log("Downloading " + path);
            return (0, _create.createObservable)(function (observer) {
                request.get(url).pipe(fs.createWriteStream(path)).on("error", (0, _lodash.bind)(observer.error, observer)).on("finish", function () {
                    _this6._logger.log("Finished downloading " + path);
                    observer.next(null);
                    observer.complete();
                });
            });
        }
    }, {
        key: "_extract",
        value: function _extract(win32, path, dest) {
            var _this7 = this;

            return (0, _create.createObservable)(function (observer) {
                _this7._logger.log("Extracting " + path);
                console.log(path, dest);
                new _decompress.Decompress({ mode: "755" }).src(path).dest(dest).run(function (err, files) {
                    if (err) {
                        observer.error(err);
                        return;
                    }
                    _this7._logger.log("Finished extracting " + path);
                    observer.complete();
                });
            });
        }
    }, {
        key: "runtime",
        get: function get() {
            return this._runtime;
        }
    }, {
        key: "platform",
        get: function get() {
            return this._platform;
        }
    }, {
        key: "arch",
        get: function get() {
            return this._arch;
        }
    }, {
        key: "bootstrap",
        get: function get() {
            return this._bootstrap;
        }
    }, {
        key: "version",
        get: function get() {
            return this._version;
        }
    }, {
        key: "destination",
        get: function get() {
            return this._destination;
        }
    }, {
        key: "id",
        get: function get() {
            return this._id;
        }
    }, {
        key: "location",
        get: function get() {
            return this._location;
        }
    }]);

    return RuntimeContext;
}();

var isSupportedRuntime = exports.isSupportedRuntime = (0, _lodash.memoize)(function (ctx) {
    return _rxjs.Observable.defer(function () {
        if (ctx.platform === "win32" || ctx.runtime === _enums.Runtime.CoreClr) {
            return _rxjs.Observable.of({ runtime: ctx.runtime, path: process.env.PATH });
        }
        return _rxjs.Observable.from(PATH).map(function (path) {
            return (0, _path.join)(path, "mono");
        }).concatMap(function (path) {
            return exists(path).map(function (e) {
                return { exists: e, path: path };
            });
        }).filter(function (x) {
            return x.exists;
        }).map(function (x) {
            return { runtime: _enums.Runtime.ClrOrMono, path: [x.path].concat(PATH).join(_path.delimiter) };
        }).take(1).defaultIfEmpty({ runtime: _enums.Runtime.CoreClr, path: process.env.PATH });
    }).do(function (ct) {
        return console.log("Supported runtime for \"" + _enums.Runtime[ct.runtime] + "\" was: " + _enums.Runtime[ct.runtime]);
    }).cache(1);
}, function (_ref) {
    var platform = _ref.platform;
    var arch = _ref.arch;
    var runtime = _ref.runtime;
    var version = _ref.version;
    return arch + "-" + platform + ":" + _enums.Runtime[runtime] + ":" + version;
});
function findRuntimeById(runtimeId, location) {
    return _rxjs.Observable.merge(exists((0, _path.resolve)(location, runtimeId, "OmniSharp.exe")), exists((0, _path.resolve)(location, runtimeId, "OmniSharp"))).filter(function (x) {
        return x;
    }).take(1).map(function (x) {
        return (0, _path.resolve)(location, runtimeId);
    }).share();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzL3J1bnRpbWUudHMiLCJsaWIvaGVscGVycy9ydW50aW1lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztRQW9SQTs7QUNwUkE7O0FBQ0E7O0FBQ0E7O0lEQVk7O0FDQ1o7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBRENBLFFBQVEsd0JBQVI7QUFFQSxJQUFNLFVBQXdELFFBQVEsU0FBUixDQUF4RDtBQUNOLElBQU0sdUJBQXVCLFFBQVEsbUJBQVEsU0FBUixFQUFtQixvQkFBbkIsQ0FBUixFQUFrRCxrQkFBbEQsQ0FBdkI7QUFDTixJQUFNLFNBQVMsaUJBQVcsWUFBWCxDQUF3QixHQUFHLE1BQUgsQ0FBakM7QUFDTixJQUFNLFdBQVcsaUJBQVcsZ0JBQVgsQ0FBNEIsR0FBRyxRQUFILENBQXZDO0FBQ04sSUFBTSxjQUFjLG1CQUFRLFNBQVIsRUFBbUIsUUFBbkIsQ0FBZDtBQUdOLElBQU0sT0FBaUIsa0JBQWEsUUFBUSxHQUFSLEVBQWEsVUFBQyxDQUFELEVBQUksR0FBSjtXQUFZLHFCQUFRLEdBQVIsTUFBaUIsTUFBakI7Q0FBWixDQUExQixDQUErRCxLQUEvRCxrQkFBZ0YsTUFBaEYsQ0FBdUYsQ0FBQyxnQkFBRCxFQUFtQiw2Q0FBbkIsQ0FBdkYsQ0FBakI7QUFTTDs7SUFFRDtBQWFJLGFBYkosY0FhSSxDQUFZLGNBQVosRUFBc0QsT0FBdEQsRUFBdUU7OEJBYjNFLGdCQWEyRTs7QUFBakIsYUFBQSxPQUFBLEdBQUEsT0FBQSxDQUFpQjtBQUNuRSxZQUFJLENBQUMsT0FBRCxFQUFVO0FBQ1YsaUJBQUssT0FBTCxHQUFlLE9BQWYsQ0FEVTtTQUFkO0FBSUEsWUFBTSxPQUFZLElBQVosQ0FMNkQ7QUFNbkUsZ0NBQVcsSUFBWCxFQUFpQixrQkFBa0IsRUFBbEIsRUFBc0IsVUFBQyxHQUFELEVBQU0sR0FBTixFQUFXLEdBQVgsRUFBYztBQUNqRCx1QkFBUyxHQUFULElBQWtCLE9BQU8sR0FBUCxD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SUYsTUFKRSxDQUlLO2VBQUs7S0FBTCxDQUpMLENBS0YsSUFMRSxDQUtHLENBTEgsRUFNRixHQU5FLENBTUU7ZUFBSyxtQkFBUSxRQUFSLEVBQWtCLFNBQWxCO0tBQUwsQ0FORixDQU9GLEtBUEUsRUFBUCxDQUQrRDtDQUFuRSIsImZpbGUiOiJsaWIvaGVscGVycy9ydW50aW1lLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtPYnNlcnZhYmxlLCBTY2hlZHVsZXJ9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQge3Jlc29sdmUsIGpvaW4sIGRlbGltaXRlcn0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHtJTG9nZ2VyLCBSdW50aW1lfSBmcm9tIFwiLi4vZW51bXNcIjtcbmltcG9ydCB7ZmluZCwgZGVsYXksIGJpbmQsIG1lbW9pemUsIGFzc2lnbldpdGgsIGlzTnVsbCwgaXNVbmRlZmluZWQsIHRvTG93ZXJ9IGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7RGVjb21wcmVzc30gZnJvbSBcIi4vZGVjb21wcmVzc1wiO1xuaW1wb3J0IHtjcmVhdGVPYnNlcnZhYmxlfSBmcm9tIFwiLi4vb3BlcmF0b3JzL2NyZWF0ZVwiO1xuaW1wb3J0IFwicnhqcy9hZGQvb3BlcmF0b3IvbWF4XCI7XG5pbXBvcnQgXCJyeGpzL2FkZC9vcGVyYXRvci9pc0VtcHR5XCI7XG5yZXF1aXJlKFwicnhqcy9hZGQvb2JzZXJ2YWJsZS9pZlwiKTtcblxuY29uc3QgcmVxdWVzdDogeyBnZXQodXJsOiBzdHJpbmcpOiBOb2RlSlMuUmVhZGFibGVTdHJlYW07IH0gPSByZXF1aXJlKFwicmVxdWVzdFwiKTtcbmNvbnN0IGRlZmF1bHRTZXJ2ZXJWZXJzaW9uID0gcmVxdWlyZShyZXNvbHZlKF9fZGlybmFtZSwgXCIuLi8uLi9wYWNrYWdlLmpzb25cIikpW1wib21uaXNoYXJwLXJvc2x5blwiXTtcbmNvbnN0IGV4aXN0cyA9IE9ic2VydmFibGUuYmluZENhbGxiYWNrKGZzLmV4aXN0cyk7XG5jb25zdCByZWFkRmlsZSA9IE9ic2VydmFibGUuYmluZE5vZGVDYWxsYmFjayhmcy5yZWFkRmlsZSk7XG5jb25zdCBkZWZhdWx0RGVzdCA9IHJlc29sdmUoX19kaXJuYW1lLCBcIi4uLy4uL1wiKTtcblxuLy8gSGFuZGxlIHRoZSBjYXNlIG9mIGhvbWVicmV3IG1vbm9cbmNvbnN0IFBBVEg6IHN0cmluZ1tdID0gZmluZDxzdHJpbmc+KHByb2Nlc3MuZW52LCAodiwga2V5KSA9PiB0b0xvd2VyKGtleSkgPT09IFwicGF0aFwiKS5zcGxpdChkZWxpbWl0ZXIpLmNvbmNhdChbXCIvdXNyL2xvY2FsL2JpblwiLCBcIi9MaWJyYXJ5L0ZyYW1ld29ya3MvTW9uby5mcmFtZXdvcmsvQ29tbWFuZHNcIl0pO1xuXG5leHBvcnQgaW50ZXJmYWNlIElSdW50aW1lQ29udGV4dCB7XG4gICAgcnVudGltZTogUnVudGltZTtcbiAgICBwbGF0Zm9ybTogc3RyaW5nO1xuICAgIGFyY2g6IHN0cmluZztcbiAgICBib290c3RyYXA/OiBib29sZWFuO1xuICAgIHZlcnNpb24/OiBzdHJpbmc7XG4gICAgZGVzdGluYXRpb24/OiBzdHJpbmc7XG59O1xuXG5leHBvcnQgY2xhc3MgUnVudGltZUNvbnRleHQge1xuICAgIHByaXZhdGUgX3J1bnRpbWU6IFJ1bnRpbWU7XG4gICAgcHJpdmF0ZSBfcGxhdGZvcm06IHN0cmluZztcbiAgICBwcml2YXRlIF9hcmNoOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfYm9vdHN0cmFwOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfdmVyc2lvbjogc3RyaW5nO1xuICAgIHByaXZhdGUgX2Rlc3RpbmF0aW9uOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIF9pZDogc3RyaW5nO1xuICAgIHByaXZhdGUgX2tleTogc3RyaW5nO1xuICAgIHByaXZhdGUgX29zOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfbG9jYXRpb246IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKHJ1bnRpbWVDb250ZXh0PzogSVJ1bnRpbWVDb250ZXh0LCBwcml2YXRlIF9sb2dnZXI/OiBJTG9nZ2VyKSB7XG4gICAgICAgIGlmICghX2xvZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyID0gY29uc29sZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNlbGYgPSA8YW55PnRoaXM7XG4gICAgICAgIGFzc2lnbldpdGgoc2VsZiwgcnVudGltZUNvbnRleHQgfHwge30sIChvYmosIHNyYywga2V5KSA9PiB7XG4gICAgICAgICAgICBzZWxmW2BfJHtrZXl9YF0gPSBvYmogfHwgc3JjO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoaXNOdWxsKHRoaXMuX3J1bnRpbWUpIHx8IGlzVW5kZWZpbmVkKHRoaXMuX3J1bnRpbWUpKSB7XG4gICAgICAgICAgICB0aGlzLl9ydW50aW1lID0gUnVudGltZS5DbHJPck1vbm87XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaXNOdWxsKHRoaXMuX3BsYXRmb3JtKSB8fCBpc1VuZGVmaW5lZCh0aGlzLl9wbGF0Zm9ybSkpIHtcbiAgICAgICAgICAgIHRoaXMuX3BsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpc051bGwodGhpcy5fYXJjaCkgfHwgaXNVbmRlZmluZWQodGhpcy5fYXJjaCkpIHtcbiAgICAgICAgICAgIHRoaXMuX2FyY2ggPSBwcm9jZXNzLmFyY2g7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaXNOdWxsKHRoaXMuX3ZlcnNpb24pIHx8IGlzVW5kZWZpbmVkKHRoaXMuX3ZlcnNpb24pKSB7XG4gICAgICAgICAgICB0aGlzLl92ZXJzaW9uID0gZGVmYXVsdFNlcnZlclZlcnNpb247XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9hcmNoID0gdGhpcy5fYXJjaCA9PT0gXCJ4ODZcIiA/IFwieDg2XCIgOiBcIng2NFwiO1xuXG4gICAgICAgIHRoaXMuX29zID0gdGhpcy5fZ2V0T3NOYW1lKCk7XG4gICAgICAgIHRoaXMuX2tleSA9IHRoaXMuX2dldElkS2V5KCk7XG4gICAgICAgIHRoaXMuX2lkID0gYG9tbmlzaGFycC0ke3RoaXMuX2tleX1gO1xuXG4gICAgICAgIGlmIChpc051bGwodGhpcy5fbG9jYXRpb24pIHx8IGlzVW5kZWZpbmVkKHRoaXMuX2xvY2F0aW9uKSkge1xuICAgICAgICAgICAgdGhpcy5fbG9jYXRpb24gPSB0aGlzLl9nZXRSdW50aW1lTG9jYXRpb24oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpc051bGwodGhpcy5fZGVzdGluYXRpb24pIHx8IGlzVW5kZWZpbmVkKHRoaXMuX2Rlc3RpbmF0aW9uKSkge1xuICAgICAgICAgICAgdGhpcy5fZGVzdGluYXRpb24gPSByZXNvbHZlKGRlZmF1bHREZXN0LCB0aGlzLl9pZCk7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QuZnJlZXplKHRoaXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcnVudGltZSgpIHsgcmV0dXJuIHRoaXMuX3J1bnRpbWU7IH07XG4gICAgcHVibGljIGdldCBwbGF0Zm9ybSgpIHsgcmV0dXJuIHRoaXMuX3BsYXRmb3JtOyB9XG4gICAgcHVibGljIGdldCBhcmNoKCkgeyByZXR1cm4gdGhpcy5fYXJjaDsgfVxuICAgIHB1YmxpYyBnZXQgYm9vdHN0cmFwKCkgeyByZXR1cm4gdGhpcy5fYm9vdHN0cmFwOyB9XG4gICAgcHVibGljIGdldCB2ZXJzaW9uKCkgeyByZXR1cm4gdGhpcy5fdmVyc2lvbjsgfVxuICAgIHB1YmxpYyBnZXQgZGVzdGluYXRpb24oKSB7IHJldHVybiB0aGlzLl9kZXN0aW5hdGlvbjsgfVxuICAgIHB1YmxpYyBnZXQgaWQoKSB7IHJldHVybiB0aGlzLl9pZDsgfVxuICAgIHB1YmxpYyBnZXQgbG9jYXRpb24oKSB7IHJldHVybiB0aGlzLl9sb2NhdGlvbjsgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0SWRLZXkoKSB7XG4gICAgICAgIGlmICh0aGlzLl9wbGF0Zm9ybSAhPT0gXCJ3aW4zMlwiICYmIHRoaXMuX3J1bnRpbWUgPT09IFJ1bnRpbWUuQ2xyT3JNb25vKSB7XG4gICAgICAgICAgICByZXR1cm4gYGxpbnV4LW1vbm9gO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJ1bnRpbWVOYW1lID0gXCJkbnhjb3JlNTBcIjtcbiAgICAgICAgaWYgKHRoaXMuX3J1bnRpbWUgPT09IFJ1bnRpbWUuQ2xyT3JNb25vKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcGxhdGZvcm0gPT09IFwid2luMzJcIikge1xuICAgICAgICAgICAgICAgIHJ1bnRpbWVOYW1lID0gXCJkbng0NTFcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcnVudGltZU5hbWUgPSBcIm1vbm9cIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBgJHt0aGlzLl9vc30tJHt0aGlzLl9hcmNofS0ke3J1bnRpbWVOYW1lfWA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0T3NOYW1lKCkge1xuICAgICAgICBpZiAodGhpcy5fcGxhdGZvcm0gPT09IFwid2luMzJcIilcbiAgICAgICAgICAgIHJldHVybiBcIndpblwiO1xuICAgICAgICBpZiAodGhpcy5fcGxhdGZvcm0gPT09IFwiZGFyd2luXCIpXG4gICAgICAgICAgICByZXR1cm4gXCJvc3hcIjtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BsYXRmb3JtO1xuICAgIH1cblxuICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLXN0cmluZy1saXRlcmFsICovXG4gICAgcHJpdmF0ZSBfZ2V0UnVudGltZUxvY2F0aW9uKCkge1xuICAgICAgICAvKmlmIChjdHguYm9vdHN0cmFwKSB7XG4gICAgICAgICAgICBjb25zdCBib290c3RyYXAgPSBwcm9jZXNzLnBsYXRmb3JtID09PSBcIndpbjMyXCIgPyBcIk9tbmlTaGFycC5leGVcIiA6IFwib21uaXNoYXJwLmJvb3RzdHJhcFwiO1xuICAgICAgICAgICAgcmV0dXJuIDxzdHJpbmc+cHJvY2Vzcy5lbnZbXCJPTU5JU0hBUlBfQk9PVFNUUkFQXCJdIHx8IHJlc29sdmUoX19kaXJuYW1lLCBcIi4uLy4uL1wiLCBnZXRSdW50aW1lSWQoY3R4KSwgYm9vdHN0cmFwKTtcbiAgICAgICAgfSovXG5cbiAgICAgICAgbGV0IHBhdGg6IHN0cmluZyA9IHByb2Nlc3MuZW52W1wiT01OSVNIQVJQXCJdO1xuXG4gICAgICAgIGlmICghcGF0aCkge1xuICAgICAgICAgICAgY29uc3Qgb21uaXNoYXJwID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gXCJ3aW4zMlwiIHx8IHRoaXMuX3J1bnRpbWUgPT09IFJ1bnRpbWUuQ2xyT3JNb25vID8gXCJPbW5pU2hhcnAuZXhlXCIgOiBcIk9tbmlTaGFycFwiO1xuICAgICAgICAgICAgcGF0aCA9IHJlc29sdmUoX19kaXJuYW1lLCBcIi4uLy4uL1wiLCB0aGlzLl9pZCwgb21uaXNoYXJwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtICE9PSBcIndpbjMyXCIgJiYgdGhpcy5fcnVudGltZSA9PT0gUnVudGltZS5DbHJPck1vbm8pIHtcbiAgICAgICAgICAgIHJldHVybiBgbW9ubyAke3BhdGh9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwYXRoO1xuICAgIH1cbiAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLXN0cmluZy1saXRlcmFsICovXG5cbiAgICBwcml2YXRlIF9jaGVja0N1cnJlbnRWZXJzaW9uKCkge1xuICAgICAgICBsZXQgZmlsZW5hbWUgPSBqb2luKHRoaXMuX2Rlc3RpbmF0aW9uLCBcIi52ZXJzaW9uXCIpO1xuXG4gICAgICAgIHJldHVybiBleGlzdHMoZmlsZW5hbWUpXG4gICAgICAgICAgICAuZmxhdE1hcChleCA9PiBPYnNlcnZhYmxlLmlmKFxuICAgICAgICAgICAgICAgICgpID0+IGV4LFxuICAgICAgICAgICAgICAgIE9ic2VydmFibGUuZGVmZXIoKCkgPT4gcmVhZEZpbGUoZmlsZW5hbWUpLm1hcChjb250ZW50ID0+IGNvbnRlbnQudG9TdHJpbmcoKS50cmltKCkgPT09IHRoaXMuX3ZlcnNpb24pKSxcbiAgICAgICAgICAgICAgICBPYnNlcnZhYmxlLm9mKGZhbHNlKVxuICAgICAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZW5zdXJlQ3VycmVudFZlcnNpb24oKSB7XG4gICAgICAgIGxldCBkZXN0ID0gdGhpcy5fZGVzdGluYXRpb247XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NoZWNrQ3VycmVudFZlcnNpb24oKVxuICAgICAgICAgICAgLmZsYXRNYXAoaXNDdXJyZW50ID0+IE9ic2VydmFibGUuaWYoXG4gICAgICAgICAgICAgICAgKCkgPT4gIWlzQ3VycmVudCxcbiAgICAgICAgICAgICAgICBPYnNlcnZhYmxlLmRlZmVyKCgpID0+IGNyZWF0ZU9ic2VydmFibGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgICAgICAgICBkZXN0ID0gZGVzdCB8fCBkZWZhdWx0RGVzdDtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZShcInJpbXJhZlwiKShkZXN0LCAoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgb2JzZXJ2ZXIuZXJyb3IoZXJyKTsgcmV0dXJuOyB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5KCgpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMubWtkaXIoZGVzdCwgKGVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vaWYgKGVyKSB7IG9ic2VydmVyLm9uRXJyb3IoZXIpOyByZXR1cm47IH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlKGpvaW4oZGVzdCwgXCIudmVyc2lvblwiKSwgdGhpcy5fdmVyc2lvbiwgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7IG9ic2VydmVyLmVycm9yKGUpOyByZXR1cm47IH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoaXNDdXJyZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLCA1MDApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KSksXG4gICAgICAgICAgICAgICAgT2JzZXJ2YWJsZS5vZihpc0N1cnJlbnQpXG4gICAgICAgICAgICApKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmluZFJ1bnRpbWUobG9jYXRpb246IHN0cmluZyA9IHJlc29sdmUoZGVmYXVsdERlc3QpKSB7XG4gICAgICAgIHJldHVybiBmaW5kUnVudGltZUJ5SWQodGhpcy5faWQsIGxvY2F0aW9uKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZG93bmxvYWRSdW50aW1lKCkge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5kZWZlcigoKSA9PiBPYnNlcnZhYmxlLmNvbmNhdChcbiAgICAgICAgICAgIC8vIGRvd25sb2FkU3BlY2lmaWNSdW50aW1lKFwib21uaXNoYXJwLmJvb3RzdHJhcFwiLCBjdHgsIGxvZ2dlciwgZGVzdCksXG4gICAgICAgICAgICB0aGlzLl9kb3dubG9hZFNwZWNpZmljUnVudGltZShcIm9tbmlzaGFycFwiKVxuICAgICAgICApKVxuICAgICAgICAgICAgLnN1YnNjcmliZU9uKFNjaGVkdWxlci5hc3luYylcbiAgICAgICAgICAgIC50b0FycmF5KCk7XG4gICAgfVxuXG4gICAgcHVibGljIGRvd25sb2FkUnVudGltZUlmTWlzc2luZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vuc3VyZUN1cnJlbnRWZXJzaW9uKClcbiAgICAgICAgICAgIC5mbGF0TWFwKChpc0N1cnJlbnQpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5maW5kUnVudGltZSgpLmlzRW1wdHkoKSlcbiAgICAgICAgICAgIC5mbGF0TWFwKGVtcHR5ID0+IE9ic2VydmFibGUuaWYoXG4gICAgICAgICAgICAgICAgKCkgPT4gZW1wdHksXG4gICAgICAgICAgICAgICAgdGhpcy5kb3dubG9hZFJ1bnRpbWUoKVxuICAgICAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZG93bmxvYWRTcGVjaWZpY1J1bnRpbWUobmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7bmFtZX0tJHt0aGlzLl9rZXl9LiR7dGhpcy5fcGxhdGZvcm0gPT09IFwid2luMzJcIiA/IFwiemlwXCIgOiBcInRhci5nelwifWA7XG4gICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gdGhpcy5fZGVzdGluYXRpb247XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGVzdGluYXRpb24pKVxuICAgICAgICAgICAgICAgIGZzLm1rZGlyU3luYyhkZXN0aW5hdGlvbik7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgLyogKi8gfVxuXG4gICAgICAgIGNvbnN0IHVybCA9IGBodHRwczovL2dpdGh1Yi5jb20vT21uaVNoYXJwL29tbmlzaGFycC1yb3NseW4vcmVsZWFzZXMvZG93bmxvYWQvJHt0aGlzLl92ZXJzaW9ufS8ke2ZpbGVuYW1lfWA7XG4gICAgICAgIGNvbnN0IHBhdGggPSBqb2luKGRlc3RpbmF0aW9uLCBmaWxlbmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZGVmZXIoKCkgPT4gT2JzZXJ2YWJsZS5jb25jYXQoXG4gICAgICAgICAgICB0aGlzLmRvd25sb2FkRmlsZSh1cmwsIHBhdGgpLmRlbGF5KDEwMCksXG4gICAgICAgICAgICBPYnNlcnZhYmxlLmRlZmVyKCgpID0+IHRoaXMuX2V4dHJhY3QodGhpcy5fcGxhdGZvcm0gPT09IFwid2luMzJcIiwgcGF0aCwgZGVzdGluYXRpb24pKVxuICAgICAgICApXG4gICAgICAgICAgICAuZG8oeyBjb21wbGV0ZTogKCkgPT4geyB0cnkgeyBmcy51bmxpbmtTeW5jKHBhdGgpOyB9IGNhdGNoIChlKSB7IC8qICovIH0gfSB9KVxuICAgICAgICAgICAgLnN1YnNjcmliZU9uKFNjaGVkdWxlci5hc3luYykpXG4gICAgICAgICAgICAubWFwKCgpID0+IG5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkb3dubG9hZEZpbGUodXJsOiBzdHJpbmcsIHBhdGg6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9sb2dnZXIubG9nKGBEb3dubG9hZGluZyAke3BhdGh9YCk7XG4gICAgICAgIHJldHVybiBjcmVhdGVPYnNlcnZhYmxlPHZvaWQ+KChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgcmVxdWVzdC5nZXQodXJsKVxuICAgICAgICAgICAgICAgIC5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgpKVxuICAgICAgICAgICAgICAgIC5vbihcImVycm9yXCIsIGJpbmQob2JzZXJ2ZXIuZXJyb3IsIG9ic2VydmVyKSlcbiAgICAgICAgICAgICAgICAub24oXCJmaW5pc2hcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIubG9nKGBGaW5pc2hlZCBkb3dubG9hZGluZyAke3BhdGh9YCk7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2V4dHJhY3Qod2luMzI6IGJvb2xlYW4sIHBhdGg6IHN0cmluZywgZGVzdDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVPYnNlcnZhYmxlPHZvaWQ+KChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgRXh0cmFjdGluZyAke3BhdGh9YCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhwYXRoLCBkZXN0KTtcbiAgICAgICAgICAgIG5ldyBEZWNvbXByZXNzKHsgbW9kZTogXCI3NTVcIiB9KVxuICAgICAgICAgICAgICAgIC5zcmMocGF0aClcbiAgICAgICAgICAgICAgICAuZGVzdChkZXN0KVxuICAgICAgICAgICAgICAgIC5ydW4oKGVycjogYW55LCBmaWxlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgRmluaXNoZWQgZXh0cmFjdGluZyAke3BhdGh9YCk7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGNvbnN0IGlzU3VwcG9ydGVkUnVudGltZSA9IG1lbW9pemUoZnVuY3Rpb24oY3R4OiBSdW50aW1lQ29udGV4dCkge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLmRlZmVyKCgpID0+IHtcbiAgICAgICAgLy8gT24gd2luZG93cyB3ZSdsbCBqdXN0IHVzZSB0aGUgY2xyLCBpdCdzIHRoZXJlXG4gICAgICAgIC8vIE9uIG1hYyAvIGxpbnV4IGlmIHdlJ3ZlIHBpY2tlZCBDb3JlQ2xyIHN0aWNrIHdpdGggdGhhdFxuICAgICAgICBpZiAoY3R4LnBsYXRmb3JtID09PSBcIndpbjMyXCIgfHwgY3R4LnJ1bnRpbWUgPT09IFJ1bnRpbWUuQ29yZUNscikge1xuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoeyBydW50aW1lOiBjdHgucnVudGltZSwgcGF0aDogcHJvY2Vzcy5lbnYuUEFUSCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFdlIG5lZWQgdG8gY2hlY2sgaWYgbW9ubyBleGlzdHMgb24gdGhlIHN5c3RlbVxuICAgICAgICAvLyBJZiBpdCBkb2Vzbid0IHdlJ2xsIGp1c3QgcnVuIENvcmVDbHJcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbSg8c3RyaW5nW10+UEFUSClcbiAgICAgICAgICAgIC5tYXAocGF0aCA9PiBqb2luKHBhdGgsIFwibW9ub1wiKSlcbiAgICAgICAgICAgIC5jb25jYXRNYXAocGF0aCA9PiBleGlzdHMocGF0aCkubWFwKGUgPT4gKHsgZXhpc3RzOiBlLCBwYXRoIH0pKSlcbiAgICAgICAgICAgIC5maWx0ZXIoeCA9PiB4LmV4aXN0cylcbiAgICAgICAgICAgIC5tYXAoeCA9PiAoeyBydW50aW1lOiBSdW50aW1lLkNsck9yTW9ubywgcGF0aDogW3gucGF0aF0uY29uY2F0KFBBVEgpLmpvaW4oZGVsaW1pdGVyKSB9KSlcbiAgICAgICAgICAgIC50YWtlKDEpXG4gICAgICAgICAgICAuZGVmYXVsdElmRW1wdHkoeyBydW50aW1lOiBSdW50aW1lLkNvcmVDbHIsIHBhdGg6IHByb2Nlc3MuZW52LlBBVEggfSk7XG4gICAgfSlcbiAgICAgICAgLmRvKGN0ID0+IGNvbnNvbGUubG9nKGBTdXBwb3J0ZWQgcnVudGltZSBmb3IgXCIke1J1bnRpbWVbY3QucnVudGltZV19XCIgd2FzOiAke1J1bnRpbWVbY3QucnVudGltZV19YCkpXG4gICAgICAgIC5jYWNoZSgxKTtcbn0sIGZ1bmN0aW9uKHtwbGF0Zm9ybSwgYXJjaCwgcnVudGltZSwgdmVyc2lvbn06IFJ1bnRpbWVDb250ZXh0KSB7IHJldHVybiBgJHthcmNofS0ke3BsYXRmb3JtfToke1J1bnRpbWVbcnVudGltZV19OiR7dmVyc2lvbn1gOyB9KTtcblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRSdW50aW1lQnlJZChydW50aW1lSWQ6IHN0cmluZywgbG9jYXRpb246IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUubWVyZ2UoXG4gICAgICAgIGV4aXN0cyhyZXNvbHZlKGxvY2F0aW9uLCBydW50aW1lSWQsIFwiT21uaVNoYXJwLmV4ZVwiKSksXG4gICAgICAgIGV4aXN0cyhyZXNvbHZlKGxvY2F0aW9uLCBydW50aW1lSWQsIFwiT21uaVNoYXJwXCIpKVxuICAgIClcbiAgICAgICAgLmZpbHRlcih4ID0+IHgpXG4gICAgICAgIC50YWtlKDEpXG4gICAgICAgIC5tYXAoeCA9PiByZXNvbHZlKGxvY2F0aW9uLCBydW50aW1lSWQpKVxuICAgICAgICAuc2hhcmUoKTtcbn1cbiIsImltcG9ydCB7IE9ic2VydmFibGUsIFNjaGVkdWxlciB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyByZXNvbHZlLCBqb2luLCBkZWxpbWl0ZXIgfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBSdW50aW1lIH0gZnJvbSBcIi4uL2VudW1zXCI7XG5pbXBvcnQgeyBmaW5kLCBkZWxheSwgYmluZCwgbWVtb2l6ZSwgYXNzaWduV2l0aCwgaXNOdWxsLCBpc1VuZGVmaW5lZCwgdG9Mb3dlciB9IGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7IERlY29tcHJlc3MgfSBmcm9tIFwiLi9kZWNvbXByZXNzXCI7XG5pbXBvcnQgeyBjcmVhdGVPYnNlcnZhYmxlIH0gZnJvbSBcIi4uL29wZXJhdG9ycy9jcmVhdGVcIjtcbmltcG9ydCBcInJ4anMvYWRkL29wZXJhdG9yL21heFwiO1xuaW1wb3J0IFwicnhqcy9hZGQvb3BlcmF0b3IvaXNFbXB0eVwiO1xucmVxdWlyZShcInJ4anMvYWRkL29ic2VydmFibGUvaWZcIik7XG5jb25zdCByZXF1ZXN0ID0gcmVxdWlyZShcInJlcXVlc3RcIik7XG5jb25zdCBkZWZhdWx0U2VydmVyVmVyc2lvbiA9IHJlcXVpcmUocmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi4vLi4vcGFja2FnZS5qc29uXCIpKVtcIm9tbmlzaGFycC1yb3NseW5cIl07XG5jb25zdCBleGlzdHMgPSBPYnNlcnZhYmxlLmJpbmRDYWxsYmFjayhmcy5leGlzdHMpO1xuY29uc3QgcmVhZEZpbGUgPSBPYnNlcnZhYmxlLmJpbmROb2RlQ2FsbGJhY2soZnMucmVhZEZpbGUpO1xuY29uc3QgZGVmYXVsdERlc3QgPSByZXNvbHZlKF9fZGlybmFtZSwgXCIuLi8uLi9cIik7XG5jb25zdCBQQVRIID0gZmluZChwcm9jZXNzLmVudiwgKHYsIGtleSkgPT4gdG9Mb3dlcihrZXkpID09PSBcInBhdGhcIikuc3BsaXQoZGVsaW1pdGVyKS5jb25jYXQoW1wiL3Vzci9sb2NhbC9iaW5cIiwgXCIvTGlicmFyeS9GcmFtZXdvcmtzL01vbm8uZnJhbWV3b3JrL0NvbW1hbmRzXCJdKTtcbjtcbmV4cG9ydCBjbGFzcyBSdW50aW1lQ29udGV4dCB7XG4gICAgY29uc3RydWN0b3IocnVudGltZUNvbnRleHQsIF9sb2dnZXIpIHtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gX2xvZ2dlcjtcbiAgICAgICAgaWYgKCFfbG9nZ2VyKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIgPSBjb25zb2xlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBhc3NpZ25XaXRoKHNlbGYsIHJ1bnRpbWVDb250ZXh0IHx8IHt9LCAob2JqLCBzcmMsIGtleSkgPT4ge1xuICAgICAgICAgICAgc2VsZltgXyR7a2V5fWBdID0gb2JqIHx8IHNyYztcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChpc051bGwodGhpcy5fcnVudGltZSkgfHwgaXNVbmRlZmluZWQodGhpcy5fcnVudGltZSkpIHtcbiAgICAgICAgICAgIHRoaXMuX3J1bnRpbWUgPSBSdW50aW1lLkNsck9yTW9ubztcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNOdWxsKHRoaXMuX3BsYXRmb3JtKSB8fCBpc1VuZGVmaW5lZCh0aGlzLl9wbGF0Zm9ybSkpIHtcbiAgICAgICAgICAgIHRoaXMuX3BsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNOdWxsKHRoaXMuX2FyY2gpIHx8IGlzVW5kZWZpbmVkKHRoaXMuX2FyY2gpKSB7XG4gICAgICAgICAgICB0aGlzLl9hcmNoID0gcHJvY2Vzcy5hcmNoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc051bGwodGhpcy5fdmVyc2lvbikgfHwgaXNVbmRlZmluZWQodGhpcy5fdmVyc2lvbikpIHtcbiAgICAgICAgICAgIHRoaXMuX3ZlcnNpb24gPSBkZWZhdWx0U2VydmVyVmVyc2lvbjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hcmNoID0gdGhpcy5fYXJjaCA9PT0gXCJ4ODZcIiA/IFwieDg2XCIgOiBcIng2NFwiO1xuICAgICAgICB0aGlzLl9vcyA9IHRoaXMuX2dldE9zTmFtZSgpO1xuICAgICAgICB0aGlzLl9rZXkgPSB0aGlzLl9nZXRJZEtleSgpO1xuICAgICAgICB0aGlzLl9pZCA9IGBvbW5pc2hhcnAtJHt0aGlzLl9rZXl9YDtcbiAgICAgICAgaWYgKGlzTnVsbCh0aGlzLl9sb2NhdGlvbikgfHwgaXNVbmRlZmluZWQodGhpcy5fbG9jYXRpb24pKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2NhdGlvbiA9IHRoaXMuX2dldFJ1bnRpbWVMb2NhdGlvbigpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc051bGwodGhpcy5fZGVzdGluYXRpb24pIHx8IGlzVW5kZWZpbmVkKHRoaXMuX2Rlc3RpbmF0aW9uKSkge1xuICAgICAgICAgICAgdGhpcy5fZGVzdGluYXRpb24gPSByZXNvbHZlKGRlZmF1bHREZXN0LCB0aGlzLl9pZCk7XG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgICB9XG4gICAgZ2V0IHJ1bnRpbWUoKSB7IHJldHVybiB0aGlzLl9ydW50aW1lOyB9XG4gICAgO1xuICAgIGdldCBwbGF0Zm9ybSgpIHsgcmV0dXJuIHRoaXMuX3BsYXRmb3JtOyB9XG4gICAgZ2V0IGFyY2goKSB7IHJldHVybiB0aGlzLl9hcmNoOyB9XG4gICAgZ2V0IGJvb3RzdHJhcCgpIHsgcmV0dXJuIHRoaXMuX2Jvb3RzdHJhcDsgfVxuICAgIGdldCB2ZXJzaW9uKCkgeyByZXR1cm4gdGhpcy5fdmVyc2lvbjsgfVxuICAgIGdldCBkZXN0aW5hdGlvbigpIHsgcmV0dXJuIHRoaXMuX2Rlc3RpbmF0aW9uOyB9XG4gICAgZ2V0IGlkKCkgeyByZXR1cm4gdGhpcy5faWQ7IH1cbiAgICBnZXQgbG9jYXRpb24oKSB7IHJldHVybiB0aGlzLl9sb2NhdGlvbjsgfVxuICAgIF9nZXRJZEtleSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3BsYXRmb3JtICE9PSBcIndpbjMyXCIgJiYgdGhpcy5fcnVudGltZSA9PT0gUnVudGltZS5DbHJPck1vbm8pIHtcbiAgICAgICAgICAgIHJldHVybiBgbGludXgtbW9ub2A7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJ1bnRpbWVOYW1lID0gXCJkbnhjb3JlNTBcIjtcbiAgICAgICAgaWYgKHRoaXMuX3J1bnRpbWUgPT09IFJ1bnRpbWUuQ2xyT3JNb25vKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcGxhdGZvcm0gPT09IFwid2luMzJcIikge1xuICAgICAgICAgICAgICAgIHJ1bnRpbWVOYW1lID0gXCJkbng0NTFcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJ1bnRpbWVOYW1lID0gXCJtb25vXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3RoaXMuX29zfS0ke3RoaXMuX2FyY2h9LSR7cnVudGltZU5hbWV9YDtcbiAgICB9XG4gICAgX2dldE9zTmFtZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3BsYXRmb3JtID09PSBcIndpbjMyXCIpXG4gICAgICAgICAgICByZXR1cm4gXCJ3aW5cIjtcbiAgICAgICAgaWYgKHRoaXMuX3BsYXRmb3JtID09PSBcImRhcndpblwiKVxuICAgICAgICAgICAgcmV0dXJuIFwib3N4XCI7XG4gICAgICAgIHJldHVybiB0aGlzLl9wbGF0Zm9ybTtcbiAgICB9XG4gICAgX2dldFJ1bnRpbWVMb2NhdGlvbigpIHtcbiAgICAgICAgbGV0IHBhdGggPSBwcm9jZXNzLmVudltcIk9NTklTSEFSUFwiXTtcbiAgICAgICAgaWYgKCFwYXRoKSB7XG4gICAgICAgICAgICBjb25zdCBvbW5pc2hhcnAgPSBwcm9jZXNzLnBsYXRmb3JtID09PSBcIndpbjMyXCIgfHwgdGhpcy5fcnVudGltZSA9PT0gUnVudGltZS5DbHJPck1vbm8gPyBcIk9tbmlTaGFycC5leGVcIiA6IFwiT21uaVNoYXJwXCI7XG4gICAgICAgICAgICBwYXRoID0gcmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi4vLi4vXCIsIHRoaXMuX2lkLCBvbW5pc2hhcnApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtICE9PSBcIndpbjMyXCIgJiYgdGhpcy5fcnVudGltZSA9PT0gUnVudGltZS5DbHJPck1vbm8pIHtcbiAgICAgICAgICAgIHJldHVybiBgbW9ubyAke3BhdGh9YDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGF0aDtcbiAgICB9XG4gICAgX2NoZWNrQ3VycmVudFZlcnNpb24oKSB7XG4gICAgICAgIGxldCBmaWxlbmFtZSA9IGpvaW4odGhpcy5fZGVzdGluYXRpb24sIFwiLnZlcnNpb25cIik7XG4gICAgICAgIHJldHVybiBleGlzdHMoZmlsZW5hbWUpXG4gICAgICAgICAgICAuZmxhdE1hcChleCA9PiBPYnNlcnZhYmxlLmlmKCgpID0+IGV4LCBPYnNlcnZhYmxlLmRlZmVyKCgpID0+IHJlYWRGaWxlKGZpbGVuYW1lKS5tYXAoY29udGVudCA9PiBjb250ZW50LnRvU3RyaW5nKCkudHJpbSgpID09PSB0aGlzLl92ZXJzaW9uKSksIE9ic2VydmFibGUub2YoZmFsc2UpKSk7XG4gICAgfVxuICAgIF9lbnN1cmVDdXJyZW50VmVyc2lvbigpIHtcbiAgICAgICAgbGV0IGRlc3QgPSB0aGlzLl9kZXN0aW5hdGlvbjtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NoZWNrQ3VycmVudFZlcnNpb24oKVxuICAgICAgICAgICAgLmZsYXRNYXAoaXNDdXJyZW50ID0+IE9ic2VydmFibGUuaWYoKCkgPT4gIWlzQ3VycmVudCwgT2JzZXJ2YWJsZS5kZWZlcigoKSA9PiBjcmVhdGVPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcbiAgICAgICAgICAgIGRlc3QgPSBkZXN0IHx8IGRlZmF1bHREZXN0O1xuICAgICAgICAgICAgcmVxdWlyZShcInJpbXJhZlwiKShkZXN0LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRlbGF5KCgpID0+IGZzLm1rZGlyKGRlc3QsIChlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGUoam9pbihkZXN0LCBcIi52ZXJzaW9uXCIpLCB0aGlzLl92ZXJzaW9uLCAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGlzQ3VycmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KSwgNTAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KSksIE9ic2VydmFibGUub2YoaXNDdXJyZW50KSkpO1xuICAgIH1cbiAgICBmaW5kUnVudGltZShsb2NhdGlvbiA9IHJlc29sdmUoZGVmYXVsdERlc3QpKSB7XG4gICAgICAgIHJldHVybiBmaW5kUnVudGltZUJ5SWQodGhpcy5faWQsIGxvY2F0aW9uKTtcbiAgICB9XG4gICAgZG93bmxvYWRSdW50aW1lKCkge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5kZWZlcigoKSA9PiBPYnNlcnZhYmxlLmNvbmNhdCh0aGlzLl9kb3dubG9hZFNwZWNpZmljUnVudGltZShcIm9tbmlzaGFycFwiKSkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlT24oU2NoZWR1bGVyLmFzeW5jKVxuICAgICAgICAgICAgLnRvQXJyYXkoKTtcbiAgICB9XG4gICAgZG93bmxvYWRSdW50aW1lSWZNaXNzaW5nKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5zdXJlQ3VycmVudFZlcnNpb24oKVxuICAgICAgICAgICAgLmZsYXRNYXAoKGlzQ3VycmVudCkgPT4gdGhpcy5maW5kUnVudGltZSgpLmlzRW1wdHkoKSlcbiAgICAgICAgICAgIC5mbGF0TWFwKGVtcHR5ID0+IE9ic2VydmFibGUuaWYoKCkgPT4gZW1wdHksIHRoaXMuZG93bmxvYWRSdW50aW1lKCkpKTtcbiAgICB9XG4gICAgX2Rvd25sb2FkU3BlY2lmaWNSdW50aW1lKG5hbWUpIHtcbiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBgJHtuYW1lfS0ke3RoaXMuX2tleX0uJHt0aGlzLl9wbGF0Zm9ybSA9PT0gXCJ3aW4zMlwiID8gXCJ6aXBcIiA6IFwidGFyLmd6XCJ9YDtcbiAgICAgICAgY29uc3QgZGVzdGluYXRpb24gPSB0aGlzLl9kZXN0aW5hdGlvbjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkZXN0aW5hdGlvbikpXG4gICAgICAgICAgICAgICAgZnMubWtkaXJTeW5jKGRlc3RpbmF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkgeyB9XG4gICAgICAgIGNvbnN0IHVybCA9IGBodHRwczovL2dpdGh1Yi5jb20vT21uaVNoYXJwL29tbmlzaGFycC1yb3NseW4vcmVsZWFzZXMvZG93bmxvYWQvJHt0aGlzLl92ZXJzaW9ufS8ke2ZpbGVuYW1lfWA7XG4gICAgICAgIGNvbnN0IHBhdGggPSBqb2luKGRlc3RpbmF0aW9uLCBmaWxlbmFtZSk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmRlZmVyKCgpID0+IE9ic2VydmFibGUuY29uY2F0KHRoaXMuZG93bmxvYWRGaWxlKHVybCwgcGF0aCkuZGVsYXkoMTAwKSwgT2JzZXJ2YWJsZS5kZWZlcigoKSA9PiB0aGlzLl9leHRyYWN0KHRoaXMuX3BsYXRmb3JtID09PSBcIndpbjMyXCIsIHBhdGgsIGRlc3RpbmF0aW9uKSkpXG4gICAgICAgICAgICAuZG8oeyBjb21wbGV0ZTogKCkgPT4geyB0cnkge1xuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMocGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZSkgeyB9IH0gfSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmVPbihTY2hlZHVsZXIuYXN5bmMpKVxuICAgICAgICAgICAgLm1hcCgoKSA9PiBuYW1lKTtcbiAgICB9XG4gICAgZG93bmxvYWRGaWxlKHVybCwgcGF0aCkge1xuICAgICAgICB0aGlzLl9sb2dnZXIubG9nKGBEb3dubG9hZGluZyAke3BhdGh9YCk7XG4gICAgICAgIHJldHVybiBjcmVhdGVPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgcmVxdWVzdC5nZXQodXJsKVxuICAgICAgICAgICAgICAgIC5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgpKVxuICAgICAgICAgICAgICAgIC5vbihcImVycm9yXCIsIGJpbmQob2JzZXJ2ZXIuZXJyb3IsIG9ic2VydmVyKSlcbiAgICAgICAgICAgICAgICAub24oXCJmaW5pc2hcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5sb2coYEZpbmlzaGVkIGRvd25sb2FkaW5nICR7cGF0aH1gKTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KG51bGwpO1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIF9leHRyYWN0KHdpbjMyLCBwYXRoLCBkZXN0KSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgRXh0cmFjdGluZyAke3BhdGh9YCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhwYXRoLCBkZXN0KTtcbiAgICAgICAgICAgIG5ldyBEZWNvbXByZXNzKHsgbW9kZTogXCI3NTVcIiB9KVxuICAgICAgICAgICAgICAgIC5zcmMocGF0aClcbiAgICAgICAgICAgICAgICAuZGVzdChkZXN0KVxuICAgICAgICAgICAgICAgIC5ydW4oKGVyciwgZmlsZXMpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmxvZyhgRmluaXNoZWQgZXh0cmFjdGluZyAke3BhdGh9YCk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5leHBvcnQgY29uc3QgaXNTdXBwb3J0ZWRSdW50aW1lID0gbWVtb2l6ZShmdW5jdGlvbiAoY3R4KSB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuZGVmZXIoKCkgPT4ge1xuICAgICAgICBpZiAoY3R4LnBsYXRmb3JtID09PSBcIndpbjMyXCIgfHwgY3R4LnJ1bnRpbWUgPT09IFJ1bnRpbWUuQ29yZUNscikge1xuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoeyBydW50aW1lOiBjdHgucnVudGltZSwgcGF0aDogcHJvY2Vzcy5lbnYuUEFUSCB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tKFBBVEgpXG4gICAgICAgICAgICAubWFwKHBhdGggPT4gam9pbihwYXRoLCBcIm1vbm9cIikpXG4gICAgICAgICAgICAuY29uY2F0TWFwKHBhdGggPT4gZXhpc3RzKHBhdGgpLm1hcChlID0+ICh7IGV4aXN0czogZSwgcGF0aCB9KSkpXG4gICAgICAgICAgICAuZmlsdGVyKHggPT4geC5leGlzdHMpXG4gICAgICAgICAgICAubWFwKHggPT4gKHsgcnVudGltZTogUnVudGltZS5DbHJPck1vbm8sIHBhdGg6IFt4LnBhdGhdLmNvbmNhdChQQVRIKS5qb2luKGRlbGltaXRlcikgfSkpXG4gICAgICAgICAgICAudGFrZSgxKVxuICAgICAgICAgICAgLmRlZmF1bHRJZkVtcHR5KHsgcnVudGltZTogUnVudGltZS5Db3JlQ2xyLCBwYXRoOiBwcm9jZXNzLmVudi5QQVRIIH0pO1xuICAgIH0pXG4gICAgICAgIC5kbyhjdCA9PiBjb25zb2xlLmxvZyhgU3VwcG9ydGVkIHJ1bnRpbWUgZm9yIFwiJHtSdW50aW1lW2N0LnJ1bnRpbWVdfVwiIHdhczogJHtSdW50aW1lW2N0LnJ1bnRpbWVdfWApKVxuICAgICAgICAuY2FjaGUoMSk7XG59LCBmdW5jdGlvbiAoeyBwbGF0Zm9ybSwgYXJjaCwgcnVudGltZSwgdmVyc2lvbiB9KSB7IHJldHVybiBgJHthcmNofS0ke3BsYXRmb3JtfToke1J1bnRpbWVbcnVudGltZV19OiR7dmVyc2lvbn1gOyB9KTtcbmV4cG9ydCBmdW5jdGlvbiBmaW5kUnVudGltZUJ5SWQocnVudGltZUlkLCBsb2NhdGlvbikge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLm1lcmdlKGV4aXN0cyhyZXNvbHZlKGxvY2F0aW9uLCBydW50aW1lSWQsIFwiT21uaVNoYXJwLmV4ZVwiKSksIGV4aXN0cyhyZXNvbHZlKGxvY2F0aW9uLCBydW50aW1lSWQsIFwiT21uaVNoYXJwXCIpKSlcbiAgICAgICAgLmZpbHRlcih4ID0+IHgpXG4gICAgICAgIC50YWtlKDEpXG4gICAgICAgIC5tYXAoeCA9PiByZXNvbHZlKGxvY2F0aW9uLCBydW50aW1lSWQpKVxuICAgICAgICAuc2hhcmUoKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
