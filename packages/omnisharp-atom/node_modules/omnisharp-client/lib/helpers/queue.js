"use strict";
var prioritization_1 = require('./prioritization');
var rxjs_1 = require('rxjs');
var lodash_1 = require('lodash');
var QueuePriority;
(function (QueuePriority) {
    QueuePriority[QueuePriority["Priority"] = 0] = "Priority";
    QueuePriority[QueuePriority["Normal"] = 1] = "Normal";
    QueuePriority[QueuePriority["Deferred"] = 2] = "Deferred";
})(QueuePriority || (QueuePriority = {}));
function getQueue(context) {
    if (prioritization_1.isPriorityCommand(context)) {
        return QueuePriority.Priority;
    }
    if (prioritization_1.isDeferredCommand(context)) {
        return QueuePriority.Deferred;
    }
    return QueuePriority.Normal;
}
var RequestQueue = (function () {
    function RequestQueue(concurrency, complete) {
        this.concurrency = concurrency;
        this.complete = complete;
        this.queue = [];
        this.requests = [];
    }
    RequestQueue.prototype.enqueue = function (item) {
        this.queue.push(item);
    };
    Object.defineProperty(RequestQueue.prototype, "full", {
        get: function () {
            return this.requests.length >= this.concurrency;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RequestQueue.prototype, "pending", {
        get: function () {
            return this.queue.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    RequestQueue.prototype.drain = function () {
        var _this = this;
        var i = 0;
        var slots = this.concurrency - this.requests.length;
        var _loop_1 = function() {
            var item = this_1.queue.shift();
            this_1.requests.push(item);
            item.subscribe({
                complete: function () {
                    lodash_1.pull(_this.requests, item);
                    _this.complete();
                }
            });
            item.next(null);
            item.complete();
            if (this_1.full)
                return { value: void 0 };
        };
        var this_1 = this;
        do {
            var state_1 = _loop_1();
            if (typeof state_1 === "object") return state_1.value;
        } while (this.queue.length && ++i < slots);
    };
    return RequestQueue;
}());
var Queue = (function () {
    function Queue(_concurrency, _requestCallback) {
        this._concurrency = _concurrency;
        this._requestCallback = _requestCallback;
        this._processing = false;
        // Keep deferred concurrency at a min of two, this lets us get around long running requests jamming the pipes.
        var _deferredConcurrency = Math.max(Math.floor(_concurrency / 4), 2);
        var complete = lodash_1.bind(this._complete, this);
        this._priority = new RequestQueue(1, complete);
        this._normal = new RequestQueue(_concurrency, complete);
        this._deferred = new RequestQueue(_deferredConcurrency, complete);
    }
    Queue.prototype.enqueue = function (context) {
        var _this = this;
        var subject = new rxjs_1.AsyncSubject();
        var observable = subject
            .asObservable()
            .mergeMap(function (x) { return _this._requestCallback(context); });
        // Doing a little bit of tickery here
        // Going to return this Observable, as if it were promise like.
        // And we will only commit to the promise once someone calls then on it.
        // This way another client, can cast the result to an observable, and gain cancelation
        var promiseLike = observable;
        promiseLike.then = (function (fulfilled, rejected) {
            return observable.toPromise().then(fulfilled, rejected);
        });
        var queue = getQueue(context);
        if (queue === QueuePriority.Priority)
            this._priority.enqueue(subject);
        if (queue === QueuePriority.Normal)
            this._normal.enqueue(subject);
        if (queue === QueuePriority.Deferred)
            this._deferred.enqueue(subject);
        this.drain();
        return observable;
    };
    Queue.prototype.drain = function () {
        if (this._processing)
            return;
        // Request inflight
        if (this._priority.full)
            return;
        if (this._normal.full && this._deferred.full)
            return;
        this._processing = true;
        if (this._priority.pending) {
            this._priority.drain();
            return;
        }
        if (this._normal.pending) {
            this._normal.drain();
        }
        if (this._deferred.pending) {
            this._deferred.drain();
        }
    };
    Queue.prototype._complete = function () {
        this._processing = false;
        this.drain();
    };
    return Queue;
}());
exports.Queue = Queue;

//# sourceMappingURL=data:application/json;base64,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QUssRUFBRSxDQUFDO1FBQzNCLENBQUM7SUFDTCxDQUFDO0lBRU8seUJBQVMsR0FBakI7UUFDSSxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDakIsQ0FBQztJQUNMLFlBQUM7QUFBRCxDQWxFQSxBQWtFQyxJQUFBO0FBbEVZLGFBQUssUUFrRWpCLENBQUEiLCJmaWxlIjoibGliL2hlbHBlcnMvcXVldWUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1ByaW9yaXR5Q29tbWFuZCwgaXNOb3JtYWxDb21tYW5kLCBpc0RlZmVycmVkQ29tbWFuZCB9IGZyb20gJy4vcHJpb3JpdGl6YXRpb24nO1xuaW1wb3J0IHsgUmVxdWVzdENvbnRleHQsIFJlc3BvbnNlQ29udGV4dCB9IGZyb20gJy4uL2NvbnRleHRzJztcbmltcG9ydCB7IE9ic2VydmFibGUsIEFzeW5jU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgcHVsbCwgYmluZCB9IGZyb20gJ2xvZGFzaCc7XG5cbmVudW0gUXVldWVQcmlvcml0eSB7XG4gICAgUHJpb3JpdHksXG4gICAgTm9ybWFsLFxuICAgIERlZmVycmVkLFxufVxuXG5mdW5jdGlvbiBnZXRRdWV1ZShjb250ZXh0OiBSZXF1ZXN0Q29udGV4dDxhbnk+KSB7XG4gICAgaWYgKGlzUHJpb3JpdHlDb21tYW5kKGNvbnRleHQpKSB7XG4gICAgICAgIHJldHVybiBRdWV1ZVByaW9yaXR5LlByaW9yaXR5O1xuICAgIH1cbiAgICBpZiAoaXNEZWZlcnJlZENvbW1hbmQoY29udGV4dCkpIHtcbiAgICAgICAgcmV0dXJuIFF1ZXVlUHJpb3JpdHkuRGVmZXJyZWQ7XG4gICAgfVxuICAgIHJldHVybiBRdWV1ZVByaW9yaXR5Lk5vcm1hbDtcbn1cblxuY2xhc3MgUmVxdWVzdFF1ZXVlIHtcbiAgICBwcml2YXRlIHF1ZXVlOiBBc3luY1N1YmplY3Q8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj5bXSA9IFtdO1xuICAgIHByaXZhdGUgcmVxdWVzdHM6IEFzeW5jU3ViamVjdDxSZXNwb25zZUNvbnRleHQ8YW55LCBhbnk+PltdID0gW107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmN1cnJlbmN5OiBudW1iZXIsIHByaXZhdGUgY29tcGxldGU6ICgpID0+IHZvaWQpIHsgfVxuXG4gICAgcHVibGljIGVucXVldWUoaXRlbTogQXN5bmNTdWJqZWN0PFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+KSB7XG4gICAgICAgIHRoaXMucXVldWUucHVzaChpdGVtKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGZ1bGwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RzLmxlbmd0aCA+PSB0aGlzLmNvbmN1cnJlbmN5O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcGVuZGluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucXVldWUubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZHJhaW4oKSB7XG4gICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgY29uc3Qgc2xvdHMgPSB0aGlzLmNvbmN1cnJlbmN5IC0gdGhpcy5yZXF1ZXN0cy5sZW5ndGg7XG4gICAgICAgIGRvIHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnF1ZXVlLnNoaWZ0KCkgITtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdHMucHVzaChpdGVtKTtcbiAgICAgICAgICAgIGl0ZW0uc3Vic2NyaWJlKHtcbiAgICAgICAgICAgICAgICBjb21wbGV0ZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBwdWxsKHRoaXMucmVxdWVzdHMsIGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0ZW0ubmV4dChudWxsISk7XG4gICAgICAgICAgICBpdGVtLmNvbXBsZXRlKCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmZ1bGwpIHJldHVybjtcbiAgICAgICAgfSB3aGlsZSAodGhpcy5xdWV1ZS5sZW5ndGggJiYgKytpIDwgc2xvdHMpO1xuICAgIH1cbn1cblxudHlwZSBERUxBWUVEX09CU0VSVkFCTEUgPSBPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+O1xuXG5leHBvcnQgY2xhc3MgUXVldWU8VFJlc3BvbnNlPiB7XG4gICAgcHJpdmF0ZSBfcHJpb3JpdHk6IFJlcXVlc3RRdWV1ZTtcbiAgICBwcml2YXRlIF9ub3JtYWw6IFJlcXVlc3RRdWV1ZTtcbiAgICBwcml2YXRlIF9kZWZlcnJlZDogUmVxdWVzdFF1ZXVlO1xuICAgIHByaXZhdGUgX3Byb2Nlc3NpbmcgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NvbmN1cnJlbmN5OiBudW1iZXIsIHByaXZhdGUgX3JlcXVlc3RDYWxsYmFjazogKGNvbnRleHQ6IFJlcXVlc3RDb250ZXh0PGFueT4pID0+IFRSZXNwb25zZSkge1xuICAgICAgICAvLyBLZWVwIGRlZmVycmVkIGNvbmN1cnJlbmN5IGF0IGEgbWluIG9mIHR3bywgdGhpcyBsZXRzIHVzIGdldCBhcm91bmQgbG9uZyBydW5uaW5nIHJlcXVlc3RzIGphbW1pbmcgdGhlIHBpcGVzLlxuICAgICAgICBjb25zdCBfZGVmZXJyZWRDb25jdXJyZW5jeSA9IE1hdGgubWF4KE1hdGguZmxvb3IoX2NvbmN1cnJlbmN5IC8gNCksIDIpO1xuICAgICAgICBjb25zdCBjb21wbGV0ZSA9IGJpbmQodGhpcy5fY29tcGxldGUsIHRoaXMpO1xuICAgICAgICB0aGlzLl9wcmlvcml0eSA9IG5ldyBSZXF1ZXN0UXVldWUoMSwgY29tcGxldGUpO1xuICAgICAgICB0aGlzLl9ub3JtYWwgPSBuZXcgUmVxdWVzdFF1ZXVlKF9jb25jdXJyZW5jeSwgY29tcGxldGUpO1xuICAgICAgICB0aGlzLl9kZWZlcnJlZCA9IG5ldyBSZXF1ZXN0UXVldWUoX2RlZmVycmVkQ29uY3VycmVuY3ksIGNvbXBsZXRlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZW5xdWV1ZShjb250ZXh0OiBSZXF1ZXN0Q29udGV4dDxhbnk+KTogVFJlc3BvbnNlIHtcbiAgICAgICAgY29uc3Qgc3ViamVjdCA9IG5ldyBBc3luY1N1YmplY3Q8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj4oKTtcbiAgICAgICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHN1YmplY3RcbiAgICAgICAgICAgIC5hc09ic2VydmFibGUoKVxuICAgICAgICAgICAgLm1lcmdlTWFwPFJlc3BvbnNlQ29udGV4dDxhbnksIGFueT4+KHggPT4gPGFueT50aGlzLl9yZXF1ZXN0Q2FsbGJhY2soY29udGV4dCkpO1xuXG4gICAgICAgIC8vIERvaW5nIGEgbGl0dGxlIGJpdCBvZiB0aWNrZXJ5IGhlcmVcbiAgICAgICAgLy8gR29pbmcgdG8gcmV0dXJuIHRoaXMgT2JzZXJ2YWJsZSwgYXMgaWYgaXQgd2VyZSBwcm9taXNlIGxpa2UuXG4gICAgICAgIC8vIEFuZCB3ZSB3aWxsIG9ubHkgY29tbWl0IHRvIHRoZSBwcm9taXNlIG9uY2Ugc29tZW9uZSBjYWxscyB0aGVuIG9uIGl0LlxuICAgICAgICAvLyBUaGlzIHdheSBhbm90aGVyIGNsaWVudCwgY2FuIGNhc3QgdGhlIHJlc3VsdCB0byBhbiBvYnNlcnZhYmxlLCBhbmQgZ2FpbiBjYW5jZWxhdGlvblxuICAgICAgICBjb25zdCBwcm9taXNlTGlrZTogUHJvbWlzZUxpa2U8UmVzcG9uc2VDb250ZXh0PGFueSwgYW55Pj4gPSA8YW55Pm9ic2VydmFibGU7XG4gICAgICAgIHByb21pc2VMaWtlLnRoZW4gPSA8YW55PigoZnVsZmlsbGVkOiBGdW5jdGlvbiwgcmVqZWN0ZWQ6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZS50b1Byb21pc2UoKS50aGVuKDxhbnk+ZnVsZmlsbGVkLCA8YW55PnJlamVjdGVkKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcXVldWUgPSBnZXRRdWV1ZShjb250ZXh0KTtcbiAgICAgICAgaWYgKHF1ZXVlID09PSBRdWV1ZVByaW9yaXR5LlByaW9yaXR5KSB0aGlzLl9wcmlvcml0eS5lbnF1ZXVlKHN1YmplY3QpO1xuICAgICAgICBpZiAocXVldWUgPT09IFF1ZXVlUHJpb3JpdHkuTm9ybWFsKSB0aGlzLl9ub3JtYWwuZW5xdWV1ZShzdWJqZWN0KTtcbiAgICAgICAgaWYgKHF1ZXVlID09PSBRdWV1ZVByaW9yaXR5LkRlZmVycmVkKSB0aGlzLl9kZWZlcnJlZC5lbnF1ZXVlKHN1YmplY3QpO1xuXG4gICAgICAgIHRoaXMuZHJhaW4oKTtcblxuICAgICAgICByZXR1cm4gPGFueT5vYnNlcnZhYmxlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZHJhaW4oKSB7XG4gICAgICAgIGlmICh0aGlzLl9wcm9jZXNzaW5nKSByZXR1cm47XG4gICAgICAgIC8vIFJlcXVlc3QgaW5mbGlnaHRcbiAgICAgICAgaWYgKHRoaXMuX3ByaW9yaXR5LmZ1bGwpIHJldHVybjtcbiAgICAgICAgaWYgKHRoaXMuX25vcm1hbC5mdWxsICYmIHRoaXMuX2RlZmVycmVkLmZ1bGwpIHJldHVybjtcblxuICAgICAgICB0aGlzLl9wcm9jZXNzaW5nID0gdHJ1ZTtcblxuICAgICAgICBpZiAodGhpcy5fcHJpb3JpdHkucGVuZGluZykge1xuICAgICAgICAgICAgdGhpcy5fcHJpb3JpdHkuZHJhaW4oKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9ub3JtYWwucGVuZGluZykge1xuICAgICAgICAgICAgdGhpcy5fbm9ybWFsLmRyYWluKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fZGVmZXJyZWQucGVuZGluZykge1xuICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWQuZHJhaW4oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NvbXBsZXRlKCkge1xuICAgICAgICB0aGlzLl9wcm9jZXNzaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZHJhaW4oKTtcbiAgICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
