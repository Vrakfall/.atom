"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.ResponseContext = exports.RequestContext = exports.CommandContext = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _lodash = require("lodash");

var _responseHandling = require("./response-handling");

var _create = require("./operators/create");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var stripBom = require("strip-bom");

var CommandContext = exports.CommandContext = function CommandContext(command, value) {
    _classCallCheck(this, CommandContext);

    this.command = command;
    this.value = value;
};

var RequestContext = exports.RequestContext = function () {
    function RequestContext(clientId, command, request, _ref) {
        var silent = _ref.silent;
        var oneBasedIndices = _ref.oneBasedIndices;
        var sequence = arguments.length <= 4 || arguments[4] === undefined ? (0, _lodash.uniqueId)("__request") : arguments[4];

        _classCallCheck(this, RequestContext);

        this.clientId = clientId;
        if (command) this.command = command.toLowerCase();
        if ((0, _lodash.isObject)(request)) {
            if (request.Buffer) {
                request.Buffer = stripBom(request.Buffer);
            }
            var obj = (0, _lodash.cloneDeep)(request);
            if (!oneBasedIndices) {
                obj = (0, _responseHandling.requestMutator)(obj);
            }
            this.request = Object.freeze(obj);
        } else {
            this.request = request;
        }
        this.silent = !!silent;
        this.sequence = sequence;
        this.time = new Date();
        Object.freeze(this);
    }

    _createClass(RequestContext, [{
        key: "isCommand",
        value: function isCommand(command) {
            if (command && this.command) {
                return command.toLowerCase() === this.command;
            }
            return null;
        }
    }, {
        key: "getResponse",
        value: function getResponse(stream) {
            var _this = this;

            return (0, _create.createObservable)(function (observer) {
                return stream.first(function (res) {
                    return res.sequence === _this.sequence;
                }).subscribe(function (res) {
                    if (!res.failed) {
                        observer.next(res.response);
                        observer.complete();
                    } else {
                        observer.complete();
                    }
                });
            });
        }
    }]);

    return RequestContext;
}();

var ResponseContext = exports.ResponseContext = function () {
    function ResponseContext(_ref2) {
        var clientId = _ref2.clientId;
        var request = _ref2.request;
        var command = _ref2.command;
        var sequence = _ref2.sequence;
        var time = _ref2.time;
        var silent = _ref2.silent;
        var oneBasedIndices = _ref2.oneBasedIndices;
        var response = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
        var failed = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

        _classCallCheck(this, ResponseContext);

        if (command) this.command = command.toLowerCase();
        if ((0, _lodash.isObject)(response)) {
            if (!oneBasedIndices) {
                response = (0, _responseHandling.responseMutator)(response);
            }
            this.response = Object.freeze(response);
        } else {
            this.response = response;
        }
        this.clientId = clientId;
        this.request = request;
        this.command = command;
        this.sequence = sequence;
        this.time = new Date();
        this.silent = !!silent;
        this.failed = !!failed;
        this.responseTime = this.time.getTime() - time.getTime();
        Object.freeze(this);
    }

    _createClass(ResponseContext, [{
        key: "isCommand",
        value: function isCommand(command) {
            if (command && this.command) {
                return command.toLowerCase() === this.command;
            }
            return null;
        }
    }]);

    return ResponseContext;
}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb250ZXh0cy5qcyIsImxpYi9jb250ZXh0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7OztBQ0dBLElBQU0sV0FBVyxRQUFRLFdBQVIsQ0FBWDs7SUFFTiwwQ0FDSSxTQURKLGNBQ0ksQ0FBbUIsT0FBbkIsRUFBMkMsS0FBM0MsRUFBbUQ7MEJBRHZELGdCQUN1RDs7QUFBaEMsU0FBQSxPQUFBLEdBQUEsT0FBQSxDQUFnQztBQUFSLFNBQUEsS0FBQSxHQUFBLEtBQUEsQ0FBUTtDQUFuRDs7SUFHSjtBQWNJLGFBZEosY0FjSSxDQUFtQixRQUFuQixFQUFxQyxPQUFyQyxFQUFzRCxPQUF0RCxRQUF1SjtZQUFwRixxQkFBb0Y7WUFBNUUsdUNBQTRFO1lBQWhDLGlFQUFXLHNCQUFTLFdBQVQsaUJBQXFCOzs4QkFkM0osZ0JBYzJKOztBQUFwSSxhQUFBLFFBQUEsR0FBQSxRQUFBLENBQW9JO0FBQ25KLFlBQUksT0FBSixFQUFhLEtBQUssT0FBTCxHQUFlLFFBQVEsV0FBUixFQUFmLENBQWI7QUFFQSxZQUFJLHNCQUFTLE9BQVQsQ0FBSixFQUF1QjtBQUVuQixnQkFBSSxRQUFRLE1BQVIsRUFBZ0I7QUFDaEIsd0JBQVEsTUFBUixHQUFpQixTQUFTLFFBQVEsTUFBUixDQUExQixDQURnQjthQUFwQjtBQUlBLGdCQUFJLE1BQU0sdUJBQVUsT0FBVixDQUFOLENBTmU7QUFPbkIsZ0JBQUksQ0FBQyxlQUFELEVBQWtCO0FBQ2xCLHNCQUFNLHNDQUFlLEdBQWYsQ0FBTixDQURrQjthQUF0QjtBQUdBLGlCQUFLLE9BQUwsR0FBZSxPQUFPLE1BQVAsQ0FBYyxHQUFkLENBQWYsQ0FWbUI7U0FBdkIsTUFXTztBQUNILGlCQUFLLE9BQUwsR0FBZSxPQUFmLENBREc7U0FYUDtBQWVBLGFBQUssTUFBTCxHQUFjLENBQUMsQ0FBQyxNQUFELENBbEJvSTtBQW1CbkosYUFBSyxRQUFMLEdBQWdCLFFBQWhCLENBbkJtSjtBQW9CbkosYUFBSyxJQUFMLEdBQVksSUFBSSxJQUFKLEVBQVosQ0FwQm1KO0FBcUJuSixlQUFPLE1BQVAsQ0FBYyxJQUFkLEVBckJtSjtLQUF2Sjs7aUJBZEo7O2tDQU9xQixTQUFlO0FBQzVCLGdCQUFJLFdBQVcsS0FBSyxPQUFMLEVBQWM7QUFDekIsdUJBQU8sUUFBUSxXQUFSLE9BQTBCLEtBQUssT0FBTCxDQURSO2FBQTdCO0FBR0EsbUJBQU8sSUFBUCxDQUo0Qjs7OztvQ0ErQkYsUUFBaUQ7OztBQUMzRSxtQkFBTyw4QkFBNEI7dUJBQy9CLE9BQU8sS0FBUCxDQUFhOzJCQUFPLElBQUksUUFBSixLQUFpQixNQUFLLFFBQUw7aUJBQXhCLENBQWIsQ0FBb0QsU0FBcEQsQ0FBOEQsZUFBRztBQUM3RCx3QkFBSSxDQUFDLElBQUksTUFBSixFQUFZO0FBQ2IsaUNBQVMsSUFBVCxDQUFjLElBQUksUUFBSixDQUFkLENBRGE7QUFFYixpQ0FBUyxRQUFULEdBRmE7cUJBQWpCLE1BR087QUFDSCxpQ0FBUyxRQUFULEdBREc7cUJBSFA7aUJBRDBEO2FBRC9CLENBQW5DLENBRDJFOzs7O1dBdENuRjs7O0lBbURBO0FBaUJJLGFBakJKLGVBaUJJLFFBQXFKO1lBQXhJLDBCQUF3STtZQUE5SCx3QkFBOEg7WUFBckgsd0JBQXFIO1lBQTVHLDBCQUE0RztZQUFsRyxrQkFBa0c7WUFBNUYsc0JBQTRGO1lBQXBGLHdDQUFvRjtZQUE3QyxpRUFBMkIsa0JBQWtCO1lBQWQsK0RBQVMscUJBQUs7OzhCQWpCekosaUJBaUJ5Sjs7QUFDakosWUFBSSxPQUFKLEVBQWEsS0FBSyxPQUFMLEdBQWUsUUFBUSxXQUFSLEVBQWYsQ0FBYjtBQUVBLFlBQUksc0JBQVMsUUFBVCxDQUFKLEVBQXdCO0FBQ3BCLGdCQUFJLENBQUMsZUFBRCxFQUFrQjtBQUNsQiwyQkFBVyx1Q0FBZ0IsUUFBaEIsQ0FBWCxDQURrQjthQUF0QjtBQUdBLGlCQUFLLFFBQUwsR0FBZ0IsT0FBTyxNQUFQLENBQWMsUUFBZCxDQUFoQixDQUpvQjtTQUF4QixNQUtPO0FBQ0gsaUJBQUssUUFBTCxHQUFnQixRQUFoQixDQURHO1NBTFA7QUFTQSxhQUFLLFFBQUwsR0FBZ0IsUUFBaEIsQ0FaaUo7QUFhakosYUFBSyxPQUFMLEdBQWUsT0FBZixDQWJpSjtBQWNqSixhQUFLLE9BQUwsR0FBZSxPQUFmLENBZGlKO0FBZWpKLGFBQUssUUFBTCxHQUFnQixRQUFoQixDQWZpSjtBQWdCakosYUFBSyxJQUFMLEdBQVksSUFBSSxJQUFKLEVBQVosQ0FoQmlKO0FBaUJqSixhQUFLLE1BQUwsR0FBYyxDQUFDLENBQUMsTUFBRCxDQWpCa0k7QUFrQmpKLGFBQUssTUFBTCxHQUFjLENBQUMsQ0FBQyxNQUFELENBbEJrSTtBQW1CakosYUFBSyxZQUFMLEdBQW9CLEtBQUssSUFBTCxDQUFVLE9BQVYsS0FBc0IsS0FBSyxPQUFMLEVBQXRCLENBbkI2SDtBQW9CakosZUFBTyxNQUFQLENBQWMsSUFBZCxFQXBCaUo7S0FBcko7O2lCQWpCSjs7a0NBVXFCLFNBQWU7QUFDNUIsZ0JBQUksV0FBVyxLQUFLLE9BQUwsRUFBYztBQUN6Qix1QkFBTyxRQUFRLFdBQVIsT0FBMEIsS0FBSyxPQUFMLENBRFI7YUFBN0I7QUFHQSxtQkFBTyxJQUFQLENBSjRCOzs7O1dBVnBDIiwiZmlsZSI6ImxpYi9jb250ZXh0cy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVuaXF1ZUlkLCBpc09iamVjdCwgY2xvbmVEZWVwIH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgcmVxdWVzdE11dGF0b3IsIHJlc3BvbnNlTXV0YXRvciB9IGZyb20gXCIuL3Jlc3BvbnNlLWhhbmRsaW5nXCI7XG5pbXBvcnQgeyBjcmVhdGVPYnNlcnZhYmxlIH0gZnJvbSBcIi4vb3BlcmF0b3JzL2NyZWF0ZVwiO1xuY29uc3Qgc3RyaXBCb20gPSByZXF1aXJlKFwic3RyaXAtYm9tXCIpO1xuZXhwb3J0IGNsYXNzIENvbW1hbmRDb250ZXh0IHtcbiAgICBjb25zdHJ1Y3Rvcihjb21tYW5kLCB2YWx1ZSkge1xuICAgICAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kO1xuICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIFJlcXVlc3RDb250ZXh0IHtcbiAgICBjb25zdHJ1Y3RvcihjbGllbnRJZCwgY29tbWFuZCwgcmVxdWVzdCwgeyBzaWxlbnQsIG9uZUJhc2VkSW5kaWNlcyB9LCBzZXF1ZW5jZSA9IHVuaXF1ZUlkKFwiX19yZXF1ZXN0XCIpKSB7XG4gICAgICAgIHRoaXMuY2xpZW50SWQgPSBjbGllbnRJZDtcbiAgICAgICAgaWYgKGNvbW1hbmQpXG4gICAgICAgICAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmIChpc09iamVjdChyZXF1ZXN0KSkge1xuICAgICAgICAgICAgaWYgKHJlcXVlc3QuQnVmZmVyKSB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdC5CdWZmZXIgPSBzdHJpcEJvbShyZXF1ZXN0LkJ1ZmZlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgb2JqID0gY2xvbmVEZWVwKHJlcXVlc3QpO1xuICAgICAgICAgICAgaWYgKCFvbmVCYXNlZEluZGljZXMpIHtcbiAgICAgICAgICAgICAgICBvYmogPSByZXF1ZXN0TXV0YXRvcihvYmopO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0ID0gT2JqZWN0LmZyZWV6ZShvYmopO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNpbGVudCA9ICEhc2lsZW50O1xuICAgICAgICB0aGlzLnNlcXVlbmNlID0gc2VxdWVuY2U7XG4gICAgICAgIHRoaXMudGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gICAgfVxuICAgIGlzQ29tbWFuZChjb21tYW5kKSB7XG4gICAgICAgIGlmIChjb21tYW5kICYmIHRoaXMuY29tbWFuZCkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbW1hbmQudG9Mb3dlckNhc2UoKSA9PT0gdGhpcy5jb21tYW5kO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBnZXRSZXNwb25zZShzdHJlYW0pIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZU9ic2VydmFibGUob2JzZXJ2ZXIgPT4gc3RyZWFtLmZpcnN0KHJlcyA9PiByZXMuc2VxdWVuY2UgPT09IHRoaXMuc2VxdWVuY2UpLnN1YnNjcmliZShyZXMgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXMuZmFpbGVkKSB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXMucmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KSk7XG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIFJlc3BvbnNlQ29udGV4dCB7XG4gICAgY29uc3RydWN0b3IoeyBjbGllbnRJZCwgcmVxdWVzdCwgY29tbWFuZCwgc2VxdWVuY2UsIHRpbWUsIHNpbGVudCwgb25lQmFzZWRJbmRpY2VzIH0sIHJlc3BvbnNlID0ge30sIGZhaWxlZCA9IGZhbHNlKSB7XG4gICAgICAgIGlmIChjb21tYW5kKVxuICAgICAgICAgICAgdGhpcy5jb21tYW5kID0gY29tbWFuZC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoaXNPYmplY3QocmVzcG9uc2UpKSB7XG4gICAgICAgICAgICBpZiAoIW9uZUJhc2VkSW5kaWNlcykge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gcmVzcG9uc2VNdXRhdG9yKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2UgPSBPYmplY3QuZnJlZXplKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsaWVudElkID0gY2xpZW50SWQ7XG4gICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgICAgIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQ7XG4gICAgICAgIHRoaXMuc2VxdWVuY2UgPSBzZXF1ZW5jZTtcbiAgICAgICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTtcbiAgICAgICAgdGhpcy5zaWxlbnQgPSAhIXNpbGVudDtcbiAgICAgICAgdGhpcy5mYWlsZWQgPSAhIWZhaWxlZDtcbiAgICAgICAgdGhpcy5yZXNwb25zZVRpbWUgPSB0aGlzLnRpbWUuZ2V0VGltZSgpIC0gdGltZS5nZXRUaW1lKCk7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gICAgfVxuICAgIGlzQ29tbWFuZChjb21tYW5kKSB7XG4gICAgICAgIGlmIChjb21tYW5kICYmIHRoaXMuY29tbWFuZCkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbW1hbmQudG9Mb3dlckNhc2UoKSA9PT0gdGhpcy5jb21tYW5kO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn1cbiIsImltcG9ydCAqIGFzIE9tbmlTaGFycCBmcm9tIFwiLi9vbW5pc2hhcnAtc2VydmVyXCI7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQge3VuaXF1ZUlkLCBpc09iamVjdCwgY2xvbmVEZWVwfSBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQge3JlcXVlc3RNdXRhdG9yLCByZXNwb25zZU11dGF0b3J9IGZyb20gXCIuL3Jlc3BvbnNlLWhhbmRsaW5nXCI7XG5pbXBvcnQge2NyZWF0ZU9ic2VydmFibGV9IGZyb20gXCIuL29wZXJhdG9ycy9jcmVhdGVcIjtcbmNvbnN0IHN0cmlwQm9tID0gcmVxdWlyZShcInN0cmlwLWJvbVwiKTtcblxuZXhwb3J0IGNsYXNzIENvbW1hbmRDb250ZXh0PFQ+IHtcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgY29tbWFuZDogc3RyaW5nLCBwdWJsaWMgdmFsdWU6IFQpIHsgfVxufVxuXG5leHBvcnQgY2xhc3MgUmVxdWVzdENvbnRleHQ8VCBleHRlbmRzIE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdD4ge1xuICAgIHB1YmxpYyBjb21tYW5kOiBzdHJpbmc7XG4gICAgcHVibGljIHJlcXVlc3Q6IFQ7XG4gICAgcHVibGljIHNlcXVlbmNlOiBzdHJpbmc7XG4gICAgcHVibGljIHRpbWU6IERhdGU7XG4gICAgcHVibGljIHNpbGVudDogYm9vbGVhbjtcbiAgICBwdWJsaWMgb25lQmFzZWRJbmRpY2VzOiBib29sZWFuO1xuICAgIHB1YmxpYyBpc0NvbW1hbmQoY29tbWFuZDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChjb21tYW5kICYmIHRoaXMuY29tbWFuZCkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbW1hbmQudG9Mb3dlckNhc2UoKSA9PT0gdGhpcy5jb21tYW5kO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBjbGllbnRJZDogc3RyaW5nLCBjb21tYW5kOiBzdHJpbmcsIHJlcXVlc3Q6IFQsIHtzaWxlbnQsIG9uZUJhc2VkSW5kaWNlc306IE9tbmlTaGFycC5SZXF1ZXN0T3B0aW9ucywgc2VxdWVuY2UgPSB1bmlxdWVJZChcIl9fcmVxdWVzdFwiKSkge1xuICAgICAgICBpZiAoY29tbWFuZCkgdGhpcy5jb21tYW5kID0gY29tbWFuZC50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGlmIChpc09iamVjdChyZXF1ZXN0KSkge1xuICAgICAgICAgICAgLyogdHNsaW50OmRpc2FibGU6bm8tc3RyaW5nLWxpdGVyYWwgKi9cbiAgICAgICAgICAgIGlmIChyZXF1ZXN0LkJ1ZmZlcikge1xuICAgICAgICAgICAgICAgIHJlcXVlc3QuQnVmZmVyID0gc3RyaXBCb20ocmVxdWVzdC5CdWZmZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyogdHNsaW50OmVuYWJsZTpuby1zdHJpbmctbGl0ZXJhbCAqL1xuICAgICAgICAgICAgbGV0IG9iaiA9IGNsb25lRGVlcChyZXF1ZXN0KTtcbiAgICAgICAgICAgIGlmICghb25lQmFzZWRJbmRpY2VzKSB7XG4gICAgICAgICAgICAgICAgb2JqID0gcmVxdWVzdE11dGF0b3Iob2JqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVxdWVzdCA9IE9iamVjdC5mcmVlemUob2JqKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNpbGVudCA9ICEhc2lsZW50O1xuICAgICAgICB0aGlzLnNlcXVlbmNlID0gc2VxdWVuY2U7XG4gICAgICAgIHRoaXMudGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFJlc3BvbnNlPFRSZXNwb25zZT4oc3RyZWFtOiBPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxULCBUUmVzcG9uc2U+Pikge1xuICAgICAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZTxUUmVzcG9uc2U+KG9ic2VydmVyID0+XG4gICAgICAgICAgICBzdHJlYW0uZmlyc3QocmVzID0+IHJlcy5zZXF1ZW5jZSA9PT0gdGhpcy5zZXF1ZW5jZSkuc3Vic2NyaWJlKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXMuZmFpbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzLnJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZXNwb25zZUNvbnRleHQ8VFJlcXVlc3QsIFRSZXNwb25zZT4ge1xuICAgIHB1YmxpYyBjbGllbnRJZDogc3RyaW5nO1xuICAgIHB1YmxpYyByZXF1ZXN0OiBUUmVxdWVzdDtcbiAgICBwdWJsaWMgcmVzcG9uc2U6IFRSZXNwb25zZTtcbiAgICBwdWJsaWMgY29tbWFuZDogc3RyaW5nO1xuICAgIHB1YmxpYyBzZXF1ZW5jZTogc3RyaW5nO1xuICAgIHB1YmxpYyB0aW1lOiBEYXRlO1xuICAgIHB1YmxpYyByZXNwb25zZVRpbWU6IG51bWJlcjtcbiAgICBwdWJsaWMgc2lsZW50OiBib29sZWFuO1xuICAgIHB1YmxpYyBmYWlsZWQ6IGJvb2xlYW47XG4gICAgcHVibGljIGlzQ29tbWFuZChjb21tYW5kOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGNvbW1hbmQgJiYgdGhpcy5jb21tYW5kKSB7XG4gICAgICAgICAgICByZXR1cm4gY29tbWFuZC50b0xvd2VyQ2FzZSgpID09PSB0aGlzLmNvbW1hbmQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3Ioe2NsaWVudElkLCByZXF1ZXN0LCBjb21tYW5kLCBzZXF1ZW5jZSwgdGltZSwgc2lsZW50LCBvbmVCYXNlZEluZGljZXN9OiBSZXF1ZXN0Q29udGV4dDxhbnk+LCByZXNwb25zZTogVFJlc3BvbnNlID0gPGFueT57fSwgZmFpbGVkID0gZmFsc2UpIHtcbiAgICAgICAgaWYgKGNvbW1hbmQpIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICBpZiAoaXNPYmplY3QocmVzcG9uc2UpKSB7XG4gICAgICAgICAgICBpZiAoIW9uZUJhc2VkSW5kaWNlcykge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gcmVzcG9uc2VNdXRhdG9yKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2UgPSBPYmplY3QuZnJlZXplKHJlc3BvbnNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY2xpZW50SWQgPSBjbGllbnRJZDtcbiAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDtcbiAgICAgICAgdGhpcy5jb21tYW5kID0gY29tbWFuZDtcbiAgICAgICAgdGhpcy5zZXF1ZW5jZSA9IHNlcXVlbmNlO1xuICAgICAgICB0aGlzLnRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB0aGlzLnNpbGVudCA9ICEhc2lsZW50O1xuICAgICAgICB0aGlzLmZhaWxlZCA9ICEhZmFpbGVkO1xuICAgICAgICB0aGlzLnJlc3BvbnNlVGltZSA9IHRoaXMudGltZS5nZXRUaW1lKCkgLSB0aW1lLmdldFRpbWUoKTtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzKTtcbiAgICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
