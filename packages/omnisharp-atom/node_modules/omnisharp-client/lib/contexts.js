"use strict";
var lodash_1 = require('lodash');
var create_1 = require('./operators/create');
var stripBom = require('strip-bom');
var CommandContext = (function () {
    function CommandContext(command, value) {
        this.command = command;
        this.value = value;
    }
    return CommandContext;
}());
exports.CommandContext = CommandContext;
var RequestContext = (function () {
    function RequestContext(clientId, command, request, _a, sequence) {
        var silent = _a.silent;
        if (sequence === void 0) { sequence = lodash_1.uniqueId('__request'); }
        this.clientId = clientId;
        if (command)
            this.command = command.toLowerCase();
        if (lodash_1.isObject(request)) {
            if (request.Buffer) {
                request.Buffer = stripBom(request.Buffer);
            }
            var obj = lodash_1.cloneDeep(request);
            this.request = Object.freeze(obj);
        }
        else {
            this.request = request;
        }
        this.silent = !!silent;
        this.sequence = sequence;
        this.time = new Date();
        Object.freeze(this);
    }
    RequestContext.prototype.isCommand = function (command) {
        if (command && this.command) {
            return command.toLowerCase() === this.command;
        }
        return null;
    };
    RequestContext.prototype.getResponse = function (stream) {
        var _this = this;
        return create_1.createObservable(function (observer) {
            return stream.first(function (res) { return res.sequence === _this.sequence; }).subscribe(function (res) {
                if (!res.failed) {
                    observer.next(res.response);
                    observer.complete();
                }
                else {
                    observer.complete();
                }
            });
        });
    };
    return RequestContext;
}());
exports.RequestContext = RequestContext;
var ResponseContext = (function () {
    function ResponseContext(_a, response, failed) {
        var clientId = _a.clientId, request = _a.request, command = _a.command, sequence = _a.sequence, time = _a.time, silent = _a.silent;
        if (response === void 0) { response = {}; }
        if (failed === void 0) { failed = false; }
        if (command)
            this.command = command.toLowerCase();
        if (lodash_1.isObject(response)) {
            this.response = Object.freeze(response);
        }
        else {
            this.response = response;
        }
        this.clientId = clientId;
        this.request = request;
        this.command = command;
        this.sequence = sequence;
        this.time = new Date();
        this.silent = !!silent;
        this.failed = !!failed;
        this.responseTime = this.time.getTime() - time.getTime();
        Object.freeze(this);
    }
    ResponseContext.prototype.isCommand = function (command) {
        if (command && this.command) {
            return command.toLowerCase() === this.command;
        }
        return null;
    };
    return ResponseContext;
}());
exports.ResponseContext = ResponseContext;

//# sourceMappingURL=data:application/json;base64,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ZTtRQUM1QixFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDMUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ2xELENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFxQkwsc0JBQUM7QUFBRCxDQXBDQSxBQW9DQyxJQUFBO0FBcENZLHVCQUFlLGtCQW9DM0IsQ0FBQSIsImZpbGUiOiJsaWIvY29udGV4dHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBPbW5pU2hhcnAgZnJvbSAnLi9vbW5pc2hhcnAtc2VydmVyJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHVuaXF1ZUlkLCBpc09iamVjdCwgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGNyZWF0ZU9ic2VydmFibGUgfSBmcm9tICcuL29wZXJhdG9ycy9jcmVhdGUnO1xuY29uc3Qgc3RyaXBCb20gPSByZXF1aXJlKCdzdHJpcC1ib20nKTtcblxuZXhwb3J0IGNsYXNzIENvbW1hbmRDb250ZXh0PFQ+IHtcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgY29tbWFuZDogc3RyaW5nLCBwdWJsaWMgdmFsdWU6IFQpIHsgfVxufVxuXG5leHBvcnQgY2xhc3MgUmVxdWVzdENvbnRleHQ8VCBleHRlbmRzIE9tbmlTaGFycC5Nb2RlbHMuUmVxdWVzdD4ge1xuICAgIHB1YmxpYyBjb21tYW5kOiBzdHJpbmc7XG4gICAgcHVibGljIHJlcXVlc3Q6IFQ7XG4gICAgcHVibGljIHNlcXVlbmNlOiBzdHJpbmc7XG4gICAgcHVibGljIHRpbWU6IERhdGU7XG4gICAgcHVibGljIHNpbGVudDogYm9vbGVhbjtcbiAgICBwdWJsaWMgaXNDb21tYW5kKGNvbW1hbmQ6IHN0cmluZykge1xuICAgICAgICBpZiAoY29tbWFuZCAmJiB0aGlzLmNvbW1hbmQpIHtcbiAgICAgICAgICAgIHJldHVybiBjb21tYW5kLnRvTG93ZXJDYXNlKCkgPT09IHRoaXMuY29tbWFuZDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgY2xpZW50SWQ6IHN0cmluZywgY29tbWFuZDogc3RyaW5nLCByZXF1ZXN0OiBULCB7c2lsZW50fTogT21uaVNoYXJwLlJlcXVlc3RPcHRpb25zLCBzZXF1ZW5jZSA9IHVuaXF1ZUlkKCdfX3JlcXVlc3QnKSkge1xuICAgICAgICBpZiAoY29tbWFuZCkgdGhpcy5jb21tYW5kID0gY29tbWFuZC50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGlmIChpc09iamVjdDxPbW5pU2hhcnAuTW9kZWxzLlJlcXVlc3Q+KHJlcXVlc3QpKSB7XG4gICAgICAgICAgICBpZiAocmVxdWVzdC5CdWZmZXIpIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0LkJ1ZmZlciA9IHN0cmlwQm9tKHJlcXVlc3QuQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBvYmogPSBjbG9uZURlZXAocmVxdWVzdCk7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3QgPSA8YW55Pk9iamVjdC5mcmVlemUob2JqKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNpbGVudCA9ICEhc2lsZW50O1xuICAgICAgICB0aGlzLnNlcXVlbmNlID0gc2VxdWVuY2U7XG4gICAgICAgIHRoaXMudGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFJlc3BvbnNlPFRSZXNwb25zZT4oc3RyZWFtOiBPYnNlcnZhYmxlPFJlc3BvbnNlQ29udGV4dDxULCBUUmVzcG9uc2U+Pikge1xuICAgICAgICByZXR1cm4gY3JlYXRlT2JzZXJ2YWJsZTxUUmVzcG9uc2U+KG9ic2VydmVyID0+XG4gICAgICAgICAgICBzdHJlYW0uZmlyc3QocmVzID0+IHJlcy5zZXF1ZW5jZSA9PT0gdGhpcy5zZXF1ZW5jZSkuc3Vic2NyaWJlKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXMuZmFpbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzLnJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZXNwb25zZUNvbnRleHQ8VFJlcXVlc3QsIFRSZXNwb25zZT4ge1xuICAgIHB1YmxpYyBjbGllbnRJZDogc3RyaW5nO1xuICAgIHB1YmxpYyByZXF1ZXN0OiBUUmVxdWVzdDtcbiAgICBwdWJsaWMgcmVzcG9uc2U6IFRSZXNwb25zZTtcbiAgICBwdWJsaWMgY29tbWFuZDogc3RyaW5nO1xuICAgIHB1YmxpYyBzZXF1ZW5jZTogc3RyaW5nO1xuICAgIHB1YmxpYyB0aW1lOiBEYXRlO1xuICAgIHB1YmxpYyByZXNwb25zZVRpbWU6IG51bWJlcjtcbiAgICBwdWJsaWMgc2lsZW50OiBib29sZWFuO1xuICAgIHB1YmxpYyBmYWlsZWQ6IGJvb2xlYW47XG4gICAgcHVibGljIGlzQ29tbWFuZChjb21tYW5kOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGNvbW1hbmQgJiYgdGhpcy5jb21tYW5kKSB7XG4gICAgICAgICAgICByZXR1cm4gY29tbWFuZC50b0xvd2VyQ2FzZSgpID09PSB0aGlzLmNvbW1hbmQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3Ioe2NsaWVudElkLCByZXF1ZXN0LCBjb21tYW5kLCBzZXF1ZW5jZSwgdGltZSwgc2lsZW50fTogUmVxdWVzdENvbnRleHQ8YW55PiwgcmVzcG9uc2U6IFRSZXNwb25zZSA9IDxhbnk+e30sIGZhaWxlZCA9IGZhbHNlKSB7XG4gICAgICAgIGlmIChjb21tYW5kKSB0aGlzLmNvbW1hbmQgPSBjb21tYW5kLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgaWYgKGlzT2JqZWN0KHJlc3BvbnNlKSkge1xuICAgICAgICAgICAgdGhpcy5yZXNwb25zZSA9IDxhbnk+T2JqZWN0LmZyZWV6ZShyZXNwb25zZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlc3BvbnNlID0gcmVzcG9uc2U7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNsaWVudElkID0gY2xpZW50SWQ7XG4gICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgICAgIHRoaXMuY29tbWFuZCA9IGNvbW1hbmQ7XG4gICAgICAgIHRoaXMuc2VxdWVuY2UgPSBzZXF1ZW5jZTtcbiAgICAgICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTtcbiAgICAgICAgdGhpcy5zaWxlbnQgPSAhIXNpbGVudDtcbiAgICAgICAgdGhpcy5mYWlsZWQgPSAhIWZhaWxlZDtcbiAgICAgICAgdGhpcy5yZXNwb25zZVRpbWUgPSB0aGlzLnRpbWUuZ2V0VGltZSgpIC0gdGltZS5nZXRUaW1lKCk7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcyk7XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
