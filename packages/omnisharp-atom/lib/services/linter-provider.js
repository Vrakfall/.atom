"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.provider = undefined;
exports.init = init;

var _omni = require("../server/omni");

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _rxjs = require("rxjs");

var _omnisharpClient = require("omnisharp-client");

var _codeCheck = require("../features/code-check");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Range = require("atom").Range;

function mapValues(editor, error) {
    var level = error.LogLevel.toLowerCase();
    return {
        type: level,
        text: error.Text + " [" + _omni.Omni.getFrameworks(error.Projects) + "] ",
        filePath: editor.getPath(),
        range: new Range([error.Line, error.Column], [error.EndLine, error.EndColumn])
    };
}
function showLinter() {
    _lodash2.default.each(document.querySelectorAll("linter-bottom-tab"), function (element) {
        return element.style.display = "";
    });
    _lodash2.default.each(document.querySelectorAll("linter-bottom-status"), function (element) {
        return element.style.display = "";
    });
    var panel = document.querySelector("linter-panel");
    if (panel) panel.style.display = "";
}
function hideLinter() {
    _lodash2.default.each(document.querySelectorAll("linter-bottom-tab"), function (element) {
        return element.style.display = "none";
    });
    _lodash2.default.each(document.querySelectorAll("linter-bottom-status"), function (element) {
        return element.style.display = "none";
    });
    var panel = document.querySelector("linter-panel");
    if (panel) panel.style.display = "none";
}
var showHiddenDiagnostics = true;
function init(linter) {
    var disposable = new _omnisharpClient.CompositeDisposable();
    var cd = void 0;
    disposable.add(atom.config.observe("omnisharp-atom.hideLinterInterface", function (hidden) {
        if (hidden) {
            cd = new _omnisharpClient.CompositeDisposable();
            disposable.add(cd);
            cd.add(_omni.Omni.activeEditor.filter(function (z) {
                return !z;
            }).subscribe(showLinter));
            cd.add(_omni.Omni.activeEditor.filter(function (z) {
                return !!z;
            }).subscribe(hideLinter));
        } else {
            if (cd) {
                disposable.remove(cd);
                cd.dispose();
            }
            showLinter();
        }
    }));
    disposable.add(atom.config.observe("omnisharp-atom.showHiddenDiagnostics", function (show) {
        showHiddenDiagnostics = show;
        atom.workspace.getTextEditors().forEach(function (editor) {
            var editorLinter = linter.getEditorLinter(editor);
            if (editorLinter) {
                editorLinter.lint(true);
            }
        });
    }));
    disposable.add(_omni.Omni.activeEditor.filter(function (z) {
        return !!z;
    }).take(1).delay(1000).subscribe(function (e) {
        _omni.Omni.whenEditorConnected(e).subscribe(function () {
            atom.workspace.getTextEditors().forEach(function (editor) {
                var editorLinter = linter.getEditorLinter(editor);
                if (editorLinter) {
                    editorLinter.lint(true);
                }
            });
        });
    }));
    return disposable;
}
var provider = exports.provider = [{
    name: "c#",
    get grammarScopes() {
        return _omni.Omni.grammars.map(function (x) {
            return x.scopeName;
        });
    },
    scope: "file",
    lintOnFly: true,
    lint: function lint(editor) {
        var path = editor.getPath();
        var o = _rxjs.Observable.defer(function () {
            return _codeCheck.codeCheck.doCodeCheck(editor);
        });
        return o.timeoutWith(30000, _rxjs.Observable.of([])).flatMap(function (x) {
            return x;
        }).filter(function (z) {
            return z.FileName === path && (showHiddenDiagnostics || z.LogLevel !== "Hidden");
        }).map(function (error) {
            return mapValues(editor, error);
        }).toArray().toPromise();
    }
}, {
    name: "c#",
    get grammarScopes() {
        return _omni.Omni.grammars.map(function (x) {
            return x.scopeName;
        });
    },
    scope: "project",
    lintOnFly: false,
    lint: function lint(editor) {
        return _omni.Omni.activeModel.flatMap(function (x) {
            return x.diagnostics;
        }).filter(function (z) {
            return showHiddenDiagnostics || z.LogLevel !== "Hidden";
        }).map(function (error) {
            return mapValues(editor, error);
        }).toArray().toPromise();
    }
}];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9saW50ZXItcHJvdmlkZXIudHMiLCJsaWIvc2VydmljZXMvbGludGVyLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztRQWdEQSxJLEdBQUEsSTs7QUNoREE7O0FBRUE7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBREZBLElBQU0sUUFBUSxRQUFRLE1BQVIsRUFBZ0IsS0FBOUI7O0FBZ0JBLFNBQUEsU0FBQSxDQUFtQixNQUFuQixFQUE0QyxLQUE1QyxFQUE0RTtBQUN4RSxRQUFNLFFBQVEsTUFBTSxRQUFOLENBQWUsV0FBZixFQUFkO0FBRUEsV0FBTztBQUNILGNBQU0sS0FESDtBQUVILGNBQVMsTUFBTSxJQUFmLFVBQXdCLFdBQUssYUFBTCxDQUFtQixNQUFNLFFBQXpCLENBQXhCLE9BRkc7QUFHSCxrQkFBVSxPQUFPLE9BQVAsRUFIUDtBQUlILGVBQU8sSUFBSSxLQUFKLENBQVUsQ0FBQyxNQUFNLElBQVAsRUFBYSxNQUFNLE1BQW5CLENBQVYsRUFBc0MsQ0FBQyxNQUFNLE9BQVAsRUFBZ0IsTUFBTSxTQUF0QixDQUF0QztBQUpKLEtBQVA7QUFNSDtBQUVELFNBQUEsVUFBQSxHQUFBO0FBQ0kscUJBQUUsSUFBRixDQUFPLFNBQVMsZ0JBQVQsQ0FBMEIsbUJBQTFCLENBQVAsRUFBdUQsVUFBQyxPQUFEO0FBQUEsZUFBMEIsUUFBUSxLQUFSLENBQWMsT0FBZCxHQUF3QixFQUFsRDtBQUFBLEtBQXZEO0FBQ0EscUJBQUUsSUFBRixDQUFPLFNBQVMsZ0JBQVQsQ0FBMEIsc0JBQTFCLENBQVAsRUFBMEQsVUFBQyxPQUFEO0FBQUEsZUFBMEIsUUFBUSxLQUFSLENBQWMsT0FBZCxHQUF3QixFQUFsRDtBQUFBLEtBQTFEO0FBQ0EsUUFBTSxRQUFxQixTQUFTLGFBQVQsQ0FBdUIsY0FBdkIsQ0FBM0I7QUFDQSxRQUFJLEtBQUosRUFDSSxNQUFNLEtBQU4sQ0FBWSxPQUFaLEdBQXNCLEVBQXRCO0FBQ1A7QUFFRCxT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ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZGVsc30gZnJvbSBcIm9tbmlzaGFycC1jbGllbnRcIjtcbmltcG9ydCB7T21uaX0gZnJvbSBcIi4uL3NlcnZlci9vbW5pXCI7XG4vKiB0c2xpbnQ6ZGlzYWJsZTp2YXJpYWJsZS1uYW1lICovXG5jb25zdCBSYW5nZSA9IHJlcXVpcmUoXCJhdG9tXCIpLlJhbmdlO1xuLyogdHNsaW50OmVuYWJsZTp2YXJpYWJsZS1uYW1lICovXG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gXCJvbW5pc2hhcnAtY2xpZW50XCI7XG5pbXBvcnQge2NvZGVDaGVja30gZnJvbSBcIi4uL2ZlYXR1cmVzL2NvZGUtY2hlY2tcIjtcblxuaW50ZXJmYWNlIExpbnRlckVycm9yIHtcbiAgICB0eXBlOiBzdHJpbmc7IC8vIFwiZXJyb3JcIiB8IFwid2FybmluZ1wiXG4gICAgdGV4dD86IHN0cmluZztcbiAgICBodG1sPzogc3RyaW5nO1xuICAgIGZpbGVQYXRoPzogc3RyaW5nO1xuICAgIHJhbmdlPzogUmFuZ2U7XG4gICAgW2tleTogc3RyaW5nXTogYW55O1xufVxuXG5mdW5jdGlvbiBtYXBWYWx1ZXMoZWRpdG9yOiBBdG9tLlRleHRFZGl0b3IsIGVycm9yOiBNb2RlbHMuRGlhZ25vc3RpY0xvY2F0aW9uKTogTGludGVyRXJyb3Ige1xuICAgIGNvbnN0IGxldmVsID0gZXJyb3IuTG9nTGV2ZWwudG9Mb3dlckNhc2UoKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IGxldmVsLFxuICAgICAgICB0ZXh0OiBgJHtlcnJvci5UZXh0fSBbJHtPbW5pLmdldEZyYW1ld29ya3MoZXJyb3IuUHJvamVjdHMpfV0gYCxcbiAgICAgICAgZmlsZVBhdGg6IGVkaXRvci5nZXRQYXRoKCksXG4gICAgICAgIHJhbmdlOiBuZXcgUmFuZ2UoW2Vycm9yLkxpbmUsIGVycm9yLkNvbHVtbl0sIFtlcnJvci5FbmRMaW5lLCBlcnJvci5FbmRDb2x1bW5dKVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHNob3dMaW50ZXIoKSB7XG4gICAgXy5lYWNoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJsaW50ZXItYm90dG9tLXRhYlwiKSwgKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBcIlwiKTtcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tc3RhdHVzXCIpLCAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IFwiXCIpO1xuICAgIGNvbnN0IHBhbmVsID0gPEhUTUxFbGVtZW50PmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJsaW50ZXItcGFuZWxcIik7XG4gICAgaWYgKHBhbmVsKVxuICAgICAgICBwYW5lbC5zdHlsZS5kaXNwbGF5ID0gXCJcIjtcbn1cblxuZnVuY3Rpb24gaGlkZUxpbnRlcigpIHtcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tdGFiXCIpLCAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiKTtcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tc3RhdHVzXCIpLCAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiKTtcbiAgICBjb25zdCBwYW5lbCA9IDxIVE1MRWxlbWVudD5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwibGludGVyLXBhbmVsXCIpO1xuICAgIGlmIChwYW5lbClcbiAgICAgICAgcGFuZWwuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xufVxuXG5sZXQgc2hvd0hpZGRlbkRpYWdub3N0aWNzID0gdHJ1ZTtcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQobGludGVyOiB7IGdldEVkaXRvckxpbnRlcjogKGVkaXRvcjogQXRvbS5UZXh0RWRpdG9yKSA9PiB7IGxpbnQ6IChzaG91bGRMaW50OiBib29sZWFuKSA9PiB2b2lkIH0gfSkge1xuICAgIGNvbnN0IGRpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIGxldCBjZDogQ29tcG9zaXRlRGlzcG9zYWJsZTtcbiAgICBkaXNwb3NhYmxlLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKFwib21uaXNoYXJwLWF0b20uaGlkZUxpbnRlckludGVyZmFjZVwiLCBoaWRkZW4gPT4ge1xuICAgICAgICBpZiAoaGlkZGVuKSB7XG4gICAgICAgICAgICBjZCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgICAgICBkaXNwb3NhYmxlLmFkZChjZCk7XG5cbiAgICAgICAgICAgIC8vIHNob3cgbGludGVyIGJ1dHRvbnNcbiAgICAgICAgICAgIGNkLmFkZChPbW5pLmFjdGl2ZUVkaXRvclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiAheilcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKHNob3dMaW50ZXIpKTtcblxuICAgICAgICAgICAgLy8gaGlkZSBsaW50ZXIgYnV0dG9uc1xuICAgICAgICAgICAgY2QuYWRkKE9tbmkuYWN0aXZlRWRpdG9yXG4gICAgICAgICAgICAgICAgLmZpbHRlcih6ID0+ICEheilcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKGhpZGVMaW50ZXIpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjZCkge1xuICAgICAgICAgICAgICAgIGRpc3Bvc2FibGUucmVtb3ZlKGNkKTtcbiAgICAgICAgICAgICAgICBjZC5kaXNwb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzaG93TGludGVyKCk7XG4gICAgICAgIH1cbiAgICB9KSk7XG5cbiAgICBkaXNwb3NhYmxlLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKFwib21uaXNoYXJwLWF0b20uc2hvd0hpZGRlbkRpYWdub3N0aWNzXCIsIHNob3cgPT4ge1xuICAgICAgICBzaG93SGlkZGVuRGlhZ25vc3RpY3MgPSBzaG93O1xuICAgICAgICBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLmZvckVhY2goKGVkaXRvcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWRpdG9yTGludGVyID0gbGludGVyLmdldEVkaXRvckxpbnRlcihlZGl0b3IpO1xuICAgICAgICAgICAgaWYgKGVkaXRvckxpbnRlcikge1xuICAgICAgICAgICAgICAgIGVkaXRvckxpbnRlci5saW50KHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KSk7XG5cbiAgICBkaXNwb3NhYmxlLmFkZChPbW5pLmFjdGl2ZUVkaXRvci5maWx0ZXIoeiA9PiAhIXopLnRha2UoMSkuZGVsYXkoMTAwMCkuc3Vic2NyaWJlKChlKSA9PiB7XG4gICAgICAgIE9tbmkud2hlbkVkaXRvckNvbm5lY3RlZChlKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKS5mb3JFYWNoKChlZGl0b3IpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBlZGl0b3JMaW50ZXIgPSBsaW50ZXIuZ2V0RWRpdG9yTGludGVyKGVkaXRvcik7XG4gICAgICAgICAgICAgICAgaWYgKGVkaXRvckxpbnRlcikge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3JMaW50ZXIubGludCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIGRpc3Bvc2FibGU7XG59XG5cbmV4cG9ydCBjb25zdCBwcm92aWRlciA9IFtcbiAgICB7XG4gICAgICAgIG5hbWU6IFwiYyNcIixcbiAgICAgICAgZ2V0IGdyYW1tYXJTY29wZXMoKSB7IHJldHVybiBPbW5pLmdyYW1tYXJzLm1hcCgoeDogYW55KSA9PiB4LnNjb3BlTmFtZSk7IH0sXG4gICAgICAgIHNjb3BlOiBcImZpbGVcIixcbiAgICAgICAgbGludE9uRmx5OiB0cnVlLFxuICAgICAgICBsaW50OiAoZWRpdG9yOiBBdG9tLlRleHRFZGl0b3IpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xuICAgICAgICAgICAgY29uc3QgbyA9IE9ic2VydmFibGUuZGVmZXIoKCkgPT4gY29kZUNoZWNrLmRvQ29kZUNoZWNrKGVkaXRvcikpO1xuICAgICAgICAgICAgcmV0dXJuIG9cbiAgICAgICAgICAgICAgICAudGltZW91dFdpdGgoMzAwMDAsIE9ic2VydmFibGUub2YoPE1vZGVscy5EaWFnbm9zdGljTG9jYXRpb25bXT5bXSkpXG4gICAgICAgICAgICAgICAgLmZsYXRNYXAoeCA9PiB4KVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiB6LkZpbGVOYW1lID09PSBwYXRoICYmIChzaG93SGlkZGVuRGlhZ25vc3RpY3MgfHwgei5Mb2dMZXZlbCAhPT0gXCJIaWRkZW5cIikpXG4gICAgICAgICAgICAgICAgLm1hcChlcnJvciA9PiBtYXBWYWx1ZXMoZWRpdG9yLCBlcnJvcikpXG4gICAgICAgICAgICAgICAgLnRvQXJyYXkoKVxuICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICAgICAgfVxuICAgIH0sIHtcbiAgICAgICAgbmFtZTogXCJjI1wiLFxuICAgICAgICBnZXQgZ3JhbW1hclNjb3BlcygpIHsgcmV0dXJuIE9tbmkuZ3JhbW1hcnMubWFwKCh4OiBhbnkpID0+IHguc2NvcGVOYW1lKTsgfSxcbiAgICAgICAgc2NvcGU6IFwicHJvamVjdFwiLFxuICAgICAgICBsaW50T25GbHk6IGZhbHNlLFxuICAgICAgICBsaW50OiAoZWRpdG9yOiBBdG9tLlRleHRFZGl0b3IpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBPbW5pLmFjdGl2ZU1vZGVsXG4gICAgICAgICAgICAgICAgLmZsYXRNYXAoeCA9PiB4LmRpYWdub3N0aWNzKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiBzaG93SGlkZGVuRGlhZ25vc3RpY3MgfHwgei5Mb2dMZXZlbCAhPT0gXCJIaWRkZW5cIilcbiAgICAgICAgICAgICAgICAubWFwKGVycm9yID0+IG1hcFZhbHVlcyhlZGl0b3IsIGVycm9yKSlcbiAgICAgICAgICAgICAgICAudG9BcnJheSgpXG4gICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgICB9XG4gICAgfVxuXTtcbiIsImltcG9ydCB7IE9tbmkgfSBmcm9tIFwiLi4vc2VydmVyL29tbmlcIjtcbmNvbnN0IFJhbmdlID0gcmVxdWlyZShcImF0b21cIikuUmFuZ2U7XG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tIFwib21uaXNoYXJwLWNsaWVudFwiO1xuaW1wb3J0IHsgY29kZUNoZWNrIH0gZnJvbSBcIi4uL2ZlYXR1cmVzL2NvZGUtY2hlY2tcIjtcbmZ1bmN0aW9uIG1hcFZhbHVlcyhlZGl0b3IsIGVycm9yKSB7XG4gICAgY29uc3QgbGV2ZWwgPSBlcnJvci5Mb2dMZXZlbC50b0xvd2VyQ2FzZSgpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IGxldmVsLFxuICAgICAgICB0ZXh0OiBgJHtlcnJvci5UZXh0fSBbJHtPbW5pLmdldEZyYW1ld29ya3MoZXJyb3IuUHJvamVjdHMpfV0gYCxcbiAgICAgICAgZmlsZVBhdGg6IGVkaXRvci5nZXRQYXRoKCksXG4gICAgICAgIHJhbmdlOiBuZXcgUmFuZ2UoW2Vycm9yLkxpbmUsIGVycm9yLkNvbHVtbl0sIFtlcnJvci5FbmRMaW5lLCBlcnJvci5FbmRDb2x1bW5dKVxuICAgIH07XG59XG5mdW5jdGlvbiBzaG93TGludGVyKCkge1xuICAgIF8uZWFjaChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwibGludGVyLWJvdHRvbS10YWJcIiksIChlbGVtZW50KSA9PiBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBcIlwiKTtcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tc3RhdHVzXCIpLCAoZWxlbWVudCkgPT4gZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gXCJcIik7XG4gICAgY29uc3QgcGFuZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwibGludGVyLXBhbmVsXCIpO1xuICAgIGlmIChwYW5lbClcbiAgICAgICAgcGFuZWwuc3R5bGUuZGlzcGxheSA9IFwiXCI7XG59XG5mdW5jdGlvbiBoaWRlTGludGVyKCkge1xuICAgIF8uZWFjaChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwibGludGVyLWJvdHRvbS10YWJcIiksIChlbGVtZW50KSA9PiBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIik7XG4gICAgXy5lYWNoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJsaW50ZXItYm90dG9tLXN0YXR1c1wiKSwgKGVsZW1lbnQpID0+IGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiKTtcbiAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJsaW50ZXItcGFuZWxcIik7XG4gICAgaWYgKHBhbmVsKVxuICAgICAgICBwYW5lbC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG59XG5sZXQgc2hvd0hpZGRlbkRpYWdub3N0aWNzID0gdHJ1ZTtcbmV4cG9ydCBmdW5jdGlvbiBpbml0KGxpbnRlcikge1xuICAgIGNvbnN0IGRpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIGxldCBjZDtcbiAgICBkaXNwb3NhYmxlLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKFwib21uaXNoYXJwLWF0b20uaGlkZUxpbnRlckludGVyZmFjZVwiLCBoaWRkZW4gPT4ge1xuICAgICAgICBpZiAoaGlkZGVuKSB7XG4gICAgICAgICAgICBjZCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgICAgICBkaXNwb3NhYmxlLmFkZChjZCk7XG4gICAgICAgICAgICBjZC5hZGQoT21uaS5hY3RpdmVFZGl0b3JcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHogPT4gIXopXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShzaG93TGludGVyKSk7XG4gICAgICAgICAgICBjZC5hZGQoT21uaS5hY3RpdmVFZGl0b3JcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHogPT4gISF6KVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoaGlkZUxpbnRlcikpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKGNkKSB7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZS5yZW1vdmUoY2QpO1xuICAgICAgICAgICAgICAgIGNkLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNob3dMaW50ZXIoKTtcbiAgICAgICAgfVxuICAgIH0pKTtcbiAgICBkaXNwb3NhYmxlLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKFwib21uaXNoYXJwLWF0b20uc2hvd0hpZGRlbkRpYWdub3N0aWNzXCIsIHNob3cgPT4ge1xuICAgICAgICBzaG93SGlkZGVuRGlhZ25vc3RpY3MgPSBzaG93O1xuICAgICAgICBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLmZvckVhY2goKGVkaXRvcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWRpdG9yTGludGVyID0gbGludGVyLmdldEVkaXRvckxpbnRlcihlZGl0b3IpO1xuICAgICAgICAgICAgaWYgKGVkaXRvckxpbnRlcikge1xuICAgICAgICAgICAgICAgIGVkaXRvckxpbnRlci5saW50KHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KSk7XG4gICAgZGlzcG9zYWJsZS5hZGQoT21uaS5hY3RpdmVFZGl0b3IuZmlsdGVyKHogPT4gISF6KS50YWtlKDEpLmRlbGF5KDEwMDApLnN1YnNjcmliZSgoZSkgPT4ge1xuICAgICAgICBPbW5pLndoZW5FZGl0b3JDb25uZWN0ZWQoZSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkuZm9yRWFjaCgoZWRpdG9yKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZWRpdG9yTGludGVyID0gbGludGVyLmdldEVkaXRvckxpbnRlcihlZGl0b3IpO1xuICAgICAgICAgICAgICAgIGlmIChlZGl0b3JMaW50ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yTGludGVyLmxpbnQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pKTtcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcbn1cbmV4cG9ydCBjb25zdCBwcm92aWRlciA9IFtcbiAgICB7XG4gICAgICAgIG5hbWU6IFwiYyNcIixcbiAgICAgICAgZ2V0IGdyYW1tYXJTY29wZXMoKSB7IHJldHVybiBPbW5pLmdyYW1tYXJzLm1hcCgoeCkgPT4geC5zY29wZU5hbWUpOyB9LFxuICAgICAgICBzY29wZTogXCJmaWxlXCIsXG4gICAgICAgIGxpbnRPbkZseTogdHJ1ZSxcbiAgICAgICAgbGludDogKGVkaXRvcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgcGF0aCA9IGVkaXRvci5nZXRQYXRoKCk7XG4gICAgICAgICAgICBjb25zdCBvID0gT2JzZXJ2YWJsZS5kZWZlcigoKSA9PiBjb2RlQ2hlY2suZG9Db2RlQ2hlY2soZWRpdG9yKSk7XG4gICAgICAgICAgICByZXR1cm4gb1xuICAgICAgICAgICAgICAgIC50aW1lb3V0V2l0aCgzMDAwMCwgT2JzZXJ2YWJsZS5vZihbXSkpXG4gICAgICAgICAgICAgICAgLmZsYXRNYXAoeCA9PiB4KVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiB6LkZpbGVOYW1lID09PSBwYXRoICYmIChzaG93SGlkZGVuRGlhZ25vc3RpY3MgfHwgei5Mb2dMZXZlbCAhPT0gXCJIaWRkZW5cIikpXG4gICAgICAgICAgICAgICAgLm1hcChlcnJvciA9PiBtYXBWYWx1ZXMoZWRpdG9yLCBlcnJvcikpXG4gICAgICAgICAgICAgICAgLnRvQXJyYXkoKVxuICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICAgICAgfVxuICAgIH0sIHtcbiAgICAgICAgbmFtZTogXCJjI1wiLFxuICAgICAgICBnZXQgZ3JhbW1hclNjb3BlcygpIHsgcmV0dXJuIE9tbmkuZ3JhbW1hcnMubWFwKCh4KSA9PiB4LnNjb3BlTmFtZSk7IH0sXG4gICAgICAgIHNjb3BlOiBcInByb2plY3RcIixcbiAgICAgICAgbGludE9uRmx5OiBmYWxzZSxcbiAgICAgICAgbGludDogKGVkaXRvcikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIE9tbmkuYWN0aXZlTW9kZWxcbiAgICAgICAgICAgICAgICAuZmxhdE1hcCh4ID0+IHguZGlhZ25vc3RpY3MpXG4gICAgICAgICAgICAgICAgLmZpbHRlcih6ID0+IHNob3dIaWRkZW5EaWFnbm9zdGljcyB8fCB6LkxvZ0xldmVsICE9PSBcIkhpZGRlblwiKVxuICAgICAgICAgICAgICAgIC5tYXAoZXJyb3IgPT4gbWFwVmFsdWVzKGVkaXRvciwgZXJyb3IpKVxuICAgICAgICAgICAgICAgIC50b0FycmF5KClcbiAgICAgICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgICAgIH1cbiAgICB9XG5dO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
